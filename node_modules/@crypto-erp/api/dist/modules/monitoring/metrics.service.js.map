{"version":3,"sources":["../../../src/modules/monitoring/metrics.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { InjectMetric } from '@willsoto/nestjs-prometheus';\nimport { Counter, Histogram, Gauge, Registry } from 'prom-client';\n\n/**\n * Metrics Service for Prometheus\n * Tracks critical business and technical metrics\n */\n@Injectable()\nexport class MetricsService {\n  constructor(\n    // HTTP Metrics\n    @InjectMetric('http_requests_total') public httpRequestsTotal: Counter<string>,\n    @InjectMetric('http_request_duration_seconds') public httpRequestDuration: Histogram<string>,\n\n    // Database Metrics\n    @InjectMetric('db_query_duration_seconds') public dbQueryDuration: Histogram<string>,\n    @InjectMetric('db_connections_active') public dbConnectionsActive: Gauge<string>,\n\n    // Business Metrics\n    @InjectMetric('invoices_created_total') public invoicesCreated: Counter<string>,\n    @InjectMetric('crypto_transactions_synced_total') public cryptoTransactionsSynced: Counter<string>,\n    @InjectMetric('ai_messages_total') public aiMessages: Counter<string>,\n    @InjectMetric('verifactu_submissions_total') public verifactuSubmissions: Counter<string>,\n\n    // Queue Metrics\n    @InjectMetric('queue_jobs_total') public queueJobsTotal: Counter<string>,\n    @InjectMetric('queue_jobs_active') public queueJobsActive: Gauge<string>,\n    @InjectMetric('queue_jobs_failed_total') public queueJobsFailed: Counter<string>,\n\n    // Subscription Metrics\n    @InjectMetric('subscriptions_active') public subscriptionsActive: Gauge<string>,\n    @InjectMetric('subscriptions_churned_total') public subscriptionsChurned: Counter<string>,\n    @InjectMetric('revenue_mrr') public revenueMRR: Gauge<string>,\n\n    private readonly registry: Registry,\n  ) {}\n\n  /**\n   * Track HTTP request\n   */\n  trackHttpRequest(method: string, route: string, statusCode: number, duration: number): void {\n    this.httpRequestsTotal.labels(method, route, statusCode.toString()).inc();\n    this.httpRequestDuration.labels(method, route).observe(duration);\n  }\n\n  /**\n   * Track database query\n   */\n  trackDbQuery(operation: string, duration: number): void {\n    this.dbQueryDuration.labels(operation).observe(duration);\n  }\n\n  /**\n   * Track invoice creation\n   */\n  trackInvoiceCreated(companyId: string, type: string): void {\n    this.invoicesCreated.labels(companyId, type).inc();\n  }\n\n  /**\n   * Track crypto transaction sync\n   */\n  trackCryptoTransactionSynced(blockchain: string, type: string): void {\n    this.cryptoTransactionsSynced.labels(blockchain, type).inc();\n  }\n\n  /**\n   * Track AI message\n   */\n  trackAiMessage(companyId: string, provider: string): void {\n    this.aiMessages.labels(companyId, provider).inc();\n  }\n\n  /**\n   * Track Verifactu submission\n   */\n  trackVerifactuSubmission(companyId: string, status: 'success' | 'error'): void {\n    this.verifactuSubmissions.labels(companyId, status).inc();\n  }\n\n  /**\n   * Track queue job\n   */\n  trackQueueJob(queue: string, status: 'completed' | 'failed'): void {\n    this.queueJobsTotal.labels(queue, status).inc();\n    if (status === 'failed') {\n      this.queueJobsFailed.labels(queue).inc();\n    }\n  }\n\n  /**\n   * Update active jobs gauge\n   */\n  setQueueJobsActive(queue: string, count: number): void {\n    this.queueJobsActive.labels(queue).set(count);\n  }\n\n  /**\n   * Update subscription metrics\n   */\n  updateSubscriptionMetrics(activeCount: number, mrr: number): void {\n    this.subscriptionsActive.set(activeCount);\n    this.revenueMRR.set(mrr);\n  }\n\n  /**\n   * Track subscription churn\n   */\n  trackSubscriptionChurn(plan: string, reason: string): void {\n    this.subscriptionsChurned.labels(plan, reason).inc();\n  }\n\n  /**\n   * Get all metrics as Prometheus text format\n   */\n  async getMetrics(): Promise<string> {\n    return this.registry.metrics();\n  }\n}\n"],"names":["MetricsService","trackHttpRequest","method","route","statusCode","duration","httpRequestsTotal","labels","toString","inc","httpRequestDuration","observe","trackDbQuery","operation","dbQueryDuration","trackInvoiceCreated","companyId","type","invoicesCreated","trackCryptoTransactionSynced","blockchain","cryptoTransactionsSynced","trackAiMessage","provider","aiMessages","trackVerifactuSubmission","status","verifactuSubmissions","trackQueueJob","queue","queueJobsTotal","queueJobsFailed","setQueueJobsActive","count","queueJobsActive","set","updateSubscriptionMetrics","activeCount","mrr","subscriptionsActive","revenueMRR","trackSubscriptionChurn","plan","reason","subscriptionsChurned","getMetrics","registry","metrics","dbConnectionsActive"],"mappings":";;;;+BASaA;;;eAAAA;;;wBATc;kCACE;4BACuB;;;;;;;;;;;;;;;AAO7C,IAAA,AAAMA,iBAAN,MAAMA;IA6BX;;GAEC,GACDC,iBAAiBC,MAAc,EAAEC,KAAa,EAAEC,UAAkB,EAAEC,QAAgB,EAAQ;QAC1F,IAAI,CAACC,iBAAiB,CAACC,MAAM,CAACL,QAAQC,OAAOC,WAAWI,QAAQ,IAAIC,GAAG;QACvE,IAAI,CAACC,mBAAmB,CAACH,MAAM,CAACL,QAAQC,OAAOQ,OAAO,CAACN;IACzD;IAEA;;GAEC,GACDO,aAAaC,SAAiB,EAAER,QAAgB,EAAQ;QACtD,IAAI,CAACS,eAAe,CAACP,MAAM,CAACM,WAAWF,OAAO,CAACN;IACjD;IAEA;;GAEC,GACDU,oBAAoBC,SAAiB,EAAEC,IAAY,EAAQ;QACzD,IAAI,CAACC,eAAe,CAACX,MAAM,CAACS,WAAWC,MAAMR,GAAG;IAClD;IAEA;;GAEC,GACDU,6BAA6BC,UAAkB,EAAEH,IAAY,EAAQ;QACnE,IAAI,CAACI,wBAAwB,CAACd,MAAM,CAACa,YAAYH,MAAMR,GAAG;IAC5D;IAEA;;GAEC,GACDa,eAAeN,SAAiB,EAAEO,QAAgB,EAAQ;QACxD,IAAI,CAACC,UAAU,CAACjB,MAAM,CAACS,WAAWO,UAAUd,GAAG;IACjD;IAEA;;GAEC,GACDgB,yBAAyBT,SAAiB,EAAEU,MAA2B,EAAQ;QAC7E,IAAI,CAACC,oBAAoB,CAACpB,MAAM,CAACS,WAAWU,QAAQjB,GAAG;IACzD;IAEA;;GAEC,GACDmB,cAAcC,KAAa,EAAEH,MAA8B,EAAQ;QACjE,IAAI,CAACI,cAAc,CAACvB,MAAM,CAACsB,OAAOH,QAAQjB,GAAG;QAC7C,IAAIiB,WAAW,UAAU;YACvB,IAAI,CAACK,eAAe,CAACxB,MAAM,CAACsB,OAAOpB,GAAG;QACxC;IACF;IAEA;;GAEC,GACDuB,mBAAmBH,KAAa,EAAEI,KAAa,EAAQ;QACrD,IAAI,CAACC,eAAe,CAAC3B,MAAM,CAACsB,OAAOM,GAAG,CAACF;IACzC;IAEA;;GAEC,GACDG,0BAA0BC,WAAmB,EAAEC,GAAW,EAAQ;QAChE,IAAI,CAACC,mBAAmB,CAACJ,GAAG,CAACE;QAC7B,IAAI,CAACG,UAAU,CAACL,GAAG,CAACG;IACtB;IAEA;;GAEC,GACDG,uBAAuBC,IAAY,EAAEC,MAAc,EAAQ;QACzD,IAAI,CAACC,oBAAoB,CAACrC,MAAM,CAACmC,MAAMC,QAAQlC,GAAG;IACpD;IAEA;;GAEC,GACD,MAAMoC,aAA8B;QAClC,OAAO,IAAI,CAACC,QAAQ,CAACC,OAAO;IAC9B;IA5GA,YACE,eAAe;IAC6BzC,iBAAkC,EAC9E,AAAsDI,mBAAsC,EAE5F,mBAAmB;IAC+BI,eAAkC,EACpF,AAA8CkC,mBAAkC,EAEhF,mBAAmB;IAC4B9B,eAAgC,EAC/E,AAAyDG,wBAAyC,EAClG,AAA0CG,UAA2B,EACrE,AAAoDG,oBAAqC,EAEzF,gBAAgB;IACyBG,cAA+B,EACxE,AAA0CI,eAA8B,EACxE,AAAgDH,eAAgC,EAEhF,uBAAuB;IACsBQ,mBAAkC,EAC/E,AAAoDK,oBAAqC,EACzF,AAAoCJ,UAAyB,EAE7D,AAAiBM,QAAkB,CACnC;aAxB4CxC,oBAAAA;aACUI,sBAAAA;aAGJI,kBAAAA;aACJkC,sBAAAA;aAGC9B,kBAAAA;aACUG,2BAAAA;aACfG,aAAAA;aACUG,uBAAAA;aAGXG,iBAAAA;aACCI,kBAAAA;aACMH,kBAAAA;aAGHQ,sBAAAA;aACOK,uBAAAA;aAChBJ,aAAAA;aAEnBM,WAAAA;IAChB;AAmFL"}