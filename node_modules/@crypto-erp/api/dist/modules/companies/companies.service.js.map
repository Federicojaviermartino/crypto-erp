{"version":3,"sources":["../../../src/modules/companies/companies.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { PrismaService, UserRole } from '@crypto-erp/database';\nimport { CreateCompanyDto, UpdateCompanyDto } from './dto/index.js';\nimport {\n  SPANISH_PGC_ACCOUNTS,\n  DEFAULT_INVOICE_SERIES,\n  DEFAULT_CRYPTO_ASSETS,\n} from './data/pgc-accounts.js';\n\n@Injectable()\nexport class CompaniesService {\n  constructor(private prisma: PrismaService) {}\n\n  async create(userId: string, dto: CreateCompanyDto) {\n    return this.prisma.$transaction(async (tx) => {\n      // Create company\n      const company = await tx.company.create({\n        data: {\n          name: dto.name,\n          legalName: dto.legalName,\n          taxId: dto.taxId,\n          taxIdType: dto.taxIdType,\n          address: dto.address,\n          city: dto.city,\n          province: dto.province,\n          postalCode: dto.postalCode,\n          country: dto.country || 'ES',\n          phone: dto.phone,\n          email: dto.email,\n          website: dto.website,\n          fiscalYearStart: dto.fiscalYearStart || 1,\n        },\n      });\n\n      // Create CompanyUser with OWNER role\n      await tx.companyUser.create({\n        data: {\n          userId,\n          companyId: company.id,\n          role: UserRole.OWNER,\n          isDefault: true,\n        },\n      });\n\n      // Seed PGC accounts\n      await tx.account.createMany({\n        data: SPANISH_PGC_ACCOUNTS.map((acc) => ({\n          companyId: company.id,\n          code: acc.code,\n          name: acc.name,\n          type: acc.type,\n          parentCode: acc.parentCode,\n          isSystem: true,\n          isCrypto: acc.code.startsWith('305'),\n        })),\n      });\n\n      // Seed invoice series\n      await tx.invoiceSeries.createMany({\n        data: DEFAULT_INVOICE_SERIES.map((series) => ({\n          companyId: company.id,\n          code: series.code,\n          name: series.name,\n          type: series.type,\n          isDefault: series.isDefault,\n        })),\n      });\n\n      // Seed crypto assets\n      await tx.cryptoAsset.createMany({\n        data: DEFAULT_CRYPTO_ASSETS.map((asset) => ({\n          companyId: company.id,\n          symbol: asset.symbol,\n          name: asset.name,\n          decimals: asset.decimals,\n          coingeckoId: asset.coingeckoId,\n        })),\n      });\n\n      // Create current fiscal year\n      const currentYear = new Date().getFullYear();\n      const fiscalStart = dto.fiscalYearStart || 1;\n      await tx.fiscalYear.create({\n        data: {\n          companyId: company.id,\n          name: String(currentYear),\n          startDate: new Date(currentYear, fiscalStart - 1, 1),\n          endDate: new Date(currentYear + 1, fiscalStart - 1, 0),\n        },\n      });\n\n      return company;\n    });\n  }\n\n  async findAllByUser(userId: string) {\n    const companyUsers = await this.prisma.companyUser.findMany({\n      where: { userId },\n      include: {\n        company: {\n          select: {\n            id: true,\n            name: true,\n            legalName: true,\n            taxId: true,\n            city: true,\n            country: true,\n            createdAt: true,\n          },\n        },\n      },\n      orderBy: { company: { name: 'asc' } },\n    });\n\n    return companyUsers.map((cu) => ({\n      ...cu.company,\n      role: cu.role,\n      isDefault: cu.isDefault,\n    }));\n  }\n\n  async findById(companyId: string, userId: string) {\n    const companyUser = await this.prisma.companyUser.findUnique({\n      where: { userId_companyId: { userId, companyId } },\n      include: { company: true },\n    });\n\n    if (!companyUser) {\n      throw new NotFoundException('Company not found');\n    }\n\n    return { ...companyUser.company, role: companyUser.role };\n  }\n\n  async update(companyId: string, userId: string, dto: UpdateCompanyDto) {\n    const companyUser = await this.prisma.companyUser.findUnique({\n      where: { userId_companyId: { userId, companyId } },\n    });\n\n    if (!companyUser) {\n      throw new NotFoundException('Company not found');\n    }\n\n    if (\n      companyUser.role !== UserRole.OWNER &&\n      companyUser.role !== UserRole.ADMIN\n    ) {\n      throw new ForbiddenException('Only OWNER or ADMIN can update company');\n    }\n\n    return this.prisma.company.update({\n      where: { id: companyId },\n      data: dto,\n    });\n  }\n\n  async delete(companyId: string, userId: string) {\n    const companyUser = await this.prisma.companyUser.findUnique({\n      where: { userId_companyId: { userId, companyId } },\n    });\n\n    if (!companyUser) {\n      throw new NotFoundException('Company not found');\n    }\n\n    if (companyUser.role !== UserRole.OWNER) {\n      throw new ForbiddenException('Only OWNER can delete company');\n    }\n\n    // Soft delete\n    return this.prisma.company.update({\n      where: { id: companyId },\n      data: { deletedAt: new Date() },\n    });\n  }\n\n  async setDefault(companyId: string, userId: string) {\n    // Remove default from all user's companies\n    await this.prisma.companyUser.updateMany({\n      where: { userId },\n      data: { isDefault: false },\n    });\n\n    // Set new default\n    return this.prisma.companyUser.update({\n      where: { userId_companyId: { userId, companyId } },\n      data: { isDefault: true },\n    });\n  }\n}\n"],"names":["CompaniesService","create","userId","dto","prisma","$transaction","tx","company","data","name","legalName","taxId","taxIdType","address","city","province","postalCode","country","phone","email","website","fiscalYearStart","companyUser","companyId","id","role","UserRole","OWNER","isDefault","account","createMany","SPANISH_PGC_ACCOUNTS","map","acc","code","type","parentCode","isSystem","isCrypto","startsWith","invoiceSeries","DEFAULT_INVOICE_SERIES","series","cryptoAsset","DEFAULT_CRYPTO_ASSETS","asset","symbol","decimals","coingeckoId","currentYear","Date","getFullYear","fiscalStart","fiscalYear","String","startDate","endDate","findAllByUser","companyUsers","findMany","where","include","select","createdAt","orderBy","cu","findById","findUnique","userId_companyId","NotFoundException","update","ADMIN","ForbiddenException","delete","deletedAt","setDefault","updateMany"],"mappings":"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"}