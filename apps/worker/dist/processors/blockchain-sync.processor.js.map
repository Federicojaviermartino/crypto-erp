{"version":3,"sources":["../../src/processors/blockchain-sync.processor.ts"],"sourcesContent":["import { Processor, WorkerHost, OnWorkerEvent } from '@nestjs/bullmq';\nimport { Logger } from '@nestjs/common';\nimport { Job } from 'bullmq';\nimport { Cron, CronExpression } from '@nestjs/schedule';\nimport { InjectQueue } from '@nestjs/bullmq';\nimport { Queue } from 'bullmq';\nimport { PrismaService } from '@crypto-erp/database';\nimport { ConfigService } from '@nestjs/config';\nimport axios from 'axios';\nimport { Prisma } from '@prisma/client';\n\nconst QUEUE_NAME = 'blockchain-sync';\n\ninterface SyncJobData {\n  walletId: string;\n  companyId: string;\n  chain: string;\n  address: string;\n}\n\ninterface SyncResult {\n  walletId: string;\n  success: boolean;\n  transactionsProcessed: number;\n  newTransactions: number;\n  lastBlock?: string;\n  error?: string;\n}\n\n@Processor(QUEUE_NAME, {\n  concurrency: 2,\n})\nexport class BlockchainSyncProcessor extends WorkerHost {\n  private readonly logger = new Logger(BlockchainSyncProcessor.name);\n  private readonly covalentApiKey: string | undefined;\n  private readonly covalentBaseUrl = 'https://api.covalenthq.com/v1';\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly config: ConfigService,\n    @InjectQueue(QUEUE_NAME) private readonly syncQueue: Queue,\n  ) {\n    super();\n    this.covalentApiKey = this.config.get<string>('COVALENT_API_KEY');\n  }\n\n  @Cron(CronExpression.EVERY_10_MINUTES)\n  async scheduledSync() {\n    this.logger.log('Scheduled blockchain sync started');\n\n    try {\n      const wallets = await this.prisma.wallet.findMany({\n        where: { isActive: true },\n        select: {\n          id: true,\n          companyId: true,\n          chain: true,\n          address: true,\n        },\n      });\n\n      this.logger.log(`Found ${wallets.length} active wallets to sync`);\n\n      for (const wallet of wallets) {\n        await this.syncQueue.add(\n          'sync-wallet',\n          {\n            walletId: wallet.id,\n            companyId: wallet.companyId,\n            chain: wallet.chain,\n            address: wallet.address,\n          } as SyncJobData,\n          {\n            jobId: `sync-${wallet.id}-${Date.now()}`,\n            priority: 10,\n          },\n        );\n      }\n    } catch (error) {\n      this.logger.error('Failed to schedule wallet syncs', error);\n    }\n  }\n\n  async process(job: Job<SyncJobData>): Promise<SyncResult> {\n    const { walletId, chain, address } = job.data;\n\n    this.logger.log(`Processing sync for wallet ${walletId} (${chain}:${address.substring(0, 10)}...)`);\n\n    if (!this.covalentApiKey) {\n      this.logger.warn('Covalent API key not configured - skipping sync');\n      return {\n        walletId,\n        success: false,\n        transactionsProcessed: 0,\n        newTransactions: 0,\n        error: 'Covalent API key not configured',\n      };\n    }\n\n    try {\n      await this.prisma.wallet.update({\n        where: { id: walletId },\n        data: { syncStatus: 'SYNCING' },\n      });\n\n      const wallet = await this.prisma.wallet.findUnique({\n        where: { id: walletId },\n      });\n\n      const chainId = this.getChainId(chain);\n      const startBlock = wallet?.lastSyncBlock ? Number(wallet.lastSyncBlock) + 1 : undefined;\n\n      const transactions = await this.fetchTransactions(chainId, address, startBlock);\n\n      let newTransactions = 0;\n      let lastBlock: bigint | undefined;\n\n      for (const tx of transactions) {\n        const exists = await this.prisma.cryptoTransaction.findFirst({\n          where: { walletId, txHash: tx.tx_hash },\n        });\n\n        if (!exists) {\n          await this.createTransaction(walletId, tx, chain);\n          newTransactions++;\n        }\n\n        const blockNum = BigInt(tx.block_height);\n        if (!lastBlock || blockNum > lastBlock) {\n          lastBlock = blockNum;\n        }\n      }\n\n      await this.prisma.wallet.update({\n        where: { id: walletId },\n        data: {\n          syncStatus: 'SYNCED',\n          lastSyncAt: new Date(),\n          lastSyncBlock: lastBlock,\n          syncError: null,\n        },\n      });\n\n      this.logger.log(`Sync complete for wallet ${walletId}: ${newTransactions} new transactions`);\n\n      return {\n        walletId,\n        success: true,\n        transactionsProcessed: transactions.length,\n        newTransactions,\n        lastBlock: lastBlock?.toString(),\n      };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n\n      await this.prisma.wallet.update({\n        where: { id: walletId },\n        data: {\n          syncStatus: 'ERROR',\n          syncError: errorMessage,\n        },\n      });\n\n      this.logger.error(`Failed to sync wallet ${walletId}: ${errorMessage}`);\n\n      return {\n        walletId,\n        success: false,\n        transactionsProcessed: 0,\n        newTransactions: 0,\n        error: errorMessage,\n      };\n    }\n  }\n\n  private async fetchTransactions(\n    chainId: number,\n    address: string,\n    startBlock?: number,\n  ): Promise<any[]> {\n    const params: Record<string, any> = {\n      'page-size': 100,\n    };\n    if (startBlock) {\n      params['starting-block'] = startBlock;\n    }\n\n    const response = await axios.get(\n      `${this.covalentBaseUrl}/${chainId}/address/${address}/transactions_v3/`,\n      {\n        params,\n        auth: {\n          username: this.covalentApiKey!,\n          password: '',\n        },\n        timeout: 30000,\n      },\n    );\n\n    return response.data?.data?.items || [];\n  }\n\n  private async createTransaction(\n    walletId: string,\n    tx: any,\n    chain: string,\n  ): Promise<void> {\n    const isIncoming = tx.to_address?.toLowerCase() === tx.from_address?.toLowerCase();\n    const type = this.determineTransactionType(tx);\n\n    await this.prisma.cryptoTransaction.create({\n      data: {\n        walletId,\n        txHash: tx.tx_hash,\n        blockNumber: BigInt(tx.block_height),\n        blockTimestamp: new Date(tx.block_signed_at),\n        chain,\n        type,\n        assetIn: isIncoming ? 'ETH' : null,\n        amountIn: isIncoming && tx.value ? new Prisma.Decimal(tx.value).div(1e18) : null,\n        assetOut: !isIncoming ? 'ETH' : null,\n        amountOut: !isIncoming && tx.value ? new Prisma.Decimal(tx.value).div(1e18) : null,\n        feeAsset: 'ETH',\n        feeAmount: tx.gas_quote ? new Prisma.Decimal(tx.gas_spent).mul(tx.gas_price).div(1e18) : null,\n        feeEur: tx.gas_quote ? new Prisma.Decimal(tx.gas_quote.toString()) : null,\n        aiCategorized: true,\n        aiConfidence: new Prisma.Decimal('0.7'),\n        aiReasoning: `Auto-categorized by worker: ${type}`,\n        status: 'COMPLETED',\n        rawData: tx as unknown as Prisma.InputJsonValue,\n      },\n    });\n  }\n\n  private determineTransactionType(tx: any): 'SWAP' | 'TRANSFER_OUT' | 'CONTRACT_INTERACTION' | 'UNKNOWN' {\n    if (tx.log_events?.some((log: any) =>\n      log.decoded?.name === 'Swap' || log.decoded?.name === 'SwapExactTokensForTokens'\n    )) {\n      return 'SWAP';\n    }\n    if (tx.to_address && tx.from_address) {\n      return tx.value && tx.value !== '0' ? 'TRANSFER_OUT' : 'CONTRACT_INTERACTION';\n    }\n    return 'UNKNOWN';\n  }\n\n  private getChainId(chain: string): number {\n    const chainIds: Record<string, number> = {\n      ETHEREUM: 1,\n      POLYGON: 137,\n      ARBITRUM: 42161,\n      OPTIMISM: 10,\n      BASE: 8453,\n      AVALANCHE: 43114,\n      BSC: 56,\n    };\n    return chainIds[chain] || 1;\n  }\n\n  @OnWorkerEvent('completed')\n  onCompleted(job: Job<SyncJobData>) {\n    this.logger.debug(`Job ${job.id} completed for wallet ${job.data.walletId}`);\n  }\n\n  @OnWorkerEvent('failed')\n  onFailed(job: Job<SyncJobData>, error: Error) {\n    this.logger.error(`Job ${job.id} failed for wallet ${job.data.walletId}: ${error.message}`);\n  }\n}\n"],"names":["BlockchainSyncProcessor","QUEUE_NAME","WorkerHost","scheduledSync","logger","log","wallets","prisma","wallet","findMany","where","isActive","select","id","companyId","chain","address","length","syncQueue","add","walletId","jobId","Date","now","priority","error","process","job","data","substring","covalentApiKey","warn","success","transactionsProcessed","newTransactions","update","syncStatus","findUnique","chainId","getChainId","startBlock","lastSyncBlock","Number","undefined","transactions","fetchTransactions","lastBlock","tx","exists","cryptoTransaction","findFirst","txHash","tx_hash","createTransaction","blockNum","BigInt","block_height","lastSyncAt","syncError","toString","errorMessage","Error","message","params","response","axios","get","covalentBaseUrl","auth","username","password","timeout","items","isIncoming","to_address","toLowerCase","from_address","type","determineTransactionType","create","blockNumber","blockTimestamp","block_signed_at","assetIn","amountIn","value","Prisma","Decimal","div","assetOut","amountOut","feeAsset","feeAmount","gas_quote","gas_spent","mul","gas_price","feeEur","aiCategorized","aiConfidence","aiReasoning","status","rawData","log_events","some","decoded","name","chainIds","ETHEREUM","POLYGON","ARBITRUM","OPTIMISM","BASE","AVALANCHE","BSC","onCompleted","debug","onFailed","config","Logger","EVERY_10_MINUTES","concurrency"],"mappings":"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"}