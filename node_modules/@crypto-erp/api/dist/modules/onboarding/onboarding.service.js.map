{"version":3,"sources":["../../../src/modules/onboarding/onboarding.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@database/prisma/prisma.service.js';\nimport { UserOnboardingStatus } from '@prisma/client';\n\nexport interface OnboardingProgress {\n  userId: string;\n  status: UserOnboardingStatus;\n  currentStep: number;\n  completedSteps: string[];\n  skippedSteps: string[];\n  startedAt: Date;\n  completedAt?: Date;\n  lastActivityAt: Date;\n}\n\nexport interface OnboardingStep {\n  id: string;\n  title: string;\n  description: string;\n  order: number;\n  isCompleted: boolean;\n  isSkipped: boolean;\n  path?: string;\n  action?: string;\n}\n\n@Injectable()\nexport class OnboardingService {\n  constructor(private prisma: PrismaService) {}\n\n  private readonly ONBOARDING_STEPS: Omit<OnboardingStep, 'isCompleted' | 'isSkipped'>[] = [\n    {\n      id: 'complete-profile',\n      title: 'Completa tu perfil',\n      description: 'Añade tu información personal y configura tu cuenta',\n      order: 1,\n      path: '/settings/profile',\n      action: 'Completar perfil',\n    },\n    {\n      id: 'create-company',\n      title: 'Crea tu empresa',\n      description: 'Registra tu empresa y configura los datos fiscales',\n      order: 2,\n      path: '/settings/company',\n      action: 'Crear empresa',\n    },\n    {\n      id: 'configure-accounting',\n      title: 'Configura el plan contable',\n      description: 'Selecciona o personaliza tu plan de cuentas contables',\n      order: 3,\n      path: '/accounting/chart-of-accounts',\n      action: 'Configurar plan',\n    },\n    {\n      id: 'create-first-invoice',\n      title: 'Emite tu primera factura',\n      description: 'Crea una factura con cumplimiento Verifactu automático',\n      order: 4,\n      path: '/invoicing/invoices/new',\n      action: 'Crear factura',\n    },\n    {\n      id: 'add-crypto-wallet',\n      title: 'Añade una wallet crypto',\n      description: 'Registra tu primera wallet para tracking de activos',\n      order: 5,\n      path: '/crypto/wallets/new',\n      action: 'Añadir wallet',\n    },\n    {\n      id: 'explore-ai-chat',\n      title: 'Prueba el asistente AI',\n      description: 'Haz tu primera pregunta al asistente de contabilidad',\n      order: 6,\n      path: '/ai/chat',\n      action: 'Abrir chat',\n    },\n  ];\n\n  async getOnboardingProgress(userId: string): Promise<OnboardingProgress> {\n    let progress = await this.prisma.userOnboarding.findUnique({\n      where: { userId },\n    });\n\n    if (!progress) {\n      // Create initial onboarding record\n      progress = await this.prisma.userOnboarding.create({\n        data: {\n          userId,\n          status: UserOnboardingStatus.IN_PROGRESS,\n          currentStep: 1,\n          completedSteps: [],\n          skippedSteps: [],\n        },\n      });\n    }\n\n    return {\n      userId: progress.userId,\n      status: progress.status,\n      currentStep: progress.currentStep,\n      completedSteps: progress.completedSteps as string[],\n      skippedSteps: progress.skippedSteps as string[],\n      startedAt: progress.startedAt,\n      completedAt: progress.completedAt,\n      lastActivityAt: progress.lastActivityAt,\n    };\n  }\n\n  async getOnboardingSteps(userId: string): Promise<OnboardingStep[]> {\n    const progress = await this.getOnboardingProgress(userId);\n\n    return this.ONBOARDING_STEPS.map(step => ({\n      ...step,\n      isCompleted: progress.completedSteps.includes(step.id),\n      isSkipped: progress.skippedSteps.includes(step.id),\n    }));\n  }\n\n  async completeStep(userId: string, stepId: string): Promise<OnboardingProgress> {\n    const progress = await this.getOnboardingProgress(userId);\n\n    // Check if step exists\n    const step = this.ONBOARDING_STEPS.find(s => s.id === stepId);\n    if (!step) {\n      throw new NotFoundException(`Onboarding step '${stepId}' not found`);\n    }\n\n    // Don't add if already completed\n    if (progress.completedSteps.includes(stepId)) {\n      return progress;\n    }\n\n    // Remove from skipped if it was there\n    const skippedSteps = progress.skippedSteps.filter(id => id !== stepId);\n\n    // Add to completed\n    const completedSteps = [...progress.completedSteps, stepId];\n\n    // Calculate progress\n    const totalSteps = this.ONBOARDING_STEPS.length;\n    const completedCount = completedSteps.length;\n    const isFullyCompleted = completedCount >= totalSteps;\n\n    // Update next step\n    const nextStep = isFullyCompleted ? totalSteps : Math.max(progress.currentStep, step.order + 1);\n\n    const updated = await this.prisma.userOnboarding.update({\n      where: { userId },\n      data: {\n        completedSteps,\n        skippedSteps,\n        currentStep: nextStep,\n        status: isFullyCompleted ? UserOnboardingStatus.COMPLETED : UserOnboardingStatus.IN_PROGRESS,\n        completedAt: isFullyCompleted ? new Date() : null,\n        lastActivityAt: new Date(),\n      },\n    });\n\n    return {\n      userId: updated.userId,\n      status: updated.status,\n      currentStep: updated.currentStep,\n      completedSteps: updated.completedSteps as string[],\n      skippedSteps: updated.skippedSteps as string[],\n      startedAt: updated.startedAt,\n      completedAt: updated.completedAt,\n      lastActivityAt: updated.lastActivityAt,\n    };\n  }\n\n  async skipStep(userId: string, stepId: string): Promise<OnboardingProgress> {\n    const progress = await this.getOnboardingProgress(userId);\n\n    // Check if step exists\n    const step = this.ONBOARDING_STEPS.find(s => s.id === stepId);\n    if (!step) {\n      throw new NotFoundException(`Onboarding step '${stepId}' not found`);\n    }\n\n    // Don't add if already skipped or completed\n    if (progress.skippedSteps.includes(stepId) || progress.completedSteps.includes(stepId)) {\n      return progress;\n    }\n\n    // Add to skipped\n    const skippedSteps = [...progress.skippedSteps, stepId];\n\n    // Update next step\n    const nextStep = Math.max(progress.currentStep, step.order + 1);\n\n    const updated = await this.prisma.userOnboarding.update({\n      where: { userId },\n      data: {\n        skippedSteps,\n        currentStep: nextStep,\n        lastActivityAt: new Date(),\n      },\n    });\n\n    return {\n      userId: updated.userId,\n      status: updated.status,\n      currentStep: updated.currentStep,\n      completedSteps: updated.completedSteps as string[],\n      skippedSteps: updated.skippedSteps as string[],\n      startedAt: updated.startedAt,\n      completedAt: updated.completedAt,\n      lastActivityAt: updated.lastActivityAt,\n    };\n  }\n\n  async dismissOnboarding(userId: string): Promise<void> {\n    await this.prisma.userOnboarding.update({\n      where: { userId },\n      data: {\n        status: UserOnboardingStatus.DISMISSED,\n        lastActivityAt: new Date(),\n      },\n    });\n  }\n\n  async restartOnboarding(userId: string): Promise<OnboardingProgress> {\n    const updated = await this.prisma.userOnboarding.update({\n      where: { userId },\n      data: {\n        status: UserOnboardingStatus.IN_PROGRESS,\n        currentStep: 1,\n        completedSteps: [],\n        skippedSteps: [],\n        completedAt: null,\n        lastActivityAt: new Date(),\n      },\n    });\n\n    return {\n      userId: updated.userId,\n      status: updated.status,\n      currentStep: updated.currentStep,\n      completedSteps: updated.completedSteps as string[],\n      skippedSteps: updated.skippedSteps as string[],\n      startedAt: updated.startedAt,\n      completedAt: updated.completedAt,\n      lastActivityAt: updated.lastActivityAt,\n    };\n  }\n\n  async getOnboardingStats(): Promise<{\n    total: number;\n    inProgress: number;\n    completed: number;\n    dismissed: number;\n    notStarted: number;\n  }> {\n    const [total, inProgress, completed, dismissed] = await Promise.all([\n      this.prisma.user.count(),\n      this.prisma.userOnboarding.count({\n        where: { status: UserOnboardingStatus.IN_PROGRESS },\n      }),\n      this.prisma.userOnboarding.count({\n        where: { status: UserOnboardingStatus.COMPLETED },\n      }),\n      this.prisma.userOnboarding.count({\n        where: { status: UserOnboardingStatus.DISMISSED },\n      }),\n    ]);\n\n    const notStarted = total - (inProgress + completed + dismissed);\n\n    return {\n      total,\n      inProgress,\n      completed,\n      dismissed,\n      notStarted,\n    };\n  }\n}\n"],"names":["OnboardingService","getOnboardingProgress","userId","progress","prisma","userOnboarding","findUnique","where","create","data","status","UserOnboardingStatus","IN_PROGRESS","currentStep","completedSteps","skippedSteps","startedAt","completedAt","lastActivityAt","getOnboardingSteps","ONBOARDING_STEPS","map","step","isCompleted","includes","id","isSkipped","completeStep","stepId","find","s","NotFoundException","filter","totalSteps","length","completedCount","isFullyCompleted","nextStep","Math","max","order","updated","update","COMPLETED","Date","skipStep","dismissOnboarding","DISMISSED","restartOnboarding","getOnboardingStats","total","inProgress","completed","dismissed","Promise","all","user","count","notStarted","title","description","path","action"],"mappings":"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"}