{"version":3,"sources":["../../../src/modules/audit/audit.interceptor.ts"],"sourcesContent":["import {\n  Injectable,\n  NestInterceptor,\n  ExecutionContext,\n  CallHandler,\n  Logger,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { AuditService } from './audit.service';\nimport { AuditAction } from '@prisma/client';\nimport { AUDITABLE_KEY } from './decorators/auditable.decorator';\n\n@Injectable()\nexport class AuditInterceptor implements NestInterceptor {\n  private readonly logger = new Logger(AuditInterceptor.name);\n\n  constructor(\n    private reflector: Reflector,\n    private audit: AuditService,\n  ) {}\n\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    const entity = this.reflector.get<string>(AUDITABLE_KEY, context.getHandler());\n\n    if (!entity) {\n      // No @Auditable decorator, skip audit logging\n      return next.handle();\n    }\n\n    const request = context.switchToHttp().getRequest();\n    const { user, body, method, ip, headers } = request;\n\n    // If no user (unauthenticated request), skip\n    if (!user) {\n      return next.handle();\n    }\n\n    return next.handle().pipe(\n      tap({\n        next: async (result) => {\n          try {\n            const action = this.getActionFromMethod(method);\n            const entityId = this.extractEntityId(result, body, request);\n\n            if (action && entityId) {\n              await this.audit.log({\n                userId: user.id,\n                companyId: request.companyId || user.defaultCompanyId,\n                action,\n                entity,\n                entityId,\n                changes: this.getChanges(method, body, result),\n                metadata: {\n                  ip,\n                  userAgent: headers['user-agent'],\n                  method,\n                  path: request.url,\n                },\n              });\n            }\n          } catch (error) {\n            this.logger.error('Failed to create audit log:', error);\n            // Don't throw - audit should not break the main flow\n          }\n        },\n        error: (error) => {\n          // Could log failed operations here if needed\n          this.logger.warn(`Operation failed, not logging audit: ${error.message}`);\n        },\n      }),\n    );\n  }\n\n  /**\n   * Map HTTP method to audit action\n   */\n  private getActionFromMethod(method: string): AuditAction | null {\n    const mapping: Record<string, AuditAction> = {\n      POST: AuditAction.CREATE,\n      PATCH: AuditAction.UPDATE,\n      PUT: AuditAction.UPDATE,\n      DELETE: AuditAction.DELETE,\n      GET: AuditAction.VIEW,\n    };\n\n    return mapping[method] || null;\n  }\n\n  /**\n   * Extract entity ID from response or request\n   */\n  private extractEntityId(result: any, body: any, request: any): string | null {\n    // Try to get ID from response\n    if (result?.id) {\n      return result.id;\n    }\n\n    // Try to get ID from request body\n    if (body?.id) {\n      return body.id;\n    }\n\n    // Try to get ID from URL params\n    if (request.params?.id) {\n      return request.params.id;\n    }\n\n    return null;\n  }\n\n  /**\n   * Get changes for UPDATE operations\n   */\n  private getChanges(method: string, body: any, result: any): any | null {\n    if (method === 'PATCH' || method === 'PUT') {\n      return {\n        updated: body,\n        // Could include before/after comparison here if available\n      };\n    }\n\n    if (method === 'DELETE') {\n      return {\n        deleted: true,\n      };\n    }\n\n    return null;\n  }\n}\n"],"names":["AuditInterceptor","intercept","context","next","entity","reflector","get","AUDITABLE_KEY","getHandler","handle","request","switchToHttp","getRequest","user","body","method","ip","headers","pipe","tap","result","action","getActionFromMethod","entityId","extractEntityId","audit","log","userId","id","companyId","defaultCompanyId","changes","getChanges","metadata","userAgent","path","url","error","logger","warn","message","mapping","POST","AuditAction","CREATE","PATCH","UPDATE","PUT","DELETE","GET","VIEW","params","updated","deleted","Logger","name"],"mappings":"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"}