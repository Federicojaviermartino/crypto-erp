{"version":3,"sources":["../../../../src/modules/accounting/services/reports.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\n\nexport interface AccountBalance {\n  accountId: string;\n  accountCode: string;\n  accountName: string;\n  accountType: string;\n  debit: number;\n  credit: number;\n  balance: number;\n}\n\nexport interface TrialBalanceReport {\n  accounts: AccountBalance[];\n  totals: {\n    totalDebits: number;\n    totalCredits: number;\n    isBalanced: boolean;\n  };\n  generatedAt: Date;\n  period: {\n    startDate: Date | null;\n    endDate: Date | null;\n    fiscalYearId: string | null;\n  };\n}\n\nexport interface BalanceSheetReport {\n  assets: {\n    accounts: AccountBalance[];\n    total: number;\n  };\n  liabilities: {\n    accounts: AccountBalance[];\n    total: number;\n  };\n  equity: {\n    accounts: AccountBalance[];\n    total: number;\n  };\n  totalLiabilitiesAndEquity: number;\n  isBalanced: boolean;\n  generatedAt: Date;\n  asOfDate: Date;\n}\n\nexport interface IncomeStatementReport {\n  income: {\n    accounts: AccountBalance[];\n    total: number;\n  };\n  expenses: {\n    accounts: AccountBalance[];\n    total: number;\n  };\n  netIncome: number;\n  generatedAt: Date;\n  period: {\n    startDate: Date;\n    endDate: Date;\n  };\n}\n\nexport interface GeneralLedgerEntry {\n  date: Date;\n  entryNumber: number;\n  description: string | null;\n  reference: string | null;\n  debit: number;\n  credit: number;\n  runningBalance: number;\n}\n\nexport interface GeneralLedgerReport {\n  account: {\n    id: string;\n    code: string;\n    name: string;\n    type: string;\n  };\n  entries: GeneralLedgerEntry[];\n  openingBalance: number;\n  closingBalance: number;\n  totalDebits: number;\n  totalCredits: number;\n  generatedAt: Date;\n  period: {\n    startDate: Date | null;\n    endDate: Date | null;\n  };\n}\n\n@Injectable()\nexport class ReportsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async getTrialBalance(\n    companyId: string,\n    options: {\n      fiscalYearId?: string;\n      startDate?: Date;\n      endDate?: Date;\n    } = {},\n  ): Promise<TrialBalanceReport> {\n    // Get all accounts with posted journal entry lines\n    const accounts = await this.prisma.account.findMany({\n      where: { companyId, isActive: true },\n      orderBy: { code: 'asc' },\n    });\n\n    const balances: AccountBalance[] = [];\n\n    for (const account of accounts) {\n      const whereClause: Parameters<typeof this.prisma.journalLine.aggregate>[0]['where'] = {\n        accountId: account.id,\n        journalEntry: {\n          companyId,\n          status: 'POSTED',\n          ...(options.fiscalYearId && { fiscalYearId: options.fiscalYearId }),\n          ...(options.startDate && { date: { gte: options.startDate } }),\n          ...(options.endDate && { date: { lte: options.endDate } }),\n        },\n      };\n\n      const result = await this.prisma.journalLine.aggregate({\n        where: whereClause,\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      });\n\n      const debit = result._sum.debit?.toNumber() || 0;\n      const credit = result._sum.credit?.toNumber() || 0;\n\n      // Only include accounts with activity\n      if (debit !== 0 || credit !== 0) {\n        const isDebitNormal = ['ASSET', 'EXPENSE'].includes(account.type);\n        const balance = isDebitNormal ? debit - credit : credit - debit;\n\n        balances.push({\n          accountId: account.id,\n          accountCode: account.code,\n          accountName: account.name,\n          accountType: account.type,\n          debit,\n          credit,\n          balance,\n        });\n      }\n    }\n\n    const totalDebits = balances.reduce((sum, b) => sum + b.debit, 0);\n    const totalCredits = balances.reduce((sum, b) => sum + b.credit, 0);\n\n    return {\n      accounts: balances,\n      totals: {\n        totalDebits,\n        totalCredits,\n        isBalanced: Math.abs(totalDebits - totalCredits) < 0.01,\n      },\n      generatedAt: new Date(),\n      period: {\n        startDate: options.startDate || null,\n        endDate: options.endDate || null,\n        fiscalYearId: options.fiscalYearId || null,\n      },\n    };\n  }\n\n  async getBalanceSheet(\n    companyId: string,\n    asOfDate: Date = new Date(),\n  ): Promise<BalanceSheetReport> {\n    const accounts = await this.prisma.account.findMany({\n      where: {\n        companyId,\n        isActive: true,\n        type: { in: ['ASSET', 'LIABILITY', 'EQUITY'] },\n      },\n      orderBy: { code: 'asc' },\n    });\n\n    const balances: AccountBalance[] = [];\n\n    for (const account of accounts) {\n      const result = await this.prisma.journalLine.aggregate({\n        where: {\n          accountId: account.id,\n          journalEntry: {\n            companyId,\n            status: 'POSTED',\n            date: { lte: asOfDate },\n          },\n        },\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      });\n\n      const debit = result._sum.debit?.toNumber() || 0;\n      const credit = result._sum.credit?.toNumber() || 0;\n\n      if (debit !== 0 || credit !== 0) {\n        const isDebitNormal = account.type === 'ASSET';\n        const balance = isDebitNormal ? debit - credit : credit - debit;\n\n        balances.push({\n          accountId: account.id,\n          accountCode: account.code,\n          accountName: account.name,\n          accountType: account.type,\n          debit,\n          credit,\n          balance,\n        });\n      }\n    }\n\n    // Calculate retained earnings (net income for all time)\n    const retainedEarnings = await this.calculateRetainedEarnings(companyId, asOfDate);\n\n    const assets = balances.filter((b) => b.accountType === 'ASSET');\n    const liabilities = balances.filter((b) => b.accountType === 'LIABILITY');\n    const equity = balances.filter((b) => b.accountType === 'EQUITY');\n\n    // Add retained earnings to equity\n    if (retainedEarnings !== 0) {\n      equity.push({\n        accountId: 'retained-earnings',\n        accountCode: '129',\n        accountName: 'Retained Earnings (Calculated)',\n        accountType: 'EQUITY',\n        debit: retainedEarnings < 0 ? Math.abs(retainedEarnings) : 0,\n        credit: retainedEarnings > 0 ? retainedEarnings : 0,\n        balance: retainedEarnings,\n      });\n    }\n\n    const totalAssets = assets.reduce((sum, b) => sum + b.balance, 0);\n    const totalLiabilities = liabilities.reduce((sum, b) => sum + b.balance, 0);\n    const totalEquity = equity.reduce((sum, b) => sum + b.balance, 0);\n\n    return {\n      assets: { accounts: assets, total: totalAssets },\n      liabilities: { accounts: liabilities, total: totalLiabilities },\n      equity: { accounts: equity, total: totalEquity },\n      totalLiabilitiesAndEquity: totalLiabilities + totalEquity,\n      isBalanced: Math.abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01,\n      generatedAt: new Date(),\n      asOfDate,\n    };\n  }\n\n  async getIncomeStatement(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n  ): Promise<IncomeStatementReport> {\n    const accounts = await this.prisma.account.findMany({\n      where: {\n        companyId,\n        isActive: true,\n        type: { in: ['INCOME', 'EXPENSE'] },\n      },\n      orderBy: { code: 'asc' },\n    });\n\n    const balances: AccountBalance[] = [];\n\n    for (const account of accounts) {\n      const result = await this.prisma.journalLine.aggregate({\n        where: {\n          accountId: account.id,\n          journalEntry: {\n            companyId,\n            status: 'POSTED',\n            date: { gte: startDate, lte: endDate },\n          },\n        },\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      });\n\n      const debit = result._sum.debit?.toNumber() || 0;\n      const credit = result._sum.credit?.toNumber() || 0;\n\n      if (debit !== 0 || credit !== 0) {\n        // Income accounts: credit increases\n        // Expense accounts: debit increases\n        const isDebitNormal = account.type === 'EXPENSE';\n        const balance = isDebitNormal ? debit - credit : credit - debit;\n\n        balances.push({\n          accountId: account.id,\n          accountCode: account.code,\n          accountName: account.name,\n          accountType: account.type,\n          debit,\n          credit,\n          balance,\n        });\n      }\n    }\n\n    const income = balances.filter((b) => b.accountType === 'INCOME');\n    const expenses = balances.filter((b) => b.accountType === 'EXPENSE');\n\n    const totalIncome = income.reduce((sum, b) => sum + b.balance, 0);\n    const totalExpenses = expenses.reduce((sum, b) => sum + b.balance, 0);\n\n    return {\n      income: { accounts: income, total: totalIncome },\n      expenses: { accounts: expenses, total: totalExpenses },\n      netIncome: totalIncome - totalExpenses,\n      generatedAt: new Date(),\n      period: { startDate, endDate },\n    };\n  }\n\n  async getGeneralLedger(\n    companyId: string,\n    accountId: string,\n    options: {\n      startDate?: Date;\n      endDate?: Date;\n    } = {},\n  ): Promise<GeneralLedgerReport> {\n    const account = await this.prisma.account.findFirst({\n      where: { id: accountId, companyId },\n    });\n\n    if (!account) {\n      throw new Error('Account not found');\n    }\n\n    // Get opening balance (all entries before start date)\n    let openingBalance = 0;\n    if (options.startDate) {\n      const openingResult = await this.prisma.journalLine.aggregate({\n        where: {\n          accountId,\n          journalEntry: {\n            companyId,\n            status: 'POSTED',\n            date: { lt: options.startDate },\n          },\n        },\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      });\n\n      const openingDebit = openingResult._sum.debit?.toNumber() || 0;\n      const openingCredit = openingResult._sum.credit?.toNumber() || 0;\n      const isDebitNormal = ['ASSET', 'EXPENSE'].includes(account.type);\n      openingBalance = isDebitNormal ? openingDebit - openingCredit : openingCredit - openingDebit;\n    }\n\n    // Get entries for the period\n    const lines = await this.prisma.journalLine.findMany({\n      where: {\n        accountId,\n        journalEntry: {\n          companyId,\n          status: 'POSTED',\n          ...(options.startDate && { date: { gte: options.startDate } }),\n          ...(options.endDate && { date: { lte: options.endDate } }),\n        },\n      },\n      include: {\n        journalEntry: {\n          select: {\n            date: true,\n            number: true,\n            description: true,\n            reference: true,\n          },\n        },\n      },\n      orderBy: [\n        { journalEntry: { date: 'asc' } },\n        { journalEntry: { number: 'asc' } },\n      ],\n    });\n\n    const isDebitNormal = ['ASSET', 'EXPENSE'].includes(account.type);\n    let runningBalance = openingBalance;\n\n    const entries: GeneralLedgerEntry[] = lines.map((line) => {\n      const debit = line.debit.toNumber();\n      const credit = line.credit.toNumber();\n      runningBalance += isDebitNormal ? debit - credit : credit - debit;\n\n      return {\n        date: line.journalEntry!.date,\n        entryNumber: line.journalEntry!.number,\n        description: line.journalEntry!.description,\n        reference: line.journalEntry!.reference,\n        debit,\n        credit,\n        runningBalance,\n      };\n    });\n\n    const totalDebits = entries.reduce((sum, e) => sum + e.debit, 0);\n    const totalCredits = entries.reduce((sum, e) => sum + e.credit, 0);\n\n    return {\n      account: {\n        id: account.id,\n        code: account.code,\n        name: account.name,\n        type: account.type,\n      },\n      entries,\n      openingBalance,\n      closingBalance: runningBalance,\n      totalDebits,\n      totalCredits,\n      generatedAt: new Date(),\n      period: {\n        startDate: options.startDate || null,\n        endDate: options.endDate || null,\n      },\n    };\n  }\n\n  private async calculateRetainedEarnings(\n    companyId: string,\n    asOfDate: Date,\n  ): Promise<number> {\n    // Get all income and expense accounts\n    const accounts = await this.prisma.account.findMany({\n      where: {\n        companyId,\n        type: { in: ['INCOME', 'EXPENSE'] },\n      },\n    });\n\n    let totalIncome = 0;\n    let totalExpenses = 0;\n\n    for (const account of accounts) {\n      const result = await this.prisma.journalLine.aggregate({\n        where: {\n          accountId: account.id,\n          journalEntry: {\n            companyId,\n            status: 'POSTED',\n            date: { lte: asOfDate },\n          },\n        },\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      });\n\n      const debit = result._sum.debit?.toNumber() || 0;\n      const credit = result._sum.credit?.toNumber() || 0;\n\n      if (account.type === 'INCOME') {\n        totalIncome += credit - debit;\n      } else {\n        totalExpenses += debit - credit;\n      }\n    }\n\n    return totalIncome - totalExpenses;\n  }\n}\n"],"names":["ReportsService","getTrialBalance","companyId","options","accounts","prisma","account","findMany","where","isActive","orderBy","code","balances","whereClause","accountId","id","journalEntry","status","fiscalYearId","startDate","date","gte","endDate","lte","result","journalLine","aggregate","_sum","debit","credit","toNumber","isDebitNormal","includes","type","balance","push","accountCode","accountName","name","accountType","totalDebits","reduce","sum","b","totalCredits","totals","isBalanced","Math","abs","generatedAt","Date","period","getBalanceSheet","asOfDate","in","retainedEarnings","calculateRetainedEarnings","assets","filter","liabilities","equity","totalAssets","totalLiabilities","totalEquity","total","totalLiabilitiesAndEquity","getIncomeStatement","income","expenses","totalIncome","totalExpenses","netIncome","getGeneralLedger","findFirst","Error","openingBalance","openingResult","lt","openingDebit","openingCredit","lines","include","select","number","description","reference","runningBalance","entries","map","line","entryNumber","e","closingBalance"],"mappings":"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"}