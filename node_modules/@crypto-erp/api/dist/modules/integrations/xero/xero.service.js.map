{"version":3,"sources":["../../../../src/modules/integrations/xero/xero.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { IntegrationProvider, SyncResult, PushResult } from '../base/integration.interface.js';\nimport { BaseIntegrationService } from '../base/base-integration.service.js';\nimport axios from 'axios';\n\n/**\n * Xero Accounting Integration\n *\n * Provides bi-directional sync with Xero:\n * - Sync invoices, contacts, and payments\n * - Push invoices from Crypto ERP to Xero\n * - Real-time webhooks support\n *\n * OAuth 2.0 with PKCE Flow\n */\n@Injectable()\nexport class XeroService implements IntegrationProvider {\n  readonly provider = 'xero';\n  private readonly logger = new Logger(XeroService.name);\n\n  private readonly authUrl = 'https://login.xero.com/identity/connect/authorize';\n  private readonly tokenUrl = 'https://identity.xero.com/connect/token';\n  private readonly apiBaseUrl = 'https://api.xero.com/api.xro/2.0';\n  private readonly connectionsUrl = 'https://api.xero.com/connections';\n\n  private readonly clientId: string;\n  private readonly clientSecret: string;\n  private readonly scopes = [\n    'offline_access',\n    'accounting.transactions',\n    'accounting.contacts',\n    'accounting.settings.read',\n  ];\n\n  constructor(\n    private readonly baseService: BaseIntegrationService,\n    private readonly config: ConfigService,\n  ) {\n    this.clientId = this.config.get<string>('XERO_CLIENT_ID') || '';\n    this.clientSecret = this.config.get<string>('XERO_CLIENT_SECRET') || '';\n  }\n\n  /**\n   * Get Xero OAuth authorization URL\n   */\n  getAuthorizationUrl(companyId: string, redirectUri: string, state: string): string {\n    const params = new URLSearchParams({\n      response_type: 'code',\n      client_id: this.clientId,\n      redirect_uri: redirectUri,\n      scope: this.scopes.join(' '),\n      state,\n    });\n\n    return `${this.authUrl}?${params.toString()}`;\n  }\n\n  /**\n   * Exchange authorization code for access token\n   */\n  async exchangeCodeForToken(code: string, redirectUri: string) {\n    const auth = Buffer.from(`${this.clientId}:${this.clientSecret}`).toString('base64');\n\n    const response = await axios.post(\n      this.tokenUrl,\n      new URLSearchParams({\n        grant_type: 'authorization_code',\n        code,\n        redirect_uri: redirectUri,\n      }),\n      {\n        headers: {\n          Authorization: `Basic ${auth}`,\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n      },\n    );\n\n    // Get tenant connections\n    const connections = await axios.get(this.connectionsUrl, {\n      headers: {\n        Authorization: `Bearer ${response.data.access_token}`,\n        'Content-Type': 'application/json',\n      },\n    });\n\n    const tenantId = connections.data[0]?.tenantId;\n\n    return {\n      accessToken: response.data.access_token,\n      refreshToken: response.data.refresh_token,\n      expiresIn: response.data.expires_in, // 1800 seconds (30 minutes)\n      metadata: {\n        tenantId,\n        tenantName: connections.data[0]?.tenantName,\n      },\n    };\n  }\n\n  /**\n   * Refresh access token\n   */\n  async refreshAccessToken(refreshToken: string) {\n    const auth = Buffer.from(`${this.clientId}:${this.clientSecret}`).toString('base64');\n\n    const response = await axios.post(\n      this.tokenUrl,\n      new URLSearchParams({\n        grant_type: 'refresh_token',\n        refresh_token: refreshToken,\n      }),\n      {\n        headers: {\n          Authorization: `Basic ${auth}`,\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n      },\n    );\n\n    return {\n      accessToken: response.data.access_token,\n      refreshToken: response.data.refresh_token,\n      expiresIn: response.data.expires_in,\n    };\n  }\n\n  /**\n   * Test connection by fetching organization info\n   */\n  async testConnection(accessToken: string): Promise<boolean> {\n    try {\n      const integration = await this.baseService.getIntegration('', this.provider);\n      if (!integration?.metadata?.['tenantId']) {\n        return false;\n      }\n\n      const tenantId = integration.metadata['tenantId'] as string;\n\n      await axios.get(`${this.apiBaseUrl}/Organisation`, {\n        headers: {\n          Authorization: `Bearer ${accessToken}`,\n          'xero-tenant-id': tenantId,\n          Accept: 'application/json',\n        },\n      });\n\n      return true;\n    } catch (error) {\n      this.logger.error('Xero connection test failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Sync invoices from Xero to Crypto ERP\n   */\n  async syncData(integrationId: string, accessToken: string): Promise<SyncResult> {\n    try {\n      const integration = await this.baseService.prisma.integration.findUnique({\n        where: { id: integrationId },\n      });\n\n      if (!integration?.metadata?.['tenantId']) {\n        throw new Error('Xero tenant ID not found');\n      }\n\n      const tenantId = integration.metadata['tenantId'] as string;\n\n      // Fetch invoices from Xero\n      const response = await axios.get(\n        `${this.apiBaseUrl}/Invoices?where=Date>DateTime(2025,1,1)`,\n        {\n          headers: {\n            Authorization: `Bearer ${accessToken}`,\n            'xero-tenant-id': tenantId,\n            Accept: 'application/json',\n          },\n        },\n      );\n\n      const invoices = response.data.Invoices || [];\n      let syncedCount = 0;\n      const errors: Array<{ item: string; error: string }> = [];\n\n      for (const xeroInvoice of invoices) {\n        try {\n          await this.syncInvoice(integration.companyId, xeroInvoice);\n          syncedCount++;\n        } catch (error: any) {\n          errors.push({\n            item: `Invoice ${xeroInvoice.InvoiceNumber}`,\n            error: error.message,\n          });\n        }\n      }\n\n      await this.baseService.updateSyncStatus(\n        integrationId,\n        errors.length === 0 ? 'success' : 'partial',\n        errors.length > 0 ? JSON.stringify(errors) : undefined,\n      );\n\n      return {\n        success: true,\n        itemsSynced: syncedCount,\n        errors: errors.length > 0 ? errors : undefined,\n      };\n    } catch (error: any) {\n      this.logger.error('Xero sync failed:', error);\n\n      await this.baseService.updateSyncStatus(\n        integrationId,\n        'error',\n        error.message,\n      );\n\n      return {\n        success: false,\n        itemsSynced: 0,\n        errors: [{ item: 'Sync', error: error.message }],\n      };\n    }\n  }\n\n  /**\n   * Push invoice from Crypto ERP to Xero\n   */\n  async pushData(integrationId: string, accessToken: string, data: any): Promise<PushResult> {\n    try {\n      const integration = await this.baseService.prisma.integration.findUnique({\n        where: { id: integrationId },\n      });\n\n      if (!integration?.metadata?.['tenantId']) {\n        throw new Error('Xero tenant ID not found');\n      }\n\n      const tenantId = integration.metadata['tenantId'] as string;\n\n      // Convert Crypto ERP invoice to Xero format\n      const xeroInvoice = this.mapToXeroInvoice(data);\n\n      // Create or update invoice in Xero\n      const response = await axios.post(\n        `${this.apiBaseUrl}/Invoices`,\n        { Invoices: [xeroInvoice] },\n        {\n          headers: {\n            Authorization: `Bearer ${accessToken}`,\n            'xero-tenant-id': tenantId,\n            'Content-Type': 'application/json',\n            Accept: 'application/json',\n          },\n        },\n      );\n\n      return {\n        success: true,\n        externalId: response.data.Invoices[0].InvoiceID,\n        metadata: {\n          invoiceNumber: response.data.Invoices[0].InvoiceNumber,\n          status: response.data.Invoices[0].Status,\n        },\n      };\n    } catch (error: any) {\n      this.logger.error('Xero push failed:', error);\n\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  /**\n   * Sync single invoice from Xero to Crypto ERP\n   */\n  private async syncInvoice(companyId: string, xeroInvoice: any) {\n    this.logger.log(`Would sync invoice ${xeroInvoice.InvoiceNumber} to Crypto ERP`);\n  }\n\n  /**\n   * Map Crypto ERP invoice to Xero format\n   */\n  private mapToXeroInvoice(invoice: any) {\n    return {\n      Type: 'ACCREC', // Accounts Receivable\n      Contact: {\n        ContactID: invoice.xeroContactId,\n      },\n      InvoiceNumber: invoice.number,\n      Date: invoice.issueDate,\n      DueDate: invoice.dueDate,\n      LineItems: invoice.lines.map((line: any) => ({\n        Description: line.description,\n        Quantity: line.quantity,\n        UnitAmount: line.unitPrice,\n        AccountCode: line.accountCode || '200', // Default sales account\n        TaxType: line.taxRate > 0 ? 'OUTPUT2' : 'NONE',\n      })),\n      Status: 'DRAFT',\n    };\n  }\n}\n"],"names":["XeroService","getAuthorizationUrl","companyId","redirectUri","state","params","URLSearchParams","response_type","client_id","clientId","redirect_uri","scope","scopes","join","authUrl","toString","exchangeCodeForToken","code","auth","Buffer","from","clientSecret","response","axios","post","tokenUrl","grant_type","headers","Authorization","connections","get","connectionsUrl","data","access_token","tenantId","accessToken","refreshToken","refresh_token","expiresIn","expires_in","metadata","tenantName","refreshAccessToken","testConnection","integration","baseService","getIntegration","provider","apiBaseUrl","Accept","error","logger","syncData","integrationId","prisma","findUnique","where","id","Error","invoices","Invoices","syncedCount","errors","xeroInvoice","syncInvoice","push","item","InvoiceNumber","message","updateSyncStatus","length","JSON","stringify","undefined","success","itemsSynced","pushData","mapToXeroInvoice","externalId","InvoiceID","invoiceNumber","status","Status","log","invoice","Type","Contact","ContactID","xeroContactId","number","Date","issueDate","DueDate","dueDate","LineItems","lines","map","line","Description","description","Quantity","quantity","UnitAmount","unitPrice","AccountCode","accountCode","TaxType","taxRate","config","Logger","name"],"mappings":"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"}