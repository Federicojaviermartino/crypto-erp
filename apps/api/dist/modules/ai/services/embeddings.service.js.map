{"version":3,"sources":["../../../../src/modules/ai/services/embeddings.service.ts"],"sourcesContent":["import { Injectable, Logger, OnModuleInit } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { PrismaService } from '@crypto-erp/database';\n\n/**\n * Embeddings Service\n * Gestiona la generación y búsqueda de embeddings vectoriales\n * Usa pgvector para almacenar y buscar vectores similares\n */\n\nexport interface EmbeddingDocument {\n  id: string;\n  content: string;\n  metadata: Record<string, unknown>;\n  embedding?: number[];\n}\n\nexport interface SearchResult {\n  id: string;\n  content: string;\n  metadata: Record<string, unknown>;\n  similarity: number;\n}\n\n@Injectable()\nexport class EmbeddingsService implements OnModuleInit {\n  private readonly logger = new Logger(EmbeddingsService.name);\n  private readonly embeddingDimension = 1536; // OpenAI ada-002 dimension\n  private openaiApiKey: string | undefined;\n  private anthropicApiKey: string | undefined;\n\n  constructor(\n    private readonly configService: ConfigService,\n    private readonly prisma: PrismaService,\n  ) {\n    this.openaiApiKey = this.configService.get<string>('OPENAI_API_KEY');\n    this.anthropicApiKey = this.configService.get<string>('ANTHROPIC_API_KEY');\n  }\n\n  async onModuleInit() {\n    // Verificar si pgvector está instalado\n    try {\n      await this.prisma.$executeRaw`SELECT 1 FROM pg_extension WHERE extname = 'vector'`;\n      this.logger.log('pgvector extension detected');\n    } catch {\n      this.logger.warn(\n        'pgvector extension not found. Vector search will use fallback cosine similarity.',\n      );\n    }\n  }\n\n  /**\n   * Genera embeddings usando OpenAI API o fallback local\n   */\n  async generateEmbedding(text: string): Promise<number[]> {\n    // Intentar con OpenAI primero (mejor calidad)\n    if (this.openaiApiKey) {\n      try {\n        return await this.generateOpenAIEmbedding(text);\n      } catch (error) {\n        this.logger.warn('OpenAI embedding failed, using fallback', error);\n      }\n    }\n\n    // Fallback: generar embedding simple basado en TF-IDF\n    return this.generateLocalEmbedding(text);\n  }\n\n  /**\n   * Genera embedding usando OpenAI text-embedding-ada-002\n   */\n  private async generateOpenAIEmbedding(text: string): Promise<number[]> {\n    const response = await fetch('https://api.openai.com/v1/embeddings', {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${this.openaiApiKey}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        model: 'text-embedding-ada-002',\n        input: text.slice(0, 8000), // Límite de tokens\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`OpenAI API error: ${response.status}`);\n    }\n\n    const data = (await response.json()) as { data: Array<{ embedding: number[] }> };\n    return data.data[0].embedding;\n  }\n\n  /**\n   * Fallback: genera embedding simple usando hash y frecuencia de palabras\n   * No tan preciso como OpenAI pero funciona sin API externa\n   */\n  private generateLocalEmbedding(text: string): number[] {\n    const words = text.toLowerCase().split(/\\s+/);\n    const embedding = new Array(this.embeddingDimension).fill(0);\n\n    // Simple hashing para distribuir palabras en el espacio vectorial\n    for (const word of words) {\n      let hash = 0;\n      for (let i = 0; i < word.length; i++) {\n        const char = word.charCodeAt(i);\n        hash = (hash << 5) - hash + char;\n        hash = hash & hash;\n      }\n      const index = Math.abs(hash) % this.embeddingDimension;\n      embedding[index] += 1;\n    }\n\n    // Normalizar el vector\n    const magnitude = Math.sqrt(embedding.reduce((sum, val) => sum + val * val, 0));\n    if (magnitude > 0) {\n      for (let i = 0; i < embedding.length; i++) {\n        embedding[i] /= magnitude;\n      }\n    }\n\n    return embedding;\n  }\n\n  /**\n   * Almacena un documento con su embedding en la base de datos\n   */\n  async storeDocument(\n    companyId: string,\n    content: string,\n    metadata: Record<string, unknown>,\n    category: string = 'general',\n  ): Promise<string> {\n    const embedding = await this.generateEmbedding(content);\n\n    // Usar la tabla Document existente\n    const doc = await this.prisma.document.create({\n      data: {\n        companyId,\n        title: (metadata.title as string) || 'Documento',\n        content,\n        type: this.mapCategoryToDocumentType(category),\n        metadata: {\n          ...metadata,\n          category,\n          embeddingJson: embedding, // Store as JSON since pgvector may not be available\n        } as any,\n      },\n    });\n\n    this.logger.debug(`Document stored with ID: ${doc.id}`);\n    return doc.id;\n  }\n\n  /**\n   * Mapea categoría a DocumentType\n   */\n  private mapCategoryToDocumentType(category: string): 'REGULATION' | 'KNOWLEDGE_BASE' | 'USER_UPLOAD' {\n    if (category.includes('normativa') || category.includes('aeat') || category.includes('modelos')) {\n      return 'REGULATION';\n    }\n    if (category.includes('user') || category.includes('upload')) {\n      return 'USER_UPLOAD';\n    }\n    return 'KNOWLEDGE_BASE';\n  }\n\n  /**\n   * Busca documentos similares usando similitud coseno\n   */\n  async searchSimilar(\n    companyId: string,\n    query: string,\n    limit: number = 5,\n    category?: string,\n  ): Promise<SearchResult[]> {\n    const queryEmbedding = await this.generateEmbedding(query);\n\n    // Obtener documentos de la categoría\n    const documents = await this.prisma.document.findMany({\n      where: {\n        companyId,\n        ...(category && {\n          type: this.mapCategoryToDocumentType(category),\n        }),\n      },\n    });\n\n    // Calcular similitud coseno para cada documento\n    const results: SearchResult[] = [];\n\n    for (const doc of documents) {\n      const metadata = doc.metadata as Record<string, unknown> | null;\n      const docEmbedding = metadata?.embeddingJson as number[] | undefined;\n\n      if (!docEmbedding) continue;\n\n      const similarity = this.cosineSimilarity(queryEmbedding, docEmbedding);\n\n      // Filtrar por categoría específica si se proporciona\n      if (category && metadata?.category !== category) {\n        continue;\n      }\n\n      results.push({\n        id: doc.id,\n        content: doc.content,\n        metadata: metadata || {},\n        similarity,\n      });\n    }\n\n    // Ordenar por similitud y limitar resultados\n    return results\n      .sort((a, b) => b.similarity - a.similarity)\n      .slice(0, limit);\n  }\n\n  /**\n   * Calcula la similitud coseno entre dos vectores\n   */\n  private cosineSimilarity(a: number[], b: number[]): number {\n    if (a.length !== b.length) return 0;\n\n    let dotProduct = 0;\n    let normA = 0;\n    let normB = 0;\n\n    for (let i = 0; i < a.length; i++) {\n      dotProduct += a[i] * b[i];\n      normA += a[i] * a[i];\n      normB += b[i] * b[i];\n    }\n\n    const magnitude = Math.sqrt(normA) * Math.sqrt(normB);\n    return magnitude > 0 ? dotProduct / magnitude : 0;\n  }\n\n  /**\n   * Indexa documentos de normativa AEAT para consultas\n   */\n  async indexAEATDocumentation(companyId: string): Promise<number> {\n    const documents = [\n      {\n        title: 'IVA - Tipos impositivos',\n        content: `En España existen tres tipos de IVA:\n        - Tipo general: 21% (aplicable a la mayoría de bienes y servicios)\n        - Tipo reducido: 10% (alimentos, transporte, hostelería)\n        - Tipo superreducido: 4% (pan, leche, libros, medicamentos)\n        Las operaciones intracomunitarias están exentas de IVA.`,\n        category: 'normativa-iva',\n      },\n      {\n        title: 'Modelo 303 - Autoliquidación IVA',\n        content: `El Modelo 303 es la declaración trimestral del IVA.\n        Plazos de presentación:\n        - 1T: 1-20 abril\n        - 2T: 1-20 julio\n        - 3T: 1-20 octubre\n        - 4T: 1-30 enero\n        Se declara el IVA devengado menos el IVA soportado deducible.`,\n        category: 'modelos-aeat',\n      },\n      {\n        title: 'Fiscalidad de criptomonedas',\n        content: `Las criptomonedas tributan como ganancias patrimoniales en el IRPF.\n        Tipos aplicables:\n        - Hasta 6.000€: 19%\n        - De 6.000€ a 50.000€: 21%\n        - De 50.000€ a 200.000€: 23%\n        - De 200.000€ a 300.000€: 27%\n        - Más de 300.000€: 28%\n        Se usa el método FIFO para calcular el coste de adquisición.`,\n        category: 'fiscalidad-crypto',\n      },\n      {\n        title: 'Verifactu - Sistema de verificación de facturas',\n        content: `Verifactu es el sistema de verificación de facturas de la AEAT.\n        Requisitos:\n        - Huella digital encadenada (SHA-256)\n        - Código QR de verificación\n        - Envío en tiempo real o diferido\n        Obligatorio para sistemas de facturación desde 2025.`,\n        category: 'verifactu',\n      },\n      {\n        title: 'Modelo 721 - Declaración de criptomonedas en el extranjero',\n        content: `El Modelo 721 declara monedas virtuales en el extranjero.\n        Obligatorio si el valor supera 50.000€ a 31 de diciembre.\n        Debe declararse también si hay variación superior a 20.000€.\n        Plazo: 1 enero a 31 marzo del año siguiente.`,\n        category: 'modelos-aeat',\n      },\n      {\n        title: 'Plan General Contable - Cuentas de criptomonedas',\n        content: `Contabilización de criptomonedas según PGC:\n        - Activos financieros a valor razonable: cuenta 250 (largo plazo) o 570 (corto plazo)\n        - Ganancias: cuenta 768 (diferencias positivas de cambio)\n        - Pérdidas: cuenta 668 (diferencias negativas de cambio)\n        - Comisiones: cuenta 662 (gastos financieros)`,\n        category: 'pgc',\n      },\n    ];\n\n    let indexed = 0;\n    for (const doc of documents) {\n      await this.storeDocument(companyId, doc.content, { title: doc.title }, doc.category);\n      indexed++;\n    }\n\n    this.logger.log(`Indexed ${indexed} AEAT documentation documents`);\n    return indexed;\n  }\n\n  /**\n   * Elimina documentos antiguos de una categoría\n   */\n  async clearCategory(companyId: string, category: string): Promise<number> {\n    // Para eliminar por categoría específica, obtenemos los documentos y filtramos\n    const documents = await this.prisma.document.findMany({\n      where: {\n        companyId,\n        type: this.mapCategoryToDocumentType(category),\n      },\n      select: { id: true, metadata: true },\n    });\n\n    const idsToDelete = documents\n      .filter((doc) => {\n        const metadata = doc.metadata as Record<string, unknown> | null;\n        return metadata?.category === category;\n      })\n      .map((doc) => doc.id);\n\n    if (idsToDelete.length === 0) {\n      return 0;\n    }\n\n    const result = await this.prisma.document.deleteMany({\n      where: {\n        id: { in: idsToDelete },\n      },\n    });\n\n    return result.count;\n  }\n}\n"],"names":["EmbeddingsService","onModuleInit","prisma","$executeRaw","logger","log","warn","generateEmbedding","text","openaiApiKey","generateOpenAIEmbedding","error","generateLocalEmbedding","response","fetch","method","headers","Authorization","body","JSON","stringify","model","input","slice","ok","Error","status","data","json","embedding","words","toLowerCase","split","Array","embeddingDimension","fill","word","hash","i","length","char","charCodeAt","index","Math","abs","magnitude","sqrt","reduce","sum","val","storeDocument","companyId","content","metadata","category","doc","document","create","title","type","mapCategoryToDocumentType","embeddingJson","debug","id","includes","searchSimilar","query","limit","queryEmbedding","documents","findMany","where","results","docEmbedding","similarity","cosineSimilarity","push","sort","a","b","dotProduct","normA","normB","indexAEATDocumentation","indexed","clearCategory","select","idsToDelete","filter","map","result","deleteMany","in","count","configService","Logger","name","get","anthropicApiKey"],"mappings":"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"}