{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import { NestFactory } from '@nestjs/core';\nimport { ValidationPipe, VersioningType } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\nimport helmet from 'helmet';\nimport * as Sentry from '@sentry/node';\nimport { ProfilingIntegration } from '@sentry/profiling-node';\nimport { AppModule } from './app.module.js';\nimport { SentryExceptionFilter } from './common/filters/sentry-exception.filter.js';\n\nasync function bootstrap(): Promise<void> {\n  const app = await NestFactory.create(AppModule);\n  const configService = app.get(ConfigService);\n\n  // Initialize Sentry (FIRST, before anything else)\n  const sentryDsn = configService.get<string>('SENTRY_DSN');\n  const nodeEnv = configService.get<string>('nodeEnv');\n\n  if (sentryDsn) {\n    Sentry.init({\n      dsn: sentryDsn,\n      environment: nodeEnv || 'development',\n      integrations: [new ProfilingIntegration()],\n      tracesSampleRate: nodeEnv === 'production' ? 0.1 : 1.0, // 10% in prod, 100% in dev\n      profilesSampleRate: nodeEnv === 'production' ? 0.1 : 1.0,\n      beforeSend(event) {\n        // Filter out sensitive data\n        if (event.request) {\n          delete event.request.cookies;\n          if (event.request.headers) {\n            delete event.request.headers.authorization;\n            delete event.request.headers.cookie;\n          }\n        }\n        return event;\n      },\n    });\n\n    console.log('Sentry initialized for error tracking');\n\n    // Register global Sentry exception filter\n    app.useGlobalFilters(new SentryExceptionFilter());\n  } else {\n    console.warn('SENTRY_DSN not configured - error tracking disabled');\n  }\n\n  // Security headers\n  app.use(helmet());\n\n  // CORS configuration\n  const frontendUrl = configService.get<string>('frontendUrl');\n  const nodeEnv = configService.get<string>('nodeEnv');\n\n  const allowedOrigins = [\n    'http://localhost:4200',\n    'http://localhost:3000',\n    frontendUrl,\n  ].filter((origin): origin is string => Boolean(origin));\n\n  app.enableCors({\n    origin: allowedOrigins,\n    credentials: true,\n    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],\n    allowedHeaders: ['Content-Type', 'Authorization', 'X-Company-Id'],\n  });\n\n  // API versioning\n  app.enableVersioning({\n    type: VersioningType.URI,\n    defaultVersion: '1',\n    prefix: 'api/v',\n  });\n\n  // Global validation pipe\n  app.useGlobalPipes(\n    new ValidationPipe({\n      whitelist: true,\n      forbidNonWhitelisted: true,\n      transform: true,\n      transformOptions: {\n        enableImplicitConversion: true,\n      },\n    }),\n  );\n\n  // Swagger documentation (only in development)\n  const swaggerEnabled = nodeEnv !== 'production';\n  if (swaggerEnabled) {\n    const swaggerConfig = new DocumentBuilder()\n      .setTitle('Crypto ERP API')\n      .setDescription(\n        'API for Crypto ERP - Spanish accounting with cryptocurrency support and Verifactu compliance',\n      )\n      .setVersion('1.0')\n      .addBearerAuth(\n        {\n          type: 'http',\n          scheme: 'bearer',\n          bearerFormat: 'JWT',\n          name: 'Authorization',\n          description: 'Enter JWT access token',\n          in: 'header',\n        },\n        'access-token',\n      )\n      .addApiKey(\n        {\n          type: 'apiKey',\n          name: 'X-Company-Id',\n          in: 'header',\n          description: 'Company ID for multi-tenancy',\n        },\n        'company-id',\n      )\n      .addTag('auth', 'Authentication endpoints')\n      .addTag('users', 'User management')\n      .addTag('companies', 'Company/tenant management')\n      .addTag('accounting', 'Accounting operations')\n      .addTag('invoicing', 'Invoice management and Verifactu')\n      .addTag('crypto', 'Cryptocurrency wallets and transactions')\n      .addTag('ai', 'AI assistant and automation')\n      .build();\n\n    const document = SwaggerModule.createDocument(app, swaggerConfig);\n    SwaggerModule.setup('api/docs', app, document, {\n      swaggerOptions: {\n        persistAuthorization: true,\n      },\n    });\n\n    console.log(`Swagger documentation available at /api/docs`);\n  }\n\n  // Start server\n  const port = configService.get<number>('port') || 3000;\n  await app.listen(port);\n\n  console.log(`\n╔══════════════════════════════════════════════════════════════╗\n║                     CRYPTO ERP API                            ║\n╠══════════════════════════════════════════════════════════════╣\n║  Environment: ${nodeEnv?.padEnd(46)}║\n║  Port:        ${String(port).padEnd(46)}║\n║  Frontend:    ${(frontendUrl || 'N/A').padEnd(46)}║\n╚══════════════════════════════════════════════════════════════╝\n  `);\n}\n\nbootstrap().catch((err) => {\n  console.error('Failed to start application:', err);\n  process.exit(1);\n});"],"names":["bootstrap","app","NestFactory","create","AppModule","configService","get","ConfigService","sentryDsn","nodeEnv","Sentry","init","dsn","environment","integrations","ProfilingIntegration","tracesSampleRate","profilesSampleRate","beforeSend","event","request","cookies","headers","authorization","cookie","console","log","useGlobalFilters","SentryExceptionFilter","warn","use","helmet","frontendUrl","allowedOrigins","filter","origin","Boolean","enableCors","credentials","methods","allowedHeaders","enableVersioning","type","VersioningType","URI","defaultVersion","prefix","useGlobalPipes","ValidationPipe","whitelist","forbidNonWhitelisted","transform","transformOptions","enableImplicitConversion","swaggerEnabled","swaggerConfig","DocumentBuilder","setTitle","setDescription","setVersion","addBearerAuth","scheme","bearerFormat","name","description","in","addApiKey","addTag","build","document","SwaggerModule","createDocument","setup","swaggerOptions","persistAuthorization","port","listen","padEnd","String","catch","err","error","process","exit"],"mappings":"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"}