{"version":3,"sources":["../../../src/modules/payments/payments.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Body,\n  UseGuards,\n  Req,\n  Headers,\n  RawBodyRequest,\n} from '@nestjs/common';\nimport { Request } from 'express';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard.js';\nimport { RolesGuard } from '../auth/guards/roles.guard.js';\nimport { Roles } from '../auth/decorators/roles.decorator.js';\nimport { GetCompany } from '../auth/decorators/get-company.decorator.js';\nimport { UserRole } from '@prisma/client';\nimport { StripeService } from './stripe.service.js';\nimport { SubscriptionsService } from './subscriptions.service.js';\nimport { CreateCheckoutDto } from './dto/create-checkout.dto.js';\n\n@ApiTags('payments')\n@Controller('payments')\nexport class PaymentsController {\n  constructor(\n    private readonly stripe: StripeService,\n    private readonly subscriptions: SubscriptionsService,\n  ) {}\n\n  /**\n   * Get available subscription plans\n   */\n  @Get('plans')\n  @ApiOperation({\n    summary: 'Get available subscription plans',\n    description: 'Returns all active subscription plans with features and pricing',\n  })\n  async getPlans() {\n    return this.subscriptions.getPlans();\n  }\n\n  /**\n   * Get current subscription\n   */\n  @Get('subscription')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Get current subscription',\n    description: 'Returns the company subscription with plan details',\n  })\n  async getSubscription(@GetCompany() companyId: string) {\n    return this.subscriptions.getSubscription(companyId);\n  }\n\n  /**\n   * Get usage statistics\n   */\n  @Get('usage')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Get usage statistics',\n    description: 'Returns current usage stats and limits for the company',\n  })\n  async getUsageStats(@GetCompany() companyId: string) {\n    return this.subscriptions.getUsageStats(companyId);\n  }\n\n  /**\n   * Create Stripe checkout session\n   */\n  @Post('checkout')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Create checkout session',\n    description: 'Creates a Stripe checkout session for subscription',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Checkout session created successfully',\n  })\n  async createCheckout(\n    @GetCompany() companyId: string,\n    @Body() dto: CreateCheckoutDto,\n  ) {\n    const session = await this.stripe.createCheckoutSession({\n      companyId,\n      planId: dto.planId,\n      successUrl: dto.successUrl,\n      cancelUrl: dto.cancelUrl,\n    });\n\n    return {\n      sessionId: session.id,\n      url: session.url,\n    };\n  }\n\n  /**\n   * Create customer portal session\n   */\n  @Post('portal')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Create customer portal session',\n    description: 'Creates a Stripe customer portal session for managing subscription',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Portal session created successfully',\n  })\n  async createPortal(\n    @GetCompany() companyId: string,\n    @Body() body: { returnUrl: string },\n  ) {\n    const session = await this.stripe.createPortalSession({\n      companyId,\n      returnUrl: body.returnUrl,\n    });\n\n    return {\n      url: session.url,\n    };\n  }\n\n  /**\n   * Cancel subscription\n   */\n  @Post('cancel')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Cancel subscription',\n    description: 'Cancels subscription at the end of the current period',\n  })\n  async cancelSubscription(@GetCompany() companyId: string) {\n    await this.stripe.cancelSubscription(companyId);\n    return { message: 'Subscription will be canceled at the end of the current period' };\n  }\n\n  /**\n   * Reactivate subscription\n   */\n  @Post('reactivate')\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @ApiBearerAuth()\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Reactivate subscription',\n    description: 'Reactivates a canceled subscription',\n  })\n  async reactivateSubscription(@GetCompany() companyId: string) {\n    await this.stripe.reactivateSubscription(companyId);\n    return { message: 'Subscription reactivated successfully' };\n  }\n\n  /**\n   * Stripe webhook endpoint\n   */\n  @Post('webhook')\n  @ApiOperation({\n    summary: 'Stripe webhook',\n    description: 'Handles Stripe webhook events',\n  })\n  async handleWebhook(\n    @Req() req: RawBodyRequest<Request>,\n    @Headers('stripe-signature') signature: string,\n  ) {\n    const payload = req.rawBody || req.body;\n    await this.stripe.handleWebhook(payload, signature);\n    return { received: true };\n  }\n}\n"],"names":["PaymentsController","getPlans","subscriptions","getSubscription","companyId","getUsageStats","createCheckout","dto","session","stripe","createCheckoutSession","planId","successUrl","cancelUrl","sessionId","id","url","createPortal","body","createPortalSession","returnUrl","cancelSubscription","message","reactivateSubscription","handleWebhook","req","signature","payload","rawBody","received","summary","description","ADMIN","OWNER","status"],"mappings":";;;;+BAuBaA;;;eAAAA;;;wBAdN;yBAE2D;8BACrC;4BACF;gCACL;qCACK;wBACF;+BACK;sCACO;mCACH;;;;;;;;;;;;;;;AAI3B,IAAA,AAAMA,qBAAN,MAAMA;IAMX;;GAEC,GACD,MAKMC,WAAW;QACf,OAAO,IAAI,CAACC,aAAa,CAACD,QAAQ;IACpC;IAEA;;GAEC,GACD,MAQME,gBAAgB,AAAcC,SAAiB,EAAE;QACrD,OAAO,IAAI,CAACF,aAAa,CAACC,eAAe,CAACC;IAC5C;IAEA;;GAEC,GACD,MAQMC,cAAc,AAAcD,SAAiB,EAAE;QACnD,OAAO,IAAI,CAACF,aAAa,CAACG,aAAa,CAACD;IAC1C;IAEA;;GAEC,GACD,MAYME,eACJ,AAAcF,SAAiB,EAC/B,AAAQG,GAAsB,EAC9B;QACA,MAAMC,UAAU,MAAM,IAAI,CAACC,MAAM,CAACC,qBAAqB,CAAC;YACtDN;YACAO,QAAQJ,IAAII,MAAM;YAClBC,YAAYL,IAAIK,UAAU;YAC1BC,WAAWN,IAAIM,SAAS;QAC1B;QAEA,OAAO;YACLC,WAAWN,QAAQO,EAAE;YACrBC,KAAKR,QAAQQ,GAAG;QAClB;IACF;IAEA;;GAEC,GACD,MAYMC,aACJ,AAAcb,SAAiB,EAC/B,AAAQc,IAA2B,EACnC;QACA,MAAMV,UAAU,MAAM,IAAI,CAACC,MAAM,CAACU,mBAAmB,CAAC;YACpDf;YACAgB,WAAWF,KAAKE,SAAS;QAC3B;QAEA,OAAO;YACLJ,KAAKR,QAAQQ,GAAG;QAClB;IACF;IAEA;;GAEC,GACD,MAQMK,mBAAmB,AAAcjB,SAAiB,EAAE;QACxD,MAAM,IAAI,CAACK,MAAM,CAACY,kBAAkB,CAACjB;QACrC,OAAO;YAAEkB,SAAS;QAAiE;IACrF;IAEA;;GAEC,GACD,MAQMC,uBAAuB,AAAcnB,SAAiB,EAAE;QAC5D,MAAM,IAAI,CAACK,MAAM,CAACc,sBAAsB,CAACnB;QACzC,OAAO;YAAEkB,SAAS;QAAwC;IAC5D;IAEA;;GAEC,GACD,MAKME,cACJ,AAAOC,GAA4B,EACnC,AAA6BC,SAAiB,EAC9C;QACA,MAAMC,UAAUF,IAAIG,OAAO,IAAIH,IAAIP,IAAI;QACvC,MAAM,IAAI,CAACT,MAAM,CAACe,aAAa,CAACG,SAASD;QACzC,OAAO;YAAEG,UAAU;QAAK;IAC1B;IA3JA,YACE,AAAiBpB,MAAqB,EACtC,AAAiBP,aAAmC,CACpD;aAFiBO,SAAAA;aACAP,gBAAAA;IAChB;AAyJL;;;;QAlJI4B,SAAS;QACTC,aAAa;;;;;;;;;;gDAYCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;;;;;;;;;;;gDAYCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;;;;;;;;;;;gDAYCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;QAGbG,QAAQ;QACRH,aAAa;;;;;;;;;;;;;;;gDAyBCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;QAGbG,QAAQ;QACRH,aAAa;;;;;;;;;;;;;;;gDAsBCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;;;;;;;;;;;gDAaCC,wBAAgBC;;QAE9BH,SAAS;QACTC,aAAa;;;;;;;;;;;;QAYbD,SAAS;QACTC,aAAa"}