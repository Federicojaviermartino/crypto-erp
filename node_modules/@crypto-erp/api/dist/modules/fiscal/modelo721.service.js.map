{"version":3,"sources":["../../../src/modules/fiscal/modelo721.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport Decimal from 'decimal.js';\n\ninterface Modelo721Position {\n  // Identificación del bien\n  tipoMoneda: string; // Código de la criptomoneda (BTC, ETH, etc.)\n  nombreMoneda: string; // Nombre completo\n\n  // Localización\n  claveExchange: string; // Código del exchange/wallet\n  nombreExchange: string;\n  paisExchange: string; // Código ISO país\n\n  // Valoración a 31 de diciembre\n  saldoAFinDeAno: Decimal; // Cantidad de unidades\n  valorEurAFinDeAno: Decimal; // Valor en EUR a 31/12\n\n  // Datos de adquisición\n  fechaAdquisicion: Date;\n  valorAdquisicionEur: Decimal;\n\n  // Porcentaje de titularidad\n  porcentajeTitularidad: number;\n}\n\ninterface Modelo721Summary {\n  ejercicio: number;\n  fechaGeneracion: Date;\n  totalValorEur: Decimal;\n  posiciones: Modelo721Position[];\n  obligadoDeclarar: boolean; // >50,000 EUR\n  variacionSignificativa: boolean; // >20,000 EUR vs año anterior\n}\n\ninterface Modelo720CryptoItem {\n  // Subgrupo 8: Monedas virtuales\n  claveIdentificacion: string;\n  denominacionCripto: string;\n  saldoCantidad: Decimal;\n  valoracionEur: Decimal;\n  codigoPais: string;\n  claveCondicion: 'T' | 'A' | 'R' | 'B'; // Titular, Autorizado, Representante, Beneficiario\n  fechaPrimeraAdquisicion: Date;\n  origenAdquisicion: string;\n}\n\n// Mapping de países por exchange conocido\nconst EXCHANGE_COUNTRIES: Record<string, string> = {\n  COINBASE: 'US',\n  KRAKEN: 'US',\n  BINANCE: 'MT', // Malta\n  BITSTAMP: 'LU', // Luxemburgo\n  GEMINI: 'US',\n  KUCOIN: 'SC', // Seychelles\n  BITFINEX: 'VG', // British Virgin Islands\n  FTX: 'BS', // Bahamas (histórico)\n  BYBIT: 'VG',\n  OKX: 'SC',\n};\n\n@Injectable()\nexport class Modelo721Service {\n  private readonly logger = new Logger(Modelo721Service.name);\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Genera el informe Modelo 721 para un año fiscal\n   * El Modelo 721 declara criptomonedas en el extranjero si el valor > 50,000 EUR\n   */\n  async generateModelo721(companyId: string, year: number): Promise<Modelo721Summary> {\n    const endOfYear = new Date(year, 11, 31, 23, 59, 59);\n\n    // Obtener todas las wallets y exchange accounts\n    const [wallets, exchangeAccounts] = await Promise.all([\n      this.prisma.wallet.findMany({\n        where: { companyId, isActive: true },\n        include: {\n          transactions: {\n            where: { blockTimestamp: { lte: endOfYear } },\n            orderBy: { blockTimestamp: 'asc' },\n          },\n        },\n      }),\n      this.prisma.exchangeAccount.findMany({\n        where: { companyId, isActive: true },\n      }),\n    ]);\n\n    // Obtener CryptoLots para calcular el cost basis\n    const lots = await this.prisma.cryptoLot.findMany({\n      where: { companyId },\n      include: { cryptoAsset: true },\n    });\n\n    // Calcular saldos por activo y origen (exchange/wallet)\n    const balancesBySource = new Map<string, {\n      asset: string;\n      assetName: string;\n      source: string;\n      sourceName: string;\n      country: string;\n      balance: Decimal;\n      costBasis: Decimal;\n      firstAcquisition: Date | null;\n    }>();\n\n    // Procesar transacciones de wallets\n    for (const wallet of wallets) {\n      // Determinar país del wallet (blockchain = jurisdicción del nodo, usamos US por defecto)\n      const country = this.getWalletCountry(wallet.chain);\n\n      for (const tx of wallet.transactions) {\n        // Procesar activo entrante (assetIn/amountIn)\n        if (tx.assetIn && tx.amountIn) {\n          const sourceKey = `${tx.assetIn}:wallet:${wallet.id}`;\n\n          if (!balancesBySource.has(sourceKey)) {\n            balancesBySource.set(sourceKey, {\n              asset: tx.assetIn,\n              assetName: tx.assetIn, // Se actualizará después\n              source: `WALLET-${wallet.address.slice(0, 8)}`,\n              sourceName: wallet.label || `Wallet ${wallet.chain}`,\n              country,\n              balance: new Decimal(0),\n              costBasis: new Decimal(0),\n              firstAcquisition: null,\n            });\n          }\n\n          const entry = balancesBySource.get(sourceKey)!;\n          const amount = new Decimal(tx.amountIn);\n          const priceEur = tx.priceInEur ? new Decimal(tx.priceInEur) : new Decimal(0);\n\n          // Tipos que aumentan el saldo\n          if (['BUY', 'DEPOSIT', 'STAKING_REWARD', 'AIRDROP', 'INCOME'].includes(tx.type)) {\n            entry.balance = entry.balance.plus(amount);\n            entry.costBasis = entry.costBasis.plus(amount.mul(priceEur));\n            if (!entry.firstAcquisition) {\n              entry.firstAcquisition = tx.blockTimestamp;\n            }\n          }\n        }\n\n        // Procesar activo saliente (assetOut/amountOut)\n        if (tx.assetOut && tx.amountOut) {\n          const sourceKey = `${tx.assetOut}:wallet:${wallet.id}`;\n\n          if (!balancesBySource.has(sourceKey)) {\n            balancesBySource.set(sourceKey, {\n              asset: tx.assetOut,\n              assetName: tx.assetOut,\n              source: `WALLET-${wallet.address.slice(0, 8)}`,\n              sourceName: wallet.label || `Wallet ${wallet.chain}`,\n              country,\n              balance: new Decimal(0),\n              costBasis: new Decimal(0),\n              firstAcquisition: null,\n            });\n          }\n\n          const entry = balancesBySource.get(sourceKey)!;\n          const amount = new Decimal(tx.amountOut);\n\n          // Tipos que disminuyen el saldo\n          if (['SELL', 'WITHDRAWAL', 'SWAP', 'FEE'].includes(tx.type)) {\n            entry.balance = entry.balance.minus(amount);\n          }\n        }\n      }\n    }\n\n    // Procesar saldos de exchange accounts\n    for (const exchange of exchangeAccounts) {\n      const country = exchange.country || EXCHANGE_COUNTRIES[exchange.exchange.toUpperCase()] || 'US';\n\n      // Obtener balances del exchange (usando los lots como proxy)\n      const exchangeLots = lots.filter(l => l.sourceType === exchange.exchange.toLowerCase());\n\n      for (const lot of exchangeLots) {\n        const remaining = new Decimal(lot.remainingAmount);\n        if (remaining.lte(0)) continue;\n\n        const sourceKey = `${lot.cryptoAsset.symbol}:exchange:${exchange.id}`;\n\n        if (!balancesBySource.has(sourceKey)) {\n          balancesBySource.set(sourceKey, {\n            asset: lot.cryptoAsset.symbol,\n            assetName: lot.cryptoAsset.name,\n            source: exchange.exchange.toUpperCase(),\n            sourceName: exchange.label || exchange.exchange,\n            country,\n            balance: new Decimal(0),\n            costBasis: new Decimal(0),\n            firstAcquisition: null,\n          });\n        }\n\n        const entry = balancesBySource.get(sourceKey)!;\n        entry.balance = entry.balance.plus(remaining);\n        entry.costBasis = entry.costBasis.plus(new Decimal(lot.costBasisEur));\n        if (!entry.firstAcquisition || lot.acquiredAt < entry.firstAcquisition) {\n          entry.firstAcquisition = lot.acquiredAt;\n        }\n      }\n    }\n\n    // Obtener precios a 31 de diciembre\n    const pricesAtYearEnd = await this.getPricesAtDate(endOfYear);\n\n    // Construir posiciones del Modelo 721\n    const posiciones: Modelo721Position[] = [];\n\n    for (const [, data] of balancesBySource) {\n      if (data.balance.lte(0)) continue;\n\n      // Solo incluir si está en el extranjero (no España)\n      if (data.country === 'ES') continue;\n\n      const priceEur = pricesAtYearEnd.get(data.asset) || new Decimal(0);\n      const valorFinAno = data.balance.mul(priceEur);\n\n      posiciones.push({\n        tipoMoneda: data.asset,\n        nombreMoneda: data.assetName,\n        claveExchange: data.source,\n        nombreExchange: data.sourceName,\n        paisExchange: data.country,\n        saldoAFinDeAno: data.balance,\n        valorEurAFinDeAno: valorFinAno,\n        fechaAdquisicion: data.firstAcquisition || new Date(year, 0, 1),\n        valorAdquisicionEur: data.costBasis,\n        porcentajeTitularidad: 100,\n      });\n    }\n\n    const totalValorEur = posiciones.reduce(\n      (sum, p) => sum.plus(p.valorEurAFinDeAno),\n      new Decimal(0),\n    );\n\n    // Verificar si hay variación significativa vs año anterior\n    const previousYear = await this.getPreviousYearTotal(companyId, year - 1);\n    const variacion = totalValorEur.minus(previousYear).abs();\n\n    const summary: Modelo721Summary = {\n      ejercicio: year,\n      fechaGeneracion: new Date(),\n      totalValorEur,\n      posiciones,\n      obligadoDeclarar: totalValorEur.gt(50000),\n      variacionSignificativa: variacion.gt(20000),\n    };\n\n    this.logger.log(\n      `Modelo 721 generado para ${year}: ${posiciones.length} posiciones, ` +\n      `valor total: ${totalValorEur.toFixed(2)} EUR, obligado: ${summary.obligadoDeclarar}`,\n    );\n\n    return summary;\n  }\n\n  /**\n   * Determinar país de un wallet basado en la blockchain\n   * Las blockchains descentralizadas se consideran \"extranjero\" por defecto\n   */\n  private getWalletCountry(chain: string): string {\n    // Para blockchains públicas, usamos US ya que la mayoría de nodos están ahí\n    // Esto es una simplificación - la AEAT no tiene guía específica para DeFi\n    const chainCountries: Record<string, string> = {\n      ethereum: 'US',\n      polygon: 'US',\n      bsc: 'SG', // Binance Smart Chain -> Singapur\n      arbitrum: 'US',\n      optimism: 'US',\n      avalanche: 'US',\n      solana: 'US',\n      bitcoin: 'US',\n    };\n    return chainCountries[chain.toLowerCase()] || 'US';\n  }\n\n  /**\n   * Genera datos para el subgrupo 8 del Modelo 720 (criptomonedas)\n   * El Modelo 720 incluye criptos en el \"Subgrupo 8 - Monedas virtuales\"\n   * Solo obligatorio si valor > 50,000 EUR y variación > 20,000 EUR\n   */\n  async generateModelo720Crypto(companyId: string, year: number): Promise<Modelo720CryptoItem[]> {\n    const modelo721 = await this.generateModelo721(companyId, year);\n\n    return modelo721.posiciones.map((pos) => ({\n      claveIdentificacion: pos.tipoMoneda,\n      denominacionCripto: pos.nombreMoneda,\n      saldoCantidad: pos.saldoAFinDeAno,\n      valoracionEur: pos.valorEurAFinDeAno,\n      codigoPais: pos.paisExchange,\n      claveCondicion: 'T' as const, // Titular\n      fechaPrimeraAdquisicion: pos.fechaAdquisicion,\n      origenAdquisicion: pos.nombreExchange,\n    }));\n  }\n\n  /**\n   * Exporta el Modelo 721 en formato XML compatible con la AEAT\n   * Formato según especificación BOE para presentación telemática\n   */\n  async exportToAEATFormat(companyId: string, year: number): Promise<string> {\n    const modelo = await this.generateModelo721(companyId, year);\n\n    // Obtener datos de la empresa para el declarante\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    if (!company) {\n      throw new Error('Empresa no encontrada');\n    }\n\n    // Formato XML según BOE para Modelo 721\n    const xmlParts: string[] = [];\n\n    // Cabecera XML\n    xmlParts.push('<?xml version=\"1.0\" encoding=\"UTF-8\"?>');\n    xmlParts.push('<Modelo721 xmlns=\"https://www.agenciatributaria.gob.es/static_files/Sede/Programas_ayuda/Modelos_700_799/Modelo_721\">');\n\n    // Datos identificativos del declarante\n    xmlParts.push('  <DatosIdentificativos>');\n    xmlParts.push(`    <Ejercicio>${year}</Ejercicio>`);\n    xmlParts.push(`    <NIF>${this.escapeXml(company.taxId || '')}</NIF>`);\n    xmlParts.push(`    <Denominacion>${this.escapeXml(company.name)}</Denominacion>`);\n    xmlParts.push(`    <FechaGeneracion>${modelo.fechaGeneracion.toISOString()}</FechaGeneracion>`);\n    xmlParts.push('  </DatosIdentificativos>');\n\n    // Resumen de la declaración\n    xmlParts.push('  <ResumenDeclaracion>');\n    xmlParts.push(`    <NumeroRegistros>${modelo.posiciones.length}</NumeroRegistros>`);\n    xmlParts.push(`    <TotalValoracion>${modelo.totalValorEur.toFixed(2)}</TotalValoracion>`);\n    xmlParts.push(`    <ObligadoDeclarar>${modelo.obligadoDeclarar ? 'S' : 'N'}</ObligadoDeclarar>`);\n    xmlParts.push(`    <VariacionSignificativa>${modelo.variacionSignificativa ? 'S' : 'N'}</VariacionSignificativa>`);\n    xmlParts.push('  </ResumenDeclaracion>');\n\n    // Detalle de bienes (monedas virtuales)\n    xmlParts.push('  <DetalleBienes>');\n\n    for (const [index, pos] of modelo.posiciones.entries()) {\n      xmlParts.push(`    <Bien numero=\"${index + 1}\">`);\n      xmlParts.push('      <TipoBien>M</TipoBien>'); // M = Moneda virtual\n      xmlParts.push(`      <ClaveMoneda>${this.escapeXml(pos.tipoMoneda)}</ClaveMoneda>`);\n      xmlParts.push(`      <Denominacion>${this.escapeXml(pos.nombreMoneda)}</Denominacion>`);\n      xmlParts.push(`      <CodigoPais>${pos.paisExchange}</CodigoPais>`);\n      xmlParts.push(`      <IdentificacionCustodia>${this.escapeXml(pos.claveExchange)}</IdentificacionCustodia>`);\n      xmlParts.push(`      <NombreCustodia>${this.escapeXml(pos.nombreExchange)}</NombreCustodia>`);\n      xmlParts.push(`      <Saldo31Diciembre>${pos.saldoAFinDeAno.toFixed(8)}</Saldo31Diciembre>`);\n      xmlParts.push(`      <ValoracionEur>${pos.valorEurAFinDeAno.toFixed(2)}</ValoracionEur>`);\n      xmlParts.push(`      <FechaPrimeraAdquisicion>${this.formatDate(pos.fechaAdquisicion)}</FechaPrimeraAdquisicion>`);\n      xmlParts.push(`      <ValorAdquisicion>${pos.valorAdquisicionEur.toFixed(2)}</ValorAdquisicion>`);\n      xmlParts.push(`      <PorcentajeTitularidad>${pos.porcentajeTitularidad}</PorcentajeTitularidad>`);\n      xmlParts.push(`      <ClaveCondicion>T</ClaveCondicion>`); // T = Titular\n      xmlParts.push('    </Bien>');\n    }\n\n    xmlParts.push('  </DetalleBienes>');\n    xmlParts.push('</Modelo721>');\n\n    return xmlParts.join('\\n');\n  }\n\n  /**\n   * Exporta el Modelo 720 Subgrupo 8 (criptomonedas) en formato XML AEAT\n   */\n  async exportModelo720ToAEATFormat(companyId: string, year: number): Promise<string> {\n    const items = await this.generateModelo720Crypto(companyId, year);\n\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    if (!company) {\n      throw new Error('Empresa no encontrada');\n    }\n\n    const totalValor = items.reduce(\n      (sum, item) => sum.plus(item.valoracionEur),\n      new Decimal(0),\n    );\n\n    const xmlParts: string[] = [];\n\n    xmlParts.push('<?xml version=\"1.0\" encoding=\"UTF-8\"?>');\n    xmlParts.push('<Modelo720 xmlns=\"https://www.agenciatributaria.gob.es/static_files/Sede/Programas_ayuda/Modelos_700_799/Modelo_720\">');\n\n    xmlParts.push('  <DatosIdentificativos>');\n    xmlParts.push(`    <Ejercicio>${year}</Ejercicio>`);\n    xmlParts.push(`    <NIF>${this.escapeXml(company.taxId || '')}</NIF>`);\n    xmlParts.push(`    <Denominacion>${this.escapeXml(company.name)}</Denominacion>`);\n    xmlParts.push('  </DatosIdentificativos>');\n\n    // Subgrupo 8: Monedas virtuales\n    xmlParts.push('  <Subgrupo8_MonedasVirtuales>');\n    xmlParts.push(`    <NumeroRegistros>${items.length}</NumeroRegistros>`);\n    xmlParts.push(`    <TotalValoracion>${totalValor.toFixed(2)}</TotalValoracion>`);\n\n    for (const [index, item] of items.entries()) {\n      xmlParts.push(`    <MonedaVirtual numero=\"${index + 1}\">`);\n      xmlParts.push(`      <ClaveIdentificacion>${this.escapeXml(item.claveIdentificacion)}</ClaveIdentificacion>`);\n      xmlParts.push(`      <Denominacion>${this.escapeXml(item.denominacionCripto)}</Denominacion>`);\n      xmlParts.push(`      <SaldoCantidad>${item.saldoCantidad.toFixed(8)}</SaldoCantidad>`);\n      xmlParts.push(`      <ValoracionEur>${item.valoracionEur.toFixed(2)}</ValoracionEur>`);\n      xmlParts.push(`      <CodigoPais>${item.codigoPais}</CodigoPais>`);\n      xmlParts.push(`      <ClaveCondicion>${item.claveCondicion}</ClaveCondicion>`);\n      xmlParts.push(`      <FechaPrimeraAdquisicion>${this.formatDate(item.fechaPrimeraAdquisicion)}</FechaPrimeraAdquisicion>`);\n      xmlParts.push(`      <OrigenAdquisicion>${this.escapeXml(item.origenAdquisicion)}</OrigenAdquisicion>`);\n      xmlParts.push('    </MonedaVirtual>');\n    }\n\n    xmlParts.push('  </Subgrupo8_MonedasVirtuales>');\n    xmlParts.push('</Modelo720>');\n\n    return xmlParts.join('\\n');\n  }\n\n  /**\n   * Escape XML special characters\n   */\n  private escapeXml(str: string): string {\n    return str\n      .replace(/&/g, '&amp;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;')\n      .replace(/\"/g, '&quot;')\n      .replace(/'/g, '&apos;');\n  }\n\n  /**\n   * Format date as YYYY-MM-DD\n   */\n  private formatDate(date: Date): string {\n    return date.toISOString().split('T')[0];\n  }\n\n  /**\n   * Genera CSV para revisión manual\n   */\n  async exportToCSV(companyId: string, year: number): Promise<string> {\n    const modelo = await this.generateModelo721(companyId, year);\n\n    const headers = [\n      'Criptomoneda',\n      'Nombre',\n      'Exchange/Wallet',\n      'País',\n      'Saldo 31/12',\n      'Valor EUR 31/12',\n      'Fecha Adquisición',\n      'Valor Adquisición EUR',\n      '% Titularidad',\n    ];\n\n    const rows = modelo.posiciones.map((pos) => [\n      pos.tipoMoneda,\n      pos.nombreMoneda,\n      pos.nombreExchange,\n      pos.paisExchange,\n      pos.saldoAFinDeAno.toFixed(8),\n      pos.valorEurAFinDeAno.toFixed(2),\n      this.formatDate(pos.fechaAdquisicion),\n      pos.valorAdquisicionEur.toFixed(2),\n      pos.porcentajeTitularidad.toString(),\n    ]);\n\n    const csv = [\n      headers.join(';'),\n      ...rows.map((row) => row.join(';')),\n      '',\n      `Total Valor EUR;${modelo.totalValorEur.toFixed(2)}`,\n      `Obligado a declarar;${modelo.obligadoDeclarar ? 'Sí' : 'No'}`,\n      `Variación significativa;${modelo.variacionSignificativa ? 'Sí' : 'No'}`,\n    ];\n\n    return csv.join('\\n');\n  }\n\n  /**\n   * Obtiene precios históricos de la tabla PriceHistory\n   * Fallback a precios por defecto si no hay datos\n   */\n  private async getPricesAtDate(date: Date): Promise<Map<string, Decimal>> {\n    const prices = new Map<string, Decimal>();\n\n    // Buscar en PriceHistory el precio más cercano a la fecha\n    const priceRecords = await this.prisma.priceHistory.findMany({\n      where: {\n        timestamp: {\n          gte: new Date(date.getTime() - 24 * 60 * 60 * 1000), // 24h antes\n          lte: date,\n        },\n      },\n      orderBy: { timestamp: 'desc' },\n    });\n\n    // Agrupar por símbolo, tomando el más reciente\n    const seenSymbols = new Set<string>();\n    for (const record of priceRecords) {\n      if (!seenSymbols.has(record.symbol)) {\n        seenSymbols.add(record.symbol);\n        prices.set(record.symbol, new Decimal(record.priceEur));\n      }\n    }\n\n    // Precios de fallback si no hay datos históricos\n    const defaultPrices: Record<string, number> = {\n      BTC: 42000,\n      ETH: 2200,\n      USDT: 0.92,\n      USDC: 0.92,\n      SOL: 85,\n      BNB: 280,\n      XRP: 0.55,\n      ADA: 0.52,\n      DOT: 6.5,\n      MATIC: 0.85,\n      AVAX: 35,\n      LINK: 14,\n      UNI: 6,\n      AAVE: 90,\n    };\n\n    // Obtener todos los assets y añadir fallbacks\n    const assets = await this.prisma.cryptoAsset.findMany();\n\n    for (const asset of assets) {\n      if (!prices.has(asset.symbol)) {\n        const fallbackPrice = defaultPrices[asset.symbol] || 1;\n        prices.set(asset.symbol, new Decimal(fallbackPrice));\n        this.logger.warn(\n          `No hay precio histórico para ${asset.symbol} a ${this.formatDate(date)}, usando fallback: ${fallbackPrice} EUR`,\n        );\n      }\n    }\n\n    return prices;\n  }\n\n  /**\n   * Obtiene el total declarado en el año anterior\n   * Útil para determinar variación significativa (>20,000 EUR)\n   */\n  private async getPreviousYearTotal(companyId: string, year: number): Promise<Decimal> {\n    // Buscar si hay un reporte guardado del año anterior\n    // Esto requeriría una tabla FiscalReport para almacenar históricos\n    // Por ahora, generamos el modelo del año anterior si hay datos\n\n    try {\n      const previousModelo = await this.generateModelo721(companyId, year);\n      return previousModelo.totalValorEur;\n    } catch {\n      // Si no hay datos del año anterior, retornamos 0\n      return new Decimal(0);\n    }\n  }\n\n  /**\n   * Valida si los datos están completos para presentar el modelo\n   */\n  async validateForSubmission(\n    companyId: string,\n    year: number,\n  ): Promise<{\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n  }> {\n    const modelo = await this.generateModelo721(companyId, year);\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    // Obtener datos de la empresa para validación\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    if (!company?.taxId) {\n      errors.push('La empresa no tiene NIF configurado');\n    }\n\n    // Validaciones de posiciones\n    for (const pos of modelo.posiciones) {\n      if (!pos.paisExchange || pos.paisExchange.length !== 2) {\n        errors.push(`${pos.tipoMoneda}: País del exchange inválido (debe ser código ISO de 2 letras)`);\n      }\n\n      if (pos.valorEurAFinDeAno.lte(0)) {\n        warnings.push(`${pos.tipoMoneda} en ${pos.nombreExchange}: Valor a fin de año es 0 o negativo`);\n      }\n\n      if (!pos.fechaAdquisicion) {\n        errors.push(`${pos.tipoMoneda}: Falta fecha de primera adquisición`);\n      }\n\n      if (pos.valorAdquisicionEur.lte(0)) {\n        warnings.push(`${pos.tipoMoneda}: Valor de adquisición es 0 - verificar datos`);\n      }\n\n      // Verificar coherencia: valor actual vs coste\n      const ratio = pos.valorEurAFinDeAno.div(pos.valorAdquisicionEur);\n      if (ratio.gt(100) || ratio.lt(0.01)) {\n        warnings.push(\n          `${pos.tipoMoneda}: Diferencia extrema entre valor actual (${pos.valorEurAFinDeAno.toFixed(2)} EUR) ` +\n            `y coste (${pos.valorAdquisicionEur.toFixed(2)} EUR) - verificar precios`,\n        );\n      }\n    }\n\n    // Validaciones globales\n    if (!modelo.obligadoDeclarar) {\n      warnings.push(\n        `Valor total (${modelo.totalValorEur.toFixed(2)} EUR) no supera umbral de 50,000 EUR - ` +\n          `no hay obligación de declarar el Modelo 721`,\n      );\n    }\n\n    if (modelo.obligadoDeclarar && modelo.posiciones.length === 0) {\n      errors.push('Obligado a declarar pero no hay posiciones - verificar datos de wallets y exchanges');\n    }\n\n    // Verificar que hay precios históricos disponibles\n    const endOfYear = new Date(year, 11, 31);\n    const priceCheck = await this.prisma.priceHistory.count({\n      where: {\n        timestamp: {\n          gte: new Date(endOfYear.getTime() - 7 * 24 * 60 * 60 * 1000),\n          lte: endOfYear,\n        },\n      },\n    });\n\n    if (priceCheck === 0) {\n      warnings.push(\n        `No hay precios históricos para la fecha 31/12/${year}. ` +\n          `Los valores mostrados son estimaciones y deben verificarse.`,\n      );\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors,\n      warnings,\n    };\n  }\n\n  /**\n   * Genera un resumen ejecutivo del Modelo 721\n   */\n  async getSummary(\n    companyId: string,\n    year: number,\n  ): Promise<{\n    obligado: boolean;\n    totalEur: string;\n    numPosiciones: number;\n    topAssets: Array<{ symbol: string; valorEur: string; porcentaje: string }>;\n    topExchanges: Array<{ nombre: string; valorEur: string; pais: string }>;\n  }> {\n    const modelo = await this.generateModelo721(companyId, year);\n\n    // Agrupar por asset\n    const byAsset = new Map<string, Decimal>();\n    for (const pos of modelo.posiciones) {\n      const current = byAsset.get(pos.tipoMoneda) || new Decimal(0);\n      byAsset.set(pos.tipoMoneda, current.plus(pos.valorEurAFinDeAno));\n    }\n\n    // Agrupar por exchange\n    const byExchange = new Map<string, { valor: Decimal; pais: string }>();\n    for (const pos of modelo.posiciones) {\n      const current = byExchange.get(pos.nombreExchange) || { valor: new Decimal(0), pais: pos.paisExchange };\n      current.valor = current.valor.plus(pos.valorEurAFinDeAno);\n      byExchange.set(pos.nombreExchange, current);\n    }\n\n    // Top 5 assets\n    const topAssets = Array.from(byAsset.entries())\n      .sort((a, b) => b[1].minus(a[1]).toNumber())\n      .slice(0, 5)\n      .map(([symbol, valor]) => ({\n        symbol,\n        valorEur: valor.toFixed(2),\n        porcentaje: modelo.totalValorEur.gt(0)\n          ? valor.div(modelo.totalValorEur).mul(100).toFixed(1)\n          : '0',\n      }));\n\n    // Top 5 exchanges\n    const topExchanges = Array.from(byExchange.entries())\n      .sort((a, b) => b[1].valor.minus(a[1].valor).toNumber())\n      .slice(0, 5)\n      .map(([nombre, data]) => ({\n        nombre,\n        valorEur: data.valor.toFixed(2),\n        pais: data.pais,\n      }));\n\n    return {\n      obligado: modelo.obligadoDeclarar,\n      totalEur: modelo.totalValorEur.toFixed(2),\n      numPosiciones: modelo.posiciones.length,\n      topAssets,\n      topExchanges,\n    };\n  }\n}\n"],"names":["Modelo721Service","EXCHANGE_COUNTRIES","COINBASE","KRAKEN","BINANCE","BITSTAMP","GEMINI","KUCOIN","BITFINEX","FTX","BYBIT","OKX","generateModelo721","companyId","year","endOfYear","Date","wallets","exchangeAccounts","Promise","all","prisma","wallet","findMany","where","isActive","include","transactions","blockTimestamp","lte","orderBy","exchangeAccount","lots","cryptoLot","cryptoAsset","balancesBySource","Map","country","getWalletCountry","chain","tx","assetIn","amountIn","sourceKey","id","has","set","asset","assetName","source","address","slice","sourceName","label","balance","Decimal","costBasis","firstAcquisition","entry","get","amount","priceEur","priceInEur","includes","type","plus","mul","assetOut","amountOut","minus","exchange","toUpperCase","exchangeLots","filter","l","sourceType","toLowerCase","lot","remaining","remainingAmount","symbol","name","costBasisEur","acquiredAt","pricesAtYearEnd","getPricesAtDate","posiciones","data","valorFinAno","push","tipoMoneda","nombreMoneda","claveExchange","nombreExchange","paisExchange","saldoAFinDeAno","valorEurAFinDeAno","fechaAdquisicion","valorAdquisicionEur","porcentajeTitularidad","totalValorEur","reduce","sum","p","previousYear","getPreviousYearTotal","variacion","abs","summary","ejercicio","fechaGeneracion","obligadoDeclarar","gt","variacionSignificativa","logger","log","length","toFixed","chainCountries","ethereum","polygon","bsc","arbitrum","optimism","avalanche","solana","bitcoin","generateModelo720Crypto","modelo721","map","pos","claveIdentificacion","denominacionCripto","saldoCantidad","valoracionEur","codigoPais","claveCondicion","fechaPrimeraAdquisicion","origenAdquisicion","exportToAEATFormat","modelo","company","findUnique","Error","xmlParts","escapeXml","taxId","toISOString","index","entries","formatDate","join","exportModelo720ToAEATFormat","items","totalValor","item","str","replace","date","split","exportToCSV","headers","rows","toString","csv","row","prices","priceRecords","priceHistory","timestamp","gte","getTime","seenSymbols","Set","record","add","defaultPrices","BTC","ETH","USDT","USDC","SOL","BNB","XRP","ADA","DOT","MATIC","AVAX","LINK","UNI","AAVE","assets","fallbackPrice","warn","previousModelo","validateForSubmission","errors","warnings","ratio","div","lt","priceCheck","count","valid","getSummary","byAsset","current","byExchange","valor","pais","topAssets","Array","from","sort","a","b","toNumber","valorEur","porcentaje","topExchanges","nombre","obligado","totalEur","numPosiciones","Logger"],"mappings":"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"}