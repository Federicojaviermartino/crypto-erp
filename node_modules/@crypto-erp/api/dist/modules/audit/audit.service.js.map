{"version":3,"sources":["../../../src/modules/audit/audit.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { AuditAction, AuditLog } from '@prisma/client';\n\nexport interface AuditLogParams {\n  userId: string;\n  companyId?: string;\n  action: AuditAction;\n  entity: string;\n  entityId: string;\n  changes?: any;\n  metadata?: any;\n}\n\n@Injectable()\nexport class AuditService {\n  private readonly logger = new Logger(AuditService.name);\n\n  constructor(private prisma: PrismaService) {}\n\n  /**\n   * Create an audit log entry\n   */\n  async log(params: AuditLogParams): Promise<void> {\n    try {\n      await this.prisma.auditLog.create({\n        data: {\n          userId: params.userId,\n          companyId: params.companyId,\n          action: params.action,\n          entity: params.entity,\n          entityId: params.entityId,\n          changes: params.changes || null,\n          metadata: params.metadata || null,\n        },\n      });\n\n      this.logger.log(\n        `Audit log created: ${params.action} on ${params.entity}:${params.entityId} by user ${params.userId}`,\n      );\n    } catch (error) {\n      this.logger.error('Failed to create audit log:', error);\n      // Don't throw - audit logging should not break the main flow\n    }\n  }\n\n  /**\n   * Find audit logs by entity\n   */\n  async findByEntity(entity: string, entityId: string): Promise<AuditLog[]> {\n    return this.prisma.auditLog.findMany({\n      where: {\n        entity,\n        entityId,\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            email: true,\n            firstName: true,\n            lastName: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n    });\n  }\n\n  /**\n   * Find audit logs by user\n   */\n  async findByUser(userId: string, limit: number = 100): Promise<AuditLog[]> {\n    return this.prisma.auditLog.findMany({\n      where: {\n        userId,\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n      take: limit,\n    });\n  }\n\n  /**\n   * Find audit logs by company\n   */\n  async findByCompany(\n    companyId: string,\n    options?: {\n      limit?: number;\n      offset?: number;\n      entity?: string;\n      action?: AuditAction;\n    },\n  ): Promise<AuditLog[]> {\n    const where: any = { companyId };\n\n    if (options?.entity) {\n      where.entity = options.entity;\n    }\n\n    if (options?.action) {\n      where.action = options.action;\n    }\n\n    return this.prisma.auditLog.findMany({\n      where,\n      include: {\n        user: {\n          select: {\n            id: true,\n            email: true,\n            firstName: true,\n            lastName: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n      take: options?.limit || 100,\n      skip: options?.offset || 0,\n    });\n  }\n\n  /**\n   * Export all audit logs for a user (for GDPR)\n   */\n  async exportForGDPR(userId: string): Promise<AuditLog[]> {\n    return this.prisma.auditLog.findMany({\n      where: {\n        userId,\n      },\n      orderBy: {\n        createdAt: 'asc',\n      },\n    });\n  }\n\n  /**\n   * Clean up old audit logs (optional - for retention policies)\n   */\n  async cleanupOldLogs(olderThanDays: number): Promise<number> {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - olderThanDays);\n\n    const result = await this.prisma.auditLog.deleteMany({\n      where: {\n        createdAt: {\n          lt: cutoffDate,\n        },\n      },\n    });\n\n    this.logger.log(`Deleted ${result.count} audit logs older than ${olderThanDays} days`);\n\n    return result.count;\n  }\n}\n"],"names":["AuditService","log","params","prisma","auditLog","create","data","userId","companyId","action","entity","entityId","changes","metadata","logger","error","findByEntity","findMany","where","include","user","select","id","email","firstName","lastName","orderBy","createdAt","findByUser","limit","take","findByCompany","options","skip","offset","exportForGDPR","cleanupOldLogs","olderThanDays","cutoffDate","Date","setDate","getDate","result","deleteMany","lt","count","Logger","name"],"mappings":"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"}