{"version":3,"sources":["../../../../src/modules/auth/strategies/saml.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Strategy, Profile } from 'passport-saml';\nimport { ConfigService } from '@nestjs/config';\nimport { AuthService } from '../auth.service';\n\n@Injectable()\nexport class SamlStrategy extends PassportStrategy(Strategy, 'saml') {\n  constructor(\n    private configService: ConfigService,\n    private authService: AuthService,\n  ) {\n    super({\n      entryPoint: configService.get<string>('SAML_ENTRY_POINT'),\n      issuer: configService.get<string>('SAML_ISSUER'),\n      callbackUrl: configService.get<string>('SAML_CALLBACK_URL'),\n      cert: configService.get<string>('SAML_CERT'),\n      acceptedClockSkewMs: -1,\n      identifierFormat: null,\n      signatureAlgorithm: 'sha256',\n      digestAlgorithm: 'sha256',\n    });\n  }\n\n  async validate(profile: Profile): Promise<any> {\n    try {\n      const { nameID, email, firstName, lastName, displayName } = profile;\n\n      if (!email && !nameID) {\n        throw new UnauthorizedException('No email found in SAML profile');\n      }\n\n      const userEmail = email || nameID;\n      const fname = firstName || displayName?.split(' ')[0] || 'User';\n      const lname = lastName || displayName?.split(' ').slice(1).join(' ') || 'User';\n\n      // Auto-provision or find existing SSO user\n      const user = await this.authService.findOrCreateSSOUser({\n        ssoProvider: 'saml',\n        ssoId: nameID,\n        email: userEmail,\n        firstName: fname,\n        lastName: lname,\n        ssoMetadata: {\n          sessionIndex: profile.sessionIndex,\n          attributes: profile,\n        },\n      });\n\n      return user;\n    } catch (error) {\n      throw new UnauthorizedException(error.message);\n    }\n  }\n}\n"],"names":["SamlStrategy","PassportStrategy","Strategy","validate","profile","nameID","email","firstName","lastName","displayName","UnauthorizedException","userEmail","fname","split","lname","slice","join","user","authService","findOrCreateSSOUser","ssoProvider","ssoId","ssoMetadata","sessionIndex","attributes","error","message","configService","entryPoint","get","issuer","callbackUrl","cert","acceptedClockSkewMs","identifierFormat","signatureAlgorithm","digestAlgorithm"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPqC;0BACjB;8BACC;wBACJ;6BACF;;;;;;;;;;AAGrB,IAAA,AAAMA,eAAN,MAAMA,qBAAqBC,IAAAA,0BAAgB,EAACC,sBAAQ,EAAE;IAiB3D,MAAMC,SAASC,OAAgB,EAAgB;QAC7C,IAAI;YACF,MAAM,EAAEC,MAAM,EAAEC,KAAK,EAAEC,SAAS,EAAEC,QAAQ,EAAEC,WAAW,EAAE,GAAGL;YAE5D,IAAI,CAACE,SAAS,CAACD,QAAQ;gBACrB,MAAM,IAAIK,6BAAqB,CAAC;YAClC;YAEA,MAAMC,YAAYL,SAASD;YAC3B,MAAMO,QAAQL,aAAaE,aAAaI,MAAM,IAAI,CAAC,EAAE,IAAI;YACzD,MAAMC,QAAQN,YAAYC,aAAaI,MAAM,KAAKE,MAAM,GAAGC,KAAK,QAAQ;YAExE,2CAA2C;YAC3C,MAAMC,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,mBAAmB,CAAC;gBACtDC,aAAa;gBACbC,OAAOhB;gBACPC,OAAOK;gBACPJ,WAAWK;gBACXJ,UAAUM;gBACVQ,aAAa;oBACXC,cAAcnB,QAAQmB,YAAY;oBAClCC,YAAYpB;gBACd;YACF;YAEA,OAAOa;QACT,EAAE,OAAOQ,OAAO;YACd,MAAM,IAAIf,6BAAqB,CAACe,MAAMC,OAAO;QAC/C;IACF;IA7CA,YACE,AAAQC,aAA4B,EACpC,AAAQT,WAAwB,CAChC;QACA,KAAK,CAAC;YACJU,YAAYD,cAAcE,GAAG,CAAS;YACtCC,QAAQH,cAAcE,GAAG,CAAS;YAClCE,aAAaJ,cAAcE,GAAG,CAAS;YACvCG,MAAML,cAAcE,GAAG,CAAS;YAChCI,qBAAqB,CAAC;YACtBC,kBAAkB;YAClBC,oBAAoB;YACpBC,iBAAiB;QACnB,SAZQT,gBAAAA,oBACAT,cAAAA;IAYV;AAgCF"}