{"version":3,"sources":["../../../src/modules/fiscal/sii.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { Invoice, InvoiceType, InvoiceDirection } from '@prisma/client';\nimport { AEATClientService } from '../invoicing/verifactu/aeat-client.service.js';\nimport { create } from 'xmlbuilder2';\n\n/**\n * SII - Suministro Inmediato de Información\n * Sistema de envío inmediato de facturas a la AEAT (plazo: 4 días)\n *\n * Tipos de registro:\n * - Facturas Emitidas (ventas)\n * - Facturas Recibidas (compras)\n * - Bienes de Inversión\n * - Cobros/Pagos en metálico\n *\n * Endpoint AEAT: https://www1.agenciatributaria.gob.es/wlpl/SSII-FACT/ws/fe/SiiFactFEV1SOAP\n */\n\ninterface SIIInvoiceData {\n  // Invoice ID\n  invoiceId: string;\n  fullNumber: string;\n  issueDate: Date;\n  type: InvoiceType;\n  direction: InvoiceDirection;\n\n  // Counterparty\n  counterpartyName: string;\n  counterpartyTaxId: string | null;\n  counterpartyCountry: string;\n\n  // Amounts\n  taxableBase: number;\n  totalTax: number;\n  total: number;\n\n  // Tax breakdown\n  taxes: Array<{\n    rate: number;\n    base: number;\n    amount: number;\n  }>;\n\n  // Special cases\n  cryptoPayment: boolean;\n  intraEU: boolean;\n  export: boolean;\n}\n\ninterface SIISubmissionResult {\n  invoiceId: string;\n  success: boolean;\n  csv?: string; // Código Seguro Verificación from AEAT\n  errors?: string[];\n  submittedAt: Date;\n}\n\n@Injectable()\nexport class SIIService {\n  private readonly logger = new Logger(SIIService.name);\n\n  // SII SOAP endpoints\n  private readonly SII_ENDPOINT_PRODUCTION =\n    'https://www1.agenciatributaria.gob.es/wlpl/SSII-FACT/ws/fe/SiiFactFEV1SOAP';\n  private readonly SII_ENDPOINT_TEST =\n    'https://prewww1.aeat.es/wlpl/SSII-FACT/ws/fe/SiiFactFEV1SOAP';\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly aeatClient: AEATClientService,\n  ) {}\n\n  /**\n   * Send issued invoices (Facturas Emitidas) to AEAT\n   */\n  async submitIssuedInvoices(\n    companyId: string,\n    invoiceIds: string[],\n  ): Promise<SIISubmissionResult[]> {\n    this.logger.log(\n      `Submitting ${invoiceIds.length} issued invoices to SII for company ${companyId}`,\n    );\n\n    const company = await this.prisma.company.findUniqueOrThrow({\n      where: { id: companyId },\n    });\n\n    const invoices = await this.prisma.invoice.findMany({\n      where: {\n        id: { in: invoiceIds },\n        companyId,\n        direction: 'SALE', // Only issued invoices\n        status: { in: ['SENT', 'PAID', 'OVERDUE'] }, // Only final invoices\n      },\n      include: {\n        taxes: true,\n        lines: true,\n      },\n    });\n\n    if (invoices.length === 0) {\n      this.logger.warn('No valid invoices to submit');\n      return [];\n    }\n\n    // Generate SII XML for issued invoices\n    const xml = this.generateIssuedInvoicesXML(company.taxId, company.name, invoices);\n\n    // Send to AEAT via SOAP\n    const endpoint = this.getSIIEndpoint();\n    const results: SIISubmissionResult[] = [];\n\n    try {\n      const response = await this.aeatClient.sendSoapRequest(\n        endpoint,\n        'SuministroLRFacturasEmitidas',\n        xml,\n      );\n\n      // Parse response and update invoices\n      for (const invoice of invoices) {\n        const accepted = this.parseResponseForInvoice(response, invoice.fullNumber);\n\n        await this.prisma.invoice.update({\n          where: { id: invoice.id },\n          data: {\n            verifactuSentAt: new Date(),\n            verifactuStatus: accepted ? 'ACCEPTED' : 'REJECTED',\n            verifactuResponse: response,\n          },\n        });\n\n        results.push({\n          invoiceId: invoice.id,\n          success: accepted,\n          csv: accepted ? this.extractCSV(response) : undefined,\n          errors: accepted ? undefined : this.extractErrors(response),\n          submittedAt: new Date(),\n        });\n      }\n\n      this.logger.log(\n        `SII submission completed: ${results.filter((r) => r.success).length}/${results.length} accepted`,\n      );\n    } catch (error) {\n      this.logger.error('Failed to submit to SII:', error);\n\n      // Mark all as failed\n      for (const invoice of invoices) {\n        results.push({\n          invoiceId: invoice.id,\n          success: false,\n          errors: [error.message],\n          submittedAt: new Date(),\n        });\n      }\n    }\n\n    return results;\n  }\n\n  /**\n   * Send received invoices (Facturas Recibidas) to AEAT\n   */\n  async submitReceivedInvoices(\n    companyId: string,\n    invoiceIds: string[],\n  ): Promise<SIISubmissionResult[]> {\n    this.logger.log(\n      `Submitting ${invoiceIds.length} received invoices to SII for company ${companyId}`,\n    );\n\n    const company = await this.prisma.company.findUniqueOrThrow({\n      where: { id: companyId },\n    });\n\n    const invoices = await this.prisma.invoice.findMany({\n      where: {\n        id: { in: invoiceIds },\n        companyId,\n        direction: 'PURCHASE', // Only received invoices\n        status: { in: ['SENT', 'PAID', 'OVERDUE'] },\n      },\n      include: {\n        taxes: true,\n        lines: true,\n      },\n    });\n\n    if (invoices.length === 0) {\n      this.logger.warn('No valid invoices to submit');\n      return [];\n    }\n\n    // Generate SII XML for received invoices\n    const xml = this.generateReceivedInvoicesXML(company.taxId, company.name, invoices);\n\n    // Send to AEAT via SOAP\n    const endpoint = this.getSIIEndpoint();\n    const results: SIISubmissionResult[] = [];\n\n    try {\n      const response = await this.aeatClient.sendSoapRequest(\n        endpoint,\n        'SuministroLRFacturasRecibidas',\n        xml,\n      );\n\n      // Parse response and update invoices\n      for (const invoice of invoices) {\n        const accepted = this.parseResponseForInvoice(response, invoice.fullNumber);\n\n        await this.prisma.invoice.update({\n          where: { id: invoice.id },\n          data: {\n            verifactuSentAt: new Date(),\n            verifactuStatus: accepted ? 'ACCEPTED' : 'REJECTED',\n            verifactuResponse: response,\n          },\n        });\n\n        results.push({\n          invoiceId: invoice.id,\n          success: accepted,\n          csv: accepted ? this.extractCSV(response) : undefined,\n          errors: accepted ? undefined : this.extractErrors(response),\n          submittedAt: new Date(),\n        });\n      }\n\n      this.logger.log(\n        `SII submission completed: ${results.filter((r) => r.success).length}/${results.length} accepted`,\n      );\n    } catch (error) {\n      this.logger.error('Failed to submit to SII:', error);\n\n      for (const invoice of invoices) {\n        results.push({\n          invoiceId: invoice.id,\n          success: false,\n          errors: [error.message],\n          submittedAt: new Date(),\n        });\n      }\n    }\n\n    return results;\n  }\n\n  /**\n   * Get invoices pending SII submission (issued >4 days ago, not sent)\n   */\n  async getPendingSubmissions(companyId: string): Promise<Invoice[]> {\n    const fourDaysAgo = new Date();\n    fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);\n\n    return this.prisma.invoice.findMany({\n      where: {\n        companyId,\n        issueDate: { lte: fourDaysAgo },\n        status: { in: ['SENT', 'PAID', 'OVERDUE'] },\n        verifactuSentAt: null, // Not sent to SII yet\n        // Exclude exports and intra-EU (different regime)\n        counterpartyCountry: 'ES',\n      },\n      include: {\n        taxes: true,\n      },\n      orderBy: {\n        issueDate: 'asc',\n      },\n    });\n  }\n\n  /**\n   * Generate XML for issued invoices (Facturas Emitidas)\n   */\n  private generateIssuedInvoicesXML(\n    declarantNif: string,\n    declarantName: string,\n    invoices: any[],\n  ): string {\n    const doc = create({ version: '1.0', encoding: 'UTF-8' })\n      .ele('sii:SuministroLRFacturasEmitidas', {\n        'xmlns:sii': 'https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroInformacion.xsd',\n      })\n      .ele('sii:Cabecera')\n      .ele('sii:IDVersionSii').txt('1.1').up()\n      .ele('sii:Titular')\n      .ele('sii:NIF').txt(declarantNif).up()\n      .ele('sii:NombreRazon').txt(declarantName).up()\n      .up() // Close Titular\n      .ele('sii:TipoComunicacion').txt('A0').up() // A0 = Alta de facturas\n      .up(); // Close Cabecera\n\n    const registros = doc.ele('sii:RegistroLRFacturasEmitidas');\n\n    for (const invoice of invoices) {\n      const registro = registros.ele('sii:RegistroLRFacturasEmitidas');\n\n      // Periodo impositivo\n      const year = invoice.issueDate.getFullYear();\n      const month = String(invoice.issueDate.getMonth() + 1).padStart(2, '0');\n\n      registro\n        .ele('sii:PeriodoImpositivo')\n        .ele('sii:Ejercicio').txt(year.toString()).up()\n        .ele('sii:Periodo').txt(month).up()\n        .up();\n\n      // ID factura\n      registro\n        .ele('sii:IDFactura')\n        .ele('sii:IDEmisorFactura')\n        .ele('sii:NIF').txt(declarantNif).up()\n        .up()\n        .ele('sii:NumSerieFacturaEmisor').txt(invoice.fullNumber).up()\n        .ele('sii:FechaExpedicionFacturaEmisor').txt(this.formatDate(invoice.issueDate)).up()\n        .up();\n\n      // Factura\n      const facturaNode = registro.ele('sii:FacturaExpedida');\n      facturaNode\n        .ele('sii:TipoFactura').txt(this.getSIIInvoiceType(invoice)).up()\n        .ele('sii:ClaveRegimenEspecialOTrascendencia').txt('01').up() // 01 = Régimen general\n        .ele('sii:DescripcionOperacion').txt(this.getInvoiceDescription(invoice)).up();\n\n      // Contraparte (if exists)\n      if (invoice.counterpartyTaxId) {\n        facturaNode\n          .ele('sii:Contraparte')\n          .ele('sii:NombreRazon').txt(invoice.counterpartyName).up()\n          .ele('sii:NIF').txt(invoice.counterpartyTaxId).up()\n          .up();\n      }\n\n      // Importe total\n      facturaNode\n        .ele('sii:TipoDesglose')\n        .ele('sii:DesgloseFactura')\n        .ele('sii:Sujeta')\n        .ele('sii:NoExenta')\n        .ele('sii:TipoNoExenta').txt('S1').up() // S1 = Sujeto/No exento\n        .ele('sii:DesgloseIVA');\n\n      // Tax breakdown\n      for (const tax of invoice.taxes) {\n        facturaNode\n          .ele('sii:DetalleIVA')\n          .ele('sii:TipoImpositivo').txt(tax.taxRate.toFixed(2)).up()\n          .ele('sii:BaseImponible').txt(tax.taxableBase.toFixed(2)).up()\n          .ele('sii:CuotaRepercutida').txt(tax.taxAmount.toFixed(2)).up()\n          .up();\n      }\n\n      facturaNode.up().up().up().up().up(); // Close nested elements\n\n      // Import total\n      facturaNode.ele('sii:ImporteTotal').txt(invoice.total.toFixed(2)).up();\n\n      facturaNode.up(); // Close FacturaExpedida\n      registro.up(); // Close RegistroLRFacturasEmitidas\n    }\n\n    return doc.end({ prettyPrint: true });\n  }\n\n  /**\n   * Generate XML for received invoices (Facturas Recibidas)\n   */\n  private generateReceivedInvoicesXML(\n    declarantNif: string,\n    declarantName: string,\n    invoices: any[],\n  ): string {\n    const doc = create({ version: '1.0', encoding: 'UTF-8' })\n      .ele('sii:SuministroLRFacturasRecibidas', {\n        'xmlns:sii': 'https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/ssii/fact/ws/SuministroInformacion.xsd',\n      })\n      .ele('sii:Cabecera')\n      .ele('sii:IDVersionSii').txt('1.1').up()\n      .ele('sii:Titular')\n      .ele('sii:NIF').txt(declarantNif).up()\n      .ele('sii:NombreRazon').txt(declarantName).up()\n      .up()\n      .ele('sii:TipoComunicacion').txt('A0').up()\n      .up();\n\n    const registros = doc.ele('sii:RegistroLRFacturasRecibidas');\n\n    for (const invoice of invoices) {\n      const registro = registros.ele('sii:RegistroLRFacturasRecibidas');\n\n      const year = invoice.issueDate.getFullYear();\n      const month = String(invoice.issueDate.getMonth() + 1).padStart(2, '0');\n\n      registro\n        .ele('sii:PeriodoImpositivo')\n        .ele('sii:Ejercicio').txt(year.toString()).up()\n        .ele('sii:Periodo').txt(month).up()\n        .up();\n\n      registro\n        .ele('sii:IDFactura')\n        .ele('sii:IDEmisorFactura');\n\n      if (invoice.counterpartyTaxId) {\n        registro.ele('sii:NIF').txt(invoice.counterpartyTaxId).up();\n      } else {\n        registro.ele('sii:NombreRazon').txt(invoice.counterpartyName).up();\n      }\n\n      registro.up()\n        .ele('sii:NumSerieFacturaEmisor').txt(invoice.fullNumber).up()\n        .ele('sii:FechaExpedicionFacturaEmisor').txt(this.formatDate(invoice.issueDate)).up()\n        .up();\n\n      const facturaNode = registro.ele('sii:FacturaRecibida');\n      facturaNode\n        .ele('sii:TipoFactura').txt(this.getSIIInvoiceType(invoice)).up()\n        .ele('sii:ClaveRegimenEspecialOTrascendencia').txt('01').up()\n        .ele('sii:DescripcionOperacion').txt(this.getInvoiceDescription(invoice)).up()\n        .ele('sii:DesgloseFactura')\n        .ele('sii:DesgloseIVA');\n\n      for (const tax of invoice.taxes) {\n        facturaNode\n          .ele('sii:DetalleIVA')\n          .ele('sii:TipoImpositivo').txt(tax.taxRate.toFixed(2)).up()\n          .ele('sii:BaseImponible').txt(tax.taxableBase.toFixed(2)).up()\n          .ele('sii:CuotaSoportada').txt(tax.taxAmount.toFixed(2)).up()\n          .up();\n      }\n\n      facturaNode.up().up();\n      facturaNode.ele('sii:ImporteTotal').txt(invoice.total.toFixed(2)).up();\n\n      facturaNode.up();\n      registro.up();\n    }\n\n    return doc.end({ prettyPrint: true });\n  }\n\n  /**\n   * Get SII endpoint based on environment\n   */\n  private getSIIEndpoint(): string {\n    const isProduction = process.env.AEAT_ENVIRONMENT === 'production';\n    return isProduction ? this.SII_ENDPOINT_PRODUCTION : this.SII_ENDPOINT_TEST;\n  }\n\n  /**\n   * Map internal invoice type to SII type\n   */\n  private getSIIInvoiceType(invoice: any): string {\n    // F1 = Factura normal\n    // F2 = Factura simplificada\n    // R1-R5 = Rectificativas\n    if (invoice.type === 'CREDIT_NOTE') return 'R1';\n    if (invoice.type === 'DEBIT_NOTE') return 'R1';\n    return 'F1';\n  }\n\n  /**\n   * Get invoice description (first line or summary)\n   */\n  private getInvoiceDescription(invoice: any): string {\n    if (invoice.lines && invoice.lines.length > 0) {\n      return invoice.lines[0].description.substring(0, 500);\n    }\n    return `Factura ${invoice.fullNumber}`;\n  }\n\n  /**\n   * Format date to SII format (DD-MM-YYYY)\n   */\n  private formatDate(date: Date): string {\n    const day = String(date.getDate()).padStart(2, '0');\n    const month = String(date.getMonth() + 1).padStart(2, '0');\n    const year = date.getFullYear();\n    return `${day}-${month}-${year}`;\n  }\n\n  /**\n   * Parse SOAP response to check if invoice was accepted\n   */\n  private parseResponseForInvoice(response: any, invoiceNumber: string): boolean {\n    // Simplified - real implementation would parse XML response\n    return response && response.EstadoEnvio === 'Correcto';\n  }\n\n  /**\n   * Extract CSV (Código Seguro Verificación) from response\n   */\n  private extractCSV(response: any): string | undefined {\n    return response?.CSV;\n  }\n\n  /**\n   * Extract error messages from response\n   */\n  private extractErrors(response: any): string[] {\n    if (!response || !response.RespuestaLinea) return ['Unknown error'];\n\n    const errors: string[] = [];\n    const lines = Array.isArray(response.RespuestaLinea)\n      ? response.RespuestaLinea\n      : [response.RespuestaLinea];\n\n    for (const line of lines) {\n      if (line.EstadoRegistro === 'Incorrecto' && line.Errores) {\n        errors.push(...line.Errores.map((e: any) => e.DescripcionError));\n      }\n    }\n\n    return errors.length > 0 ? errors : ['Submission rejected'];\n  }\n}\n"],"names":["SIIService","submitIssuedInvoices","companyId","invoiceIds","logger","log","length","company","prisma","findUniqueOrThrow","where","id","invoices","invoice","findMany","in","direction","status","include","taxes","lines","warn","xml","generateIssuedInvoicesXML","taxId","name","endpoint","getSIIEndpoint","results","response","aeatClient","sendSoapRequest","accepted","parseResponseForInvoice","fullNumber","update","data","verifactuSentAt","Date","verifactuStatus","verifactuResponse","push","invoiceId","success","csv","extractCSV","undefined","errors","extractErrors","submittedAt","filter","r","error","message","submitReceivedInvoices","generateReceivedInvoicesXML","getPendingSubmissions","fourDaysAgo","setDate","getDate","issueDate","lte","counterpartyCountry","orderBy","declarantNif","declarantName","doc","create","version","encoding","ele","txt","up","registros","registro","year","getFullYear","month","String","getMonth","padStart","toString","formatDate","facturaNode","getSIIInvoiceType","getInvoiceDescription","counterpartyTaxId","counterpartyName","tax","taxRate","toFixed","taxableBase","taxAmount","total","end","prettyPrint","isProduction","process","env","AEAT_ENVIRONMENT","SII_ENDPOINT_PRODUCTION","SII_ENDPOINT_TEST","type","description","substring","date","day","invoiceNumber","EstadoEnvio","CSV","RespuestaLinea","Array","isArray","line","EstadoRegistro","Errores","map","e","DescripcionError","Logger"],"mappings":"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"}