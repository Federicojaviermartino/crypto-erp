{"version":3,"sources":["../../../src/common/health/health.controller.ts"],"sourcesContent":["import { Controller, Get } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { InjectQueue } from '@nestjs/bullmq';\nimport { Queue } from 'bullmq';\n\nexport interface HealthStatus {\n  status: 'ok' | 'error';\n  timestamp: Date;\n  services: {\n    database: 'healthy' | 'unhealthy';\n    redis: 'healthy' | 'unhealthy';\n  };\n  uptime: number;\n}\n\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private prisma: PrismaService,\n    @InjectQueue('email-send') private emailQueue: Queue,\n  ) {}\n\n  @Get()\n  async check(): Promise<HealthStatus> {\n    const [dbOk, redisOk] = await Promise.all([\n      this.checkDatabase(),\n      this.checkRedis(),\n    ]);\n\n    return {\n      status: dbOk && redisOk ? 'ok' : 'error',\n      timestamp: new Date(),\n      services: {\n        database: dbOk ? 'healthy' : 'unhealthy',\n        redis: redisOk ? 'healthy' : 'unhealthy',\n      },\n      uptime: process.uptime(),\n    };\n  }\n\n  @Get('liveness')\n  async liveness() {\n    return { status: 'ok', timestamp: new Date() };\n  }\n\n  @Get('readiness')\n  async readiness(): Promise<HealthStatus> {\n    return this.check();\n  }\n\n  private async checkDatabase(): Promise<boolean> {\n    try {\n      await this.prisma.$queryRaw`SELECT 1`;\n      return true;\n    } catch (error) {\n      console.error('Database health check failed:', error);\n      return false;\n    }\n  }\n\n  private async checkRedis(): Promise<boolean> {\n    try {\n      await this.emailQueue.client.ping();\n      return true;\n    } catch (error) {\n      console.error('Redis health check failed:', error);\n      return false;\n    }\n  }\n}\n"],"names":["HealthController","check","dbOk","redisOk","Promise","all","checkDatabase","checkRedis","status","timestamp","Date","services","database","redis","uptime","process","liveness","readiness","prisma","$queryRaw","error","console","emailQueue","client","ping"],"mappings":";;;;+BAgBaA;;;eAAAA;;;wBAhBmB;0BACF;wBACF;yBACN;;;;;;;;;;;;;;;AAaf,IAAA,AAAMA,mBAAN,MAAMA;IAMX,MACMC,QAA+B;QACnC,MAAM,CAACC,MAAMC,QAAQ,GAAG,MAAMC,QAAQC,GAAG,CAAC;YACxC,IAAI,CAACC,aAAa;YAClB,IAAI,CAACC,UAAU;SAChB;QAED,OAAO;YACLC,QAAQN,QAAQC,UAAU,OAAO;YACjCM,WAAW,IAAIC;YACfC,UAAU;gBACRC,UAAUV,OAAO,YAAY;gBAC7BW,OAAOV,UAAU,YAAY;YAC/B;YACAW,QAAQC,QAAQD,MAAM;QACxB;IACF;IAEA,MACME,WAAW;QACf,OAAO;YAAER,QAAQ;YAAMC,WAAW,IAAIC;QAAO;IAC/C;IAEA,MACMO,YAAmC;QACvC,OAAO,IAAI,CAAChB,KAAK;IACnB;IAEA,MAAcK,gBAAkC;QAC9C,IAAI;YACF,MAAM,IAAI,CAACY,MAAM,CAACC,SAAS,CAAC,QAAQ,CAAC;YACrC,OAAO;QACT,EAAE,OAAOC,OAAO;YACdC,QAAQD,KAAK,CAAC,iCAAiCA;YAC/C,OAAO;QACT;IACF;IAEA,MAAcb,aAA+B;QAC3C,IAAI;YACF,MAAM,IAAI,CAACe,UAAU,CAACC,MAAM,CAACC,IAAI;YACjC,OAAO;QACT,EAAE,OAAOJ,OAAO;YACdC,QAAQD,KAAK,CAAC,8BAA8BA;YAC5C,OAAO;QACT;IACF;IAnDA,YACE,AAAQF,MAAqB,EAC7B,AAAmCI,UAAiB,CACpD;aAFQJ,SAAAA;aAC2BI,aAAAA;IAClC;AAiDL"}