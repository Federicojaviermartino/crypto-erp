{"version":3,"sources":["../../../src/modules/fiscal/tax-prediction.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { PredictTaxImpactDto, TaxPredictionResponseDto, ConsumedLotDto } from './dto/predict-tax.dto.js';\n\n/**\n * Servicio de Predicción Fiscal\n * Simula impacto fiscal de transacciones crypto antes de ejecutarlas\n * usando método FIFO sin modificar la base de datos\n */\n\ninterface CostLot {\n  id: string;\n  assetSymbol: string;\n  quantity: number;\n  costBasisEur: number;\n  acquisitionDate: Date;\n  remaining: number;\n}\n\n@Injectable()\nexport class TaxPredictionService {\n  private readonly logger = new Logger(TaxPredictionService.name);\n\n  // Tramos IRPF base del ahorro 2024 (España)\n  private readonly taxBrackets = [\n    { limit: 6000, rate: 0.19 },\n    { limit: 50000, rate: 0.21 },\n    { limit: 200000, rate: 0.23 },\n    { limit: 300000, rate: 0.27 },\n    { limit: Infinity, rate: 0.28 },\n  ];\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Predice el impacto fiscal de una transacción prospectiva\n   */\n  async predictTaxImpact(\n    companyId: string,\n    dto: PredictTaxImpactDto,\n  ): Promise<TaxPredictionResponseDto> {\n    // Solo aplica a ventas\n    if (dto.transactionType === 'BUY') {\n      return this.getBuyPrediction(dto);\n    }\n\n    // Verificar que el activo existe\n    const asset = await this.prisma.cryptoAsset.findFirst({\n      where: {\n        companyId,\n        symbol: dto.asset.toUpperCase(),\n      },\n    });\n\n    if (!asset) {\n      throw new NotFoundException(`Crypto asset ${dto.asset} not found`);\n    }\n\n    // Obtener wallets de la compañía\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    if (walletIds.length === 0) {\n      throw new NotFoundException('No wallets found for this company');\n    }\n\n    // Fecha de venta (usar fecha proporcionada o fecha actual)\n    const saleDate = dto.dateOfSale ? new Date(dto.dateOfSale) : new Date();\n\n    // Construir lotes de costo hasta la fecha de venta\n    const costLots = await this.buildCostLots(\n      walletIds,\n      dto.asset.toUpperCase(),\n      saleDate,\n    );\n\n    // Calcular impacto fiscal\n    const result = this.simulateSale(\n      dto.amount,\n      dto.priceEur,\n      costLots,\n      saleDate,\n    );\n\n    // Generar recomendación\n    const recommendation = this.generateRecommendation(result.lotsConsumed, result.capitalGain);\n\n    this.logger.log(\n      `Tax prediction for ${dto.amount} ${dto.asset} at ${dto.priceEur} EUR: ` +\n      `Capital gain: ${result.capitalGain.toFixed(2)} EUR, Tax: ${result.taxOwed.toFixed(2)} EUR`\n    );\n\n    return {\n      capitalGain: result.capitalGain,\n      taxOwed: result.taxOwed,\n      effectiveTaxRate: result.effectiveTaxRate,\n      lotsConsumed: result.lotsConsumed,\n      recommendation,\n      totalProceeds: result.totalProceeds,\n      totalAcquisitionCost: result.totalAcquisitionCost,\n    };\n  }\n\n  /**\n   * Predicción para compras (sin impacto fiscal inmediato)\n   */\n  private getBuyPrediction(dto: PredictTaxImpactDto): TaxPredictionResponseDto {\n    return {\n      capitalGain: 0,\n      taxOwed: 0,\n      effectiveTaxRate: 0,\n      lotsConsumed: [],\n      recommendation: `Buying ${dto.amount} ${dto.asset} at ${dto.priceEur} EUR will add to your cost basis. No immediate tax impact.`,\n      totalProceeds: 0,\n      totalAcquisitionCost: dto.amount * dto.priceEur,\n    };\n  }\n\n  /**\n   * Construye lotes de costo para un activo específico\n   */\n  private async buildCostLots(\n    walletIds: string[],\n    assetSymbol: string,\n    upToDate: Date,\n  ): Promise<CostLot[]> {\n    // Transacciones de entrada (compras/depósitos)\n    const buyTransactions = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_IN', 'CLAIM_REWARD', 'AIRDROP'] },\n        assetIn: assetSymbol,\n        blockTimestamp: { lte: upToDate },\n      },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n\n    // Transacciones de salida previas\n    const sellTransactions = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_OUT', 'SWAP'] },\n        assetOut: assetSymbol,\n        blockTimestamp: { lte: upToDate },\n      },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n\n    const lots: CostLot[] = [];\n\n    // Crear lotes de compra\n    for (const tx of buyTransactions) {\n      const quantity = tx.amountIn?.toNumber() || 0;\n      const priceEur = tx.priceInEur?.toNumber() || 0;\n      const totalEur = quantity * priceEur;\n      const costBasis = quantity > 0 ? totalEur / quantity : 0;\n\n      lots.push({\n        id: tx.id,\n        assetSymbol,\n        quantity,\n        costBasisEur: costBasis,\n        acquisitionDate: tx.blockTimestamp,\n        remaining: quantity,\n      });\n    }\n\n    // Consumir lotes según ventas previas (FIFO)\n    for (const sellTx of sellTransactions) {\n      let remaining = sellTx.amountOut?.toNumber() || 0;\n\n      for (const lot of lots) {\n        if (remaining <= 0) break;\n        if (lot.remaining <= 0) continue;\n\n        const toConsume = Math.min(lot.remaining, remaining);\n        lot.remaining -= toConsume;\n        remaining -= toConsume;\n      }\n    }\n\n    // Filtrar lotes con cantidad restante\n    return lots.filter(lot => lot.remaining > 0);\n  }\n\n  /**\n   * Simula una venta y calcula impacto fiscal\n   */\n  private simulateSale(\n    sellQuantity: number,\n    sellPriceEur: number,\n    lots: CostLot[],\n    saleDate: Date,\n  ): {\n    capitalGain: number;\n    taxOwed: number;\n    effectiveTaxRate: number;\n    lotsConsumed: ConsumedLotDto[];\n    totalProceeds: number;\n    totalAcquisitionCost: number;\n  } {\n    const totalProceeds = sellQuantity * sellPriceEur;\n    let remaining = sellQuantity;\n    let totalAcquisitionCost = 0;\n    const consumedLots: ConsumedLotDto[] = [];\n\n    // Crear copias de los lotes para no modificar los originales\n    const lotsCopy = lots.map(lot => ({ ...lot }));\n\n    // Consumir lotes FIFO\n    for (const lot of lotsCopy) {\n      if (remaining <= 0) break;\n      if (lot.remaining <= 0) continue;\n\n      const toUse = Math.min(lot.remaining, remaining);\n      const lotCost = toUse * lot.costBasisEur;\n      const lotProceeds = toUse * sellPriceEur;\n      const lotGainLoss = lotProceeds - lotCost;\n\n      // Calcular período de tenencia\n      const holdingPeriodMs = saleDate.getTime() - lot.acquisitionDate.getTime();\n      const holdingPeriodDays = Math.floor(holdingPeriodMs / (1000 * 60 * 60 * 24));\n\n      consumedLots.push({\n        acquisitionDate: lot.acquisitionDate,\n        quantity: toUse,\n        costBasisPerUnit: lot.costBasisEur,\n        totalCostBasis: lotCost,\n        gainLoss: lotGainLoss,\n        holdingPeriodDays,\n      });\n\n      totalAcquisitionCost += lotCost;\n      remaining -= toUse;\n      lot.remaining -= toUse;\n    }\n\n    // Si no hay suficientes lotes, advertir\n    if (remaining > 0) {\n      this.logger.warn(\n        `Insufficient cost basis. Missing ${remaining} units. ` +\n        `This will result in higher capital gains.`\n      );\n    }\n\n    const capitalGain = totalProceeds - totalAcquisitionCost;\n    const taxOwed = capitalGain > 0 ? this.calculateTax(capitalGain) : 0;\n    const effectiveTaxRate = capitalGain > 0 ? this.getTaxBracket(capitalGain) * 100 : 0;\n\n    return {\n      capitalGain,\n      taxOwed,\n      effectiveTaxRate,\n      lotsConsumed: consumedLots,\n      totalProceeds,\n      totalAcquisitionCost,\n    };\n  }\n\n  /**\n   * Calcula el impuesto según tramos de la base del ahorro\n   */\n  private calculateTax(gain: number): number {\n    if (gain <= 0) return 0;\n\n    let tax = 0;\n    let remaining = gain;\n    let previousLimit = 0;\n\n    for (const bracket of this.taxBrackets) {\n      const bracketAmount = Math.min(remaining, bracket.limit - previousLimit);\n      if (bracketAmount <= 0) break;\n\n      tax += bracketAmount * bracket.rate;\n      remaining -= bracketAmount;\n      previousLimit = bracket.limit;\n    }\n\n    return tax;\n  }\n\n  /**\n   * Obtiene el tramo impositivo marginal\n   */\n  private getTaxBracket(gain: number): number {\n    if (gain <= 0) return 0;\n\n    for (const bracket of this.taxBrackets) {\n      if (gain <= bracket.limit) {\n        return bracket.rate;\n      }\n    }\n    return this.taxBrackets[this.taxBrackets.length - 1].rate;\n  }\n\n  /**\n   * Genera recomendación basada en los lotes consumidos\n   */\n  private generateRecommendation(lotsConsumed: ConsumedLotDto[], capitalGain: number): string {\n    if (lotsConsumed.length === 0) {\n      return 'No cost basis available. Consider adding purchase records for accurate tax calculation.';\n    }\n\n    // Verificar si hay lotes con menos de 1 año\n    const shortTermLots = lotsConsumed.filter(lot => lot.holdingPeriodDays < 365);\n    const longTermLots = lotsConsumed.filter(lot => lot.holdingPeriodDays >= 365);\n\n    if (capitalGain > 0) {\n      if (shortTermLots.length > 0 && longTermLots.length === 0) {\n        const daysUntilLongTerm = 365 - Math.max(...shortTermLots.map(l => l.holdingPeriodDays));\n        return `All consumed lots are short-term (< 1 year). Consider waiting ${daysUntilLongTerm} days for potential future tax benefits.`;\n      }\n\n      if (capitalGain > 50000) {\n        return `High capital gain (${capitalGain.toFixed(2)} EUR) will be taxed at higher brackets. Consider splitting the sale across multiple tax years.`;\n      }\n\n      return `Capital gain of ${capitalGain.toFixed(2)} EUR will be taxed at ${this.getTaxBracket(capitalGain) * 100}% marginal rate.`;\n    } else {\n      return `This sale will result in a capital loss of ${Math.abs(capitalGain).toFixed(2)} EUR, which can offset other gains.`;\n    }\n  }\n}\n"],"names":["TaxPredictionService","predictTaxImpact","companyId","dto","transactionType","getBuyPrediction","asset","prisma","cryptoAsset","findFirst","where","symbol","toUpperCase","NotFoundException","wallets","wallet","findMany","select","id","walletIds","map","w","length","saleDate","dateOfSale","Date","costLots","buildCostLots","result","simulateSale","amount","priceEur","recommendation","generateRecommendation","lotsConsumed","capitalGain","logger","log","toFixed","taxOwed","effectiveTaxRate","totalProceeds","totalAcquisitionCost","assetSymbol","upToDate","buyTransactions","cryptoTransaction","walletId","in","type","assetIn","blockTimestamp","lte","orderBy","sellTransactions","assetOut","lots","tx","quantity","amountIn","toNumber","priceInEur","totalEur","costBasis","push","costBasisEur","acquisitionDate","remaining","sellTx","amountOut","lot","toConsume","Math","min","filter","sellQuantity","sellPriceEur","consumedLots","lotsCopy","toUse","lotCost","lotProceeds","lotGainLoss","holdingPeriodMs","getTime","holdingPeriodDays","floor","costBasisPerUnit","totalCostBasis","gainLoss","warn","calculateTax","getTaxBracket","gain","tax","previousLimit","bracket","taxBrackets","bracketAmount","limit","rate","shortTermLots","longTermLots","daysUntilLongTerm","max","l","abs","Logger","name","Infinity"],"mappings":"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"}