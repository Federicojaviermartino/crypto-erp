{"version":3,"sources":["../../../../src/modules/oauth/guards/oauth.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  UnauthorizedException,\n  SetMetadata,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { OAuthService } from '../oauth.service.js';\n\nexport const OAUTH_SCOPES_KEY = 'oauth_scopes';\n\n/**\n * Decorator to require specific OAuth scopes\n * @example @RequireScopes('read:invoices', 'write:invoices')\n */\nexport const RequireScopes = (...scopes: string[]) =>\n  SetMetadata(OAUTH_SCOPES_KEY, scopes);\n\n/**\n * OAuth Guard\n * Validates OAuth access tokens and checks required scopes\n *\n * Usage:\n * @UseGuards(OAuthGuard)\n * @RequireScopes('read:invoices')\n * async getInvoices() { ... }\n */\n@Injectable()\nexport class OAuthGuard implements CanActivate {\n  constructor(\n    private readonly oauthService: OAuthService,\n    private readonly reflector: Reflector,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n\n    // Extract access token from Authorization header\n    const authHeader = request.headers['authorization'];\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      throw new UnauthorizedException('Missing or invalid Authorization header');\n    }\n\n    const accessToken = authHeader.substring(7); // Remove 'Bearer ' prefix\n\n    // Verify access token\n    let tokenData;\n    try {\n      tokenData = await this.oauthService.verifyAccessToken(accessToken);\n    } catch (error) {\n      throw new UnauthorizedException('Invalid or expired access token');\n    }\n\n    // Get required scopes from decorator\n    const requiredScopes = this.reflector.getAllAndOverride<string[]>(\n      OAUTH_SCOPES_KEY,\n      [context.getHandler(), context.getClass()],\n    );\n\n    // Check if token has required scopes\n    if (requiredScopes && requiredScopes.length > 0) {\n      const hasAllScopes = requiredScopes.every(scope =>\n        tokenData.scopes.includes(scope),\n      );\n\n      if (!hasAllScopes) {\n        throw new UnauthorizedException(\n          `Insufficient scopes. Required: ${requiredScopes.join(', ')}`,\n        );\n      }\n    }\n\n    // Attach token data to request for use in controllers\n    request.oauth = {\n      userId: tokenData.userId,\n      companyId: tokenData.companyId,\n      scopes: tokenData.scopes,\n      app: tokenData.app,\n    };\n\n    // Also set X-Company-Id header for compatibility with existing endpoints\n    request.headers['x-company-id'] = tokenData.companyId;\n\n    return true;\n  }\n}\n"],"names":["OAUTH_SCOPES_KEY","OAuthGuard","RequireScopes","scopes","SetMetadata","canActivate","context","request","switchToHttp","getRequest","authHeader","headers","startsWith","UnauthorizedException","accessToken","substring","tokenData","oauthService","verifyAccessToken","error","requiredScopes","reflector","getAllAndOverride","getHandler","getClass","length","hasAllScopes","every","scope","includes","join","oauth","userId","companyId","app"],"mappings":";;;;;;;;;;;QAUaA;eAAAA;;QAmBAC;eAAAA;;QAbAC;eAAAA;;;wBAVN;sBACmB;8BACG;;;;;;;;;;AAEtB,MAAMF,mBAAmB;AAMzB,MAAME,gBAAgB,CAAC,GAAGC,SAC/BC,IAAAA,mBAAW,EAACJ,kBAAkBG;AAYzB,IAAA,AAAMF,aAAN,MAAMA;IAMX,MAAMI,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QAEjD,iDAAiD;QACjD,MAAMC,aAAaH,QAAQI,OAAO,CAAC,gBAAgB;QACnD,IAAI,CAACD,cAAc,CAACA,WAAWE,UAAU,CAAC,YAAY;YACpD,MAAM,IAAIC,6BAAqB,CAAC;QAClC;QAEA,MAAMC,cAAcJ,WAAWK,SAAS,CAAC,IAAI,0BAA0B;QAEvE,sBAAsB;QACtB,IAAIC;QACJ,IAAI;YACFA,YAAY,MAAM,IAAI,CAACC,YAAY,CAACC,iBAAiB,CAACJ;QACxD,EAAE,OAAOK,OAAO;YACd,MAAM,IAAIN,6BAAqB,CAAC;QAClC;QAEA,qCAAqC;QACrC,MAAMO,iBAAiB,IAAI,CAACC,SAAS,CAACC,iBAAiB,CACrDtB,kBACA;YAACM,QAAQiB,UAAU;YAAIjB,QAAQkB,QAAQ;SAAG;QAG5C,qCAAqC;QACrC,IAAIJ,kBAAkBA,eAAeK,MAAM,GAAG,GAAG;YAC/C,MAAMC,eAAeN,eAAeO,KAAK,CAACC,CAAAA,QACxCZ,UAAUb,MAAM,CAAC0B,QAAQ,CAACD;YAG5B,IAAI,CAACF,cAAc;gBACjB,MAAM,IAAIb,6BAAqB,CAC7B,CAAC,+BAA+B,EAAEO,eAAeU,IAAI,CAAC,OAAO;YAEjE;QACF;QAEA,sDAAsD;QACtDvB,QAAQwB,KAAK,GAAG;YACdC,QAAQhB,UAAUgB,MAAM;YACxBC,WAAWjB,UAAUiB,SAAS;YAC9B9B,QAAQa,UAAUb,MAAM;YACxB+B,KAAKlB,UAAUkB,GAAG;QACpB;QAEA,yEAAyE;QACzE3B,QAAQI,OAAO,CAAC,eAAe,GAAGK,UAAUiB,SAAS;QAErD,OAAO;IACT;IAvDA,YACE,AAAiBhB,YAA0B,EAC3C,AAAiBI,SAAoB,CACrC;aAFiBJ,eAAAA;aACAI,YAAAA;IAChB;AAqDL"}