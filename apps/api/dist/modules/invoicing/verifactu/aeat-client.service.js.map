{"version":3,"sources":["../../../../src/modules/invoicing/verifactu/aeat-client.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport * as https from 'https';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as crypto from 'crypto';\n\n/**\n * Cliente SOAP para comunicación con AEAT Verifactu\n * Implementa la transmisión de facturas según Real Decreto 1007/2023\n */\n\ninterface AEATCertificate {\n  key: string;\n  cert: string;\n  passphrase?: string;\n}\n\ninterface AEATResponse {\n  success: boolean;\n  csv?: string;\n  timestamp?: string;\n  errors?: AEATError[];\n  rawResponse?: string;\n}\n\ninterface AEATError {\n  code: string;\n  message: string;\n  field?: string;\n}\n\ninterface VerifactuSubmission {\n  xml: string;\n  nifEmisor: string;\n  invoiceNumber: string;\n  retryCount?: number;\n}\n\n@Injectable()\nexport class AEATClientService {\n  private readonly logger = new Logger(AEATClientService.name);\n\n  // Endpoints AEAT\n  private readonly PRODUCTION_URL = 'https://www1.agenciatributaria.gob.es/wlpl/TGVI-JDIT/ws/VeriFactuSV';\n  private readonly SANDBOX_URL = 'https://prewww1.aeat.es/wlpl/TGVI-JDIT/ws/VeriFactuSV';\n\n  // Retry configuration\n  private readonly MAX_RETRIES = 3;\n  private readonly RETRY_DELAY_MS = 2000;\n\n  private certificate: AEATCertificate | null = null;\n\n  constructor(private readonly configService: ConfigService) {\n    this.loadCertificate();\n  }\n\n  /**\n   * Carga el certificado digital para autenticación con AEAT\n   */\n  private loadCertificate(): void {\n    const certPath = this.configService.get<string>('AEAT_CERTIFICATE_PATH');\n    const certPassword = this.configService.get<string>('AEAT_CERTIFICATE_PASSWORD');\n\n    if (!certPath) {\n      this.logger.warn('AEAT certificate path not configured. AEAT submissions will fail in production.');\n      return;\n    }\n\n    try {\n      const absolutePath = path.isAbsolute(certPath)\n        ? certPath\n        : path.join(process.cwd(), certPath);\n\n      if (!fs.existsSync(absolutePath)) {\n        this.logger.warn(`AEAT certificate not found at: ${absolutePath}`);\n        return;\n      }\n\n      // Read PFX/P12 certificate and extract key/cert\n      const pfxBuffer = fs.readFileSync(absolutePath);\n      const pfxAsn1 = this.parsePkcs12(pfxBuffer, certPassword);\n\n      if (pfxAsn1) {\n        this.certificate = pfxAsn1;\n        this.logger.log('AEAT certificate loaded successfully');\n      }\n    } catch (error) {\n      this.logger.error(`Failed to load AEAT certificate: ${error}`);\n    }\n  }\n\n  /**\n   * Parse PKCS12/PFX certificate\n   * Uses node-forge for certificate parsing\n   */\n  private parsePkcs12(pfxBuffer: Buffer, password?: string): AEATCertificate | null {\n    try {\n      // Using dynamic import to handle ESM module\n      const forge = require('node-forge');\n\n      const p12Asn1 = forge.asn1.fromDer(pfxBuffer.toString('binary'));\n      const p12 = forge.pkcs12.pkcs12FromAsn1(p12Asn1, password || '');\n\n      // Extract private key\n      const keyBags = p12.getBags({ bagType: forge.pki.oids.pkcs8ShroudedKeyBag });\n      const keyBag = keyBags[forge.pki.oids.pkcs8ShroudedKeyBag]?.[0];\n\n      if (!keyBag?.key) {\n        this.logger.error('No private key found in certificate');\n        return null;\n      }\n\n      // Extract certificate\n      const certBags = p12.getBags({ bagType: forge.pki.oids.certBag });\n      const certBag = certBags[forge.pki.oids.certBag]?.[0];\n\n      if (!certBag?.cert) {\n        this.logger.error('No certificate found in PFX file');\n        return null;\n      }\n\n      return {\n        key: forge.pki.privateKeyToPem(keyBag.key),\n        cert: forge.pki.certificateToPem(certBag.cert),\n        passphrase: password,\n      };\n    } catch (error) {\n      this.logger.error(`Failed to parse PKCS12 certificate: ${error}`);\n      return null;\n    }\n  }\n\n  /**\n   * Verifica si el cliente está configurado para producción\n   */\n  isConfiguredForProduction(): boolean {\n    return this.certificate !== null;\n  }\n\n  /**\n   * Obtiene la URL del endpoint según el entorno\n   */\n  private getEndpointUrl(): string {\n    const isProduction = this.configService.get<string>('NODE_ENV') === 'production';\n    return isProduction ? this.PRODUCTION_URL : this.SANDBOX_URL;\n  }\n\n  /**\n   * Envía una factura a AEAT vía SOAP\n   */\n  async submitInvoice(submission: VerifactuSubmission): Promise<AEATResponse> {\n    const { xml, nifEmisor, invoiceNumber, retryCount = 0 } = submission;\n\n    this.logger.log(`Submitting invoice ${invoiceNumber} to AEAT (attempt ${retryCount + 1})`);\n\n    // En desarrollo sin certificado, simular respuesta\n    if (!this.certificate) {\n      this.logger.warn('No certificate configured - simulating AEAT response');\n      return this.simulateResponse(invoiceNumber);\n    }\n\n    try {\n      const response = await this.sendSoapRequest(xml);\n      return this.parseResponse(response);\n    } catch (error) {\n      this.logger.error(`AEAT submission failed: ${error}`);\n\n      // Retry logic with exponential backoff\n      if (retryCount < this.MAX_RETRIES && this.isRetryableError(error)) {\n        const delay = this.RETRY_DELAY_MS * Math.pow(2, retryCount);\n        this.logger.log(`Retrying in ${delay}ms...`);\n\n        await this.sleep(delay);\n        return this.submitInvoice({\n          ...submission,\n          retryCount: retryCount + 1,\n        });\n      }\n\n      return {\n        success: false,\n        errors: [{\n          code: 'AEAT_CONNECTION_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        }],\n      };\n    }\n  }\n\n  /**\n   * Envía la petición SOAP a AEAT\n   */\n  private sendSoapRequest(xml: string): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const url = new URL(this.getEndpointUrl());\n\n      const options: https.RequestOptions = {\n        hostname: url.hostname,\n        port: 443,\n        path: url.pathname,\n        method: 'POST',\n        headers: {\n          'Content-Type': 'text/xml; charset=utf-8',\n          'Content-Length': Buffer.byteLength(xml, 'utf8'),\n          'SOAPAction': '\"SuministroLRFacturasEmitidas\"',\n        },\n        key: this.certificate!.key,\n        cert: this.certificate!.cert,\n        passphrase: this.certificate!.passphrase,\n        rejectUnauthorized: true,\n        timeout: 30000, // 30 seconds timeout\n      };\n\n      const req = https.request(options, (res) => {\n        let data = '';\n        res.on('data', (chunk) => data += chunk);\n        res.on('end', () => {\n          if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {\n            resolve(data);\n          } else {\n            reject(new Error(`HTTP ${res.statusCode}: ${data}`));\n          }\n        });\n      });\n\n      req.on('error', reject);\n      req.on('timeout', () => {\n        req.destroy();\n        reject(new Error('Request timeout'));\n      });\n\n      req.write(xml);\n      req.end();\n    });\n  }\n\n  /**\n   * Parsea la respuesta SOAP de AEAT\n   */\n  private parseResponse(xmlResponse: string): AEATResponse {\n    try {\n      // Parse CSV (Código Seguro de Verificación)\n      const csvMatch = xmlResponse.match(/<CSV>([A-Z0-9]+)<\\/CSV>/);\n      const csv = csvMatch ? csvMatch[1] : undefined;\n\n      // Parse timestamp\n      const timestampMatch = xmlResponse.match(/<FechaHoraRegistro>([^<]+)<\\/FechaHoraRegistro>/);\n      const timestamp = timestampMatch ? timestampMatch[1] : undefined;\n\n      // Check for errors\n      const errorMatches = xmlResponse.matchAll(/<Error>.*?<CodigoError>([^<]+)<\\/CodigoError>.*?<DescripcionError>([^<]+)<\\/DescripcionError>.*?<\\/Error>/gs);\n      const errors: AEATError[] = [];\n\n      for (const match of errorMatches) {\n        errors.push({\n          code: match[1],\n          message: match[2],\n        });\n      }\n\n      // Check estado\n      const estadoMatch = xmlResponse.match(/<EstadoRegistro>([^<]+)<\\/EstadoRegistro>/);\n      const estado = estadoMatch ? estadoMatch[1] : 'DESCONOCIDO';\n\n      const success = estado === 'Correcto' || estado === 'AceptadoConErrores';\n\n      return {\n        success,\n        csv,\n        timestamp,\n        errors: errors.length > 0 ? errors : undefined,\n        rawResponse: xmlResponse,\n      };\n    } catch (error) {\n      this.logger.error(`Failed to parse AEAT response: ${error}`);\n      return {\n        success: false,\n        errors: [{\n          code: 'PARSE_ERROR',\n          message: 'Failed to parse AEAT response',\n        }],\n        rawResponse: xmlResponse,\n      };\n    }\n  }\n\n  /**\n   * Simula respuesta de AEAT para desarrollo\n   */\n  private simulateResponse(invoiceNumber: string): AEATResponse {\n    // Generate a fake CSV that looks realistic\n    const timestamp = new Date().toISOString();\n    const csv = this.generateFakeCSV(invoiceNumber, timestamp);\n\n    this.logger.log(`Simulated AEAT acceptance for invoice ${invoiceNumber}: ${csv}`);\n\n    return {\n      success: true,\n      csv,\n      timestamp,\n    };\n  }\n\n  /**\n   * Genera un CSV simulado para desarrollo\n   */\n  private generateFakeCSV(invoiceNumber: string, timestamp: string): string {\n    const hash = crypto\n      .createHash('sha256')\n      .update(`${invoiceNumber}${timestamp}`)\n      .digest('hex')\n      .substring(0, 16)\n      .toUpperCase();\n\n    return `VF${hash}`;\n  }\n\n  /**\n   * Determina si un error es recuperable\n   */\n  private isRetryableError(error: unknown): boolean {\n    if (error instanceof Error) {\n      const message = error.message.toLowerCase();\n      return (\n        message.includes('timeout') ||\n        message.includes('econnreset') ||\n        message.includes('econnrefused') ||\n        message.includes('socket hang up') ||\n        message.includes('503') ||\n        message.includes('502') ||\n        message.includes('504')\n      );\n    }\n    return false;\n  }\n\n  /**\n   * Sleep helper\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Consulta el estado de una factura previamente enviada\n   */\n  async queryInvoiceStatus(nifEmisor: string, invoiceNumber: string, fecha: string): Promise<AEATResponse> {\n    const queryXml = this.buildQueryXml(nifEmisor, invoiceNumber, fecha);\n\n    if (!this.certificate) {\n      this.logger.warn('No certificate - cannot query AEAT');\n      return {\n        success: false,\n        errors: [{\n          code: 'NO_CERTIFICATE',\n          message: 'AEAT certificate not configured',\n        }],\n      };\n    }\n\n    try {\n      const response = await this.sendSoapRequest(queryXml);\n      return this.parseResponse(response);\n    } catch (error) {\n      return {\n        success: false,\n        errors: [{\n          code: 'QUERY_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        }],\n      };\n    }\n  }\n\n  /**\n   * Construye el XML para consulta de estado\n   */\n  private buildQueryXml(nifEmisor: string, invoiceNumber: string, fecha: string): string {\n    return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\n                  xmlns:vf=\"https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/tike/cont/ws/ConsultaVeriFactu.xsd\">\n  <soapenv:Header/>\n  <soapenv:Body>\n    <vf:ConsultaLR>\n      <vf:Cabecera>\n        <vf:IDVersionSii>1.1</vf:IDVersionSii>\n        <vf:Titular>\n          <vf:NIF>${nifEmisor}</vf:NIF>\n        </vf:Titular>\n      </vf:Cabecera>\n      <vf:FiltroConsulta>\n        <vf:PeriodoLiquidacion>\n          <vf:Ejercicio>${fecha.substring(0, 4)}</vf:Ejercicio>\n          <vf:Periodo>${fecha.substring(5, 7)}</vf:Periodo>\n        </vf:PeriodoLiquidacion>\n        <vf:IDFactura>\n          <vf:NumSerieFacturaEmisor>${invoiceNumber}</vf:NumSerieFacturaEmisor>\n          <vf:FechaExpedicionFacturaEmisor>${fecha}</vf:FechaExpedicionFacturaEmisor>\n        </vf:IDFactura>\n      </vf:FiltroConsulta>\n    </vf:ConsultaLR>\n  </soapenv:Body>\n</soapenv:Envelope>`;\n  }\n\n  /**\n   * Anula una factura previamente registrada\n   */\n  async cancelInvoice(\n    nifEmisor: string,\n    nombreEmisor: string,\n    invoiceNumber: string,\n    fecha: string,\n    originalCSV: string,\n  ): Promise<AEATResponse> {\n    const cancelXml = this.buildCancelXml(nifEmisor, nombreEmisor, invoiceNumber, fecha, originalCSV);\n\n    if (!this.certificate) {\n      this.logger.warn('No certificate - simulating AEAT cancel response');\n      return {\n        success: true,\n        csv: `AN${this.generateFakeCSV(invoiceNumber, new Date().toISOString())}`,\n        timestamp: new Date().toISOString(),\n      };\n    }\n\n    try {\n      const response = await this.sendSoapRequest(cancelXml);\n      return this.parseResponse(response);\n    } catch (error) {\n      return {\n        success: false,\n        errors: [{\n          code: 'CANCEL_ERROR',\n          message: error instanceof Error ? error.message : 'Unknown error',\n        }],\n      };\n    }\n  }\n\n  /**\n   * Construye el XML para anulación de factura\n   */\n  private buildCancelXml(\n    nifEmisor: string,\n    nombreEmisor: string,\n    invoiceNumber: string,\n    fecha: string,\n    originalCSV: string,\n  ): string {\n    return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\n                  xmlns:vf=\"https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/tike/cont/ws/SuministroLRBajaFacturasEmitidas.xsd\">\n  <soapenv:Header/>\n  <soapenv:Body>\n    <vf:SuministroLRBajaExpedidas>\n      <vf:Cabecera>\n        <vf:IDVersionSii>1.1</vf:IDVersionSii>\n        <vf:Titular>\n          <vf:NombreRazon>${this.escapeXml(nombreEmisor)}</vf:NombreRazon>\n          <vf:NIF>${nifEmisor}</vf:NIF>\n        </vf:Titular>\n        <vf:TipoComunicacion>A0</vf:TipoComunicacion>\n      </vf:Cabecera>\n      <vf:RegistroLRBajaExpedidas>\n        <vf:IDFactura>\n          <vf:IDEmisorFactura>\n            <vf:NIF>${nifEmisor}</vf:NIF>\n          </vf:IDEmisorFactura>\n          <vf:NumSerieFacturaEmisor>${invoiceNumber}</vf:NumSerieFacturaEmisor>\n          <vf:FechaExpedicionFacturaEmisor>${fecha}</vf:FechaExpedicionFacturaEmisor>\n        </vf:IDFactura>\n      </vf:RegistroLRBajaExpedidas>\n    </vf:SuministroLRBajaExpedidas>\n  </soapenv:Body>\n</soapenv:Envelope>`;\n  }\n\n  private escapeXml(str: string): string {\n    return str\n      .replace(/&/g, '&amp;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;')\n      .replace(/\"/g, '&quot;')\n      .replace(/'/g, '&apos;');\n  }\n}\n"],"names":["AEATClientService","loadCertificate","certPath","configService","get","certPassword","logger","warn","absolutePath","path","isAbsolute","join","process","cwd","fs","existsSync","pfxBuffer","readFileSync","pfxAsn1","parsePkcs12","certificate","log","error","password","forge","require","p12Asn1","asn1","fromDer","toString","p12","pkcs12","pkcs12FromAsn1","keyBags","getBags","bagType","pki","oids","pkcs8ShroudedKeyBag","keyBag","key","certBags","certBag","cert","privateKeyToPem","certificateToPem","passphrase","isConfiguredForProduction","getEndpointUrl","isProduction","PRODUCTION_URL","SANDBOX_URL","submitInvoice","submission","xml","nifEmisor","invoiceNumber","retryCount","simulateResponse","response","sendSoapRequest","parseResponse","MAX_RETRIES","isRetryableError","delay","RETRY_DELAY_MS","Math","pow","sleep","success","errors","code","message","Error","Promise","resolve","reject","url","URL","options","hostname","port","pathname","method","headers","Buffer","byteLength","rejectUnauthorized","timeout","req","https","request","res","data","on","chunk","statusCode","destroy","write","end","xmlResponse","csvMatch","match","csv","undefined","timestampMatch","timestamp","errorMatches","matchAll","push","estadoMatch","estado","length","rawResponse","Date","toISOString","generateFakeCSV","hash","crypto","createHash","update","digest","substring","toUpperCase","toLowerCase","includes","ms","setTimeout","queryInvoiceStatus","fecha","queryXml","buildQueryXml","cancelInvoice","nombreEmisor","originalCSV","cancelXml","buildCancelXml","escapeXml","str","replace","Logger","name"],"mappings":"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"}