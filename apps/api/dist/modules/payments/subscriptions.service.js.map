{"version":3,"sources":["../../../src/modules/payments/subscriptions.service.ts"],"sourcesContent":["import { Injectable, Logger, ForbiddenException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { SubscriptionPlan, Subscription, SubscriptionStatus } from '@prisma/client';\n\ninterface UsageCheck {\n  allowed: boolean;\n  limit: number;\n  current: number;\n  message?: string;\n}\n\n@Injectable()\nexport class SubscriptionsService {\n  private readonly logger = new Logger(SubscriptionsService.name);\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Get all available subscription plans\n   */\n  async getPlans(): Promise<SubscriptionPlan[]> {\n    return this.prisma.subscriptionPlan.findMany({\n      where: { isActive: true },\n      orderBy: { monthlyPrice: 'asc' },\n    });\n  }\n\n  /**\n   * Get company's current subscription\n   */\n  async getSubscription(companyId: string): Promise<Subscription & { plan: SubscriptionPlan }> {\n    const subscription = await this.prisma.subscription.findUnique({\n      where: { companyId },\n      include: { plan: true },\n    });\n\n    if (!subscription) {\n      // Return free plan if no subscription exists\n      const freePlan = await this.getOrCreateFreePlan();\n      return {\n        id: '',\n        companyId,\n        planId: freePlan.id,\n        stripeCustomerId: null,\n        stripeSubscriptionId: null,\n        status: 'ACTIVE' as SubscriptionStatus,\n        currentPeriodStart: null,\n        currentPeriodEnd: null,\n        cancelAtPeriodEnd: false,\n        canceledAt: null,\n        trialEndsAt: null,\n        invoicesThisMonth: 0,\n        aiMessagesThisMonth: 0,\n        createdAt: new Date(),\n        updatedAt: new Date(),\n        plan: freePlan,\n      } as any;\n    }\n\n    return subscription;\n  }\n\n  /**\n   * Create or get free plan\n   */\n  private async getOrCreateFreePlan(): Promise<SubscriptionPlan> {\n    let plan = await this.prisma.subscriptionPlan.findFirst({\n      where: { name: 'Free' },\n    });\n\n    if (!plan) {\n      plan = await this.prisma.subscriptionPlan.create({\n        data: {\n          name: 'Free',\n          monthlyPrice: 0,\n          yearlyPrice: 0,\n          maxCompanies: 1,\n          maxUsers: 1,\n          maxInvoicesPerMonth: 10,\n          maxWallets: 1,\n          maxAiMessagesPerMonth: 10,\n          verifactuEnabled: false,\n          siiEnabled: false,\n          aiChatEnabled: true,\n          aiOcrEnabled: false,\n          cryptoEnabled: true,\n          multiUserEnabled: false,\n          prioritySupport: false,\n        },\n      });\n    }\n\n    return plan;\n  }\n\n  /**\n   * Check if company can create an invoice (usage limit)\n   */\n  async checkInvoiceLimit(companyId: string): Promise<UsageCheck> {\n    const subscription = await this.getSubscription(companyId);\n\n    const limit = subscription.plan.maxInvoicesPerMonth;\n    const current = subscription.invoicesThisMonth;\n\n    if (current >= limit) {\n      return {\n        allowed: false,\n        limit,\n        current,\n        message: `Monthly invoice limit reached (${limit}). Upgrade your plan to create more invoices.`,\n      };\n    }\n\n    return { allowed: true, limit, current };\n  }\n\n  /**\n   * Check if company can send AI messages (usage limit)\n   */\n  async checkAiMessageLimit(companyId: string): Promise<UsageCheck> {\n    const subscription = await this.getSubscription(companyId);\n\n    if (!subscription.plan.aiChatEnabled) {\n      return {\n        allowed: false,\n        limit: 0,\n        current: 0,\n        message: 'AI Chat not available in your plan. Upgrade to use this feature.',\n      };\n    }\n\n    const limit = subscription.plan.maxAiMessagesPerMonth;\n    const current = subscription.aiMessagesThisMonth;\n\n    if (current >= limit) {\n      return {\n        allowed: false,\n        limit,\n        current,\n        message: `Monthly AI message limit reached (${limit}). Upgrade your plan for more messages.`,\n      };\n    }\n\n    return { allowed: true, limit, current };\n  }\n\n  /**\n   * Check if company has access to a feature\n   */\n  async checkFeatureAccess(companyId: string, feature: keyof SubscriptionPlan): Promise<boolean> {\n    const subscription = await this.getSubscription(companyId);\n    const featureValue = subscription.plan[feature];\n\n    if (typeof featureValue === 'boolean') {\n      return featureValue;\n    }\n\n    return false;\n  }\n\n  /**\n   * Increment invoice usage counter\n   */\n  async incrementInvoiceUsage(companyId: string): Promise<void> {\n    const subscription = await this.prisma.subscription.findUnique({\n      where: { companyId },\n    });\n\n    if (subscription) {\n      await this.prisma.subscription.update({\n        where: { companyId },\n        data: { invoicesThisMonth: { increment: 1 } },\n      });\n    }\n  }\n\n  /**\n   * Increment AI message usage counter\n   */\n  async incrementAiMessageUsage(companyId: string): Promise<void> {\n    const subscription = await this.prisma.subscription.findUnique({\n      where: { companyId },\n    });\n\n    if (subscription) {\n      await this.prisma.subscription.update({\n        where: { companyId },\n        data: { aiMessagesThisMonth: { increment: 1 } },\n      });\n    }\n  }\n\n  /**\n   * Reset monthly usage counters (run via cron job on 1st of month)\n   */\n  async resetMonthlyUsage(): Promise<void> {\n    await this.prisma.subscription.updateMany({\n      data: {\n        invoicesThisMonth: 0,\n        aiMessagesThisMonth: 0,\n      },\n    });\n\n    this.logger.log('Monthly usage counters reset');\n  }\n\n  /**\n   * Guard to enforce usage limits\n   */\n  async enforceInvoiceLimit(companyId: string): Promise<void> {\n    const check = await this.checkInvoiceLimit(companyId);\n\n    if (!check.allowed) {\n      throw new ForbiddenException(check.message);\n    }\n  }\n\n  /**\n   * Guard to enforce AI message limits\n   */\n  async enforceAiMessageLimit(companyId: string): Promise<void> {\n    const check = await this.checkAiMessageLimit(companyId);\n\n    if (!check.allowed) {\n      throw new ForbiddenException(check.message);\n    }\n  }\n\n  /**\n   * Guard to enforce feature access\n   */\n  async enforceFeatureAccess(companyId: string, feature: keyof SubscriptionPlan): Promise<void> {\n    const hasAccess = await this.checkFeatureAccess(companyId, feature);\n\n    if (!hasAccess) {\n      throw new ForbiddenException(\n        `This feature is not available in your plan. Upgrade to access ${String(feature)}.`,\n      );\n    }\n  }\n\n  /**\n   * Get usage stats for company\n   */\n  async getUsageStats(companyId: string) {\n    const subscription = await this.getSubscription(companyId);\n\n    return {\n      plan: {\n        name: subscription.plan.name,\n        status: subscription.status,\n        trialEndsAt: subscription.trialEndsAt,\n        currentPeriodEnd: subscription.currentPeriodEnd,\n      },\n      usage: {\n        invoices: {\n          current: subscription.invoicesThisMonth,\n          limit: subscription.plan.maxInvoicesPerMonth,\n          percentage: Math.round(\n            (subscription.invoicesThisMonth / subscription.plan.maxInvoicesPerMonth) * 100,\n          ),\n        },\n        aiMessages: {\n          current: subscription.aiMessagesThisMonth,\n          limit: subscription.plan.maxAiMessagesPerMonth,\n          percentage: Math.round(\n            (subscription.aiMessagesThisMonth / subscription.plan.maxAiMessagesPerMonth) * 100,\n          ),\n        },\n      },\n      features: {\n        verifactu: subscription.plan.verifactuEnabled,\n        sii: subscription.plan.siiEnabled,\n        aiChat: subscription.plan.aiChatEnabled,\n        aiOcr: subscription.plan.aiOcrEnabled,\n        multiUser: subscription.plan.multiUserEnabled,\n        prioritySupport: subscription.plan.prioritySupport,\n      },\n    };\n  }\n}\n"],"names":["SubscriptionsService","getPlans","prisma","subscriptionPlan","findMany","where","isActive","orderBy","monthlyPrice","getSubscription","companyId","subscription","findUnique","include","plan","freePlan","getOrCreateFreePlan","id","planId","stripeCustomerId","stripeSubscriptionId","status","currentPeriodStart","currentPeriodEnd","cancelAtPeriodEnd","canceledAt","trialEndsAt","invoicesThisMonth","aiMessagesThisMonth","createdAt","Date","updatedAt","findFirst","name","create","data","yearlyPrice","maxCompanies","maxUsers","maxInvoicesPerMonth","maxWallets","maxAiMessagesPerMonth","verifactuEnabled","siiEnabled","aiChatEnabled","aiOcrEnabled","cryptoEnabled","multiUserEnabled","prioritySupport","checkInvoiceLimit","limit","current","allowed","message","checkAiMessageLimit","checkFeatureAccess","feature","featureValue","incrementInvoiceUsage","update","increment","incrementAiMessageUsage","resetMonthlyUsage","updateMany","logger","log","enforceInvoiceLimit","check","ForbiddenException","enforceAiMessageLimit","enforceFeatureAccess","hasAccess","String","getUsageStats","usage","invoices","percentage","Math","round","aiMessages","features","verifactu","sii","aiChat","aiOcr","multiUser","Logger"],"mappings":"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"}