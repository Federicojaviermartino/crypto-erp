{"version":3,"sources":["../../../src/common/guards/roles.guard.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { UserRole } from '@prisma/client';\nimport { ROLES_KEY } from '../decorators/roles.decorator.js';\nimport type { RequestWithCompany } from '../decorators/current-company.decorator.js';\n\n/**\n * Role hierarchy - higher index = more permissions\n */\nconst ROLE_HIERARCHY: UserRole[] = [\n  UserRole.VIEWER,\n  UserRole.USER,\n  UserRole.ACCOUNTANT,\n  UserRole.ADMIN,\n  UserRole.OWNER,\n];\n\n/**\n * Roles guard with hierarchy support.\n * Must be used after TenantGuard.\n */\n@Injectable()\nexport class RolesGuard implements CanActivate {\n  constructor(private reflector: Reflector) {}\n\n  canActivate(context: ExecutionContext): boolean {\n    const requiredRoles = this.reflector.getAllAndOverride<UserRole[]>(\n      ROLES_KEY,\n      [context.getHandler(), context.getClass()],\n    );\n\n    if (!requiredRoles || requiredRoles.length === 0) {\n      return true;\n    }\n\n    const request = context.switchToHttp().getRequest<RequestWithCompany>();\n    const companyContext = request.companyContext;\n\n    if (!companyContext) {\n      return false;\n    }\n\n    const userRoleIndex = ROLE_HIERARCHY.indexOf(companyContext.role);\n\n    // Check if user has any of the required roles or higher\n    return requiredRoles.some((requiredRole) => {\n      const requiredRoleIndex = ROLE_HIERARCHY.indexOf(requiredRole);\n      return userRoleIndex >= requiredRoleIndex;\n    });\n  }\n}"],"names":["RolesGuard","ROLE_HIERARCHY","UserRole","VIEWER","USER","ACCOUNTANT","ADMIN","OWNER","canActivate","context","requiredRoles","reflector","getAllAndOverride","ROLES_KEY","getHandler","getClass","length","request","switchToHttp","getRequest","companyContext","userRoleIndex","indexOf","role","some","requiredRole","requiredRoleIndex"],"mappings":";;;;+BAsBaA;;;eAAAA;;;wBAtB6C;sBAChC;wBACD;gCACC;;;;;;;;;;AAG1B;;CAEC,GACD,MAAMC,iBAA6B;IACjCC,gBAAQ,CAACC,MAAM;IACfD,gBAAQ,CAACE,IAAI;IACbF,gBAAQ,CAACG,UAAU;IACnBH,gBAAQ,CAACI,KAAK;IACdJ,gBAAQ,CAACK,KAAK;CACf;AAOM,IAAA,AAAMP,aAAN,MAAMA;IAGXQ,YAAYC,OAAyB,EAAW;QAC9C,MAAMC,gBAAgB,IAAI,CAACC,SAAS,CAACC,iBAAiB,CACpDC,yBAAS,EACT;YAACJ,QAAQK,UAAU;YAAIL,QAAQM,QAAQ;SAAG;QAG5C,IAAI,CAACL,iBAAiBA,cAAcM,MAAM,KAAK,GAAG;YAChD,OAAO;QACT;QAEA,MAAMC,UAAUR,QAAQS,YAAY,GAAGC,UAAU;QACjD,MAAMC,iBAAiBH,QAAQG,cAAc;QAE7C,IAAI,CAACA,gBAAgB;YACnB,OAAO;QACT;QAEA,MAAMC,gBAAgBpB,eAAeqB,OAAO,CAACF,eAAeG,IAAI;QAEhE,wDAAwD;QACxD,OAAOb,cAAcc,IAAI,CAAC,CAACC;YACzB,MAAMC,oBAAoBzB,eAAeqB,OAAO,CAACG;YACjD,OAAOJ,iBAAiBK;QAC1B;IACF;IA1BA,YAAY,AAAQf,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AA2B7C"}