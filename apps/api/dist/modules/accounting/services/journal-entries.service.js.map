{"version":3,"sources":["../../../../src/modules/accounting/services/journal-entries.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  BadRequestException,\n  ConflictException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateJournalEntryDto, QueryJournalEntriesDto } from '../dto/index.js';\nimport { JournalEntry, JournalStatus, Prisma } from '@prisma/client';\nimport { Decimal } from '@prisma/client/runtime/library';\n\ntype JournalEntryWithLines = JournalEntry & {\n  lines: {\n    id: string;\n    accountId: string;\n    debit: Decimal;\n    credit: Decimal;\n    description: string | null;\n    account: {\n      id: string;\n      code: string;\n      name: string;\n      type: string;\n    };\n  }[];\n};\n\n@Injectable()\nexport class JournalEntriesService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAll(\n    companyId: string,\n    query: QueryJournalEntriesDto,\n  ): Promise<{ entries: JournalEntryWithLines[]; total: number }> {\n    const where: Prisma.JournalEntryWhereInput = {\n      companyId,\n      ...(query.status && { status: query.status as JournalStatus }),\n      ...(query.fiscalYearId && { fiscalYearId: query.fiscalYearId }),\n      ...(query.startDate && { date: { gte: new Date(query.startDate) } }),\n      ...(query.endDate && { date: { lte: new Date(query.endDate) } }),\n      ...(query.search && {\n        OR: [\n          { description: { contains: query.search, mode: 'insensitive' as const } },\n        ],\n      }),\n    };\n\n    const [entries, total] = await Promise.all([\n      this.prisma.journalEntry.findMany({\n        where,\n        include: {\n          lines: {\n            include: {\n              account: {\n                select: { id: true, code: true, name: true, type: true },\n              },\n            },\n            orderBy: { lineNumber: 'asc' },\n          },\n        },\n        orderBy: [{ date: 'desc' }, { number: 'desc' }],\n        skip: query.skip || 0,\n        take: query.take || 50,\n      }),\n      this.prisma.journalEntry.count({ where }),\n    ]);\n\n    return { entries: entries as JournalEntryWithLines[], total };\n  }\n\n  async findById(companyId: string, id: string): Promise<JournalEntryWithLines> {\n    const entry = await this.prisma.journalEntry.findFirst({\n      where: { id, companyId },\n      include: {\n        lines: {\n          include: {\n            account: {\n              select: { id: true, code: true, name: true, type: true },\n            },\n          },\n          orderBy: { lineNumber: 'asc' },\n        },\n      },\n    });\n\n    if (!entry) {\n      throw new NotFoundException(`Journal entry with ID ${id} not found`);\n    }\n\n    return entry as JournalEntryWithLines;\n  }\n\n  async create(\n    companyId: string,\n    _userId: string,\n    dto: CreateJournalEntryDto,\n  ): Promise<JournalEntryWithLines> {\n    // Validate that debits equal credits\n    const totalDebits = dto.lines.reduce((sum, line) => sum + (line.debit || 0), 0);\n    const totalCredits = dto.lines.reduce((sum, line) => sum + (line.credit || 0), 0);\n\n    if (Math.abs(totalDebits - totalCredits) > 0.001) {\n      throw new BadRequestException(\n        `Debits (${totalDebits}) must equal credits (${totalCredits})`,\n      );\n    }\n\n    // Validate accounts exist\n    const accountCodes = dto.lines.map((line) => line.accountCode);\n    const accounts = await this.prisma.account.findMany({\n      where: { companyId, code: { in: accountCodes } },\n    });\n\n    const accountMap = new Map(accounts.map((a) => [a.code, a]));\n    for (const code of accountCodes) {\n      if (!accountMap.has(code)) {\n        throw new NotFoundException(`Account with code ${code} not found`);\n      }\n    }\n\n    // Get or validate fiscal year\n    const entryDate = new Date(dto.date);\n    const fiscalYear = await this.prisma.fiscalYear.findFirst({\n      where: {\n        companyId,\n        startDate: { lte: entryDate },\n        endDate: { gte: entryDate },\n      },\n    });\n\n    if (!fiscalYear) {\n      throw new BadRequestException('No fiscal year found for the entry date');\n    }\n\n    if (fiscalYear.isClosed) {\n      throw new BadRequestException('Cannot create entries in a closed fiscal year');\n    }\n\n    // Generate entry number\n    const entryNumber = await this.generateEntryNumber(companyId, fiscalYear.id);\n\n    const entry = await this.prisma.journalEntry.create({\n      data: {\n        number: entryNumber,\n        date: entryDate,\n        description: dto.description,\n        reference: dto.reference,\n        status: 'DRAFT',\n        companyId,\n        fiscalYearId: fiscalYear.id,\n        lines: {\n          create: dto.lines.map((line, index) => ({\n            lineNumber: index + 1,\n            accountId: accountMap.get(line.accountCode)!.id,\n            debit: line.debit || 0,\n            credit: line.credit || 0,\n            description: line.description,\n          })),\n        },\n      },\n      include: {\n        lines: {\n          include: {\n            account: {\n              select: { id: true, code: true, name: true, type: true },\n            },\n          },\n          orderBy: { lineNumber: 'asc' },\n        },\n      },\n    });\n\n    return entry as JournalEntryWithLines;\n  }\n\n  async update(\n    companyId: string,\n    id: string,\n    dto: Partial<CreateJournalEntryDto>,\n  ): Promise<JournalEntryWithLines> {\n    const existing = await this.findById(companyId, id);\n\n    if (existing.status === 'POSTED') {\n      throw new ConflictException('Cannot modify a posted journal entry');\n    }\n\n    if (existing.status === 'REVERSED') {\n      throw new ConflictException('Cannot modify a reversed journal entry');\n    }\n\n    // If lines are being updated, validate them\n    if (dto.lines) {\n      const totalDebits = dto.lines.reduce((sum, line) => sum + (line.debit || 0), 0);\n      const totalCredits = dto.lines.reduce((sum, line) => sum + (line.credit || 0), 0);\n\n      if (Math.abs(totalDebits - totalCredits) > 0.001) {\n        throw new BadRequestException(\n          `Debits (${totalDebits}) must equal credits (${totalCredits})`,\n        );\n      }\n\n      const accountCodes = dto.lines.map((line) => line.accountCode);\n      const accounts = await this.prisma.account.findMany({\n        where: { companyId, code: { in: accountCodes } },\n      });\n\n      const accountMap = new Map(accounts.map((a) => [a.code, a]));\n      for (const code of accountCodes) {\n        if (!accountMap.has(code)) {\n          throw new NotFoundException(`Account with code ${code} not found`);\n        }\n      }\n\n      // Delete existing lines and create new ones\n      await this.prisma.journalLine.deleteMany({\n        where: { journalEntryId: id },\n      });\n\n      await this.prisma.journalLine.createMany({\n        data: dto.lines.map((line, index) => ({\n          journalEntryId: id,\n          lineNumber: index + 1,\n          accountId: accountMap.get(line.accountCode)!.id,\n          debit: line.debit || 0,\n          credit: line.credit || 0,\n          description: line.description,\n        })),\n      });\n    }\n\n    // Update main entry\n    await this.prisma.journalEntry.update({\n      where: { id },\n      data: {\n        ...(dto.date && { date: new Date(dto.date) }),\n        ...(dto.description !== undefined && { description: dto.description }),\n        ...(dto.reference !== undefined && { reference: dto.reference }),\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async post(companyId: string, id: string, userId: string): Promise<JournalEntryWithLines> {\n    const entry = await this.findById(companyId, id);\n\n    if (entry.status === 'POSTED') {\n      throw new ConflictException('Journal entry is already posted');\n    }\n\n    if (entry.status === 'REVERSED') {\n      throw new ConflictException('Cannot post a reversed journal entry');\n    }\n\n    await this.prisma.journalEntry.update({\n      where: { id },\n      data: {\n        status: 'POSTED',\n        isPosted: true,\n        postedAt: new Date(),\n        postedBy: userId,\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async void(\n    companyId: string,\n    id: string,\n    userId: string,\n  ): Promise<JournalEntryWithLines> {\n    const entry = await this.findById(companyId, id);\n\n    if (entry.status === 'REVERSED') {\n      throw new ConflictException('Journal entry is already reversed');\n    }\n\n    // Check if fiscal year is closed\n    const fiscalYear = await this.prisma.fiscalYear.findUnique({\n      where: { id: entry.fiscalYearId },\n    });\n\n    if (fiscalYear?.isClosed) {\n      throw new BadRequestException('Cannot void entries in a closed fiscal year');\n    }\n\n    // For posted entries, create a reversal entry\n    if (entry.status === 'POSTED') {\n      const reversalNumber = await this.generateEntryNumber(companyId, entry.fiscalYearId);\n\n      await this.prisma.$transaction([\n        this.prisma.journalEntry.update({\n          where: { id },\n          data: {\n            status: 'REVERSED',\n            reversedBy: null, // Will be set to the reversal entry ID\n          },\n        }),\n        this.prisma.journalEntry.create({\n          data: {\n            number: reversalNumber,\n            date: new Date(),\n            description: `Reversal of #${entry.number}: ${entry.description || ''}`,\n            reference: entry.reference,\n            status: 'POSTED',\n            isPosted: true,\n            isReversal: true,\n            reversalOf: id,\n            companyId,\n            fiscalYearId: entry.fiscalYearId,\n            postedAt: new Date(),\n            postedBy: userId,\n            lines: {\n              create: entry.lines.map((line, index) => ({\n                lineNumber: index + 1,\n                accountId: line.accountId,\n                debit: line.credit, // Reverse debit and credit\n                credit: line.debit,\n                description: `Reversal: ${line.description || ''}`,\n              })),\n            },\n          },\n        }),\n      ]);\n    } else {\n      // Draft entries can be directly deleted or marked\n      await this.prisma.journalEntry.update({\n        where: { id },\n        data: { status: 'REVERSED' },\n      });\n    }\n\n    return this.findById(companyId, id);\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    const entry = await this.findById(companyId, id);\n\n    if (entry.status !== 'DRAFT') {\n      throw new ConflictException('Only draft entries can be deleted');\n    }\n\n    await this.prisma.$transaction([\n      this.prisma.journalLine.deleteMany({ where: { journalEntryId: id } }),\n      this.prisma.journalEntry.delete({ where: { id } }),\n    ]);\n  }\n\n  private async generateEntryNumber(companyId: string, fiscalYearId: string): Promise<number> {\n    const lastEntry = await this.prisma.journalEntry.findFirst({\n      where: { companyId, fiscalYearId },\n      orderBy: { number: 'desc' },\n    });\n\n    return (lastEntry?.number || 0) + 1;\n  }\n}\n"],"names":["JournalEntriesService","findAll","companyId","query","where","status","fiscalYearId","startDate","date","gte","Date","endDate","lte","search","OR","description","contains","mode","entries","total","Promise","all","prisma","journalEntry","findMany","include","lines","account","select","id","code","name","type","orderBy","lineNumber","number","skip","take","count","findById","entry","findFirst","NotFoundException","create","_userId","dto","totalDebits","reduce","sum","line","debit","totalCredits","credit","Math","abs","BadRequestException","accountCodes","map","accountCode","accounts","in","accountMap","Map","a","has","entryDate","fiscalYear","isClosed","entryNumber","generateEntryNumber","data","reference","index","accountId","get","update","existing","ConflictException","journalLine","deleteMany","journalEntryId","createMany","undefined","post","userId","isPosted","postedAt","postedBy","void","findUnique","reversalNumber","$transaction","reversedBy","isReversal","reversalOf","delete","lastEntry"],"mappings":";;;;+BA4BaA;;;eAAAA;;;wBAvBN;0BACuB;;;;;;;;;;AAsBvB,IAAA,AAAMA,wBAAN,MAAMA;IAGX,MAAMC,QACJC,SAAiB,EACjBC,KAA6B,EACiC;QAC9D,MAAMC,QAAuC;YAC3CF;YACA,GAAIC,MAAME,MAAM,IAAI;gBAAEA,QAAQF,MAAME,MAAM;YAAkB,CAAC;YAC7D,GAAIF,MAAMG,YAAY,IAAI;gBAAEA,cAAcH,MAAMG,YAAY;YAAC,CAAC;YAC9D,GAAIH,MAAMI,SAAS,IAAI;gBAAEC,MAAM;oBAAEC,KAAK,IAAIC,KAAKP,MAAMI,SAAS;gBAAE;YAAE,CAAC;YACnE,GAAIJ,MAAMQ,OAAO,IAAI;gBAAEH,MAAM;oBAAEI,KAAK,IAAIF,KAAKP,MAAMQ,OAAO;gBAAE;YAAE,CAAC;YAC/D,GAAIR,MAAMU,MAAM,IAAI;gBAClBC,IAAI;oBACF;wBAAEC,aAAa;4BAAEC,UAAUb,MAAMU,MAAM;4BAAEI,MAAM;wBAAuB;oBAAE;iBACzE;YACH,CAAC;QACH;QAEA,MAAM,CAACC,SAASC,MAAM,GAAG,MAAMC,QAAQC,GAAG,CAAC;YACzC,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,QAAQ,CAAC;gBAChCpB;gBACAqB,SAAS;oBACPC,OAAO;wBACLD,SAAS;4BACPE,SAAS;gCACPC,QAAQ;oCAAEC,IAAI;oCAAMC,MAAM;oCAAMC,MAAM;oCAAMC,MAAM;gCAAK;4BACzD;wBACF;wBACAC,SAAS;4BAAEC,YAAY;wBAAM;oBAC/B;gBACF;gBACAD,SAAS;oBAAC;wBAAEzB,MAAM;oBAAO;oBAAG;wBAAE2B,QAAQ;oBAAO;iBAAE;gBAC/CC,MAAMjC,MAAMiC,IAAI,IAAI;gBACpBC,MAAMlC,MAAMkC,IAAI,IAAI;YACtB;YACA,IAAI,CAACf,MAAM,CAACC,YAAY,CAACe,KAAK,CAAC;gBAAElC;YAAM;SACxC;QAED,OAAO;YAAEc,SAASA;YAAoCC;QAAM;IAC9D;IAEA,MAAMoB,SAASrC,SAAiB,EAAE2B,EAAU,EAAkC;QAC5E,MAAMW,QAAQ,MAAM,IAAI,CAAClB,MAAM,CAACC,YAAY,CAACkB,SAAS,CAAC;YACrDrC,OAAO;gBAAEyB;gBAAI3B;YAAU;YACvBuB,SAAS;gBACPC,OAAO;oBACLD,SAAS;wBACPE,SAAS;4BACPC,QAAQ;gCAAEC,IAAI;gCAAMC,MAAM;gCAAMC,MAAM;gCAAMC,MAAM;4BAAK;wBACzD;oBACF;oBACAC,SAAS;wBAAEC,YAAY;oBAAM;gBAC/B;YACF;QACF;QAEA,IAAI,CAACM,OAAO;YACV,MAAM,IAAIE,yBAAiB,CAAC,CAAC,sBAAsB,EAAEb,GAAG,UAAU,CAAC;QACrE;QAEA,OAAOW;IACT;IAEA,MAAMG,OACJzC,SAAiB,EACjB0C,OAAe,EACfC,GAA0B,EACM;QAChC,qCAAqC;QACrC,MAAMC,cAAcD,IAAInB,KAAK,CAACqB,MAAM,CAAC,CAACC,KAAKC,OAASD,MAAOC,CAAAA,KAAKC,KAAK,IAAI,CAAA,GAAI;QAC7E,MAAMC,eAAeN,IAAInB,KAAK,CAACqB,MAAM,CAAC,CAACC,KAAKC,OAASD,MAAOC,CAAAA,KAAKG,MAAM,IAAI,CAAA,GAAI;QAE/E,IAAIC,KAAKC,GAAG,CAACR,cAAcK,gBAAgB,OAAO;YAChD,MAAM,IAAII,2BAAmB,CAC3B,CAAC,QAAQ,EAAET,YAAY,sBAAsB,EAAEK,aAAa,CAAC,CAAC;QAElE;QAEA,0BAA0B;QAC1B,MAAMK,eAAeX,IAAInB,KAAK,CAAC+B,GAAG,CAAC,CAACR,OAASA,KAAKS,WAAW;QAC7D,MAAMC,WAAW,MAAM,IAAI,CAACrC,MAAM,CAACK,OAAO,CAACH,QAAQ,CAAC;YAClDpB,OAAO;gBAAEF;gBAAW4B,MAAM;oBAAE8B,IAAIJ;gBAAa;YAAE;QACjD;QAEA,MAAMK,aAAa,IAAIC,IAAIH,SAASF,GAAG,CAAC,CAACM,IAAM;gBAACA,EAAEjC,IAAI;gBAAEiC;aAAE;QAC1D,KAAK,MAAMjC,QAAQ0B,aAAc;YAC/B,IAAI,CAACK,WAAWG,GAAG,CAAClC,OAAO;gBACzB,MAAM,IAAIY,yBAAiB,CAAC,CAAC,kBAAkB,EAAEZ,KAAK,UAAU,CAAC;YACnE;QACF;QAEA,8BAA8B;QAC9B,MAAMmC,YAAY,IAAIvD,KAAKmC,IAAIrC,IAAI;QACnC,MAAM0D,aAAa,MAAM,IAAI,CAAC5C,MAAM,CAAC4C,UAAU,CAACzB,SAAS,CAAC;YACxDrC,OAAO;gBACLF;gBACAK,WAAW;oBAAEK,KAAKqD;gBAAU;gBAC5BtD,SAAS;oBAAEF,KAAKwD;gBAAU;YAC5B;QACF;QAEA,IAAI,CAACC,YAAY;YACf,MAAM,IAAIX,2BAAmB,CAAC;QAChC;QAEA,IAAIW,WAAWC,QAAQ,EAAE;YACvB,MAAM,IAAIZ,2BAAmB,CAAC;QAChC;QAEA,wBAAwB;QACxB,MAAMa,cAAc,MAAM,IAAI,CAACC,mBAAmB,CAACnE,WAAWgE,WAAWrC,EAAE;QAE3E,MAAMW,QAAQ,MAAM,IAAI,CAAClB,MAAM,CAACC,YAAY,CAACoB,MAAM,CAAC;YAClD2B,MAAM;gBACJnC,QAAQiC;gBACR5D,MAAMyD;gBACNlD,aAAa8B,IAAI9B,WAAW;gBAC5BwD,WAAW1B,IAAI0B,SAAS;gBACxBlE,QAAQ;gBACRH;gBACAI,cAAc4D,WAAWrC,EAAE;gBAC3BH,OAAO;oBACLiB,QAAQE,IAAInB,KAAK,CAAC+B,GAAG,CAAC,CAACR,MAAMuB,QAAW,CAAA;4BACtCtC,YAAYsC,QAAQ;4BACpBC,WAAWZ,WAAWa,GAAG,CAACzB,KAAKS,WAAW,EAAG7B,EAAE;4BAC/CqB,OAAOD,KAAKC,KAAK,IAAI;4BACrBE,QAAQH,KAAKG,MAAM,IAAI;4BACvBrC,aAAakC,KAAKlC,WAAW;wBAC/B,CAAA;gBACF;YACF;YACAU,SAAS;gBACPC,OAAO;oBACLD,SAAS;wBACPE,SAAS;4BACPC,QAAQ;gCAAEC,IAAI;gCAAMC,MAAM;gCAAMC,MAAM;gCAAMC,MAAM;4BAAK;wBACzD;oBACF;oBACAC,SAAS;wBAAEC,YAAY;oBAAM;gBAC/B;YACF;QACF;QAEA,OAAOM;IACT;IAEA,MAAMmC,OACJzE,SAAiB,EACjB2B,EAAU,EACVgB,GAAmC,EACH;QAChC,MAAM+B,WAAW,MAAM,IAAI,CAACrC,QAAQ,CAACrC,WAAW2B;QAEhD,IAAI+C,SAASvE,MAAM,KAAK,UAAU;YAChC,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,IAAID,SAASvE,MAAM,KAAK,YAAY;YAClC,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,4CAA4C;QAC5C,IAAIhC,IAAInB,KAAK,EAAE;YACb,MAAMoB,cAAcD,IAAInB,KAAK,CAACqB,MAAM,CAAC,CAACC,KAAKC,OAASD,MAAOC,CAAAA,KAAKC,KAAK,IAAI,CAAA,GAAI;YAC7E,MAAMC,eAAeN,IAAInB,KAAK,CAACqB,MAAM,CAAC,CAACC,KAAKC,OAASD,MAAOC,CAAAA,KAAKG,MAAM,IAAI,CAAA,GAAI;YAE/E,IAAIC,KAAKC,GAAG,CAACR,cAAcK,gBAAgB,OAAO;gBAChD,MAAM,IAAII,2BAAmB,CAC3B,CAAC,QAAQ,EAAET,YAAY,sBAAsB,EAAEK,aAAa,CAAC,CAAC;YAElE;YAEA,MAAMK,eAAeX,IAAInB,KAAK,CAAC+B,GAAG,CAAC,CAACR,OAASA,KAAKS,WAAW;YAC7D,MAAMC,WAAW,MAAM,IAAI,CAACrC,MAAM,CAACK,OAAO,CAACH,QAAQ,CAAC;gBAClDpB,OAAO;oBAAEF;oBAAW4B,MAAM;wBAAE8B,IAAIJ;oBAAa;gBAAE;YACjD;YAEA,MAAMK,aAAa,IAAIC,IAAIH,SAASF,GAAG,CAAC,CAACM,IAAM;oBAACA,EAAEjC,IAAI;oBAAEiC;iBAAE;YAC1D,KAAK,MAAMjC,QAAQ0B,aAAc;gBAC/B,IAAI,CAACK,WAAWG,GAAG,CAAClC,OAAO;oBACzB,MAAM,IAAIY,yBAAiB,CAAC,CAAC,kBAAkB,EAAEZ,KAAK,UAAU,CAAC;gBACnE;YACF;YAEA,4CAA4C;YAC5C,MAAM,IAAI,CAACR,MAAM,CAACwD,WAAW,CAACC,UAAU,CAAC;gBACvC3E,OAAO;oBAAE4E,gBAAgBnD;gBAAG;YAC9B;YAEA,MAAM,IAAI,CAACP,MAAM,CAACwD,WAAW,CAACG,UAAU,CAAC;gBACvCX,MAAMzB,IAAInB,KAAK,CAAC+B,GAAG,CAAC,CAACR,MAAMuB,QAAW,CAAA;wBACpCQ,gBAAgBnD;wBAChBK,YAAYsC,QAAQ;wBACpBC,WAAWZ,WAAWa,GAAG,CAACzB,KAAKS,WAAW,EAAG7B,EAAE;wBAC/CqB,OAAOD,KAAKC,KAAK,IAAI;wBACrBE,QAAQH,KAAKG,MAAM,IAAI;wBACvBrC,aAAakC,KAAKlC,WAAW;oBAC/B,CAAA;YACF;QACF;QAEA,oBAAoB;QACpB,MAAM,IAAI,CAACO,MAAM,CAACC,YAAY,CAACoD,MAAM,CAAC;YACpCvE,OAAO;gBAAEyB;YAAG;YACZyC,MAAM;gBACJ,GAAIzB,IAAIrC,IAAI,IAAI;oBAAEA,MAAM,IAAIE,KAAKmC,IAAIrC,IAAI;gBAAE,CAAC;gBAC5C,GAAIqC,IAAI9B,WAAW,KAAKmE,aAAa;oBAAEnE,aAAa8B,IAAI9B,WAAW;gBAAC,CAAC;gBACrE,GAAI8B,IAAI0B,SAAS,KAAKW,aAAa;oBAAEX,WAAW1B,IAAI0B,SAAS;gBAAC,CAAC;YACjE;QACF;QAEA,OAAO,IAAI,CAAChC,QAAQ,CAACrC,WAAW2B;IAClC;IAEA,MAAMsD,KAAKjF,SAAiB,EAAE2B,EAAU,EAAEuD,MAAc,EAAkC;QACxF,MAAM5C,QAAQ,MAAM,IAAI,CAACD,QAAQ,CAACrC,WAAW2B;QAE7C,IAAIW,MAAMnC,MAAM,KAAK,UAAU;YAC7B,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,IAAIrC,MAAMnC,MAAM,KAAK,YAAY;YAC/B,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,MAAM,IAAI,CAACvD,MAAM,CAACC,YAAY,CAACoD,MAAM,CAAC;YACpCvE,OAAO;gBAAEyB;YAAG;YACZyC,MAAM;gBACJjE,QAAQ;gBACRgF,UAAU;gBACVC,UAAU,IAAI5E;gBACd6E,UAAUH;YACZ;QACF;QAEA,OAAO,IAAI,CAAC7C,QAAQ,CAACrC,WAAW2B;IAClC;IAEA,MAAM2D,KACJtF,SAAiB,EACjB2B,EAAU,EACVuD,MAAc,EACkB;QAChC,MAAM5C,QAAQ,MAAM,IAAI,CAACD,QAAQ,CAACrC,WAAW2B;QAE7C,IAAIW,MAAMnC,MAAM,KAAK,YAAY;YAC/B,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,iCAAiC;QACjC,MAAMX,aAAa,MAAM,IAAI,CAAC5C,MAAM,CAAC4C,UAAU,CAACuB,UAAU,CAAC;YACzDrF,OAAO;gBAAEyB,IAAIW,MAAMlC,YAAY;YAAC;QAClC;QAEA,IAAI4D,YAAYC,UAAU;YACxB,MAAM,IAAIZ,2BAAmB,CAAC;QAChC;QAEA,8CAA8C;QAC9C,IAAIf,MAAMnC,MAAM,KAAK,UAAU;YAC7B,MAAMqF,iBAAiB,MAAM,IAAI,CAACrB,mBAAmB,CAACnE,WAAWsC,MAAMlC,YAAY;YAEnF,MAAM,IAAI,CAACgB,MAAM,CAACqE,YAAY,CAAC;gBAC7B,IAAI,CAACrE,MAAM,CAACC,YAAY,CAACoD,MAAM,CAAC;oBAC9BvE,OAAO;wBAAEyB;oBAAG;oBACZyC,MAAM;wBACJjE,QAAQ;wBACRuF,YAAY;oBACd;gBACF;gBACA,IAAI,CAACtE,MAAM,CAACC,YAAY,CAACoB,MAAM,CAAC;oBAC9B2B,MAAM;wBACJnC,QAAQuD;wBACRlF,MAAM,IAAIE;wBACVK,aAAa,CAAC,aAAa,EAAEyB,MAAML,MAAM,CAAC,EAAE,EAAEK,MAAMzB,WAAW,IAAI,IAAI;wBACvEwD,WAAW/B,MAAM+B,SAAS;wBAC1BlE,QAAQ;wBACRgF,UAAU;wBACVQ,YAAY;wBACZC,YAAYjE;wBACZ3B;wBACAI,cAAckC,MAAMlC,YAAY;wBAChCgF,UAAU,IAAI5E;wBACd6E,UAAUH;wBACV1D,OAAO;4BACLiB,QAAQH,MAAMd,KAAK,CAAC+B,GAAG,CAAC,CAACR,MAAMuB,QAAW,CAAA;oCACxCtC,YAAYsC,QAAQ;oCACpBC,WAAWxB,KAAKwB,SAAS;oCACzBvB,OAAOD,KAAKG,MAAM;oCAClBA,QAAQH,KAAKC,KAAK;oCAClBnC,aAAa,CAAC,UAAU,EAAEkC,KAAKlC,WAAW,IAAI,IAAI;gCACpD,CAAA;wBACF;oBACF;gBACF;aACD;QACH,OAAO;YACL,kDAAkD;YAClD,MAAM,IAAI,CAACO,MAAM,CAACC,YAAY,CAACoD,MAAM,CAAC;gBACpCvE,OAAO;oBAAEyB;gBAAG;gBACZyC,MAAM;oBAAEjE,QAAQ;gBAAW;YAC7B;QACF;QAEA,OAAO,IAAI,CAACkC,QAAQ,CAACrC,WAAW2B;IAClC;IAEA,MAAMkE,OAAO7F,SAAiB,EAAE2B,EAAU,EAAiB;QACzD,MAAMW,QAAQ,MAAM,IAAI,CAACD,QAAQ,CAACrC,WAAW2B;QAE7C,IAAIW,MAAMnC,MAAM,KAAK,SAAS;YAC5B,MAAM,IAAIwE,yBAAiB,CAAC;QAC9B;QAEA,MAAM,IAAI,CAACvD,MAAM,CAACqE,YAAY,CAAC;YAC7B,IAAI,CAACrE,MAAM,CAACwD,WAAW,CAACC,UAAU,CAAC;gBAAE3E,OAAO;oBAAE4E,gBAAgBnD;gBAAG;YAAE;YACnE,IAAI,CAACP,MAAM,CAACC,YAAY,CAACwE,MAAM,CAAC;gBAAE3F,OAAO;oBAAEyB;gBAAG;YAAE;SACjD;IACH;IAEA,MAAcwC,oBAAoBnE,SAAiB,EAAEI,YAAoB,EAAmB;QAC1F,MAAM0F,YAAY,MAAM,IAAI,CAAC1E,MAAM,CAACC,YAAY,CAACkB,SAAS,CAAC;YACzDrC,OAAO;gBAAEF;gBAAWI;YAAa;YACjC2B,SAAS;gBAAEE,QAAQ;YAAO;QAC5B;QAEA,OAAO,AAAC6D,CAAAA,WAAW7D,UAAU,CAAA,IAAK;IACpC;IAxUA,YAAY,AAAiBb,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AAyUvD"}