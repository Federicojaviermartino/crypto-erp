{"version":3,"sources":["../../../../src/modules/crypto/exchanges/exchange-accounts.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Delete,\n  Body,\n  Param,\n  Headers,\n  BadRequestException,\n} from '@nestjs/common';\nimport { ExchangeAccountsService } from './exchange-accounts.service.js';\n\n@Controller('crypto/exchanges')\nexport class ExchangeAccountsController {\n  constructor(private readonly exchangeAccountsService: ExchangeAccountsService) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  @Get('supported')\n  getSupportedExchanges() {\n    return this.exchangeAccountsService.getSupportedExchanges();\n  }\n\n  @Get('accounts')\n  findAll(@Headers() headers: Record<string, string>) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.findAll(companyId);\n  }\n\n  @Get('accounts/:id')\n  findOne(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.findOne(companyId, id);\n  }\n\n  @Post('accounts')\n  create(\n    @Headers() headers: Record<string, string>,\n    @Body() body: {\n      exchange: string;\n      label?: string;\n      apiKey: string;\n      apiSecret: string;\n    },\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.create(companyId, body);\n  }\n\n  @Put('accounts/:id')\n  update(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n    @Body() body: {\n      label?: string;\n      apiKey?: string;\n      apiSecret?: string;\n    },\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.update(companyId, id, body);\n  }\n\n  @Delete('accounts/:id')\n  delete(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.delete(companyId, id);\n  }\n\n  @Post('accounts/:id/test')\n  async testConnection(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const success = await this.exchangeAccountsService.testConnection(companyId, id);\n    return { success };\n  }\n\n  @Get('accounts/:id/balances')\n  getBalances(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.getBalances(companyId, id);\n  }\n\n  @Post('accounts/:id/sync/trades')\n  syncTrades(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n    @Body() body: { startTime?: string; endTime?: string },\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.syncTrades(companyId, id, {\n      startTime: body.startTime ? new Date(body.startTime) : undefined,\n      endTime: body.endTime ? new Date(body.endTime) : undefined,\n    });\n  }\n\n  @Post('accounts/:id/sync/deposits-withdrawals')\n  syncDepositsWithdrawals(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n    @Body() body: { startTime?: string; endTime?: string },\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.exchangeAccountsService.syncDepositsWithdrawals(companyId, id, {\n      startTime: body.startTime ? new Date(body.startTime) : undefined,\n      endTime: body.endTime ? new Date(body.endTime) : undefined,\n    });\n  }\n\n  @Post('accounts/:id/sync/all')\n  async syncAll(\n    @Headers() headers: Record<string, string>,\n    @Param('id') id: string,\n    @Body() body: { startTime?: string; endTime?: string },\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const options = {\n      startTime: body.startTime ? new Date(body.startTime) : undefined,\n      endTime: body.endTime ? new Date(body.endTime) : undefined,\n    };\n\n    const [trades, depositsWithdrawals] = await Promise.all([\n      this.exchangeAccountsService.syncTrades(companyId, id, options),\n      this.exchangeAccountsService.syncDepositsWithdrawals(companyId, id, options),\n    ]);\n\n    return {\n      trades: trades.imported,\n      deposits: depositsWithdrawals.deposits,\n      withdrawals: depositsWithdrawals.withdrawals,\n    };\n  }\n}\n"],"names":["ExchangeAccountsController","getCompanyId","headers","companyId","BadRequestException","getSupportedExchanges","exchangeAccountsService","findAll","findOne","id","create","body","update","delete","testConnection","success","getBalances","syncTrades","startTime","Date","undefined","endTime","syncDepositsWithdrawals","syncAll","options","trades","depositsWithdrawals","Promise","all","imported","deposits","withdrawals"],"mappings":"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"}