{"version":3,"sources":["../../../../src/modules/invoicing/services/series.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ConflictException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateSeriesDto } from '../dto/index.js';\nimport { InvoiceSeries, InvoiceType } from '@prisma/client';\n\n@Injectable()\nexport class SeriesService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAll(companyId: string): Promise<InvoiceSeries[]> {\n    return this.prisma.invoiceSeries.findMany({\n      where: { companyId },\n      orderBy: { prefix: 'asc' },\n    });\n  }\n\n  async findById(companyId: string, id: string): Promise<InvoiceSeries> {\n    const series = await this.prisma.invoiceSeries.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!series) {\n      throw new NotFoundException(`Invoice series with ID ${id} not found`);\n    }\n\n    return series;\n  }\n\n  async findByPrefix(companyId: string, prefix: string): Promise<InvoiceSeries | null> {\n    return this.prisma.invoiceSeries.findFirst({\n      where: { companyId, prefix },\n    });\n  }\n\n  async create(companyId: string, dto: CreateSeriesDto): Promise<InvoiceSeries> {\n    // Check for duplicate prefix\n    const existing = await this.findByPrefix(companyId, dto.prefix);\n    if (existing) {\n      throw new ConflictException(`Series with prefix ${dto.prefix} already exists`);\n    }\n\n    // If this will be default, unset other defaults\n    if (dto.isDefault) {\n      await this.prisma.invoiceSeries.updateMany({\n        where: {\n          companyId,\n          isDefault: true,\n        },\n        data: { isDefault: false },\n      });\n    }\n\n    return this.prisma.invoiceSeries.create({\n      data: {\n        code: dto.prefix, // Use prefix as code\n        prefix: dto.prefix,\n        name: dto.name,\n        type: InvoiceType.STANDARD,\n        nextNumber: dto.nextNumber ?? 1,\n        digitCount: 6,\n        isDefault: dto.isDefault ?? false,\n        company: {\n          connect: { id: companyId },\n        },\n      },\n    });\n  }\n\n  async update(\n    companyId: string,\n    id: string,\n    dto: Partial<CreateSeriesDto>,\n  ): Promise<InvoiceSeries> {\n    const existing = await this.findById(companyId, id);\n\n    // Check for duplicate prefix if changing\n    if (dto.prefix && dto.prefix !== existing.prefix) {\n      const duplicate = await this.findByPrefix(companyId, dto.prefix);\n      if (duplicate) {\n        throw new ConflictException(`Series with prefix ${dto.prefix} already exists`);\n      }\n    }\n\n    // If setting as default, unset other defaults\n    if (dto.isDefault) {\n      await this.prisma.invoiceSeries.updateMany({\n        where: {\n          companyId,\n          isDefault: true,\n          NOT: { id },\n        },\n        data: { isDefault: false },\n      });\n    }\n\n    return this.prisma.invoiceSeries.update({\n      where: { id },\n      data: {\n        ...(dto.prefix && { prefix: dto.prefix, code: dto.prefix }),\n        ...(dto.name && { name: dto.name }),\n        ...(dto.nextNumber && { nextNumber: dto.nextNumber }),\n        ...(dto.isDefault !== undefined && { isDefault: dto.isDefault }),\n      },\n    });\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    await this.findById(companyId, id);\n\n    // Check if series has invoices\n    const invoiceCount = await this.prisma.invoice.count({\n      where: { seriesId: id },\n    });\n\n    if (invoiceCount > 0) {\n      throw new ConflictException(\n        `Cannot delete series with ${invoiceCount} associated invoices. Deactivate instead.`,\n      );\n    }\n\n    await this.prisma.invoiceSeries.delete({ where: { id } });\n  }\n\n  async getStats(\n    companyId: string,\n    id: string,\n  ): Promise<{\n    totalInvoices: number;\n    currentYear: number;\n    currentYearInvoices: number;\n    lastInvoiceNumber: string | null;\n  }> {\n    await this.findById(companyId, id);\n\n    const currentYear = new Date().getFullYear();\n    const startOfYear = new Date(currentYear, 0, 1);\n    const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59);\n\n    const [totalInvoices, currentYearInvoices, lastInvoice] = await Promise.all([\n      this.prisma.invoice.count({\n        where: { seriesId: id },\n      }),\n      this.prisma.invoice.count({\n        where: {\n          seriesId: id,\n          issueDate: { gte: startOfYear, lte: endOfYear },\n        },\n      }),\n      this.prisma.invoice.findFirst({\n        where: { seriesId: id },\n        orderBy: { number: 'desc' },\n        select: { fullNumber: true },\n      }),\n    ]);\n\n    return {\n      totalInvoices,\n      currentYear,\n      currentYearInvoices,\n      lastInvoiceNumber: lastInvoice?.fullNumber || null,\n    };\n  }\n}\n"],"names":["SeriesService","findAll","companyId","prisma","invoiceSeries","findMany","where","orderBy","prefix","findById","id","series","findFirst","NotFoundException","findByPrefix","create","dto","existing","ConflictException","isDefault","updateMany","data","code","name","type","InvoiceType","STANDARD","nextNumber","digitCount","company","connect","update","duplicate","NOT","undefined","delete","invoiceCount","invoice","count","seriesId","getStats","currentYear","Date","getFullYear","startOfYear","endOfYear","totalInvoices","currentYearInvoices","lastInvoice","Promise","all","issueDate","gte","lte","number","select","fullNumber","lastInvoiceNumber"],"mappings":"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"}