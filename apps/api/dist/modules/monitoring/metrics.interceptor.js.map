{"version":3,"sources":["../../../src/modules/monitoring/metrics.interceptor.ts"],"sourcesContent":["import {\n  Injectable,\n  NestInterceptor,\n  ExecutionContext,\n  CallHandler,\n} from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { MetricsService } from './metrics.service.js';\n\n/**\n * HTTP Metrics Interceptor\n * Automatically tracks request duration and count for all endpoints\n */\n@Injectable()\nexport class MetricsInterceptor implements NestInterceptor {\n  constructor(private readonly metricsService: MetricsService) {}\n\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    const request = context.switchToHttp().getRequest();\n    const response = context.switchToHttp().getResponse();\n\n    const startTime = Date.now();\n    const method = request.method;\n    const route = this.getRoute(request);\n\n    return next.handle().pipe(\n      tap({\n        next: () => {\n          const duration = (Date.now() - startTime) / 1000; // Convert to seconds\n          const statusCode = response.statusCode;\n          this.metricsService.trackHttpRequest(method, route, statusCode, duration);\n        },\n        error: (error) => {\n          const duration = (Date.now() - startTime) / 1000;\n          const statusCode = error.status || 500;\n          this.metricsService.trackHttpRequest(method, route, statusCode, duration);\n        },\n      }),\n    );\n  }\n\n  /**\n   * Get normalized route path (remove IDs)\n   */\n  private getRoute(request: any): string {\n    // Use route pattern if available, otherwise use path\n    const route = request.route?.path || request.path;\n\n    // Normalize: remove UUIDs and numeric IDs\n    return route\n      .replace(/\\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi, '/:id')\n      .replace(/\\/\\d+/g, '/:id');\n  }\n}\n"],"names":["MetricsInterceptor","intercept","context","next","request","switchToHttp","getRequest","response","getResponse","startTime","Date","now","method","route","getRoute","handle","pipe","tap","duration","statusCode","metricsService","trackHttpRequest","error","status","path","replace"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBAVN;2BAEa;gCACW;;;;;;;;;;AAOxB,IAAA,AAAMA,qBAAN,MAAMA;IAGXC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACvE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,WAAWL,QAAQG,YAAY,GAAGG,WAAW;QAEnD,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,MAAMC,SAASR,QAAQQ,MAAM;QAC7B,MAAMC,QAAQ,IAAI,CAACC,QAAQ,CAACV;QAE5B,OAAOD,KAAKY,MAAM,GAAGC,IAAI,CACvBC,IAAAA,cAAG,EAAC;YACFd,MAAM;gBACJ,MAAMe,WAAW,AAACR,CAAAA,KAAKC,GAAG,KAAKF,SAAQ,IAAK,MAAM,qBAAqB;gBACvE,MAAMU,aAAaZ,SAASY,UAAU;gBACtC,IAAI,CAACC,cAAc,CAACC,gBAAgB,CAACT,QAAQC,OAAOM,YAAYD;YAClE;YACAI,OAAO,CAACA;gBACN,MAAMJ,WAAW,AAACR,CAAAA,KAAKC,GAAG,KAAKF,SAAQ,IAAK;gBAC5C,MAAMU,aAAaG,MAAMC,MAAM,IAAI;gBACnC,IAAI,CAACH,cAAc,CAACC,gBAAgB,CAACT,QAAQC,OAAOM,YAAYD;YAClE;QACF;IAEJ;IAEA;;GAEC,GACD,AAAQJ,SAASV,OAAY,EAAU;QACrC,qDAAqD;QACrD,MAAMS,QAAQT,QAAQS,KAAK,EAAEW,QAAQpB,QAAQoB,IAAI;QAEjD,0CAA0C;QAC1C,OAAOX,MACJY,OAAO,CAAC,oEAAoE,QAC5EA,OAAO,CAAC,UAAU;IACvB;IArCA,YAAY,AAAiBL,cAA8B,CAAE;aAAhCA,iBAAAA;IAAiC;AAsChE"}