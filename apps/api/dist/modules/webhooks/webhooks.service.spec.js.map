{"version":3,"sources":["../../../src/modules/webhooks/webhooks.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { WebhooksService } from './webhooks.service';\nimport { PrismaService } from '@crypto-erp/database';\nimport { Queue } from 'bullmq';\nimport { getQueueToken } from '@nestjs/bullmq';\nimport { NotFoundException, ConflictException } from '@nestjs/common';\n\ndescribe('WebhooksService', () => {\n  let service: WebhooksService;\n  let prisma: PrismaService;\n  let webhookQueue: Queue;\n\n  const mockPrisma = {\n    webhookSubscription: {\n      create: jest.fn(),\n      findMany: jest.fn(),\n      findUnique: jest.fn(),\n      update: jest.fn(),\n      delete: jest.fn(),\n    },\n    webhookDelivery: {\n      create: jest.fn(),\n      findMany: jest.fn(),\n      findFirst: jest.fn(),\n      update: jest.fn(),\n    },\n    webhookEvent: {\n      create: jest.fn(),\n    },\n  };\n\n  const mockQueue = {\n    add: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        WebhooksService,\n        {\n          provide: PrismaService,\n          useValue: mockPrisma,\n        },\n        {\n          provide: getQueueToken('webhook-delivery'),\n          useValue: mockQueue,\n        },\n      ],\n    }).compile();\n\n    service = module.get<WebhooksService>(WebhooksService);\n    prisma = module.get<PrismaService>(PrismaService);\n    webhookQueue = module.get<Queue>(getQueueToken('webhook-delivery'));\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('createSubscription', () => {\n    it('should create a webhook subscription with secret', async () => {\n      const companyId = 'company-123';\n      const dto = {\n        url: 'https://example.com/webhook',\n        events: ['invoice.created', 'invoice.sent'],\n        description: 'Test webhook',\n      };\n\n      const mockSubscription = {\n        id: 'sub-123',\n        companyId,\n        ...dto,\n        secret: expect.any(String),\n        isActive: true,\n        retryCount: 3,\n        timeout: 30000,\n      };\n\n      mockPrisma.webhookSubscription.create.mockResolvedValue(mockSubscription);\n\n      const result = await service.createSubscription(companyId, dto);\n\n      expect(result).toHaveProperty('secret');\n      expect(result.secret).toHaveLength(64);\n      expect(mockPrisma.webhookSubscription.create).toHaveBeenCalledWith({\n        data: expect.objectContaining({\n          companyId,\n          url: dto.url,\n          events: dto.events,\n          secret: expect.any(String),\n        }),\n      });\n    });\n  });\n\n  describe('findAllByCompany', () => {\n    it('should return all subscriptions for a company', async () => {\n      const companyId = 'company-123';\n      const mockSubscriptions = [\n        { id: 'sub-1', url: 'https://example.com/webhook1' },\n        { id: 'sub-2', url: 'https://example.com/webhook2' },\n      ];\n\n      mockPrisma.webhookSubscription.findMany.mockResolvedValue(mockSubscriptions);\n\n      const result = await service.findAllByCompany(companyId);\n\n      expect(result).toEqual(mockSubscriptions);\n      expect(mockPrisma.webhookSubscription.findMany).toHaveBeenCalledWith({\n        where: { companyId },\n        orderBy: { createdAt: 'desc' },\n      });\n    });\n  });\n\n  describe('emitEvent', () => {\n    it('should create event and queue deliveries for matching subscriptions', async () => {\n      const companyId = 'company-123';\n      const eventDto = {\n        event: 'invoice.created',\n        entityType: 'Invoice',\n        entityId: 'inv-123',\n        payload: { id: 'inv-123', amount: 1000 },\n      };\n\n      const mockSubscriptions = [\n        {\n          id: 'sub-1',\n          url: 'https://example.com/webhook',\n          secret: 'secret-123',\n          events: ['invoice.created'],\n          isActive: true,\n          retryCount: 3,\n          timeout: 30000,\n        },\n      ];\n\n      mockPrisma.webhookEvent.create.mockResolvedValue({ id: 'event-123' });\n      mockPrisma.webhookSubscription.findMany.mockResolvedValue(mockSubscriptions);\n      mockPrisma.webhookDelivery.findFirst.mockResolvedValue(null);\n      mockPrisma.webhookDelivery.create.mockResolvedValue({ id: 'delivery-123' });\n\n      await service.emitEvent(companyId, eventDto);\n\n      expect(mockPrisma.webhookEvent.create).toHaveBeenCalled();\n      expect(mockPrisma.webhookSubscription.findMany).toHaveBeenCalledWith({\n        where: { companyId, isActive: true },\n      });\n      expect(mockQueue.add).toHaveBeenCalled();\n    });\n\n    it('should not queue duplicate deliveries', async () => {\n      const companyId = 'company-123';\n      const eventDto = {\n        event: 'invoice.created',\n        entityType: 'Invoice',\n        entityId: 'inv-123',\n        payload: { id: 'inv-123' },\n      };\n\n      const mockSubscriptions = [\n        {\n          id: 'sub-1',\n          events: ['invoice.created'],\n          isActive: true,\n        },\n      ];\n\n      mockPrisma.webhookEvent.create.mockResolvedValue({ id: 'event-123' });\n      mockPrisma.webhookSubscription.findMany.mockResolvedValue(mockSubscriptions);\n      mockPrisma.webhookDelivery.findFirst.mockResolvedValue({ id: 'existing-delivery' });\n\n      await service.emitEvent(companyId, eventDto);\n\n      expect(mockPrisma.webhookDelivery.create).not.toHaveBeenCalled();\n      expect(mockQueue.add).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('generateSignature', () => {\n    it('should generate consistent HMAC signature', () => {\n      const payload = { test: 'data' };\n      const secret = 'test-secret';\n\n      const signature1 = WebhooksService.generateSignature(payload, secret);\n      const signature2 = WebhooksService.generateSignature(payload, secret);\n\n      expect(signature1).toBe(signature2);\n      expect(signature1).toHaveLength(64);\n    });\n\n    it('should generate different signatures for different secrets', () => {\n      const payload = { test: 'data' };\n\n      const sig1 = WebhooksService.generateSignature(payload, 'secret1');\n      const sig2 = WebhooksService.generateSignature(payload, 'secret2');\n\n      expect(sig1).not.toBe(sig2);\n    });\n  });\n\n  describe('testWebhook', () => {\n    it('should send test webhook', async () => {\n      const subscriptionId = 'sub-123';\n      const mockSubscription = {\n        id: subscriptionId,\n        url: 'https://example.com/webhook',\n        secret: 'secret-123',\n        events: ['*'],\n      };\n\n      mockPrisma.webhookSubscription.findUnique.mockResolvedValue(mockSubscription);\n      mockPrisma.webhookDelivery.findFirst.mockResolvedValue(null);\n      mockPrisma.webhookDelivery.create.mockResolvedValue({ id: 'delivery-123' });\n\n      const result = await service.testWebhook(subscriptionId);\n\n      expect(result).toHaveProperty('message');\n      expect(mockQueue.add).toHaveBeenCalled();\n    });\n\n    it('should throw NotFoundException if subscription not found', async () => {\n      mockPrisma.webhookSubscription.findUnique.mockResolvedValue(null);\n\n      await expect(service.testWebhook('invalid-id')).rejects.toThrow(NotFoundException);\n    });\n  });\n});\n"],"names":["describe","service","prisma","webhookQueue","mockPrisma","webhookSubscription","create","jest","fn","findMany","findUnique","update","delete","webhookDelivery","findFirst","webhookEvent","mockQueue","add","beforeEach","module","Test","createTestingModule","providers","WebhooksService","provide","PrismaService","useValue","getQueueToken","compile","get","clearAllMocks","it","expect","toBeDefined","companyId","dto","url","events","description","mockSubscription","id","secret","any","String","isActive","retryCount","timeout","mockResolvedValue","result","createSubscription","toHaveProperty","toHaveLength","toHaveBeenCalledWith","data","objectContaining","mockSubscriptions","findAllByCompany","toEqual","where","orderBy","createdAt","eventDto","event","entityType","entityId","payload","amount","emitEvent","toHaveBeenCalled","not","test","signature1","generateSignature","signature2","toBe","sig1","sig2","subscriptionId","testWebhook","rejects","toThrow","NotFoundException"],"mappings":"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"}