{"version":3,"sources":["../../../../src/modules/crypto/blockchain/solana-parser.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { CryptoTxType } from '@prisma/client';\n\nexport interface SolanaTransaction {\n  signature: string;\n  slot: number;\n  blockTime: number;\n  err: any;\n  memo?: string;\n  instructions: SolanaInstruction[];\n  balanceChanges: SolanaBalanceChange[];\n}\n\nexport interface SolanaInstruction {\n  programId: string;\n  accounts: string[];\n  data: string;\n  innerInstructions?: SolanaInstruction[];\n}\n\nexport interface SolanaBalanceChange {\n  account: string;\n  amount: number;\n  mint?: string;\n  decimals?: number;\n}\n\nexport interface ParsedSolanaTransaction {\n  type: CryptoTxType;\n  subtype?: string;\n  assetIn?: string;\n  amountIn?: string;\n  assetOut?: string;\n  amountOut?: string;\n  feeAsset: 'SOL';\n  feeAmount?: string;\n  confidence: number;\n  reasoning: string;\n}\n\n// Known Solana Program IDs\nconst PROGRAM_IDS = {\n  // Core programs\n  SYSTEM: '11111111111111111111111111111111',\n  TOKEN: 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA',\n  ASSOCIATED_TOKEN: 'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL',\n\n  // DEXs\n  RAYDIUM_V4: '675kPX9MHTjS2zt1qfzwCoKfse4L1h4L4qQHPAJNvL6p',\n  RAYDIUM_CLMM: 'CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK',\n  ORCA_WHIRLPOOL: 'whirLbMiicVdio4qvUfM5KAg6Ct8VwpYzGff3uctyCc',\n  JUPITER_V6: 'JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4',\n\n  // Staking\n  MARINADE: 'MarBmsSgKXdrN1egZf5sqe1TMai9K1rChYNDJgjq7aD',\n  LIDO: 'CrX7kMhLC3cSsXJdT7JDgqrRVWGnUpX3gfEfxxU2NVLi',\n\n  // Lending\n  SOLEND: 'So1endDq2YkqhipRh3WViPa8hdiSpxWy6z3Z6tMCpAo',\n  MANGO: 'mv3ekLzLbnVPNxjSKvqBpU3ZeZXPQdEC3bp5MDEBG68',\n};\n\n@Injectable()\nexport class SolanaParser {\n  private readonly logger = new Logger(SolanaParser.name);\n\n  /**\n   * Parse Solana transaction into standard format\n   */\n  parseTransaction(\n    tx: SolanaTransaction,\n    walletAddress: string,\n  ): ParsedSolanaTransaction {\n    try {\n      // Check for failed transactions\n      if (tx.err) {\n        return {\n          type: 'FAILED',\n          feeAsset: 'SOL',\n          confidence: 1.0,\n          reasoning: 'Transaction failed on-chain',\n        };\n      }\n\n      // Detect transaction type based on program IDs\n      const programIds = tx.instructions.map(i => i.programId);\n\n      // 1. Check for DEX swaps\n      if (this.isDexSwap(programIds)) {\n        return this.parseSwap(tx, walletAddress);\n      }\n\n      // 2. Check for staking operations\n      if (this.isStaking(programIds)) {\n        return this.parseStaking(tx, walletAddress);\n      }\n\n      // 3. Check for token transfers\n      if (this.isTokenTransfer(programIds)) {\n        return this.parseTokenTransfer(tx, walletAddress);\n      }\n\n      // 4. Check for SOL transfer (system program)\n      if (programIds.includes(PROGRAM_IDS.SYSTEM)) {\n        return this.parseSolTransfer(tx, walletAddress);\n      }\n\n      // Default: unknown transaction\n      return {\n        type: 'OTHER',\n        feeAsset: 'SOL',\n        confidence: 0.3,\n        reasoning: 'Unknown Solana transaction type',\n      };\n    } catch (error) {\n      this.logger.error(`Failed to parse Solana transaction: ${error.message}`);\n      return {\n        type: 'OTHER',\n        feeAsset: 'SOL',\n        confidence: 0.1,\n        reasoning: `Parse error: ${error.message}`,\n      };\n    }\n  }\n\n  private isDexSwap(programIds: string[]): boolean {\n    return (\n      programIds.includes(PROGRAM_IDS.RAYDIUM_V4) ||\n      programIds.includes(PROGRAM_IDS.RAYDIUM_CLMM) ||\n      programIds.includes(PROGRAM_IDS.ORCA_WHIRLPOOL) ||\n      programIds.includes(PROGRAM_IDS.JUPITER_V6)\n    );\n  }\n\n  private isStaking(programIds: string[]): boolean {\n    return (\n      programIds.includes(PROGRAM_IDS.MARINADE) ||\n      programIds.includes(PROGRAM_IDS.LIDO)\n    );\n  }\n\n  private isTokenTransfer(programIds: string[]): boolean {\n    return programIds.includes(PROGRAM_IDS.TOKEN);\n  }\n\n  private parseSwap(\n    tx: SolanaTransaction,\n    walletAddress: string,\n  ): ParsedSolanaTransaction {\n    // Analyze balance changes to determine swap\n    const balanceChanges = tx.balanceChanges.filter(\n      bc => bc.account === walletAddress,\n    );\n\n    if (balanceChanges.length < 2) {\n      return {\n        type: 'SWAP',\n        feeAsset: 'SOL',\n        confidence: 0.5,\n        reasoning: 'DEX swap detected but insufficient balance data',\n      };\n    }\n\n    // Find tokens that decreased (assetOut) and increased (assetIn)\n    const decreased = balanceChanges.filter(bc => bc.amount < 0);\n    const increased = balanceChanges.filter(bc => bc.amount > 0);\n\n    if (decreased.length > 0 && increased.length > 0) {\n      const assetOut = decreased[0].mint || 'SOL';\n      const amountOut = Math.abs(decreased[0].amount).toString();\n      const assetIn = increased[0].mint || 'SOL';\n      const amountIn = increased[0].amount.toString();\n\n      const protocol = this.detectDexProtocol(tx.instructions);\n\n      return {\n        type: 'SWAP',\n        subtype: protocol,\n        assetOut,\n        amountOut,\n        assetIn,\n        amountIn,\n        feeAsset: 'SOL',\n        confidence: 0.9,\n        reasoning: `Swap on ${protocol}: ${amountOut} ${assetOut} â†’ ${amountIn} ${assetIn}`,\n      };\n    }\n\n    return {\n      type: 'SWAP',\n      feeAsset: 'SOL',\n      confidence: 0.6,\n      reasoning: 'DEX swap detected',\n    };\n  }\n\n  private detectDexProtocol(instructions: SolanaInstruction[]): string {\n    for (const instruction of instructions) {\n      if (instruction.programId === PROGRAM_IDS.JUPITER_V6) return 'Jupiter';\n      if (instruction.programId === PROGRAM_IDS.RAYDIUM_V4) return 'Raydium';\n      if (instruction.programId === PROGRAM_IDS.RAYDIUM_CLMM) return 'Raydium CLMM';\n      if (instruction.programId === PROGRAM_IDS.ORCA_WHIRLPOOL) return 'Orca';\n    }\n    return 'Unknown DEX';\n  }\n\n  private parseStaking(\n    tx: SolanaTransaction,\n    walletAddress: string,\n  ): ParsedSolanaTransaction {\n    const balanceChanges = tx.balanceChanges.filter(\n      bc => bc.account === walletAddress,\n    );\n\n    // Check if SOL decreased (stake) or increased (unstake)\n    const solChange = balanceChanges.find(bc => !bc.mint); // SOL has no mint\n\n    if (!solChange) {\n      return {\n        type: 'STAKE',\n        feeAsset: 'SOL',\n        confidence: 0.7,\n        reasoning: 'Staking transaction detected',\n      };\n    }\n\n    if (solChange.amount < 0) {\n      // Staking SOL\n      return {\n        type: 'STAKE',\n        assetOut: 'SOL',\n        amountOut: Math.abs(solChange.amount).toString(),\n        feeAsset: 'SOL',\n        confidence: 0.9,\n        reasoning: `Staked ${Math.abs(solChange.amount)} SOL`,\n      };\n    } else {\n      // Unstaking SOL\n      return {\n        type: 'UNSTAKE',\n        assetIn: 'SOL',\n        amountIn: solChange.amount.toString(),\n        feeAsset: 'SOL',\n        confidence: 0.9,\n        reasoning: `Unstaked ${solChange.amount} SOL`,\n      };\n    }\n  }\n\n  private parseTokenTransfer(\n    tx: SolanaTransaction,\n    walletAddress: string,\n  ): ParsedSolanaTransaction {\n    const balanceChanges = tx.balanceChanges.filter(\n      bc => bc.account === walletAddress,\n    );\n\n    if (balanceChanges.length === 0) {\n      return {\n        type: 'OTHER',\n        feeAsset: 'SOL',\n        confidence: 0.4,\n        reasoning: 'Token program called but no balance changes detected',\n      };\n    }\n\n    const change = balanceChanges[0];\n\n    if (change.amount < 0) {\n      // Token sent\n      return {\n        type: 'TRANSFER_OUT',\n        assetOut: change.mint || 'SOL',\n        amountOut: Math.abs(change.amount).toString(),\n        feeAsset: 'SOL',\n        confidence: 0.95,\n        reasoning: `Sent ${Math.abs(change.amount)} ${change.mint || 'SOL'}`,\n      };\n    } else {\n      // Token received\n      return {\n        type: 'TRANSFER_IN',\n        assetIn: change.mint || 'SOL',\n        amountIn: change.amount.toString(),\n        feeAsset: 'SOL',\n        confidence: 0.95,\n        reasoning: `Received ${change.amount} ${change.mint || 'SOL'}`,\n      };\n    }\n  }\n\n  private parseSolTransfer(\n    tx: SolanaTransaction,\n    walletAddress: string,\n  ): ParsedSolanaTransaction {\n    const balanceChanges = tx.balanceChanges.filter(\n      bc => bc.account === walletAddress && !bc.mint,\n    );\n\n    if (balanceChanges.length === 0) {\n      return {\n        type: 'OTHER',\n        feeAsset: 'SOL',\n        confidence: 0.5,\n        reasoning: 'System program transaction',\n      };\n    }\n\n    const solChange = balanceChanges[0];\n\n    if (solChange.amount < 0) {\n      return {\n        type: 'TRANSFER_OUT',\n        assetOut: 'SOL',\n        amountOut: Math.abs(solChange.amount).toString(),\n        feeAsset: 'SOL',\n        confidence: 0.95,\n        reasoning: `Sent ${Math.abs(solChange.amount)} SOL`,\n      };\n    } else {\n      return {\n        type: 'TRANSFER_IN',\n        assetIn: 'SOL',\n        amountIn: solChange.amount.toString(),\n        feeAsset: 'SOL',\n        confidence: 0.95,\n        reasoning: `Received ${solChange.amount} SOL`,\n      };\n    }\n  }\n}\n"],"names":["SolanaParser","PROGRAM_IDS","SYSTEM","TOKEN","ASSOCIATED_TOKEN","RAYDIUM_V4","RAYDIUM_CLMM","ORCA_WHIRLPOOL","JUPITER_V6","MARINADE","LIDO","SOLEND","MANGO","parseTransaction","tx","walletAddress","err","type","feeAsset","confidence","reasoning","programIds","instructions","map","i","programId","isDexSwap","parseSwap","isStaking","parseStaking","isTokenTransfer","parseTokenTransfer","includes","parseSolTransfer","error","logger","message","balanceChanges","filter","bc","account","length","decreased","amount","increased","assetOut","mint","amountOut","Math","abs","toString","assetIn","amountIn","protocol","detectDexProtocol","subtype","instruction","solChange","find","change","Logger","name"],"mappings":"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"}