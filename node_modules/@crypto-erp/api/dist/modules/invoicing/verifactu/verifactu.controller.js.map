{"version":3,"sources":["../../../../src/modules/invoicing/verifactu/verifactu.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Param,\n  Headers,\n  BadRequestException,\n  Res,\n} from '@nestjs/common';\nimport { Response } from 'express';\nimport { VerifactuService } from './verifactu.service.js';\n\n@Controller('invoicing/verifactu')\nexport class VerifactuController {\n  constructor(private readonly verifactuService: VerifactuService) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  @Post('invoices/:invoiceId/generate')\n  async generateRecord(\n    @Headers() headers: Record<string, string>,\n    @Param('invoiceId') invoiceId: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.verifactuService.generateVerifactuRecord(companyId, invoiceId);\n  }\n\n  @Post('invoices/:invoiceId/send')\n  async sendToAEAT(\n    @Headers() headers: Record<string, string>,\n    @Param('invoiceId') invoiceId: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.verifactuService.sendToAEAT(companyId, invoiceId);\n  }\n\n  @Get('invoices/:invoiceId/status')\n  async getStatus(\n    @Headers() headers: Record<string, string>,\n    @Param('invoiceId') invoiceId: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.verifactuService.getVerificationStatus(companyId, invoiceId);\n  }\n\n  @Get('invoices/:invoiceId/xml')\n  async getXML(\n    @Headers() headers: Record<string, string>,\n    @Param('invoiceId') invoiceId: string,\n    @Res() res: Response,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const record = await this.verifactuService.generateVerifactuRecord(companyId, invoiceId);\n    const xml = this.verifactuService.generateXML(record);\n\n    res.setHeader('Content-Type', 'application/xml');\n    res.setHeader('Content-Disposition', `attachment; filename=verifactu_${invoiceId}.xml`);\n    res.send(xml);\n  }\n\n  @Get('chain/validate')\n  async validateChain(@Headers() headers: Record<string, string>) {\n    const companyId = this.getCompanyId(headers);\n    return this.verifactuService.validateChainIntegrity(companyId);\n  }\n}\n"],"names":["VerifactuController","getCompanyId","headers","companyId","BadRequestException","generateRecord","invoiceId","verifactuService","generateVerifactuRecord","sendToAEAT","getStatus","getVerificationStatus","getXML","res","record","xml","generateXML","setHeader","send","validateChain","validateChainIntegrity"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBALN;yBACkB;kCACQ;;;;;;;;;;;;;;;AAG1B,IAAA,AAAMA,sBAAN,MAAMA;IAGHC,aAAaC,OAA+B,EAAU;QAC5D,MAAMC,YAAYD,OAAO,CAAC,eAAe;QACzC,IAAI,CAACC,WAAW;YACd,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QACA,OAAOD;IACT;IAEA,MACME,eACJ,AAAWH,OAA+B,EAC1C,AAAoBI,SAAiB,EACrC;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,OAAO,IAAI,CAACK,gBAAgB,CAACC,uBAAuB,CAACL,WAAWG;IAClE;IAEA,MACMG,WACJ,AAAWP,OAA+B,EAC1C,AAAoBI,SAAiB,EACrC;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,OAAO,IAAI,CAACK,gBAAgB,CAACE,UAAU,CAACN,WAAWG;IACrD;IAEA,MACMI,UACJ,AAAWR,OAA+B,EAC1C,AAAoBI,SAAiB,EACrC;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,OAAO,IAAI,CAACK,gBAAgB,CAACI,qBAAqB,CAACR,WAAWG;IAChE;IAEA,MACMM,OACJ,AAAWV,OAA+B,EAC1C,AAAoBI,SAAiB,EACrC,AAAOO,GAAa,EACpB;QACA,MAAMV,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,MAAMY,SAAS,MAAM,IAAI,CAACP,gBAAgB,CAACC,uBAAuB,CAACL,WAAWG;QAC9E,MAAMS,MAAM,IAAI,CAACR,gBAAgB,CAACS,WAAW,CAACF;QAE9CD,IAAII,SAAS,CAAC,gBAAgB;QAC9BJ,IAAII,SAAS,CAAC,uBAAuB,CAAC,+BAA+B,EAAEX,UAAU,IAAI,CAAC;QACtFO,IAAIK,IAAI,CAACH;IACX;IAEA,MACMI,cAAc,AAAWjB,OAA+B,EAAE;QAC9D,MAAMC,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,OAAO,IAAI,CAACK,gBAAgB,CAACa,sBAAsB,CAACjB;IACtD;IAxDA,YAAY,AAAiBI,gBAAkC,CAAE;aAApCA,mBAAAA;IAAqC;AAyDpE"}