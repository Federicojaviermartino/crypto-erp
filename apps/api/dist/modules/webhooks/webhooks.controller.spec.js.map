{"version":3,"sources":["../../../src/modules/webhooks/webhooks.controller.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { WebhooksController } from './webhooks.controller';\nimport { WebhooksService } from './webhooks.service';\n\ndescribe('WebhooksController', () => {\n  let controller: WebhooksController;\n  let service: WebhooksService;\n\n  const mockWebhooksService = {\n    createSubscription: jest.fn(),\n    findAllByCompany: jest.fn(),\n    findOne: jest.fn(),\n    updateSubscription: jest.fn(),\n    deleteSubscription: jest.fn(),\n    testWebhook: jest.fn(),\n    getDeliveries: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      controllers: [WebhooksController],\n      providers: [\n        {\n          provide: WebhooksService,\n          useValue: mockWebhooksService,\n        },\n      ],\n    }).compile();\n\n    controller = module.get<WebhooksController>(WebhooksController);\n    service = module.get<WebhooksService>(WebhooksService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(controller).toBeDefined();\n  });\n\n  describe('create', () => {\n    it('should create a webhook subscription', async () => {\n      const companyId = 'company-123';\n      const dto = {\n        url: 'https://example.com/webhook',\n        events: ['invoice.created'],\n      };\n      const mockResult = { id: 'sub-123', ...dto, secret: 'secret-123' };\n\n      mockWebhooksService.createSubscription.mockResolvedValue(mockResult);\n\n      const result = await controller.create(companyId, dto);\n\n      expect(result).toEqual(mockResult);\n      expect(service.createSubscription).toHaveBeenCalledWith(companyId, dto);\n    });\n  });\n\n  describe('findAll', () => {\n    it('should return all subscriptions for a company', async () => {\n      const companyId = 'company-123';\n      const mockSubscriptions = [\n        { id: 'sub-1', url: 'https://example.com/webhook1' },\n        { id: 'sub-2', url: 'https://example.com/webhook2' },\n      ];\n\n      mockWebhooksService.findAllByCompany.mockResolvedValue(mockSubscriptions);\n\n      const result = await controller.findAll(companyId);\n\n      expect(result).toEqual(mockSubscriptions);\n      expect(service.findAllByCompany).toHaveBeenCalledWith(companyId);\n    });\n  });\n\n  describe('findOne', () => {\n    it('should return a single subscription', async () => {\n      const id = 'sub-123';\n      const companyId = 'company-123';\n      const mockSubscription = { id, url: 'https://example.com/webhook' };\n\n      mockWebhooksService.findOne.mockResolvedValue(mockSubscription);\n\n      const result = await controller.findOne(id, companyId);\n\n      expect(result).toEqual(mockSubscription);\n      expect(service.findOne).toHaveBeenCalledWith(id, companyId);\n    });\n  });\n\n  describe('update', () => {\n    it('should update a subscription', async () => {\n      const id = 'sub-123';\n      const companyId = 'company-123';\n      const dto = { isActive: false };\n      const mockUpdated = { id, isActive: false };\n\n      mockWebhooksService.updateSubscription.mockResolvedValue(mockUpdated);\n\n      const result = await controller.update(id, companyId, dto);\n\n      expect(result).toEqual(mockUpdated);\n      expect(service.updateSubscription).toHaveBeenCalledWith(id, companyId, dto);\n    });\n  });\n\n  describe('remove', () => {\n    it('should delete a subscription', async () => {\n      const id = 'sub-123';\n      const companyId = 'company-123';\n\n      mockWebhooksService.deleteSubscription.mockResolvedValue({ message: 'Deleted' });\n\n      const result = await controller.remove(id, companyId);\n\n      expect(result).toHaveProperty('message');\n      expect(service.deleteSubscription).toHaveBeenCalledWith(id, companyId);\n    });\n  });\n\n  describe('test', () => {\n    it('should send a test webhook', async () => {\n      const id = 'sub-123';\n      const mockResult = { message: 'Test webhook queued' };\n\n      mockWebhooksService.testWebhook.mockResolvedValue(mockResult);\n\n      const result = await controller.test(id);\n\n      expect(result).toEqual(mockResult);\n      expect(service.testWebhook).toHaveBeenCalledWith(id);\n    });\n  });\n\n  describe('getDeliveries', () => {\n    it('should return delivery history', async () => {\n      const id = 'sub-123';\n      const mockDeliveries = [\n        { id: 'del-1', status: 'DELIVERED' },\n        { id: 'del-2', status: 'PENDING' },\n      ];\n\n      mockWebhooksService.getDeliveries.mockResolvedValue(mockDeliveries);\n\n      const result = await controller.getDeliveries(id);\n\n      expect(result).toEqual(mockDeliveries);\n      expect(service.getDeliveries).toHaveBeenCalledWith(id);\n    });\n  });\n});\n"],"names":["describe","controller","service","mockWebhooksService","createSubscription","jest","fn","findAllByCompany","findOne","updateSubscription","deleteSubscription","testWebhook","getDeliveries","beforeEach","module","Test","createTestingModule","controllers","WebhooksController","providers","provide","WebhooksService","useValue","compile","get","clearAllMocks","it","expect","toBeDefined","companyId","dto","url","events","mockResult","id","secret","mockResolvedValue","result","create","toEqual","toHaveBeenCalledWith","mockSubscriptions","findAll","mockSubscription","isActive","mockUpdated","update","message","remove","toHaveProperty","test","mockDeliveries","status"],"mappings":"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"}