{"version":3,"sources":["../../../src/modules/oauth/oauth.service.ts"],"sourcesContent":["import {\n  Injectable,\n  BadRequestException,\n  UnauthorizedException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport * as bcrypt from 'bcrypt';\nimport * as crypto from 'crypto';\nimport { CreateOAuthAppDto } from './dto/create-oauth-app.dto.js';\n\n/**\n * OAuth 2.0 Service\n * Implements OAuth 2.0 Authorization Code Flow with PKCE support\n * Supports scopes, token refresh, and token revocation\n */\n@Injectable()\nexport class OAuthService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  // Token expiration times\n  private readonly ACCESS_TOKEN_EXPIRY = 3600; // 1 hour in seconds\n  private readonly REFRESH_TOKEN_EXPIRY = 2592000; // 30 days in seconds\n  private readonly AUTH_CODE_EXPIRY = 600; // 10 minutes in seconds\n\n  /**\n   * Create a new OAuth application\n   */\n  async createApp(\n    companyId: string,\n    userId: string,\n    dto: CreateOAuthAppDto,\n  ) {\n    // Generate client credentials\n    const clientId = this.generateClientId();\n    const clientSecret = this.generateClientSecret();\n    const hashedSecret = await bcrypt.hash(clientSecret, 10);\n\n    const app = await this.prisma.oAuthApp.create({\n      data: {\n        companyId,\n        createdById: userId,\n        name: dto.name,\n        description: dto.description,\n        logoUrl: dto.logoUrl,\n        website: dto.website,\n        clientId,\n        clientSecret: hashedSecret,\n        redirectUris: dto.redirectUris,\n        scopes: dto.scopes,\n        rateLimit: dto.rateLimit || 1000,\n        dailyQuota: dto.dailyQuota || 10000,\n      },\n    });\n\n    return {\n      id: app.id,\n      name: app.name,\n      clientId: app.clientId,\n      clientSecret: clientSecret, // Return plain secret only once\n      redirectUris: app.redirectUris,\n      scopes: app.scopes,\n      rateLimit: app.rateLimit,\n      dailyQuota: app.dailyQuota,\n      createdAt: app.createdAt,\n    };\n  }\n\n  /**\n   * Get OAuth app by client ID\n   */\n  async getAppByClientId(clientId: string) {\n    const app = await this.prisma.oAuthApp.findUnique({\n      where: { clientId },\n    });\n\n    if (!app) {\n      throw new NotFoundException('OAuth app not found');\n    }\n\n    if (!app.isActive) {\n      throw new BadRequestException('OAuth app is inactive');\n    }\n\n    return app;\n  }\n\n  /**\n   * List OAuth apps for a company\n   */\n  async listApps(companyId: string) {\n    return this.prisma.oAuthApp.findMany({\n      where: { companyId },\n      select: {\n        id: true,\n        name: true,\n        description: true,\n        logoUrl: true,\n        website: true,\n        clientId: true,\n        redirectUris: true,\n        scopes: true,\n        rateLimit: true,\n        dailyQuota: true,\n        isActive: true,\n        isPublic: true,\n        createdAt: true,\n        updatedAt: true,\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  /**\n   * Generate authorization code\n   * Step 1 of OAuth 2.0 Authorization Code Flow\n   */\n  async generateAuthorizationCode(\n    clientId: string,\n    userId: string,\n    companyId: string,\n    redirectUri: string,\n    scopes: string[],\n  ) {\n    const app = await this.getAppByClientId(clientId);\n\n    // Validate redirect URI\n    if (!app.redirectUris.includes(redirectUri)) {\n      throw new BadRequestException('Invalid redirect URI');\n    }\n\n    // Validate scopes\n    const invalidScopes = scopes.filter(scope => !app.scopes.includes(scope));\n    if (invalidScopes.length > 0) {\n      throw new BadRequestException(`Invalid scopes: ${invalidScopes.join(', ')}`);\n    }\n\n    // Generate authorization code\n    const code = this.generateRandomToken(32);\n    const hashedCode = await bcrypt.hash(code, 10);\n\n    const expiresAt = new Date(Date.now() + this.AUTH_CODE_EXPIRY * 1000);\n\n    // Store authorization code in token table\n    await this.prisma.oAuthToken.create({\n      data: {\n        appId: app.id,\n        userId,\n        companyId,\n        authorizationCode: hashedCode,\n        codeExpiresAt: expiresAt,\n        scopes,\n        accessToken: '', // Placeholder, will be set when code is exchanged\n        expiresAt: new Date(), // Placeholder\n      },\n    });\n\n    return {\n      code,\n      expiresIn: this.AUTH_CODE_EXPIRY,\n    };\n  }\n\n  /**\n   * Exchange authorization code for access token\n   * Step 2 of OAuth 2.0 Authorization Code Flow\n   */\n  async exchangeCodeForToken(\n    code: string,\n    clientId: string,\n    clientSecret: string,\n    redirectUri: string,\n  ) {\n    const app = await this.getAppByClientId(clientId);\n\n    // Verify client secret\n    const secretValid = await bcrypt.compare(clientSecret, app.clientSecret);\n    if (!secretValid) {\n      throw new UnauthorizedException('Invalid client credentials');\n    }\n\n    // Find authorization code\n    const tokenRecords = await this.prisma.oAuthToken.findMany({\n      where: {\n        appId: app.id,\n        isRevoked: false,\n      },\n    });\n\n    let tokenRecord = null;\n    for (const record of tokenRecords) {\n      if (record.authorizationCode) {\n        const codeValid = await bcrypt.compare(code, record.authorizationCode);\n        if (codeValid) {\n          tokenRecord = record;\n          break;\n        }\n      }\n    }\n\n    if (!tokenRecord) {\n      throw new UnauthorizedException('Invalid authorization code');\n    }\n\n    // Check if code is expired\n    if (tokenRecord.codeExpiresAt && tokenRecord.codeExpiresAt < new Date()) {\n      throw new UnauthorizedException('Authorization code expired');\n    }\n\n    // Generate access and refresh tokens\n    const accessToken = this.generateRandomToken(64);\n    const refreshToken = this.generateRandomToken(64);\n\n    const hashedAccessToken = await bcrypt.hash(accessToken, 10);\n    const hashedRefreshToken = await bcrypt.hash(refreshToken, 10);\n\n    const accessTokenExpiresAt = new Date(\n      Date.now() + this.ACCESS_TOKEN_EXPIRY * 1000,\n    );\n    const refreshTokenExpiresAt = new Date(\n      Date.now() + this.REFRESH_TOKEN_EXPIRY * 1000,\n    );\n\n    // Update token record with access and refresh tokens\n    await this.prisma.oAuthToken.update({\n      where: { id: tokenRecord.id },\n      data: {\n        accessToken: hashedAccessToken,\n        refreshToken: hashedRefreshToken,\n        expiresAt: accessTokenExpiresAt,\n        refreshExpiresAt: refreshTokenExpiresAt,\n        authorizationCode: null, // Clear used code\n        codeExpiresAt: null,\n      },\n    });\n\n    return {\n      accessToken,\n      refreshToken,\n      tokenType: 'Bearer',\n      expiresIn: this.ACCESS_TOKEN_EXPIRY,\n      scope: tokenRecord.scopes.join(' '),\n    };\n  }\n\n  /**\n   * Refresh access token using refresh token\n   */\n  async refreshAccessToken(refreshToken: string, clientId: string, clientSecret: string) {\n    const app = await this.getAppByClientId(clientId);\n\n    // Verify client secret\n    const secretValid = await bcrypt.compare(clientSecret, app.clientSecret);\n    if (!secretValid) {\n      throw new UnauthorizedException('Invalid client credentials');\n    }\n\n    // Find refresh token\n    const tokenRecords = await this.prisma.oAuthToken.findMany({\n      where: {\n        appId: app.id,\n        isRevoked: false,\n      },\n    });\n\n    let tokenRecord = null;\n    for (const record of tokenRecords) {\n      if (record.refreshToken) {\n        const tokenValid = await bcrypt.compare(refreshToken, record.refreshToken);\n        if (tokenValid) {\n          tokenRecord = record;\n          break;\n        }\n      }\n    }\n\n    if (!tokenRecord) {\n      throw new UnauthorizedException('Invalid refresh token');\n    }\n\n    // Check if refresh token is expired\n    if (\n      tokenRecord.refreshExpiresAt &&\n      tokenRecord.refreshExpiresAt < new Date()\n    ) {\n      throw new UnauthorizedException('Refresh token expired');\n    }\n\n    // Generate new access token\n    const newAccessToken = this.generateRandomToken(64);\n    const hashedAccessToken = await bcrypt.hash(newAccessToken, 10);\n\n    const accessTokenExpiresAt = new Date(\n      Date.now() + this.ACCESS_TOKEN_EXPIRY * 1000,\n    );\n\n    // Update token record\n    await this.prisma.oAuthToken.update({\n      where: { id: tokenRecord.id },\n      data: {\n        accessToken: hashedAccessToken,\n        expiresAt: accessTokenExpiresAt,\n        lastUsedAt: new Date(),\n      },\n    });\n\n    return {\n      accessToken: newAccessToken,\n      tokenType: 'Bearer',\n      expiresIn: this.ACCESS_TOKEN_EXPIRY,\n      scope: tokenRecord.scopes.join(' '),\n    };\n  }\n\n  /**\n   * Verify access token and return token data\n   */\n  async verifyAccessToken(accessToken: string) {\n    const tokenRecords = await this.prisma.oAuthToken.findMany({\n      where: {\n        isRevoked: false,\n      },\n      include: {\n        app: true,\n        user: true,\n        company: true,\n      },\n    });\n\n    let tokenRecord = null;\n    for (const record of tokenRecords) {\n      const tokenValid = await bcrypt.compare(accessToken, record.accessToken);\n      if (tokenValid) {\n        tokenRecord = record;\n        break;\n      }\n    }\n\n    if (!tokenRecord) {\n      throw new UnauthorizedException('Invalid access token');\n    }\n\n    // Check if token is expired\n    if (tokenRecord.expiresAt < new Date()) {\n      throw new UnauthorizedException('Access token expired');\n    }\n\n    // Check if app is still active\n    if (!tokenRecord.app.isActive) {\n      throw new UnauthorizedException('OAuth app is inactive');\n    }\n\n    // Update last used timestamp\n    await this.prisma.oAuthToken.update({\n      where: { id: tokenRecord.id },\n      data: { lastUsedAt: new Date() },\n    });\n\n    return {\n      userId: tokenRecord.userId,\n      companyId: tokenRecord.companyId,\n      scopes: tokenRecord.scopes,\n      app: {\n        id: tokenRecord.app.id,\n        name: tokenRecord.app.name,\n        clientId: tokenRecord.app.clientId,\n      },\n    };\n  }\n\n  /**\n   * Revoke token (access or refresh)\n   */\n  async revokeToken(token: string) {\n    const tokenRecords = await this.prisma.oAuthToken.findMany({\n      where: {\n        isRevoked: false,\n      },\n    });\n\n    for (const record of tokenRecords) {\n      const accessTokenMatch = await bcrypt.compare(token, record.accessToken);\n      const refreshTokenMatch =\n        record.refreshToken && (await bcrypt.compare(token, record.refreshToken));\n\n      if (accessTokenMatch || refreshTokenMatch) {\n        await this.prisma.oAuthToken.update({\n          where: { id: record.id },\n          data: { isRevoked: true },\n        });\n        return { success: true };\n      }\n    }\n\n    return { success: false };\n  }\n\n  /**\n   * Delete OAuth app\n   */\n  async deleteApp(appId: string, companyId: string) {\n    const app = await this.prisma.oAuthApp.findFirst({\n      where: { id: appId, companyId },\n    });\n\n    if (!app) {\n      throw new NotFoundException('OAuth app not found');\n    }\n\n    await this.prisma.oAuthApp.delete({\n      where: { id: appId },\n    });\n\n    return { success: true };\n  }\n\n  // ============================================================================\n  // Helper Methods\n  // ============================================================================\n\n  private generateClientId(): string {\n    return `${crypto.randomBytes(8).toString('hex')}_${Date.now().toString(36)}`;\n  }\n\n  private generateClientSecret(): string {\n    return crypto.randomBytes(32).toString('base64url');\n  }\n\n  private generateRandomToken(length: number): string {\n    return crypto.randomBytes(length).toString('base64url');\n  }\n}\n"],"names":["OAuthService","createApp","companyId","userId","dto","clientId","generateClientId","clientSecret","generateClientSecret","hashedSecret","bcrypt","hash","app","prisma","oAuthApp","create","data","createdById","name","description","logoUrl","website","redirectUris","scopes","rateLimit","dailyQuota","id","createdAt","getAppByClientId","findUnique","where","NotFoundException","isActive","BadRequestException","listApps","findMany","select","isPublic","updatedAt","orderBy","generateAuthorizationCode","redirectUri","includes","invalidScopes","filter","scope","length","join","code","generateRandomToken","hashedCode","expiresAt","Date","now","AUTH_CODE_EXPIRY","oAuthToken","appId","authorizationCode","codeExpiresAt","accessToken","expiresIn","exchangeCodeForToken","secretValid","compare","UnauthorizedException","tokenRecords","isRevoked","tokenRecord","record","codeValid","refreshToken","hashedAccessToken","hashedRefreshToken","accessTokenExpiresAt","ACCESS_TOKEN_EXPIRY","refreshTokenExpiresAt","REFRESH_TOKEN_EXPIRY","update","refreshExpiresAt","tokenType","refreshAccessToken","tokenValid","newAccessToken","lastUsedAt","verifyAccessToken","include","user","company","revokeToken","token","accessTokenMatch","refreshTokenMatch","success","deleteApp","findFirst","delete","crypto","randomBytes","toString"],"mappings":"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"}