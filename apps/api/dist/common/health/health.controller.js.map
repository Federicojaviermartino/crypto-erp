{"version":3,"sources":["../../../src/common/health/health.controller.ts"],"sourcesContent":["import { Controller, Get } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { InjectQueue } from '@nestjs/bullmq';\nimport { Queue } from 'bullmq';\n\nexport interface HealthStatus {\n  status: 'ok' | 'error';\n  timestamp: Date;\n  services: {\n    database: 'healthy' | 'unhealthy';\n    redis: 'healthy' | 'unhealthy';\n  };\n  uptime: number;\n}\n\nexport interface RegionalHealthStatus {\n  status: 'ok' | 'degraded' | 'error';\n  timestamp: Date;\n  region: string;\n  services: {\n    primaryDatabase: 'healthy' | 'unhealthy';\n    readReplicas: {\n      region: string;\n      status: 'healthy' | 'unhealthy';\n      latency: number;\n    }[];\n    redis: 'healthy' | 'unhealthy';\n  };\n  replicaCount: number;\n  uptime: number;\n}\n\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private prisma: PrismaService,\n    @InjectQueue('email-send') private emailQueue: Queue,\n  ) {}\n\n  @Get()\n  async check(): Promise<HealthStatus> {\n    const [dbOk, redisOk] = await Promise.all([\n      this.checkDatabase(),\n      this.checkRedis(),\n    ]);\n\n    return {\n      status: dbOk && redisOk ? 'ok' : 'error',\n      timestamp: new Date(),\n      services: {\n        database: dbOk ? 'healthy' : 'unhealthy',\n        redis: redisOk ? 'healthy' : 'unhealthy',\n      },\n      uptime: process.uptime(),\n    };\n  }\n\n  @Get('liveness')\n  async liveness() {\n    return { status: 'ok', timestamp: new Date() };\n  }\n\n  @Get('readiness')\n  async readiness(): Promise<HealthStatus> {\n    return this.check();\n  }\n\n  @Get('regional')\n  async regionalHealth(): Promise<RegionalHealthStatus> {\n    const primaryRegion = process.env['DATABASE_PRIMARY_REGION'] || 'eu';\n    const [primaryOk, replicaStatuses, redisOk] = await Promise.all([\n      this.checkDatabase(),\n      this.checkReadReplicas(),\n      this.checkRedis(),\n    ]);\n\n    const replicaCount = this.prisma.getReplicaCount();\n    const allHealthy = primaryOk && redisOk && replicaStatuses.every(r => r.status === 'healthy');\n    const anyUnhealthy = !primaryOk || !redisOk || replicaStatuses.some(r => r.status === 'unhealthy');\n\n    return {\n      status: allHealthy ? 'ok' : anyUnhealthy ? 'error' : 'degraded',\n      timestamp: new Date(),\n      region: primaryRegion,\n      services: {\n        primaryDatabase: primaryOk ? 'healthy' : 'unhealthy',\n        readReplicas: replicaStatuses,\n        redis: redisOk ? 'healthy' : 'unhealthy',\n      },\n      replicaCount,\n      uptime: process.uptime(),\n    };\n  }\n\n  private async checkDatabase(): Promise<boolean> {\n    try {\n      await this.prisma.$queryRaw`SELECT 1`;\n      return true;\n    } catch (error) {\n      console.error('Database health check failed:', error);\n      return false;\n    }\n  }\n\n  private async checkRedis(): Promise<boolean> {\n    try {\n      await this.emailQueue.client.ping();\n      return true;\n    } catch (error) {\n      console.error('Redis health check failed:', error);\n      return false;\n    }\n  }\n\n  private async checkReadReplicas(): Promise<\n    Array<{ region: string; status: 'healthy' | 'unhealthy'; latency: number }>\n  > {\n    const regions = this.prisma.getAvailableRegions();\n    const results = await Promise.all(\n      regions.map(async (region) => {\n        const startTime = Date.now();\n        try {\n          const replica = this.prisma.getReadReplica(region);\n          await replica.$queryRaw`SELECT 1`;\n          const latency = Date.now() - startTime;\n          return { region, status: 'healthy' as const, latency };\n        } catch (error) {\n          console.error(`Read replica health check failed for ${region}:`, error);\n          return { region, status: 'unhealthy' as const, latency: -1 };\n        }\n      }),\n    );\n    return results;\n  }\n}\n"],"names":["HealthController","check","dbOk","redisOk","Promise","all","checkDatabase","checkRedis","status","timestamp","Date","services","database","redis","uptime","process","liveness","readiness","regionalHealth","primaryRegion","env","primaryOk","replicaStatuses","checkReadReplicas","replicaCount","prisma","getReplicaCount","allHealthy","every","r","anyUnhealthy","some","region","primaryDatabase","readReplicas","$queryRaw","error","console","emailQueue","client","ping","regions","getAvailableRegions","results","map","startTime","now","replica","getReadReplica","latency"],"mappings":"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"}