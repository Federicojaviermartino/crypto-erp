{"version":3,"sources":["../../../src/modules/notifications/notifications.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { InjectQueue } from '@nestjs/bullmq';\nimport { Queue } from 'bullmq';\nimport { ConfigService } from '@nestjs/config';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { EmailPayload, TemplateData } from './dto/email-payload.dto';\n\ninterface User {\n  id: string;\n  email: string;\n  firstName: string;\n  lastName: string;\n}\n\ninterface CompanyInvitation {\n  id: string;\n  email: string;\n  token: string;\n  role: string;\n  company: {\n    id: string;\n    name: string;\n  };\n  inviter: {\n    id: string;\n    firstName: string;\n    lastName: string;\n  };\n}\n\n@Injectable()\nexport class NotificationsService {\n  private readonly logger = new Logger(NotificationsService.name);\n  private readonly defaultFrom: string;\n  private readonly webUrl: string;\n\n  constructor(\n    @InjectQueue('email-send') private emailQueue: Queue,\n    private configService: ConfigService,\n  ) {\n    this.defaultFrom = this.configService.get<string>('EMAIL_FROM', 'Crypto-ERP <noreply@crypto-erp.com>');\n    this.webUrl = this.configService.get<string>('WEB_URL', 'http://localhost:4200');\n  }\n\n  /**\n   * Send welcome email to new user\n   */\n  async sendWelcomeEmail(user: User): Promise<void> {\n    const html = this.renderTemplate('welcome', {\n      firstName: user.firstName,\n      loginUrl: `${this.webUrl}/auth/login`,\n    });\n\n    await this.queueEmail({\n      to: user.email,\n      subject: 'Bienvenido a Crypto-ERP',\n      html,\n    });\n\n    this.logger.log(`Welcome email queued for ${user.email}`);\n  }\n\n  /**\n   * Send password reset email\n   */\n  async sendPasswordResetEmail(user: User, resetToken: string): Promise<void> {\n    const html = this.renderTemplate('password-reset', {\n      firstName: user.firstName,\n      resetUrl: `${this.webUrl}/auth/reset-password?token=${resetToken}`,\n      expiresIn: '1 hora',\n    });\n\n    await this.queueEmail({\n      to: user.email,\n      subject: 'Restablecer contraseña - Crypto-ERP',\n      html,\n    });\n\n    this.logger.log(`Password reset email queued for ${user.email}`);\n  }\n\n  /**\n   * Send team invitation email\n   */\n  async sendTeamInvitation(invitation: CompanyInvitation): Promise<void> {\n    const html = this.renderTemplate('team-invitation', {\n      companyName: invitation.company.name,\n      inviterName: invitation.inviter.firstName,\n      role: this.getRoleDisplayName(invitation.role),\n      acceptUrl: `${this.webUrl}/invitations/${invitation.token}`,\n    });\n\n    await this.queueEmail({\n      to: invitation.email,\n      subject: `Invitación a ${invitation.company.name} - Crypto-ERP`,\n      html,\n    });\n\n    this.logger.log(`Team invitation email queued for ${invitation.email}`);\n  }\n\n  /**\n   * Send invoice notification (for future use)\n   */\n  async sendInvoiceNotification(\n    recipientEmail: string,\n    invoiceNumber: string,\n    pdfUrl?: string,\n  ): Promise<void> {\n    // Placeholder for future invoice email template\n    const html = `\n      <html>\n        <body>\n          <h1>Nueva Factura</h1>\n          <p>Has recibido la factura ${invoiceNumber}</p>\n          ${pdfUrl ? `<a href=\"${pdfUrl}\">Descargar PDF</a>` : ''}\n        </body>\n      </html>\n    `;\n\n    await this.queueEmail({\n      to: recipientEmail,\n      subject: `Factura ${invoiceNumber}`,\n      html,\n    });\n\n    this.logger.log(`Invoice notification queued for ${recipientEmail}`);\n  }\n\n  /**\n   * Queue email for async processing\n   */\n  private async queueEmail(emailData: EmailPayload): Promise<void> {\n    // Set default 'from' if not provided\n    if (!emailData.from) {\n      emailData.from = this.defaultFrom;\n    }\n\n    await this.emailQueue.add('send-email', emailData, {\n      attempts: 3,\n      backoff: {\n        type: 'exponential',\n        delay: 2000,\n      },\n      removeOnComplete: true,\n      removeOnFail: false,\n    });\n  }\n\n  /**\n   * Render email template with data\n   */\n  private renderTemplate(templateName: string, data: TemplateData): string {\n    const templatePath = path.join(__dirname, 'templates', `${templateName}.html`);\n\n    try {\n      let html = fs.readFileSync(templatePath, 'utf-8');\n\n      // Simple template variable replacement\n      Object.keys(data).forEach((key) => {\n        const regex = new RegExp(`{{${key}}}`, 'g');\n        html = html.replace(regex, String(data[key]));\n      });\n\n      return html;\n    } catch (error) {\n      this.logger.error(`Failed to render template ${templateName}:`, error);\n      throw new Error(`Email template ${templateName} not found`);\n    }\n  }\n\n  /**\n   * Get display name for user role\n   */\n  private getRoleDisplayName(role: string): string {\n    const roleNames: Record<string, string> = {\n      OWNER: 'Propietario',\n      ADMIN: 'Administrador',\n      ACCOUNTANT: 'Contable',\n      USER: 'Usuario',\n      VIEWER: 'Visualizador',\n    };\n\n    return roleNames[role] || role;\n  }\n\n  /**\n   * Send custom email (for admin use or testing)\n   */\n  async sendCustomEmail(\n    to: string | string[],\n    subject: string,\n    html: string,\n  ): Promise<void> {\n    await this.queueEmail({\n      to,\n      subject,\n      html,\n    });\n\n    this.logger.log(`Custom email queued for ${Array.isArray(to) ? to.join(', ') : to}`);\n  }\n}\n"],"names":["NotificationsService","sendWelcomeEmail","user","html","renderTemplate","firstName","loginUrl","webUrl","queueEmail","to","email","subject","logger","log","sendPasswordResetEmail","resetToken","resetUrl","expiresIn","sendTeamInvitation","invitation","companyName","company","name","inviterName","inviter","role","getRoleDisplayName","acceptUrl","token","sendInvoiceNotification","recipientEmail","invoiceNumber","pdfUrl","emailData","from","defaultFrom","emailQueue","add","attempts","backoff","type","delay","removeOnComplete","removeOnFail","templateName","data","templatePath","path","join","__dirname","fs","readFileSync","Object","keys","forEach","key","regex","RegExp","replace","String","error","Error","roleNames","OWNER","ADMIN","ACCOUNTANT","USER","VIEWER","sendCustomEmail","Array","isArray","configService","Logger","get"],"mappings":"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"}