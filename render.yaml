# Render Blueprint for Crypto ERP
# https://render.com/docs/blueprint-spec
# Updated: Phase 4B - Simplified for Render compatibility

services:
  # ============================================================================
  # NestJS API Backend (Main Application)
  # ============================================================================
  - type: web
    name: crypto-erp-api
    env: node
    region: frankfurt
    plan: starter
    buildCommand: npm ci && npm run build:api && npm run db:migrate:prod
    startCommand: npm run start:api:prod
    healthCheckPath: /api/v1/health/liveness
    envVars:
      # Environment
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: API_PREFIX
        value: api/v1

      # Database (PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: crypto-erp-db
          property: connectionString
      - key: DATABASE_PRIMARY_REGION
        value: eu

      # Redis (must be configured manually via Upstash)
      # After deployment, add these variables manually:
      # REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, REDIS_DB
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        sync: false
      - key: REDIS_PASSWORD
        sync: false
      - key: REDIS_DB
        value: 0

      # JWT Authentication
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: JWT_EXPIRATION
        value: 1h
      - key: JWT_REFRESH_EXPIRATION
        value: 7d

      # Encryption (for OAuth tokens, etc.)
      - key: ENCRYPTION_KEY
        generateValue: true

      # CORS
      - key: CORS_ORIGINS
        sync: false

      # AI (OpenAI for chat and OCR)
      - key: OPENAI_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false

      # Blockchain APIs
      - key: COVALENT_API_KEY
        sync: false

      # QuickBooks Integration
      - key: QUICKBOOKS_CLIENT_ID
        sync: false
      - key: QUICKBOOKS_CLIENT_SECRET
        sync: false

      # Xero Integration
      - key: XERO_CLIENT_ID
        sync: false
      - key: XERO_CLIENT_SECRET
        sync: false

      # Error Tracking (Sentry)
      - key: SENTRY_DSN
        sync: false

      # Email (optional)
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASSWORD
        sync: false

  # ============================================================================
  # Worker Service (Background Jobs with BullMQ)
  # ============================================================================
  - type: worker
    name: crypto-erp-worker
    env: node
    region: frankfurt
    plan: starter
    buildCommand: npm ci && npm run build:worker
    startCommand: npm run start:worker:prod
    envVars:
      # Environment
      - key: NODE_ENV
        value: production

      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: crypto-erp-db
          property: connectionString

      # Redis (same as API)
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        sync: false
      - key: REDIS_PASSWORD
        sync: false
      - key: REDIS_DB
        value: 0

      # Blockchain APIs (for crypto sync jobs)
      - key: COVALENT_API_KEY
        sync: false

  # ============================================================================
  # Angular Frontend (Static Site)
  # ============================================================================
  - type: web
    name: crypto-erp-web
    env: static
    buildCommand: npm ci && npm run build:web
    staticPublishPath: ./apps/web/dist/web/browser
    routes:
      # Proxy API requests to backend
      - type: rewrite
        source: /api/*
        destination: https://crypto-erp-api.onrender.com/api/*
      # SPA fallback
      - type: rewrite
        source: /*
        destination: /index.html
    headers:
      # Security headers
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin

# ============================================================================
# Databases
# ============================================================================
databases:
  # PostgreSQL 16
  # Note: TimescaleDB extension not available on Render's managed PostgreSQL
  # For analytics features, consider external TimescaleDB or use PostgreSQL partitioning
  - name: crypto-erp-db
    region: frankfurt
    plan: basic-256mb
    diskSizeGB: 15
    databaseName: crypto_erp
    user: crypto_erp_user
