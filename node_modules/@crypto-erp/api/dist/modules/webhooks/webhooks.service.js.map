{"version":3,"sources":["../../../src/modules/webhooks/webhooks.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { InjectQueue } from '@nestjs/bull';\nimport { Queue } from 'bull';\nimport { CreateWebhookSubscriptionDto } from './dto/create-webhook-subscription.dto';\nimport { UpdateWebhookSubscriptionDto } from './dto/update-webhook-subscription.dto';\nimport { WebhookEventDto } from './dto/webhook-event.dto';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class WebhooksService {\n  private readonly logger = new Logger(WebhooksService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    @InjectQueue('webhook-delivery') private webhookQueue: Queue,\n  ) {}\n\n  async createSubscription(companyId: string, dto: CreateWebhookSubscriptionDto) {\n    const secret = this.generateSecret();\n\n    const subscription = await this.prisma.webhookSubscription.create({\n      data: {\n        companyId,\n        url: dto.url,\n        secret,\n        events: dto.events,\n        description: dto.description,\n        retryCount: dto.retryCount ?? 3,\n        timeout: dto.timeout ?? 30000,\n        metadata: dto.metadata ?? {},\n      },\n    });\n\n    this.logger.log(`Created webhook subscription ${subscription.id}`);\n    return { ...subscription, secret };\n  }\n\n  async findAllByCompany(companyId: string) {\n    return this.prisma.webhookSubscription.findMany({\n      where: { companyId },\n      select: {\n        id: true,\n        url: true,\n        isActive: true,\n        events: true,\n        description: true,\n        retryCount: true,\n        timeout: true,\n        metadata: true,\n        createdAt: true,\n        updatedAt: true,\n      },\n    });\n  }\n\n  async findOne(id: string, companyId: string) {\n    const subscription = await this.prisma.webhookSubscription.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!subscription) {\n      throw new NotFoundException('Webhook subscription not found');\n    }\n\n    const { secret, ...rest } = subscription;\n    return rest;\n  }\n\n  async updateSubscription(id: string, companyId: string, dto: UpdateWebhookSubscriptionDto) {\n    await this.findOne(id, companyId);\n\n    const updated = await this.prisma.webhookSubscription.update({\n      where: { id },\n      data: {\n        url: dto.url,\n        isActive: dto.isActive,\n        events: dto.events,\n        description: dto.description,\n        retryCount: dto.retryCount,\n        timeout: dto.timeout,\n        metadata: dto.metadata,\n      },\n    });\n\n    this.logger.log(`Updated webhook subscription ${id}`);\n    const { secret, ...rest } = updated;\n    return rest;\n  }\n\n  async deleteSubscription(id: string, companyId: string) {\n    await this.findOne(id, companyId);\n    await this.prisma.webhookSubscription.delete({ where: { id } });\n    this.logger.log(`Deleted webhook subscription ${id}`);\n  }\n\n  async emitEvent(companyId: string, eventDto: WebhookEventDto) {\n    await this.prisma.webhookEvent.create({\n      data: {\n        companyId,\n        event: eventDto.event,\n        entityType: eventDto.entityType,\n        entityId: eventDto.entityId,\n        payload: eventDto.payload,\n      },\n    });\n\n    const subscriptions = await this.prisma.webhookSubscription.findMany({\n      where: { companyId, isActive: true },\n    });\n\n    const subscribedTo = subscriptions.filter((sub) => {\n      const events = sub.events as string[];\n      return events.includes(eventDto.event) || events.includes('*');\n    });\n\n    this.logger.log(`Emitting ${eventDto.event} to ${subscribedTo.length} subscriptions`);\n\n    for (const subscription of subscribedTo) {\n      await this.queueDelivery(subscription, eventDto);\n    }\n  }\n\n  private async queueDelivery(subscription: any, eventDto: WebhookEventDto) {\n    const payloadHash = this.hashPayload(eventDto.payload);\n\n    const existing = await this.prisma.webhookDelivery.findFirst({\n      where: {\n        subscriptionId: subscription.id,\n        payloadHash,\n        status: { in: ['PENDING', 'SENDING', 'DELIVERED'] },\n      },\n    });\n\n    if (existing) {\n      this.logger.debug(`Skipping duplicate delivery`);\n      return;\n    }\n\n    const delivery = await this.prisma.webhookDelivery.create({\n      data: {\n        subscriptionId: subscription.id,\n        event: eventDto.event,\n        payload: eventDto.payload,\n        payloadHash,\n        maxAttempts: subscription.retryCount,\n      },\n    });\n\n    await this.webhookQueue.add(\n      'send-webhook',\n      {\n        deliveryId: delivery.id,\n        subscriptionId: subscription.id,\n        url: subscription.url,\n        secret: subscription.secret,\n        event: eventDto.event,\n        payload: eventDto.payload,\n        timeout: subscription.timeout,\n      },\n      {\n        attempts: subscription.retryCount + 1,\n        backoff: { type: 'exponential', delay: 5000 },\n      },\n    );\n  }\n\n  async getDeliveryHistory(subscriptionId: string, companyId: string, limit = 50) {\n    await this.findOne(subscriptionId, companyId);\n\n    return this.prisma.webhookDelivery.findMany({\n      where: { subscriptionId },\n      orderBy: { createdAt: 'desc' },\n      take: limit,\n      select: {\n        id: true,\n        event: true,\n        status: true,\n        attemptCount: true,\n        responseStatus: true,\n        errorMessage: true,\n        scheduledFor: true,\n        lastAttemptAt: true,\n        deliveredAt: true,\n        createdAt: true,\n      },\n    });\n  }\n\n  async testWebhook(id: string, companyId: string) {\n    const subscription = await this.prisma.webhookSubscription.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!subscription) {\n      throw new NotFoundException('Webhook subscription not found');\n    }\n\n    await this.emitEvent(companyId, {\n      event: 'webhook.test',\n      entityType: 'WebhookSubscription',\n      entityId: id,\n      payload: {\n        message: 'Test webhook',\n        timestamp: new Date().toISOString(),\n      },\n    });\n\n    return { message: 'Test webhook queued' };\n  }\n\n  private generateSecret(): string {\n    return crypto.randomBytes(32).toString('hex');\n  }\n\n  private hashPayload(payload: any): string {\n    return crypto.createHash('sha256').update(JSON.stringify(payload)).digest('hex');\n  }\n\n  static generateSignature(payload: any, secret: string): string {\n    return crypto.createHmac('sha256', secret).update(JSON.stringify(payload)).digest('hex');\n  }\n}\n"],"names":["WebhooksService","createSubscription","companyId","dto","secret","generateSecret","subscription","prisma","webhookSubscription","create","data","url","events","description","retryCount","timeout","metadata","logger","log","id","findAllByCompany","findMany","where","select","isActive","createdAt","updatedAt","findOne","findFirst","NotFoundException","rest","updateSubscription","updated","update","deleteSubscription","delete","emitEvent","eventDto","webhookEvent","event","entityType","entityId","payload","subscriptions","subscribedTo","filter","sub","includes","length","queueDelivery","payloadHash","hashPayload","existing","webhookDelivery","subscriptionId","status","in","debug","delivery","maxAttempts","webhookQueue","add","deliveryId","attempts","backoff","type","delay","getDeliveryHistory","limit","orderBy","take","attemptCount","responseStatus","errorMessage","scheduledFor","lastAttemptAt","deliveredAt","testWebhook","message","timestamp","Date","toISOString","crypto","randomBytes","toString","createHash","JSON","stringify","digest","generateSignature","createHmac","Logger","name"],"mappings":"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"}