{"version":3,"sources":["../../../src/modules/analytics/analytics.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\n\ninterface PortfolioOverview {\n  totalCostBasis: number;\n  totalPositions: number;\n  totalTransactions: number;\n  portfolioByAsset: Array<{\n    symbol: string;\n    name: string;\n    amount: number;\n    costBasis: number;\n    percentage: number;\n  }>;\n}\n\ninterface TransactionStats {\n  totalBuys: number;\n  totalSells: number;\n  buyVolume: number;\n  sellVolume: number;\n  avgBuySize: number;\n  avgSellSize: number;\n}\n\ninterface TimeSeriesData {\n  labels: string[];\n  datasets: Array<{\n    label: string;\n    data: number[];\n  }>;\n}\n\ninterface DashboardMetrics {\n  // KPIs principales\n  totalCostBasis: number;\n  monthlyActivity: number;\n  pendingInvoices: number;\n  yearlyCapitalGain: number;\n\n  // Cambios porcentuales\n  costBasisChange: number;\n  activityChange: number;\n  invoicesChange: number;\n  capitalGainChange: number;\n\n  // Datos de gráficos\n  portfolioDistribution: Array<{\n    name: string;\n    value: number;\n    color: string;\n  }>;\n\n  monthlyTransactions: TimeSeriesData;\n  monthlyVolume: TimeSeriesData;\n\n  // Actividad reciente\n  recentTransactions: Array<{\n    id: string;\n    type: string;\n    asset: string;\n    amount: number;\n    valueEur: number;\n    date: Date;\n  }>;\n\n  recentInvoices: Array<{\n    id: string;\n    number: string;\n    customer: string;\n    total: number;\n    status: string;\n    date: Date;\n  }>;\n}\n\n@Injectable()\nexport class AnalyticsService {\n  private readonly logger = new Logger(AnalyticsService.name);\n\n  // Colores para gráficos\n  private readonly chartColors = [\n    '#3B82F6', // blue\n    '#10B981', // green\n    '#F59E0B', // amber\n    '#EF4444', // red\n    '#8B5CF6', // purple\n    '#EC4899', // pink\n    '#06B6D4', // cyan\n    '#F97316', // orange\n  ];\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Obtiene las métricas del dashboard principal\n   */\n  async getDashboardMetrics(companyId: string): Promise<DashboardMetrics> {\n    const now = new Date();\n    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\n\n    // Ejecutar consultas en paralelo\n    const [\n      portfolioOverview,\n      currentMonthTx,\n      lastMonthTx,\n      pendingInvoices,\n      lastMonthInvoices,\n      yearlyGains,\n      lastYearGains,\n      recentTx,\n      recentInv,\n      monthlyData,\n    ] = await Promise.all([\n      this.getPortfolioOverview(companyId),\n      this.getTransactionCount(companyId, startOfMonth, now),\n      this.getTransactionCount(companyId, startOfLastMonth, startOfMonth),\n      this.getPendingInvoicesCount(companyId),\n      this.getInvoicesCount(companyId, startOfLastMonth, startOfMonth),\n      this.getYearlyCapitalGain(companyId, now.getFullYear()),\n      this.getYearlyCapitalGain(companyId, now.getFullYear() - 1),\n      this.getRecentTransactions(companyId, 5),\n      this.getRecentInvoices(companyId, 5),\n      this.getMonthlyData(companyId, 12),\n    ]);\n\n    // Calcular cambios porcentuales\n    const costBasisChange = 0; // No hay histórico, se podría implementar\n    const activityChange = lastMonthTx > 0\n      ? ((currentMonthTx - lastMonthTx) / lastMonthTx) * 100\n      : 0;\n    const invoicesChange = lastMonthInvoices > 0\n      ? ((pendingInvoices - lastMonthInvoices) / lastMonthInvoices) * 100\n      : 0;\n    const capitalGainChange = lastYearGains !== 0\n      ? ((yearlyGains - lastYearGains) / Math.abs(lastYearGains)) * 100\n      : 0;\n\n    // Distribución del portfolio\n    const portfolioDistribution = portfolioOverview.portfolioByAsset.map((asset, index) => ({\n      name: asset.symbol,\n      value: asset.costBasis,\n      color: this.chartColors[index % this.chartColors.length],\n    }));\n\n    return {\n      totalCostBasis: portfolioOverview.totalCostBasis,\n      monthlyActivity: currentMonthTx,\n      pendingInvoices,\n      yearlyCapitalGain: yearlyGains,\n\n      costBasisChange,\n      activityChange,\n      invoicesChange,\n      capitalGainChange,\n\n      portfolioDistribution,\n      monthlyTransactions: monthlyData.transactions,\n      monthlyVolume: monthlyData.volume,\n\n      recentTransactions: recentTx,\n      recentInvoices: recentInv,\n    };\n  }\n\n  /**\n   * Obtiene el resumen del portfolio crypto\n   */\n  async getPortfolioOverview(companyId: string): Promise<PortfolioOverview> {\n    // Obtener wallets de la compañía\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n\n    const walletIds = wallets.map(w => w.id);\n\n    // Obtener transacciones de esas wallets\n    const transactions = await this.prisma.cryptoTransaction.findMany({\n      where: { walletId: { in: walletIds } },\n    });\n\n    // Obtener assets de la compañía para mapear símbolos\n    const assets = await this.prisma.cryptoAsset.findMany({\n      where: { companyId },\n    });\n    const assetMap = new Map(assets.map(a => [a.symbol, a]));\n\n    const portfolioMap = new Map<string, {\n      symbol: string;\n      name: string;\n      amount: number;\n      costBasis: number;\n    }>();\n\n    for (const tx of transactions) {\n      // Procesar entrada (assetIn)\n      if (tx.assetIn && tx.amountIn) {\n        const asset = assetMap.get(tx.assetIn);\n        if (!portfolioMap.has(tx.assetIn)) {\n          portfolioMap.set(tx.assetIn, {\n            symbol: tx.assetIn,\n            name: asset?.name || tx.assetIn,\n            amount: 0,\n            costBasis: 0,\n          });\n        }\n        const entry = portfolioMap.get(tx.assetIn)!;\n        entry.amount += tx.amountIn.toNumber();\n        if (tx.priceInEur) {\n          entry.costBasis += tx.amountIn.toNumber() * tx.priceInEur.toNumber();\n        }\n      }\n\n      // Procesar salida (assetOut)\n      if (tx.assetOut && tx.amountOut) {\n        if (!portfolioMap.has(tx.assetOut)) {\n          const asset = assetMap.get(tx.assetOut);\n          portfolioMap.set(tx.assetOut, {\n            symbol: tx.assetOut,\n            name: asset?.name || tx.assetOut,\n            amount: 0,\n            costBasis: 0,\n          });\n        }\n        const entry = portfolioMap.get(tx.assetOut)!;\n        entry.amount -= tx.amountOut.toNumber();\n      }\n    }\n\n    const portfolioByAsset = Array.from(portfolioMap.values())\n      .filter(p => p.amount > 0)\n      .sort((a, b) => b.costBasis - a.costBasis);\n\n    const totalCostBasis = portfolioByAsset.reduce((sum, p) => sum + p.costBasis, 0);\n\n    return {\n      totalCostBasis,\n      totalPositions: portfolioByAsset.length,\n      totalTransactions: transactions.length,\n      portfolioByAsset: portfolioByAsset.map(p => ({\n        ...p,\n        percentage: totalCostBasis > 0 ? (p.costBasis / totalCostBasis) * 100 : 0,\n      })),\n    };\n  }\n\n  /**\n   * Obtiene estadísticas de transacciones\n   */\n  async getTransactionStats(\n    companyId: string,\n    startDate?: Date,\n    endDate?: Date,\n  ): Promise<TransactionStats> {\n    // Obtener wallets de la compañía\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n\n    const walletIds = wallets.map(w => w.id);\n\n    const whereClause: Record<string, unknown> = { walletId: { in: walletIds } };\n    if (startDate || endDate) {\n      whereClause.blockTimestamp = {};\n      if (startDate) (whereClause.blockTimestamp as Record<string, Date>).gte = startDate;\n      if (endDate) (whereClause.blockTimestamp as Record<string, Date>).lte = endDate;\n    }\n\n    const transactions = await this.prisma.cryptoTransaction.findMany({\n      where: whereClause,\n      select: {\n        type: true,\n        amountIn: true,\n        amountOut: true,\n        priceInEur: true,\n        priceOutEur: true,\n      },\n    });\n\n    // TRANSFER_IN se considera \"compra\", TRANSFER_OUT y SWAP se consideran \"venta\"\n    const buys = transactions.filter(t => t.type === 'TRANSFER_IN' || t.type === 'CLAIM_REWARD' || t.type === 'AIRDROP');\n    const sells = transactions.filter(t => t.type === 'TRANSFER_OUT' || t.type === 'SWAP');\n\n    const buyVolume = buys.reduce((sum, t) => {\n      const amount = t.amountIn?.toNumber() || 0;\n      const price = t.priceInEur?.toNumber() || 0;\n      return sum + (amount * price);\n    }, 0);\n\n    const sellVolume = sells.reduce((sum, t) => {\n      const amount = t.amountOut?.toNumber() || 0;\n      const price = t.priceOutEur?.toNumber() || 0;\n      return sum + (amount * price);\n    }, 0);\n\n    return {\n      totalBuys: buys.length,\n      totalSells: sells.length,\n      buyVolume,\n      sellVolume,\n      avgBuySize: buys.length > 0 ? buyVolume / buys.length : 0,\n      avgSellSize: sells.length > 0 ? sellVolume / sells.length : 0,\n    };\n  }\n\n  /**\n   * Obtiene datos mensuales para gráficos\n   */\n  async getMonthlyData(\n    companyId: string,\n    months: number,\n  ): Promise<{ transactions: TimeSeriesData; volume: TimeSeriesData }> {\n    const now = new Date();\n    const labels: string[] = [];\n    const transactionCounts: number[] = [];\n    const buyVolumes: number[] = [];\n    const sellVolumes: number[] = [];\n\n    // Obtener wallets de la compañía\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    for (let i = months - 1; i >= 0; i--) {\n      const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);\n      const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);\n\n      const monthName = monthStart.toLocaleDateString('es-ES', { month: 'short' });\n      labels.push(monthName);\n\n      const transactions = await this.prisma.cryptoTransaction.findMany({\n        where: {\n          walletId: { in: walletIds },\n          blockTimestamp: {\n            gte: monthStart,\n            lte: monthEnd,\n          },\n        },\n        select: {\n          type: true,\n          amountIn: true,\n          amountOut: true,\n          priceInEur: true,\n          priceOutEur: true,\n        },\n      });\n\n      transactionCounts.push(transactions.length);\n\n      const buys = transactions.filter(t => t.type === 'TRANSFER_IN' || t.type === 'CLAIM_REWARD');\n      const sells = transactions.filter(t => t.type === 'TRANSFER_OUT' || t.type === 'SWAP');\n\n      const monthBuyVolume = buys.reduce((sum, t) => {\n        const amount = t.amountIn?.toNumber() || 0;\n        const price = t.priceInEur?.toNumber() || 0;\n        return sum + (amount * price);\n      }, 0);\n\n      const monthSellVolume = sells.reduce((sum, t) => {\n        const amount = t.amountOut?.toNumber() || 0;\n        const price = t.priceOutEur?.toNumber() || 0;\n        return sum + (amount * price);\n      }, 0);\n\n      buyVolumes.push(monthBuyVolume);\n      sellVolumes.push(monthSellVolume);\n    }\n\n    return {\n      transactions: {\n        labels,\n        datasets: [\n          { label: 'Transacciones', data: transactionCounts },\n        ],\n      },\n      volume: {\n        labels,\n        datasets: [\n          { label: 'Compras (EUR)', data: buyVolumes },\n          { label: 'Ventas (EUR)', data: sellVolumes },\n        ],\n      },\n    };\n  }\n\n  // Helpers privados\n\n  private async getTransactionCount(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n  ): Promise<number> {\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    return this.prisma.cryptoTransaction.count({\n      where: {\n        walletId: { in: walletIds },\n        blockTimestamp: {\n          gte: startDate,\n          lt: endDate,\n        },\n      },\n    });\n  }\n\n  private async getPendingInvoicesCount(companyId: string): Promise<number> {\n    return this.prisma.invoice.count({\n      where: {\n        companyId,\n        status: { in: ['DRAFT', 'SENT'] },\n      },\n    });\n  }\n\n  private async getInvoicesCount(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n  ): Promise<number> {\n    return this.prisma.invoice.count({\n      where: {\n        companyId,\n        issueDate: {\n          gte: startDate,\n          lt: endDate,\n        },\n      },\n    });\n  }\n\n  private async getYearlyCapitalGain(companyId: string, year: number): Promise<number> {\n    // Simplified calculation - in production, use TaxReportService\n    const startDate = new Date(year, 0, 1);\n    const endDate = new Date(year, 11, 31, 23, 59, 59);\n\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    const sells = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_OUT', 'SWAP'] },\n        blockTimestamp: {\n          gte: startDate,\n          lte: endDate,\n        },\n      },\n      select: {\n        realizedGain: true,\n        amountOut: true,\n        priceOutEur: true,\n      },\n    });\n\n    // Use realized gain if available, otherwise estimate\n    const totalGain = sells.reduce((sum, s) => {\n      if (s.realizedGain) {\n        return sum + s.realizedGain.toNumber();\n      }\n      // Rough estimate if no realized gain\n      const amount = s.amountOut?.toNumber() || 0;\n      const price = s.priceOutEur?.toNumber() || 0;\n      return sum + (amount * price * 0.2); // Assume 20% profit\n    }, 0);\n\n    return totalGain;\n  }\n\n  private async getRecentTransactions(companyId: string, limit: number) {\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    const transactions = await this.prisma.cryptoTransaction.findMany({\n      where: { walletId: { in: walletIds } },\n      orderBy: { blockTimestamp: 'desc' },\n      take: limit,\n    });\n\n    return transactions.map(tx => ({\n      id: tx.id,\n      type: tx.type,\n      asset: tx.assetIn || tx.assetOut || 'Unknown',\n      amount: tx.amountIn?.toNumber() || tx.amountOut?.toNumber() || 0,\n      valueEur: (() => {\n        const amountIn = tx.amountIn?.toNumber() || 0;\n        const priceIn = tx.priceInEur?.toNumber() || 0;\n        const amountOut = tx.amountOut?.toNumber() || 0;\n        const priceOut = tx.priceOutEur?.toNumber() || 0;\n        return (amountIn * priceIn) || (amountOut * priceOut);\n      })(),\n      date: tx.blockTimestamp,\n    }));\n  }\n\n  private async getRecentInvoices(companyId: string, limit: number) {\n    const invoices = await this.prisma.invoice.findMany({\n      where: { companyId },\n      orderBy: { issueDate: 'desc' },\n      take: limit,\n      include: { contact: true },\n    });\n\n    return invoices.map(inv => ({\n      id: inv.id,\n      number: inv.fullNumber,\n      customer: inv.contact?.name || inv.counterpartyName,\n      total: inv.total.toNumber(),\n      status: inv.status,\n      date: inv.issueDate,\n    }));\n  }\n}\n"],"names":["AnalyticsService","getDashboardMetrics","companyId","now","Date","startOfMonth","getFullYear","getMonth","startOfLastMonth","portfolioOverview","currentMonthTx","lastMonthTx","pendingInvoices","lastMonthInvoices","yearlyGains","lastYearGains","recentTx","recentInv","monthlyData","Promise","all","getPortfolioOverview","getTransactionCount","getPendingInvoicesCount","getInvoicesCount","getYearlyCapitalGain","getRecentTransactions","getRecentInvoices","getMonthlyData","costBasisChange","activityChange","invoicesChange","capitalGainChange","Math","abs","portfolioDistribution","portfolioByAsset","map","asset","index","name","symbol","value","costBasis","color","chartColors","length","totalCostBasis","monthlyActivity","yearlyCapitalGain","monthlyTransactions","transactions","monthlyVolume","volume","recentTransactions","recentInvoices","wallets","prisma","wallet","findMany","where","select","id","walletIds","w","cryptoTransaction","walletId","in","assets","cryptoAsset","assetMap","Map","a","portfolioMap","tx","assetIn","amountIn","get","has","set","amount","entry","toNumber","priceInEur","assetOut","amountOut","Array","from","values","filter","p","sort","b","reduce","sum","totalPositions","totalTransactions","percentage","getTransactionStats","startDate","endDate","whereClause","blockTimestamp","gte","lte","type","priceOutEur","buys","t","sells","buyVolume","price","sellVolume","totalBuys","totalSells","avgBuySize","avgSellSize","months","labels","transactionCounts","buyVolumes","sellVolumes","i","monthStart","monthEnd","monthName","toLocaleDateString","month","push","monthBuyVolume","monthSellVolume","datasets","label","data","count","lt","invoice","status","issueDate","year","realizedGain","totalGain","s","limit","orderBy","take","valueEur","priceIn","priceOut","date","invoices","include","contact","inv","number","fullNumber","customer","counterpartyName","total","logger","Logger"],"mappings":"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"}