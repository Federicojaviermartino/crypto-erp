{"version":3,"sources":["../../src/processors/email-send.processor.ts"],"sourcesContent":["import { Processor, WorkerHost } from '@nestjs/bullmq';\nimport { Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Job } from 'bullmq';\nimport { Resend } from 'resend';\n\ninterface EmailPayload {\n  to: string | string[];\n  subject: string;\n  html: string;\n  from?: string;\n  replyTo?: string;\n  attachments?: Array<{\n    filename: string;\n    content: Buffer | string;\n    contentType?: string;\n  }>;\n}\n\n@Processor('email-send', {\n  concurrency: 5,\n})\nexport class EmailSendProcessor extends WorkerHost {\n  private readonly logger = new Logger(EmailSendProcessor.name);\n  private resendClient: Resend | null = null;\n  private readonly enabled: boolean;\n\n  constructor(private configService: ConfigService) {\n    super();\n    const apiKey = this.configService.get<string>('RESEND_API_KEY');\n\n    if (apiKey) {\n      this.resendClient = new Resend(apiKey);\n      this.enabled = true;\n      this.logger.log('Resend email client initialized');\n    } else {\n      this.enabled = false;\n      this.logger.warn('RESEND_API_KEY not configured - emails will not be sent');\n    }\n  }\n\n  async process(job: Job<EmailPayload>): Promise<void> {\n    const { to, subject, html, from, replyTo, attachments } = job.data;\n\n    if (!this.enabled) {\n      this.logger.warn(\n        `Email sending disabled - would have sent to ${Array.isArray(to) ? to.join(', ') : to}: ${subject}`,\n      );\n      return;\n    }\n\n    try {\n      const result = await this.resendClient!.emails.send({\n        from: from || 'Crypto-ERP <noreply@crypto-erp.com>',\n        to: Array.isArray(to) ? to : [to],\n        subject,\n        html,\n        replyTo: replyTo,\n        attachments: attachments as any,\n      });\n\n      this.logger.log(\n        `Email sent successfully to ${Array.isArray(to) ? to.join(', ') : to}: ${subject} (ID: ${result.data?.id})`,\n      );\n    } catch (error) {\n      this.logger.error(\n        `Failed to send email to ${Array.isArray(to) ? to.join(', ') : to}: ${subject}`,\n        error.stack,\n      );\n      throw error; // Let BullMQ retry\n    }\n  }\n}\n"],"names":["EmailSendProcessor","WorkerHost","process","job","to","subject","html","from","replyTo","attachments","data","enabled","logger","warn","Array","isArray","join","result","resendClient","emails","send","log","id","error","stack","configService","Logger","name","apiKey","get","Resend","concurrency"],"mappings":";;;;+BAsBaA;;;eAAAA;;;wBAtByB;wBACf;wBACO;wBAEP;;;;;;;;;;AAkBhB,IAAA,AAAMA,qBAAN,MAAMA,2BAA2BC,kBAAU;IAmBhD,MAAMC,QAAQC,GAAsB,EAAiB;QACnD,MAAM,EAAEC,EAAE,EAAEC,OAAO,EAAEC,IAAI,EAAEC,IAAI,EAAEC,OAAO,EAAEC,WAAW,EAAE,GAAGN,IAAIO,IAAI;QAElE,IAAI,CAAC,IAAI,CAACC,OAAO,EAAE;YACjB,IAAI,CAACC,MAAM,CAACC,IAAI,CACd,CAAC,4CAA4C,EAAEC,MAAMC,OAAO,CAACX,MAAMA,GAAGY,IAAI,CAAC,QAAQZ,GAAG,EAAE,EAAEC,SAAS;YAErG;QACF;QAEA,IAAI;YACF,MAAMY,SAAS,MAAM,IAAI,CAACC,YAAY,CAAEC,MAAM,CAACC,IAAI,CAAC;gBAClDb,MAAMA,QAAQ;gBACdH,IAAIU,MAAMC,OAAO,CAACX,MAAMA,KAAK;oBAACA;iBAAG;gBACjCC;gBACAC;gBACAE,SAASA;gBACTC,aAAaA;YACf;YAEA,IAAI,CAACG,MAAM,CAACS,GAAG,CACb,CAAC,2BAA2B,EAAEP,MAAMC,OAAO,CAACX,MAAMA,GAAGY,IAAI,CAAC,QAAQZ,GAAG,EAAE,EAAEC,QAAQ,MAAM,EAAEY,OAAOP,IAAI,EAAEY,GAAG,CAAC,CAAC;QAE/G,EAAE,OAAOC,OAAO;YACd,IAAI,CAACX,MAAM,CAACW,KAAK,CACf,CAAC,wBAAwB,EAAET,MAAMC,OAAO,CAACX,MAAMA,GAAGY,IAAI,CAAC,QAAQZ,GAAG,EAAE,EAAEC,SAAS,EAC/EkB,MAAMC,KAAK;YAEb,MAAMD,OAAO,mBAAmB;QAClC;IACF;IA5CA,YAAY,AAAQE,aAA4B,CAAE;QAChD,KAAK,SADaA,gBAAAA,oBAJHb,SAAS,IAAIc,cAAM,CAAC1B,mBAAmB2B,IAAI,QACpDT,eAA8B;QAKpC,MAAMU,SAAS,IAAI,CAACH,aAAa,CAACI,GAAG,CAAS;QAE9C,IAAID,QAAQ;YACV,IAAI,CAACV,YAAY,GAAG,IAAIY,cAAM,CAACF;YAC/B,IAAI,CAACjB,OAAO,GAAG;YACf,IAAI,CAACC,MAAM,CAACS,GAAG,CAAC;QAClB,OAAO;YACL,IAAI,CAACV,OAAO,GAAG;YACf,IAAI,CAACC,MAAM,CAACC,IAAI,CAAC;QACnB;IACF;AAiCF;;;QApDEkB,aAAa"}