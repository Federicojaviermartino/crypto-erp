{"version":3,"sources":["../../../src/modules/fiscal/fiscal.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Body,\n  Query,\n  Headers,\n  BadRequestException,\n  UseGuards,\n  Res,\n  HttpStatus,\n} from '@nestjs/common';\nimport { Response } from 'express';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { TaxPredictionService } from './tax-prediction.service.js';\nimport { PredictTaxImpactDto, TaxPredictionResponseDto } from './dto/predict-tax.dto.js';\nimport { Modelo347Service } from './modelo347.service.js';\nimport { SIIService } from './sii.service.js';\nimport { LibroRegistroService } from './libro-registro.service.js';\nimport { GenerateModelo347Dto } from './dto/generate-modelo347.dto.js';\nimport { GenerateLibroRegistroDto, ExportFormat } from './dto/generate-libro-registro.dto.js';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard.js';\nimport { RolesGuard } from '../auth/guards/roles.guard.js';\nimport { Roles } from '../auth/decorators/roles.decorator.js';\nimport { GetCompany } from '../auth/decorators/get-company.decorator.js';\nimport { UserRole } from '@prisma/client';\nimport { Auditable } from '../audit/decorators/auditable.decorator.js';\n\n@ApiTags('fiscal')\n@ApiBearerAuth()\n@Controller('fiscal')\n@UseGuards(JwtAuthGuard, RolesGuard)\nexport class FiscalController {\n  constructor(\n    private readonly taxPredictionService: TaxPredictionService,\n    private readonly modelo347: Modelo347Service,\n    private readonly sii: SIIService,\n    private readonly libroRegistro: LibroRegistroService,\n  ) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  @Post('predict-tax-impact')\n  @ApiOperation({\n    summary: 'Predict tax impact of a prospective crypto transaction',\n    description:\n      'Simulates the tax consequences of selling or buying crypto assets using FIFO method. ' +\n      'Does not persist any data to the database. Returns capital gains/losses and estimated tax.',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Tax prediction calculated successfully',\n    type: TaxPredictionResponseDto,\n  })\n  @ApiResponse({\n    status: 400,\n    description: 'Invalid request parameters',\n  })\n  @ApiResponse({\n    status: 404,\n    description: 'Crypto asset or company not found',\n  })\n  async predictTaxImpact(\n    @Headers() headers: Record<string, string>,\n    @Body() dto: PredictTaxImpactDto,\n  ): Promise<TaxPredictionResponseDto> {\n    const companyId = this.getCompanyId(headers);\n    return this.taxPredictionService.predictTaxImpact(companyId, dto);\n  }\n\n  /**\n   * Calculate Modelo 347 data (preview)\n   */\n  @Get('modelo347/calculate')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Calculate Modelo 347 (preview)',\n    description: 'Detects all operations with third parties exceeding 3,005.01â‚¬ for a fiscal year',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Modelo 347 calculated successfully',\n  })\n  async calculateModelo347(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateModelo347Dto,\n  ) {\n    return this.modelo347.calculateModelo347(companyId, dto.fiscalYear);\n  }\n\n  /**\n   * Download Modelo 347 as XML (AEAT format)\n   */\n  @Get('modelo347/xml')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('Modelo347')\n  @ApiOperation({\n    summary: 'Download Modelo 347 XML',\n    description: 'Generate and download Modelo 347 in AEAT XML format for submission',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'XML file generated successfully',\n  })\n  async downloadModelo347XML(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateModelo347Dto,\n    @Res() res: Response,\n  ) {\n    const xml = await this.modelo347.generateXML(companyId, dto.fiscalYear);\n\n    res.setHeader('Content-Type', 'application/xml');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"modelo347_${dto.fiscalYear}.xml\"`,\n    );\n    res.status(HttpStatus.OK).send(xml);\n  }\n\n  /**\n   * Download Modelo 347 as CSV (for accounting software)\n   */\n  @Get('modelo347/csv')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('Modelo347')\n  @ApiOperation({\n    summary: 'Download Modelo 347 CSV',\n    description: 'Generate and download Modelo 347 as CSV for accounting software',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'CSV file generated successfully',\n  })\n  async downloadModelo347CSV(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateModelo347Dto,\n    @Res() res: Response,\n  ) {\n    const csv = await this.modelo347.generateCSV(companyId, dto.fiscalYear);\n\n    res.setHeader('Content-Type', 'text/csv; charset=utf-8');\n    res.setHeader(\n      'Content-Disposition',\n      `attachment; filename=\"modelo347_${dto.fiscalYear}.csv\"`,\n    );\n    res.status(HttpStatus.OK).send('\\uFEFF' + csv); // Add BOM for Excel\n  }\n\n  /**\n   * Get invoices pending SII submission\n   */\n  @Get('sii/pending')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Get invoices pending SII submission',\n    description: 'Returns invoices issued >4 days ago that have not been submitted to AEAT SII',\n  })\n  async getSIIPendingInvoices(@GetCompany() companyId: string) {\n    return this.sii.getPendingSubmissions(companyId);\n  }\n\n  /**\n   * Submit issued invoices to SII\n   */\n  @Post('sii/submit-issued')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('SII')\n  @ApiOperation({\n    summary: 'Submit issued invoices to SII',\n    description: 'Send issued invoices (Facturas Emitidas) to AEAT SII system',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Invoices submitted successfully',\n  })\n  async submitIssuedInvoices(\n    @GetCompany() companyId: string,\n    @Body() body: { invoiceIds: string[] },\n  ) {\n    return this.sii.submitIssuedInvoices(companyId, body.invoiceIds);\n  }\n\n  /**\n   * Submit received invoices to SII\n   */\n  @Post('sii/submit-received')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('SII')\n  @ApiOperation({\n    summary: 'Submit received invoices to SII',\n    description: 'Send received invoices (Facturas Recibidas) to AEAT SII system',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Invoices submitted successfully',\n  })\n  async submitReceivedInvoices(\n    @GetCompany() companyId: string,\n    @Body() body: { invoiceIds: string[] },\n  ) {\n    return this.sii.submitReceivedInvoices(companyId, body.invoiceIds);\n  }\n\n  /**\n   * Generate Libro Registro de Facturas\n   */\n  @Get('libro-registro')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @ApiOperation({\n    summary: 'Generate Libro Registro de Facturas',\n    description: 'Generate the official invoice registry book for a given period',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Libro Registro generated successfully',\n  })\n  async generateLibroRegistro(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateLibroRegistroDto,\n  ) {\n    const startDate = new Date(dto.startDate);\n    const endDate = new Date(dto.endDate);\n\n    return this.libroRegistro.generateLibroRegistro(companyId, startDate, endDate);\n  }\n\n  /**\n   * Export Libro Registro to CSV\n   */\n  @Get('libro-registro/csv')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('LibroRegistro')\n  @ApiOperation({\n    summary: 'Export Libro Registro to CSV',\n    description: 'Download Libro Registro as CSV file',\n  })\n  async exportLibroRegistroCSV(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateLibroRegistroDto,\n    @Res() res: Response,\n  ) {\n    const startDate = new Date(dto.startDate);\n    const endDate = new Date(dto.endDate);\n\n    const csv = await this.libroRegistro.exportToCSV(\n      companyId,\n      startDate,\n      endDate,\n      dto.type === 'emitidas' ? 'emitidas' : 'recibidas',\n    );\n\n    const filename = `libro_registro_${dto.type}_${dto.startDate}_${dto.endDate}.csv`;\n\n    res.setHeader('Content-Type', 'text/csv; charset=utf-8');\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    res.status(HttpStatus.OK).send('\\uFEFF' + csv); // Add BOM for Excel\n  }\n\n  /**\n   * Export Libro Registro to Excel\n   */\n  @Get('libro-registro/excel')\n  @Roles(UserRole.ADMIN, UserRole.OWNER)\n  @Auditable('LibroRegistro')\n  @ApiOperation({\n    summary: 'Export Libro Registro to Excel',\n    description: 'Download Libro Registro as Excel file with formatted sheets',\n  })\n  async exportLibroRegistroExcel(\n    @GetCompany() companyId: string,\n    @Query() dto: GenerateLibroRegistroDto,\n    @Res() res: Response,\n  ) {\n    const startDate = new Date(dto.startDate);\n    const endDate = new Date(dto.endDate);\n\n    const filename = `libro_registro_${dto.startDate}_${dto.endDate}.xlsx`;\n    const tmpFilePath = `/tmp/${filename}`;\n\n    await this.libroRegistro.exportToExcel(companyId, startDate, endDate, tmpFilePath);\n\n    res.setHeader(\n      'Content-Type',\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n    );\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    res.status(HttpStatus.OK).sendFile(tmpFilePath);\n  }\n}\n"],"names":["FiscalController","getCompanyId","headers","companyId","BadRequestException","predictTaxImpact","dto","taxPredictionService","calculateModelo347","modelo347","fiscalYear","downloadModelo347XML","res","xml","generateXML","setHeader","status","HttpStatus","OK","send","downloadModelo347CSV","csv","generateCSV","getSIIPendingInvoices","sii","getPendingSubmissions","submitIssuedInvoices","body","invoiceIds","submitReceivedInvoices","generateLibroRegistro","startDate","Date","endDate","libroRegistro","exportLibroRegistroCSV","exportToCSV","type","filename","exportLibroRegistroExcel","tmpFilePath","exportToExcel","sendFile","summary","description","TaxPredictionResponseDto","ADMIN","OWNER"],"mappings":"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"}