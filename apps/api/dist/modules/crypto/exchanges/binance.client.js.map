{"version":3,"sources":["../../../../src/modules/crypto/exchanges/binance.client.ts"],"sourcesContent":["import { Logger } from '@nestjs/common';\nimport * as crypto from 'crypto';\nimport {\n  ExchangeClient,\n  ExchangeCredentials,\n  ExchangeBalance,\n  ExchangeTrade,\n  ExchangeDeposit,\n  ExchangeWithdrawal,\n} from './exchange.interface.js';\n\nexport class BinanceClient implements ExchangeClient {\n  readonly name = 'Binance';\n  readonly country = 'MT'; // Malta\n  private readonly logger = new Logger(BinanceClient.name);\n  private readonly baseUrl = 'https://api.binance.com';\n\n  constructor(private readonly credentials: ExchangeCredentials) {}\n\n  private sign(queryString: string): string {\n    return crypto\n      .createHmac('sha256', this.credentials.apiSecret)\n      .update(queryString)\n      .digest('hex');\n  }\n\n  private async request<T>(\n    endpoint: string,\n    params: Record<string, string | number> = {},\n    signed = false,\n  ): Promise<T> {\n    const url = new URL(`${this.baseUrl}${endpoint}`);\n\n    if (signed) {\n      params.timestamp = Date.now();\n      params.recvWindow = 60000;\n    }\n\n    const searchParams = new URLSearchParams();\n    for (const [key, value] of Object.entries(params)) {\n      searchParams.append(key, String(value));\n    }\n    const queryString = searchParams.toString();\n\n    if (signed) {\n      const signature = this.sign(queryString);\n      url.search = `${queryString}&signature=${signature}`;\n    } else if (queryString) {\n      url.search = queryString;\n    }\n\n    const headers: Record<string, string> = {\n      'X-MBX-APIKEY': this.credentials.apiKey,\n    };\n\n    const response = await fetch(url.toString(), { headers });\n\n    if (!response.ok) {\n      const error = await response.text();\n      this.logger.error(`Binance API error: ${response.status} - ${error}`);\n      throw new Error(`Binance API error: ${response.status}`);\n    }\n\n    return response.json() as Promise<T>;\n  }\n\n  async testConnection(): Promise<boolean> {\n    try {\n      await this.request('/api/v3/account', {}, true);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  async getBalances(): Promise<ExchangeBalance[]> {\n    interface BinanceAccountResponse {\n      balances: Array<{\n        asset: string;\n        free: string;\n        locked: string;\n      }>;\n    }\n\n    const account = await this.request<BinanceAccountResponse>('/api/v3/account', {}, true);\n\n    return account.balances\n      .filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0)\n      .map(b => ({\n        asset: b.asset,\n        free: b.free,\n        locked: b.locked,\n        total: (parseFloat(b.free) + parseFloat(b.locked)).toString(),\n      }));\n  }\n\n  async getTrades(options: {\n    symbol?: string;\n    startTime?: Date;\n    endTime?: Date;\n    limit?: number;\n  } = {}): Promise<ExchangeTrade[]> {\n    // If no symbol specified, we need to get all trading pairs first\n    if (!options.symbol) {\n      // Get all unique trading pairs from recent trades\n      // For simplicity, return empty if no symbol - user should specify\n      return [];\n    }\n\n    interface BinanceTrade {\n      id: number;\n      symbol: string;\n      orderId: number;\n      price: string;\n      qty: string;\n      quoteQty: string;\n      commission: string;\n      commissionAsset: string;\n      time: number;\n      isBuyer: boolean;\n      isMaker: boolean;\n    }\n\n    const params: Record<string, string | number> = {\n      symbol: options.symbol,\n      limit: options.limit || 1000,\n    };\n\n    if (options.startTime) {\n      params.startTime = options.startTime.getTime();\n    }\n    if (options.endTime) {\n      params.endTime = options.endTime.getTime();\n    }\n\n    const trades = await this.request<BinanceTrade[]>('/api/v3/myTrades', params, true);\n\n    return trades.map(t => ({\n      id: t.id.toString(),\n      symbol: t.symbol,\n      orderId: t.orderId.toString(),\n      side: t.isBuyer ? 'BUY' as const : 'SELL' as const,\n      price: t.price,\n      quantity: t.qty,\n      quoteQuantity: t.quoteQty,\n      commission: t.commission,\n      commissionAsset: t.commissionAsset,\n      timestamp: new Date(t.time),\n      isMaker: t.isMaker,\n    }));\n  }\n\n  async getDeposits(options: {\n    asset?: string;\n    startTime?: Date;\n    endTime?: Date;\n  } = {}): Promise<ExchangeDeposit[]> {\n    interface BinanceDeposit {\n      id: string;\n      amount: string;\n      coin: string;\n      network: string;\n      status: number;\n      txId: string;\n      insertTime: number;\n    }\n\n    const params: Record<string, string | number> = {};\n\n    if (options.asset) {\n      params.coin = options.asset;\n    }\n    if (options.startTime) {\n      params.startTime = options.startTime.getTime();\n    }\n    if (options.endTime) {\n      params.endTime = options.endTime.getTime();\n    }\n\n    const deposits = await this.request<BinanceDeposit[]>('/sapi/v1/capital/deposit/hisrec', params, true);\n\n    const statusMap: Record<number, ExchangeDeposit['status']> = {\n      0: 'PENDING',\n      1: 'COMPLETED',\n      6: 'COMPLETED',\n    };\n\n    return deposits.map(d => ({\n      id: d.id,\n      asset: d.coin,\n      amount: d.amount,\n      status: statusMap[d.status] || 'PENDING',\n      txHash: d.txId,\n      timestamp: new Date(d.insertTime),\n      network: d.network,\n    }));\n  }\n\n  async getWithdrawals(options: {\n    asset?: string;\n    startTime?: Date;\n    endTime?: Date;\n  } = {}): Promise<ExchangeWithdrawal[]> {\n    interface BinanceWithdrawal {\n      id: string;\n      amount: string;\n      transactionFee: string;\n      coin: string;\n      status: number;\n      txId: string;\n      address: string;\n      applyTime: string;\n      network: string;\n    }\n\n    const params: Record<string, string | number> = {};\n\n    if (options.asset) {\n      params.coin = options.asset;\n    }\n    if (options.startTime) {\n      params.startTime = options.startTime.getTime();\n    }\n    if (options.endTime) {\n      params.endTime = options.endTime.getTime();\n    }\n\n    const withdrawals = await this.request<BinanceWithdrawal[]>('/sapi/v1/capital/withdraw/history', params, true);\n\n    const statusMap: Record<number, ExchangeWithdrawal['status']> = {\n      0: 'PENDING',\n      1: 'CANCELLED',\n      2: 'PENDING',\n      3: 'FAILED',\n      4: 'PENDING',\n      5: 'FAILED',\n      6: 'COMPLETED',\n    };\n\n    return withdrawals.map(w => ({\n      id: w.id,\n      asset: w.coin,\n      amount: w.amount,\n      fee: w.transactionFee,\n      status: statusMap[w.status] || 'PENDING',\n      txHash: w.txId,\n      address: w.address,\n      timestamp: new Date(w.applyTime),\n      network: w.network,\n    }));\n  }\n\n  // Helper to get all symbols user has traded\n  async getTradingSymbols(): Promise<string[]> {\n    interface BinanceExchangeInfo {\n      symbols: Array<{ symbol: string; status: string }>;\n    }\n\n    const info = await this.request<BinanceExchangeInfo>('/api/v3/exchangeInfo');\n    const activeSymbols = info.symbols\n      .filter(s => s.status === 'TRADING')\n      .map(s => s.symbol);\n\n    return activeSymbols;\n  }\n\n  // Get all trades by iterating through common pairs\n  async getAllTrades(options: {\n    startTime?: Date;\n    endTime?: Date;\n  } = {}): Promise<ExchangeTrade[]> {\n    const balances = await this.getBalances();\n    const assets = balances.map(b => b.asset);\n\n    const commonQuotes = ['USDT', 'EUR', 'BTC', 'ETH', 'BUSD'];\n    const allTrades: ExchangeTrade[] = [];\n    const processedSymbols = new Set<string>();\n\n    for (const asset of assets) {\n      for (const quote of commonQuotes) {\n        const symbol = `${asset}${quote}`;\n        if (processedSymbols.has(symbol)) continue;\n        processedSymbols.add(symbol);\n\n        try {\n          const trades = await this.getTrades({\n            symbol,\n            startTime: options.startTime,\n            endTime: options.endTime,\n          });\n          allTrades.push(...trades);\n        } catch {\n          // Symbol might not exist, skip\n        }\n      }\n    }\n\n    return allTrades.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\n  }\n}\n"],"names":["BinanceClient","sign","queryString","crypto","createHmac","credentials","apiSecret","update","digest","request","endpoint","params","signed","url","URL","baseUrl","timestamp","Date","now","recvWindow","searchParams","URLSearchParams","key","value","Object","entries","append","String","toString","signature","search","headers","apiKey","response","fetch","ok","error","text","logger","status","Error","json","testConnection","getBalances","account","balances","filter","b","parseFloat","free","locked","map","asset","total","getTrades","options","symbol","limit","startTime","getTime","endTime","trades","t","id","orderId","side","isBuyer","price","quantity","qty","quoteQuantity","quoteQty","commission","commissionAsset","time","isMaker","getDeposits","coin","deposits","statusMap","d","amount","txHash","txId","insertTime","network","getWithdrawals","withdrawals","w","fee","transactionFee","address","applyTime","getTradingSymbols","info","activeSymbols","symbols","s","getAllTrades","assets","commonQuotes","allTrades","processedSymbols","Set","quote","has","add","push","sort","a","name","country","Logger"],"mappings":"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"}