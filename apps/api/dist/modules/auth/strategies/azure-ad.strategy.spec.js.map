{"version":3,"sources":["../../../../src/modules/auth/strategies/azure-ad.strategy.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { AzureADStrategy } from './azure-ad.strategy';\nimport { AuthService } from '../auth.service';\nimport { ConfigService } from '@nestjs/config';\nimport { UnauthorizedException } from '@nestjs/common';\n\ndescribe('AzureADStrategy', () => {\n  let strategy: AzureADStrategy;\n  let authService: AuthService;\n\n  const mockConfigService = {\n    get: jest.fn((key: string) => {\n      const config = {\n        AZURE_TENANT_ID: 'test-tenant-id',\n        AZURE_CLIENT_ID: 'test-client-id',\n      };\n      return config[key];\n    }),\n  };\n\n  const mockAuthService = {\n    findOrCreateSSOUser: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        AzureADStrategy,\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n        {\n          provide: AuthService,\n          useValue: mockAuthService,\n        },\n      ],\n    }).compile();\n\n    strategy = module.get<AzureADStrategy>(AzureADStrategy);\n    authService = module.get<AuthService>(AuthService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(strategy).toBeDefined();\n  });\n\n  describe('validate', () => {\n    it('should validate Azure AD token payload', async () => {\n      const mockPayload = {\n        oid: 'azure-object-id-123',\n        email: 'user@company.com',\n        preferred_username: 'user@company.com',\n        name: 'John Doe',\n        tid: 'tenant-id-123',\n        upn: 'user@company.com',\n        roles: ['User'],\n      };\n\n      const mockUser = {\n        id: 'user-123',\n        email: 'user@company.com',\n        firstName: 'John',\n        lastName: 'Doe',\n      };\n\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      const result = await strategy.validate(mockPayload);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith({\n        ssoProvider: 'azure',\n        ssoId: 'azure-object-id-123',\n        email: 'user@company.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        ssoMetadata: {\n          tenantId: 'tenant-id-123',\n          upn: 'user@company.com',\n          roles: ['User'],\n        },\n      });\n\n      expect(result).toEqual(mockUser);\n    });\n\n    it('should use preferred_username if email is not present', async () => {\n      const mockPayload = {\n        oid: 'azure-object-id-123',\n        preferred_username: 'user@company.com',\n        name: 'John Doe',\n        tid: 'tenant-id-123',\n      };\n\n      const mockUser = { id: 'user-123' };\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      await strategy.validate(mockPayload);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith(\n        expect.objectContaining({\n          email: 'user@company.com',\n        }),\n      );\n    });\n\n    it('should throw error if no email or preferred_username', async () => {\n      const mockPayload = {\n        oid: 'azure-object-id-123',\n        name: 'John Doe',\n      };\n\n      await expect(strategy.validate(mockPayload)).rejects.toThrow(UnauthorizedException);\n    });\n\n    it('should handle name parsing correctly', async () => {\n      const mockPayload = {\n        oid: 'azure-object-id-123',\n        email: 'user@company.com',\n        name: 'John Michael Doe',\n      };\n\n      const mockUser = { id: 'user-123' };\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      await strategy.validate(mockPayload);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith(\n        expect.objectContaining({\n          firstName: 'John',\n          lastName: 'Michael Doe',\n        }),\n      );\n    });\n  });\n});\n"],"names":["describe","strategy","authService","mockConfigService","get","jest","fn","key","config","AZURE_TENANT_ID","AZURE_CLIENT_ID","mockAuthService","findOrCreateSSOUser","beforeEach","module","Test","createTestingModule","providers","AzureADStrategy","provide","ConfigService","useValue","AuthService","compile","clearAllMocks","it","expect","toBeDefined","mockPayload","oid","email","preferred_username","name","tid","upn","roles","mockUser","id","firstName","lastName","mockResolvedValue","result","validate","toHaveBeenCalledWith","ssoProvider","ssoId","ssoMetadata","tenantId","toEqual","objectContaining","rejects","toThrow","UnauthorizedException"],"mappings":";;;;yBAAoC;iCACJ;6BACJ;wBACE;wBACQ;AAEtCA,SAAS,mBAAmB;IAC1B,IAAIC;IACJ,IAAIC;IAEJ,MAAMC,oBAAoB;QACxBC,KAAKC,KAAKC,EAAE,CAAC,CAACC;YACZ,MAAMC,SAAS;gBACbC,iBAAiB;gBACjBC,iBAAiB;YACnB;YACA,OAAOF,MAAM,CAACD,IAAI;QACpB;IACF;IAEA,MAAMI,kBAAkB;QACtBC,qBAAqBP,KAAKC,EAAE;IAC9B;IAEAO,WAAW;QACT,MAAMC,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,WAAW;gBACTC,gCAAe;gBACf;oBACEC,SAASC,qBAAa;oBACtBC,UAAUlB;gBACZ;gBACA;oBACEgB,SAASG,wBAAW;oBACpBD,UAAUV;gBACZ;aACD;QACH,GAAGY,OAAO;QAEVtB,WAAWa,OAAOV,GAAG,CAAkBc,gCAAe;QACtDhB,cAAcY,OAAOV,GAAG,CAAckB,wBAAW;QAEjDjB,KAAKmB,aAAa;IACpB;IAEAC,GAAG,qBAAqB;QACtBC,OAAOzB,UAAU0B,WAAW;IAC9B;IAEA3B,SAAS,YAAY;QACnByB,GAAG,0CAA0C;YAC3C,MAAMG,cAAc;gBAClBC,KAAK;gBACLC,OAAO;gBACPC,oBAAoB;gBACpBC,MAAM;gBACNC,KAAK;gBACLC,KAAK;gBACLC,OAAO;oBAAC;iBAAO;YACjB;YAEA,MAAMC,WAAW;gBACfC,IAAI;gBACJP,OAAO;gBACPQ,WAAW;gBACXC,UAAU;YACZ;YAEA5B,gBAAgBC,mBAAmB,CAAC4B,iBAAiB,CAACJ;YAEtD,MAAMK,SAAS,MAAMxC,SAASyC,QAAQ,CAACd;YAEvCF,OAAOxB,YAAYU,mBAAmB,EAAE+B,oBAAoB,CAAC;gBAC3DC,aAAa;gBACbC,OAAO;gBACPf,OAAO;gBACPQ,WAAW;gBACXC,UAAU;gBACVO,aAAa;oBACXC,UAAU;oBACVb,KAAK;oBACLC,OAAO;wBAAC;qBAAO;gBACjB;YACF;YAEAT,OAAOe,QAAQO,OAAO,CAACZ;QACzB;QAEAX,GAAG,yDAAyD;YAC1D,MAAMG,cAAc;gBAClBC,KAAK;gBACLE,oBAAoB;gBACpBC,MAAM;gBACNC,KAAK;YACP;YAEA,MAAMG,WAAW;gBAAEC,IAAI;YAAW;YAClC1B,gBAAgBC,mBAAmB,CAAC4B,iBAAiB,CAACJ;YAEtD,MAAMnC,SAASyC,QAAQ,CAACd;YAExBF,OAAOxB,YAAYU,mBAAmB,EAAE+B,oBAAoB,CAC1DjB,OAAOuB,gBAAgB,CAAC;gBACtBnB,OAAO;YACT;QAEJ;QAEAL,GAAG,wDAAwD;YACzD,MAAMG,cAAc;gBAClBC,KAAK;gBACLG,MAAM;YACR;YAEA,MAAMN,OAAOzB,SAASyC,QAAQ,CAACd,cAAcsB,OAAO,CAACC,OAAO,CAACC,6BAAqB;QACpF;QAEA3B,GAAG,wCAAwC;YACzC,MAAMG,cAAc;gBAClBC,KAAK;gBACLC,OAAO;gBACPE,MAAM;YACR;YAEA,MAAMI,WAAW;gBAAEC,IAAI;YAAW;YAClC1B,gBAAgBC,mBAAmB,CAAC4B,iBAAiB,CAACJ;YAEtD,MAAMnC,SAASyC,QAAQ,CAACd;YAExBF,OAAOxB,YAAYU,mBAAmB,EAAE+B,oBAAoB,CAC1DjB,OAAOuB,gBAAgB,CAAC;gBACtBX,WAAW;gBACXC,UAAU;YACZ;QAEJ;IACF;AACF"}