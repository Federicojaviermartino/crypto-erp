{"version":3,"sources":["../../../../src/modules/ai/services/ai.service.ts"],"sourcesContent":["import { Injectable, Logger, Optional } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport Anthropic from '@anthropic-ai/sdk';\nimport { AIProviderService, ChatMessage as ProviderMessage } from './ai-provider.service.js';\nimport { RAGService } from './rag.service.js';\nimport { EmbeddingsService } from './embeddings.service.js';\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant';\n  content: string;\n}\n\nexport interface AiContext {\n  companyId?: string;\n  companyName?: string;\n  fiscalYear?: string;\n  recentTransactions?: string;\n  accountBalances?: string;\n  useRAG?: boolean;\n  language?: 'es' | 'en';\n}\n\n@Injectable()\nexport class AiService {\n  private readonly logger = new Logger(AiService.name);\n  private client: Anthropic | null = null;\n\n  constructor(\n    private configService: ConfigService,\n    @Optional() private readonly providerService?: AIProviderService,\n    @Optional() private readonly ragService?: RAGService,\n    @Optional() private readonly embeddingsService?: EmbeddingsService,\n  ) {\n    const apiKey = this.configService.get<string>('ANTHROPIC_API_KEY');\n    if (apiKey) {\n      this.client = new Anthropic({ apiKey });\n    } else {\n      this.logger.warn('ANTHROPIC_API_KEY not configured - using provider fallback');\n    }\n  }\n\n  private getSystemPrompt(context?: AiContext): string {\n    const language = context?.language || 'es';\n\n    const prompts = {\n      es: `Eres un asistente contable experto especializado en:\n- Plan General Contable (PGC) español\n- Facturación electrónica y Verifactu\n- Contabilidad de criptomonedas (FIFO, cost basis)\n- Normativa fiscal española (IVA, IRPF, Impuesto de Sociedades)\n\nTu rol es ayudar a los usuarios con:\n1. Dudas contables y fiscales\n2. Cómo registrar asientos contables\n3. Explicar conceptos de criptomonedas y su fiscalidad\n4. Generar informes y análisis\n5. Sugerir mejoras en la gestión financiera\n\nResponde siempre en español, de forma clara y profesional.\nSi no estás seguro de algo, indícalo claramente.\nCuando sea relevante, cita la normativa aplicable.`,\n\n      en: `You are an expert accounting assistant specialized in:\n- Spanish General Accounting Plan (PGC - Plan General Contable)\n- Electronic invoicing and Verifactu\n- Cryptocurrency accounting (FIFO, cost basis)\n- Spanish tax regulations (VAT/IVA, Personal Income Tax/IRPF, Corporate Tax/IS)\n\nYour role is to help users with:\n1. Accounting and tax questions\n2. How to record accounting entries\n3. Explaining cryptocurrency concepts and their taxation in Spain\n4. Generating reports and analysis\n5. Suggesting improvements in financial management\n\nAlways respond in English, clearly and professionally.\nIf you're unsure about something, state it clearly.\nWhen relevant, cite applicable Spanish regulations (AEAT, BOE, BOICAC).`\n    };\n\n    let systemPrompt = prompts[language];\n\n    if (context) {\n      const contextHeader = language === 'es'\n        ? '\\n\\nContexto actual del usuario:'\n        : '\\n\\nCurrent user context:';\n\n      systemPrompt += contextHeader;\n\n      if (context.companyName) {\n        const label = language === 'es' ? '- Empresa:' : '- Company:';\n        systemPrompt += `\\n${label} ${context.companyName}`;\n      }\n      if (context.fiscalYear) {\n        const label = language === 'es' ? '- Ejercicio fiscal:' : '- Fiscal year:';\n        systemPrompt += `\\n${label} ${context.fiscalYear}`;\n      }\n      if (context.accountBalances) {\n        const label = language === 'es' ? '- Saldos principales:' : '- Main balances:';\n        systemPrompt += `\\n${label} ${context.accountBalances}`;\n      }\n      if (context.recentTransactions) {\n        const label = language === 'es' ? '- Transacciones recientes:' : '- Recent transactions:';\n        systemPrompt += `\\n${label} ${context.recentTransactions}`;\n      }\n    }\n\n    return systemPrompt;\n  }\n\n  async chat(\n    messages: ChatMessage[],\n    context?: AiContext,\n  ): Promise<string> {\n    // Enriquecer la última pregunta con RAG si está disponible\n    let enhancedMessages = [...messages];\n    if (context?.useRAG && context?.companyId && this.ragService && messages.length > 0) {\n      try {\n        const lastMessage = messages[messages.length - 1];\n        if (lastMessage.role === 'user') {\n          const ragContext = await this.ragService.smartQuery(\n            context.companyId,\n            lastMessage.content,\n            undefined,\n            context.language,\n          );\n\n          if (ragContext.relevantDocuments.length > 0) {\n            enhancedMessages[enhancedMessages.length - 1] = {\n              role: 'user',\n              content: ragContext.enhancedPrompt,\n            };\n            this.logger.debug(`RAG: Added ${ragContext.relevantDocuments.length} docs (lang: ${context.language || 'es'})`);\n          }\n        }\n      } catch (error) {\n        this.logger.warn('RAG enhancement failed, continuing without', error);\n      }\n    }\n\n    // Intentar con Anthropic SDK primero\n    if (this.client) {\n      try {\n        const response = await this.client.messages.create({\n          model: 'claude-sonnet-4-20250514',\n          max_tokens: 2048,\n          system: this.getSystemPrompt(context),\n          messages: enhancedMessages.map(m => ({\n            role: m.role,\n            content: m.content,\n          })),\n        });\n\n        const textBlock = response.content.find(block => block.type === 'text') as { type: 'text'; text: string } | undefined;\n        return textBlock?.text || 'No se pudo generar una respuesta.';\n      } catch (error) {\n        this.logger.warn('Anthropic SDK failed, trying provider fallback', error);\n      }\n    }\n\n    // Fallback a provider service con múltiples proveedores\n    if (this.providerService) {\n      try {\n        const providerMessages: ProviderMessage[] = enhancedMessages.map(m => ({\n          role: m.role,\n          content: m.content,\n        }));\n\n        const response = await this.providerService.chat(providerMessages, {\n          systemPrompt: this.getSystemPrompt(context),\n        });\n\n        this.logger.log(`Response from ${response.provider} (${response.latencyMs}ms)`);\n        return response.content;\n      } catch (error) {\n        this.logger.error('All AI providers failed', error);\n      }\n    }\n\n    return 'El servicio de IA no está disponible. Por favor, configura al menos un proveedor de IA.';\n  }\n\n  async analyzeTransaction(description: string): Promise<{\n    suggestedAccounts: { debit: string; credit: string };\n    explanation: string;\n  }> {\n    if (!this.client) {\n      return {\n        suggestedAccounts: { debit: '', credit: '' },\n        explanation: 'Servicio de IA no disponible',\n      };\n    }\n\n    const prompt = `Analiza la siguiente transacción y sugiere las cuentas del PGC español para el asiento contable:\n\n\"${description}\"\n\nResponde en formato JSON con esta estructura:\n{\n  \"suggestedAccounts\": {\n    \"debit\": \"código y nombre de cuenta al debe\",\n    \"credit\": \"código y nombre de cuenta al haber\"\n  },\n  \"explanation\": \"breve explicación del asiento\"\n}`;\n\n    try {\n      const response = await this.client.messages.create({\n        model: 'claude-sonnet-4-20250514',\n        max_tokens: 1024,\n        messages: [{ role: 'user', content: prompt }],\n      });\n\n      const textBlock = response.content.find(block => block.type === 'text') as { type: 'text'; text: string } | undefined;\n      if (textBlock) {\n        const jsonMatch = textBlock.text.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          return JSON.parse(jsonMatch[0]);\n        }\n      }\n\n      return {\n        suggestedAccounts: { debit: '', credit: '' },\n        explanation: 'No se pudo analizar la transacción',\n      };\n    } catch (error) {\n      this.logger.error('Error analyzing transaction', error);\n      return {\n        suggestedAccounts: { debit: '', credit: '' },\n        explanation: 'Error al analizar la transacción',\n      };\n    }\n  }\n\n  async generateReport(\n    reportType: 'summary' | 'recommendations' | 'tax-planning',\n    data: Record<string, unknown>,\n  ): Promise<string> {\n    if (!this.client) {\n      return 'Servicio de IA no disponible';\n    }\n\n    const prompts: Record<string, string> = {\n      summary: `Genera un resumen ejecutivo de la siguiente información financiera en español:\\n${JSON.stringify(data, null, 2)}`,\n      recommendations: `Analiza los siguientes datos financieros y proporciona recomendaciones de mejora:\\n${JSON.stringify(data, null, 2)}`,\n      'tax-planning': `Basándote en los siguientes datos, sugiere estrategias de planificación fiscal para una empresa española:\\n${JSON.stringify(data, null, 2)}`,\n    };\n\n    const prompt = prompts[reportType];\n    if (!prompt) {\n      return 'Tipo de informe no válido';\n    }\n\n    try {\n      const response = await this.client.messages.create({\n        model: 'claude-sonnet-4-20250514',\n        max_tokens: 2048,\n        system: this.getSystemPrompt(),\n        messages: [{ role: 'user', content: prompt }],\n      });\n\n      const textBlock = response.content.find(block => block.type === 'text') as { type: 'text'; text: string } | undefined;\n      return textBlock?.text || 'No se pudo generar el informe.';\n    } catch (error) {\n      this.logger.error('Error generating report', error);\n      throw new Error('Error al generar el informe');\n    }\n  }\n\n  async explainCryptoTax(\n    transactions: Array<{ type: string; amount: number; gainLoss?: number }>,\n  ): Promise<string> {\n    if (!this.client) {\n      return 'Servicio de IA no disponible';\n    }\n\n    const prompt = `Explica las implicaciones fiscales en España de las siguientes transacciones de criptomonedas:\n\n${JSON.stringify(transactions, null, 2)}\n\nIncluye:\n1. Cómo se calculan las ganancias/pérdidas patrimoniales\n2. En qué casilla de la declaración de la renta se declaran\n3. Tipos impositivos aplicables\n4. Posibles deducciones o compensaciones`;\n\n    try {\n      const response = await this.client.messages.create({\n        model: 'claude-sonnet-4-20250514',\n        max_tokens: 2048,\n        system: this.getSystemPrompt(),\n        messages: [{ role: 'user', content: prompt }],\n      });\n\n      const textBlock = response.content.find(block => block.type === 'text') as { type: 'text'; text: string } | undefined;\n      return textBlock?.text || 'No se pudo generar la explicación.';\n    } catch (error) {\n      this.logger.error('Error explaining crypto tax', error);\n      throw new Error('Error al explicar la fiscalidad');\n    }\n  }\n\n  /**\n   * Inicializa la base de conocimientos con documentación AEAT\n   */\n  async initializeKnowledgeBase(companyId: string): Promise<number> {\n    if (!this.embeddingsService) {\n      this.logger.warn('Embeddings service not available');\n      return 0;\n    }\n\n    return this.embeddingsService.indexAEATDocumentation(companyId);\n  }\n\n  /**\n   * Añade documento a la base de conocimientos\n   */\n  async addToKnowledgeBase(\n    companyId: string,\n    content: string,\n    metadata: Record<string, unknown>,\n    category?: string,\n  ): Promise<string | null> {\n    if (!this.embeddingsService) {\n      this.logger.warn('Embeddings service not available');\n      return null;\n    }\n\n    return this.embeddingsService.storeDocument(companyId, content, metadata, category);\n  }\n\n  /**\n   * Busca en la base de conocimientos\n   */\n  async searchKnowledge(\n    companyId: string,\n    query: string,\n    limit?: number,\n    category?: string,\n  ): Promise<Array<{ id: string; content: string; similarity: number }>> {\n    if (!this.embeddingsService) {\n      return [];\n    }\n\n    const results = await this.embeddingsService.searchSimilar(\n      companyId,\n      query,\n      limit,\n      category,\n    );\n\n    return results.map((r) => ({\n      id: r.id,\n      content: r.content,\n      similarity: r.similarity,\n    }));\n  }\n\n  /**\n   * Obtiene el estado de los proveedores de IA\n   */\n  getProvidersStatus(): Array<{ name: string; enabled: boolean }> {\n    if (!this.providerService) {\n      return [\n        {\n          name: 'anthropic',\n          enabled: !!this.client,\n        },\n      ];\n    }\n\n    return this.providerService.getProvidersStatus();\n  }\n}\n"],"names":["AiService","getSystemPrompt","context","language","prompts","es","en","systemPrompt","contextHeader","companyName","label","fiscalYear","accountBalances","recentTransactions","chat","messages","enhancedMessages","useRAG","companyId","ragService","length","lastMessage","role","ragContext","smartQuery","content","undefined","relevantDocuments","enhancedPrompt","logger","debug","error","warn","client","response","create","model","max_tokens","system","map","m","textBlock","find","block","type","text","providerService","providerMessages","log","provider","latencyMs","analyzeTransaction","description","suggestedAccounts","debit","credit","explanation","prompt","jsonMatch","match","JSON","parse","generateReport","reportType","data","summary","stringify","recommendations","Error","explainCryptoTax","transactions","initializeKnowledgeBase","embeddingsService","indexAEATDocumentation","addToKnowledgeBase","metadata","category","storeDocument","searchKnowledge","query","limit","results","searchSimilar","r","id","similarity","getProvidersStatus","name","enabled","configService","Logger","apiKey","get","Anthropic"],"mappings":"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"}