{"version":3,"sources":["../../../../src/modules/auth/strategies/google.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Strategy, VerifyCallback } from 'passport-google-oauth20';\nimport { ConfigService } from '@nestjs/config';\nimport { AuthService } from '../auth.service';\n\n@Injectable()\nexport class GoogleStrategy extends PassportStrategy(Strategy, 'google') {\n  constructor(\n    private configService: ConfigService,\n    private authService: AuthService,\n  ) {\n    super({\n      clientID: configService.get<string>('GOOGLE_CLIENT_ID'),\n      clientSecret: configService.get<string>('GOOGLE_CLIENT_SECRET'),\n      callbackURL: configService.get<string>('GOOGLE_CALLBACK_URL'),\n      scope: ['email', 'profile'],\n    });\n  }\n\n  async validate(\n    accessToken: string,\n    refreshToken: string,\n    profile: any,\n    done: VerifyCallback,\n  ): Promise<any> {\n    try {\n      const { id, emails, name, photos } = profile;\n\n      if (!emails || emails.length === 0) {\n        throw new UnauthorizedException('No email found in Google profile');\n      }\n\n      const email = emails[0].value;\n\n      // Auto-provision or find existing SSO user\n      const user = await this.authService.findOrCreateSSOUser({\n        ssoProvider: 'google',\n        ssoId: id,\n        email,\n        firstName: name.givenName,\n        lastName: name.familyName,\n        avatarUrl: photos?.[0]?.value,\n        ssoMetadata: {\n          accessToken,\n          refreshToken,\n          locale: profile._json.locale,\n        },\n      });\n\n      done(null, user);\n    } catch (error) {\n      done(error, false);\n    }\n  }\n}\n"],"names":["GoogleStrategy","PassportStrategy","Strategy","validate","accessToken","refreshToken","profile","done","id","emails","name","photos","length","UnauthorizedException","email","value","user","authService","findOrCreateSSOUser","ssoProvider","ssoId","firstName","givenName","lastName","familyName","avatarUrl","ssoMetadata","locale","_json","error","configService","clientID","get","clientSecret","callbackURL","scope"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPqC;0BACjB;uCACQ;wBACX;6BACF;;;;;;;;;;AAGrB,IAAA,AAAMA,iBAAN,MAAMA,uBAAuBC,IAAAA,0BAAgB,EAACC,+BAAQ,EAAE;IAa7D,MAAMC,SACJC,WAAmB,EACnBC,YAAoB,EACpBC,OAAY,EACZC,IAAoB,EACN;QACd,IAAI;YACF,MAAM,EAAEC,EAAE,EAAEC,MAAM,EAAEC,IAAI,EAAEC,MAAM,EAAE,GAAGL;YAErC,IAAI,CAACG,UAAUA,OAAOG,MAAM,KAAK,GAAG;gBAClC,MAAM,IAAIC,6BAAqB,CAAC;YAClC;YAEA,MAAMC,QAAQL,MAAM,CAAC,EAAE,CAACM,KAAK;YAE7B,2CAA2C;YAC3C,MAAMC,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,mBAAmB,CAAC;gBACtDC,aAAa;gBACbC,OAAOZ;gBACPM;gBACAO,WAAWX,KAAKY,SAAS;gBACzBC,UAAUb,KAAKc,UAAU;gBACzBC,WAAWd,QAAQ,CAAC,EAAE,EAAEI;gBACxBW,aAAa;oBACXtB;oBACAC;oBACAsB,QAAQrB,QAAQsB,KAAK,CAACD,MAAM;gBAC9B;YACF;YAEApB,KAAK,MAAMS;QACb,EAAE,OAAOa,OAAO;YACdtB,KAAKsB,OAAO;QACd;IACF;IA9CA,YACE,AAAQC,aAA4B,EACpC,AAAQb,WAAwB,CAChC;QACA,KAAK,CAAC;YACJc,UAAUD,cAAcE,GAAG,CAAS;YACpCC,cAAcH,cAAcE,GAAG,CAAS;YACxCE,aAAaJ,cAAcE,GAAG,CAAS;YACvCG,OAAO;gBAAC;gBAAS;aAAU;QAC7B,SARQL,gBAAAA,oBACAb,cAAAA;IAQV;AAqCF"}