{"version":3,"sources":["../../../src/modules/white-label/white-label.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException, BadRequestException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { UpdateWhiteLabelDto } from './dto/update-white-label.dto.js';\n\n/**\n * White-Label Service\n *\n * Manages branding customization for companies:\n * - Theme colors and CSS\n * - Logo and favicon\n * - Custom domain\n * - Email branding\n * - Feature flags\n */\n@Injectable()\nexport class WhiteLabelService {\n  private readonly logger = new Logger(WhiteLabelService.name);\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Get white-label configuration for a company\n   */\n  async getWhiteLabelConfig(companyId: string) {\n    let config = await this.prisma.whiteLabelConfig.findUnique({\n      where: { companyId },\n      include: {\n        company: {\n          select: {\n            id: true,\n            name: true,\n            logo: true,\n          },\n        },\n      },\n    });\n\n    // Create default config if not exists\n    if (!config) {\n      config = await this.prisma.whiteLabelConfig.create({\n        data: {\n          companyId,\n          enabledFeatures: ['invoicing', 'crypto', 'analytics', 'integrations'],\n        },\n        include: {\n          company: {\n            select: {\n              id: true,\n              name: true,\n              logo: true,\n            },\n          },\n        },\n      });\n      this.logger.log(`Created default white-label config for company ${companyId}`);\n    }\n\n    return config;\n  }\n\n  /**\n   * Get white-label configuration by custom domain\n   * Used for multi-tenant routing\n   */\n  async getWhiteLabelByDomain(domain: string) {\n    const config = await this.prisma.whiteLabelConfig.findUnique({\n      where: { customDomain: domain },\n      include: {\n        company: {\n          select: {\n            id: true,\n            name: true,\n            logo: true,\n          },\n        },\n      },\n    });\n\n    if (!config) {\n      throw new NotFoundException(`No white-label configuration found for domain: ${domain}`);\n    }\n\n    if (!config.domainVerified) {\n      throw new BadRequestException(`Domain ${domain} is not verified yet`);\n    }\n\n    return config;\n  }\n\n  /**\n   * Update white-label configuration\n   */\n  async updateWhiteLabelConfig(companyId: string, dto: UpdateWhiteLabelDto) {\n    // Validate custom domain uniqueness\n    if (dto.customDomain) {\n      const existing = await this.prisma.whiteLabelConfig.findFirst({\n        where: {\n          customDomain: dto.customDomain,\n          companyId: { not: companyId },\n        },\n      });\n\n      if (existing) {\n        throw new BadRequestException(`Custom domain ${dto.customDomain} is already in use`);\n      }\n    }\n\n    // Validate hex colors\n    if (dto.primaryColor && !this.isValidHexColor(dto.primaryColor)) {\n      throw new BadRequestException('Invalid primaryColor format. Use #RRGGBB');\n    }\n    if (dto.secondaryColor && !this.isValidHexColor(dto.secondaryColor)) {\n      throw new BadRequestException('Invalid secondaryColor format. Use #RRGGBB');\n    }\n    if (dto.accentColor && !this.isValidHexColor(dto.accentColor)) {\n      throw new BadRequestException('Invalid accentColor format. Use #RRGGBB');\n    }\n\n    // Upsert configuration\n    const config = await this.prisma.whiteLabelConfig.upsert({\n      where: { companyId },\n      create: {\n        companyId,\n        ...dto,\n      },\n      update: dto,\n      include: {\n        company: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n      },\n    });\n\n    this.logger.log(`Updated white-label config for company ${companyId}`);\n    return config;\n  }\n\n  /**\n   * Verify custom domain ownership\n   * In production, this would check DNS records or challenge tokens\n   */\n  async verifyCustomDomain(companyId: string): Promise<boolean> {\n    const config = await this.prisma.whiteLabelConfig.findUnique({\n      where: { companyId },\n    });\n\n    if (!config?.customDomain) {\n      throw new BadRequestException('No custom domain configured');\n    }\n\n    // TODO: Implement actual DNS verification\n    // For now, simulate verification\n    const verified = true; // In production: check DNS TXT record or CNAME\n\n    if (verified) {\n      await this.prisma.whiteLabelConfig.update({\n        where: { companyId },\n        data: { domainVerified: true },\n      });\n\n      this.logger.log(`Verified custom domain ${config.customDomain} for company ${companyId}`);\n    }\n\n    return verified;\n  }\n\n  /**\n   * Get theme CSS variables for a company\n   */\n  async getThemeCss(companyId: string): Promise<string> {\n    const config = await this.getWhiteLabelConfig(companyId);\n\n    const cssVariables = `\n:root {\n  ${config.primaryColor ? `--primary-color: ${config.primaryColor};` : ''}\n  ${config.secondaryColor ? `--secondary-color: ${config.secondaryColor};` : ''}\n  ${config.accentColor ? `--accent-color: ${config.accentColor};` : ''}\n  ${config.backgroundColor ? `--background-color: ${config.backgroundColor};` : ''}\n  ${config.textColor ? `--text-color: ${config.textColor};` : ''}\n}\n${config.customCss || ''}\n`.trim();\n\n    return cssVariables;\n  }\n\n  /**\n   * Check if feature is enabled for company\n   */\n  async isFeatureEnabled(companyId: string, feature: string): Promise<boolean> {\n    const config = await this.getWhiteLabelConfig(companyId);\n    return config.enabledFeatures.includes(feature);\n  }\n\n  /**\n   * Get email branding for a company\n   */\n  async getEmailBranding(companyId: string) {\n    const config = await this.getWhiteLabelConfig(companyId);\n\n    return {\n      fromName: config.emailFromName || config.company.name,\n      replyTo: config.emailReplyTo,\n      logoUrl: config.logoUrl || config.company.logo,\n      footerText: config.emailFooterText,\n      brandName: config.brandName || config.company.name,\n    };\n  }\n\n  /**\n   * Delete white-label configuration (reset to defaults)\n   */\n  async deleteWhiteLabelConfig(companyId: string) {\n    await this.prisma.whiteLabelConfig.delete({\n      where: { companyId },\n    });\n\n    this.logger.log(`Deleted white-label config for company ${companyId}`);\n    return { success: true, message: 'White-label configuration reset to defaults' };\n  }\n\n  /**\n   * Helper: Validate hex color format\n   */\n  private isValidHexColor(color: string): boolean {\n    return /^#[0-9A-Fa-f]{6}$/.test(color);\n  }\n}\n"],"names":["WhiteLabelService","getWhiteLabelConfig","companyId","config","prisma","whiteLabelConfig","findUnique","where","include","company","select","id","name","logo","create","data","enabledFeatures","logger","log","getWhiteLabelByDomain","domain","customDomain","NotFoundException","domainVerified","BadRequestException","updateWhiteLabelConfig","dto","existing","findFirst","not","primaryColor","isValidHexColor","secondaryColor","accentColor","upsert","update","verifyCustomDomain","verified","getThemeCss","cssVariables","backgroundColor","textColor","customCss","trim","isFeatureEnabled","feature","includes","getEmailBranding","fromName","emailFromName","replyTo","emailReplyTo","logoUrl","footerText","emailFooterText","brandName","deleteWhiteLabelConfig","delete","success","message","color","test","Logger"],"mappings":"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"}