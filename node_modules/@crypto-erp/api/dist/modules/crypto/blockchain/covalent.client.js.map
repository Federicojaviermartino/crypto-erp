{"version":3,"sources":["../../../../src/modules/crypto/blockchain/covalent.client.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\n\nexport interface CovalentBalance {\n  contract_address: string;\n  contract_name: string;\n  contract_ticker_symbol: string;\n  contract_decimals: number;\n  balance: string;\n  quote: number;\n  quote_currency: string;\n  logo_url?: string;\n  type: 'cryptocurrency' | 'nft' | 'dust';\n}\n\nexport interface CovalentTransaction {\n  tx_hash: string;\n  block_signed_at: string;\n  block_height: number;\n  from_address: string;\n  to_address: string;\n  value: string;\n  gas_spent: number;\n  gas_price: number;\n  gas_quote: number;\n  successful: boolean;\n  log_events: CovalentLogEvent[];\n  dex_details?: CovalentDexDetails;\n}\n\nexport interface CovalentLogEvent {\n  sender_address: string;\n  sender_name?: string;\n  decoded?: {\n    name: string;\n    signature: string;\n    params: Array<{\n      name: string;\n      type: string;\n      value: string;\n      decoded: boolean;\n    }>;\n  };\n}\n\nexport interface CovalentDexDetails {\n  protocol_name: string;\n  protocol_logo_url?: string;\n  token_0: {\n    contract_address: string;\n    contract_ticker_symbol: string;\n    contract_decimals: number;\n    amount: string;\n    quote: number;\n  };\n  token_1: {\n    contract_address: string;\n    contract_ticker_symbol: string;\n    contract_decimals: number;\n    amount: string;\n    quote: number;\n  };\n}\n\nexport interface CovalentResponse<T> {\n  data: {\n    items: T[];\n    pagination?: {\n      has_more: boolean;\n      page_number: number;\n      page_size: number;\n      total_count?: number;\n    };\n  };\n  error: boolean;\n  error_message?: string;\n  error_code?: number;\n}\n\nexport type ChainName =\n  | 'eth-mainnet'\n  | 'matic-mainnet'\n  | 'bsc-mainnet'\n  | 'arbitrum-mainnet'\n  | 'optimism-mainnet'\n  | 'base-mainnet'\n  | 'avalanche-mainnet'\n  | 'solana-mainnet'\n  | 'bitcoin-mainnet';\n\nconst CHAIN_MAP: Record<string, ChainName> = {\n  ethereum: 'eth-mainnet',\n  polygon: 'matic-mainnet',\n  bsc: 'bsc-mainnet',\n  arbitrum: 'arbitrum-mainnet',\n  optimism: 'optimism-mainnet',\n  base: 'base-mainnet',\n  avalanche: 'avalanche-mainnet',\n  solana: 'solana-mainnet',\n  bitcoin: 'bitcoin-mainnet',\n};\n\nconst NATIVE_TOKENS: Record<ChainName, { symbol: string; name: string; decimals: number }> = {\n  'eth-mainnet': { symbol: 'ETH', name: 'Ethereum', decimals: 18 },\n  'matic-mainnet': { symbol: 'MATIC', name: 'Polygon', decimals: 18 },\n  'bsc-mainnet': { symbol: 'BNB', name: 'BNB', decimals: 18 },\n  'arbitrum-mainnet': { symbol: 'ETH', name: 'Ethereum', decimals: 18 },\n  'optimism-mainnet': { symbol: 'ETH', name: 'Ethereum', decimals: 18 },\n  'base-mainnet': { symbol: 'ETH', name: 'Ethereum', decimals: 18 },\n  'avalanche-mainnet': { symbol: 'AVAX', name: 'Avalanche', decimals: 18 },\n  'solana-mainnet': { symbol: 'SOL', name: 'Solana', decimals: 9 },\n  'bitcoin-mainnet': { symbol: 'BTC', name: 'Bitcoin', decimals: 8 },\n};\n\n@Injectable()\nexport class CovalentClient {\n  private readonly logger = new Logger(CovalentClient.name);\n  private readonly apiKey: string;\n  private readonly baseUrl = 'https://api.covalenthq.com/v1';\n\n  constructor(private configService: ConfigService) {\n    this.apiKey = this.configService.get<string>('blockchain.covalentApiKey') || '';\n    if (!this.apiKey) {\n      this.logger.warn('COVALENT_API_KEY not configured - blockchain sync disabled');\n    }\n  }\n\n  isConfigured(): boolean {\n    return !!this.apiKey;\n  }\n\n  getChainName(chain: string): ChainName {\n    return CHAIN_MAP[chain.toLowerCase()] || 'eth-mainnet';\n  }\n\n  getNativeToken(chain: ChainName) {\n    return NATIVE_TOKENS[chain];\n  }\n\n  private async request<T>(endpoint: string): Promise<T> {\n    if (!this.apiKey) {\n      throw new Error('Covalent API key not configured');\n    }\n\n    const url = `${this.baseUrl}${endpoint}`;\n    const headers = {\n      Authorization: `Bearer ${this.apiKey}`,\n      'Content-Type': 'application/json',\n    };\n\n    this.logger.debug(`Covalent request: ${url}`);\n\n    const response = await fetch(url, { headers });\n\n    if (!response.ok) {\n      const error = await response.text();\n      this.logger.error(`Covalent API error: ${response.status} - ${error}`);\n      throw new Error(`Covalent API error: ${response.status}`);\n    }\n\n    const data = await response.json() as { error?: boolean; error_message?: string } & T;\n\n    if (data.error) {\n      this.logger.error(`Covalent API error: ${data.error_message}`);\n      throw new Error(data.error_message || 'Covalent API error');\n    }\n\n    return data as T;\n  }\n\n  async getBalances(\n    chain: string,\n    address: string,\n  ): Promise<CovalentBalance[]> {\n    const chainName = this.getChainName(chain);\n    const endpoint = `/${chainName}/address/${address}/balances_v2/?quote-currency=EUR&no-spam=true`;\n\n    const response = await this.request<CovalentResponse<CovalentBalance>>(endpoint);\n    return response.data.items;\n  }\n\n  async getTransactions(\n    chain: string,\n    address: string,\n    options: {\n      pageSize?: number;\n      pageNumber?: number;\n      startBlock?: number;\n      endBlock?: number;\n    } = {},\n  ): Promise<{\n    transactions: CovalentTransaction[];\n    hasMore: boolean;\n    pageNumber: number;\n  }> {\n    const chainName = this.getChainName(chain);\n    const params = new URLSearchParams({\n      'quote-currency': 'EUR',\n      'page-size': String(options.pageSize || 100),\n      'page-number': String(options.pageNumber || 0),\n      'no-logs': 'false',\n    });\n\n    if (options.startBlock) {\n      params.set('starting-block', String(options.startBlock));\n    }\n    if (options.endBlock) {\n      params.set('ending-block', String(options.endBlock));\n    }\n\n    const endpoint = `/${chainName}/address/${address}/transactions_v3/?${params}`;\n\n    const response = await this.request<CovalentResponse<CovalentTransaction>>(endpoint);\n\n    return {\n      transactions: response.data.items,\n      hasMore: response.data.pagination?.has_more || false,\n      pageNumber: response.data.pagination?.page_number || 0,\n    };\n  }\n\n  async getERC20Transfers(\n    chain: string,\n    address: string,\n    options: {\n      pageSize?: number;\n      pageNumber?: number;\n      startBlock?: number;\n      endBlock?: number;\n      contractAddress?: string;\n    } = {},\n  ): Promise<{\n    transfers: Array<{\n      tx_hash: string;\n      block_signed_at: string;\n      block_height: number;\n      from_address: string;\n      to_address: string;\n      contract_address: string;\n      contract_ticker_symbol: string;\n      contract_decimals: number;\n      transfers: Array<{\n        from_address: string;\n        to_address: string;\n        contract_address: string;\n        contract_ticker_symbol: string;\n        contract_decimals: number;\n        delta: string;\n        delta_quote: number;\n        transfer_type: 'IN' | 'OUT';\n      }>;\n    }>;\n    hasMore: boolean;\n  }> {\n    const chainName = this.getChainName(chain);\n    const params = new URLSearchParams({\n      'quote-currency': 'EUR',\n      'page-size': String(options.pageSize || 100),\n      'page-number': String(options.pageNumber || 0),\n    });\n\n    if (options.startBlock) {\n      params.set('starting-block', String(options.startBlock));\n    }\n    if (options.endBlock) {\n      params.set('ending-block', String(options.endBlock));\n    }\n    if (options.contractAddress) {\n      params.set('contract-address', options.contractAddress);\n    }\n\n    const endpoint = `/${chainName}/address/${address}/transfers_v2/?${params}`;\n\n    const response = await this.request<CovalentResponse<any>>(endpoint);\n\n    return {\n      transfers: response.data.items,\n      hasMore: response.data.pagination?.has_more || false,\n    };\n  }\n\n  async getTransaction(chain: string, txHash: string): Promise<CovalentTransaction | null> {\n    const chainName = this.getChainName(chain);\n    const endpoint = `/${chainName}/transaction_v2/${txHash}/?quote-currency=EUR&no-logs=false`;\n\n    try {\n      const response = await this.request<CovalentResponse<CovalentTransaction>>(endpoint);\n      return response.data.items[0] || null;\n    } catch {\n      return null;\n    }\n  }\n\n  async getBlockHeight(chain: string): Promise<number> {\n    const chainName = this.getChainName(chain);\n    const endpoint = `/${chainName}/block_v2/latest/`;\n\n    const response = await this.request<{ data: { items: [{ height: number }] } }>(endpoint);\n    return response.data.items[0]?.height || 0;\n  }\n}\n"],"names":["CovalentClient","CHAIN_MAP","ethereum","polygon","bsc","arbitrum","optimism","base","avalanche","solana","bitcoin","NATIVE_TOKENS","symbol","name","decimals","isConfigured","apiKey","getChainName","chain","toLowerCase","getNativeToken","request","endpoint","Error","url","baseUrl","headers","Authorization","logger","debug","response","fetch","ok","error","text","status","data","json","error_message","getBalances","address","chainName","items","getTransactions","options","params","URLSearchParams","String","pageSize","pageNumber","startBlock","set","endBlock","transactions","hasMore","pagination","has_more","page_number","getERC20Transfers","contractAddress","transfers","getTransaction","txHash","getBlockHeight","height","configService","Logger","get","warn"],"mappings":"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"}