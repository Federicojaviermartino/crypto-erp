{"version":3,"sources":["../../../src/modules/oauth/api-usage.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\n\n/**\n * API Usage Tracking Service\n * Tracks API usage for rate limiting and analytics\n */\n@Injectable()\nexport class ApiUsageService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Record an API request for usage tracking\n   */\n  async recordRequest(data: {\n    appId?: string;\n    companyId: string;\n    userId?: string;\n    endpoint: string;\n    method: string;\n    statusCode: number;\n    responseTime: number;\n    ipAddress?: string;\n    userAgent?: string;\n  }) {\n    try {\n      await this.prisma.apiUsage.create({\n        data: {\n          appId: data.appId,\n          companyId: data.companyId,\n          userId: data.userId,\n          endpoint: data.endpoint,\n          method: data.method,\n          statusCode: data.statusCode,\n          responseTime: data.responseTime,\n          ipAddress: data.ipAddress,\n          userAgent: data.userAgent,\n          timestamp: new Date(),\n        },\n      });\n    } catch (error) {\n      // Don't fail the request if usage tracking fails\n      console.error('Failed to record API usage:', error);\n    }\n  }\n\n  /**\n   * Get request count for an app in the last hour\n   */\n  async getHourlyRequestCount(appId: string): Promise<number> {\n    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);\n\n    const result = await this.prisma.apiUsage.count({\n      where: {\n        appId,\n        timestamp: {\n          gte: oneHourAgo,\n        },\n      },\n    });\n\n    return result;\n  }\n\n  /**\n   * Get request count for an app in the last 24 hours\n   */\n  async getDailyRequestCount(appId: string): Promise<number> {\n    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n\n    const result = await this.prisma.apiUsage.count({\n      where: {\n        appId,\n        timestamp: {\n          gte: oneDayAgo,\n        },\n      },\n    });\n\n    return result;\n  }\n\n  /**\n   * Get usage statistics for an app\n   */\n  async getAppUsageStats(appId: string, startDate?: Date, endDate?: Date) {\n    const where: any = {\n      appId,\n    };\n\n    if (startDate || endDate) {\n      where.timestamp = {};\n      if (startDate) where.timestamp.gte = startDate;\n      if (endDate) where.timestamp.lte = endDate;\n    }\n\n    const [totalRequests, avgResponseTime, statusCodeDistribution] =\n      await Promise.all([\n        // Total requests\n        this.prisma.apiUsage.count({ where }),\n\n        // Average response time\n        this.prisma.apiUsage.aggregate({\n          where,\n          _avg: {\n            responseTime: true,\n          },\n        }),\n\n        // Status code distribution\n        this.prisma.apiUsage.groupBy({\n          by: ['statusCode'],\n          where,\n          _count: true,\n          orderBy: {\n            _count: {\n              statusCode: 'desc',\n            },\n          },\n        }),\n      ]);\n\n    // Get most used endpoints\n    const topEndpoints = await this.prisma.apiUsage.groupBy({\n      by: ['endpoint', 'method'],\n      where,\n      _count: true,\n      orderBy: {\n        _count: {\n          endpoint: 'desc',\n        },\n      },\n      take: 10,\n    });\n\n    return {\n      totalRequests,\n      averageResponseTime: avgResponseTime._avg.responseTime || 0,\n      statusCodeDistribution: statusCodeDistribution.map(s => ({\n        statusCode: s.statusCode,\n        count: s._count,\n      })),\n      topEndpoints: topEndpoints.map(e => ({\n        endpoint: e.endpoint,\n        method: e.method,\n        count: e._count,\n      })),\n    };\n  }\n\n  /**\n   * Get company usage statistics\n   */\n  async getCompanyUsageStats(companyId: string, startDate?: Date, endDate?: Date) {\n    const where: any = {\n      companyId,\n    };\n\n    if (startDate || endDate) {\n      where.timestamp = {};\n      if (startDate) where.timestamp.gte = startDate;\n      if (endDate) where.timestamp.lte = endDate;\n    }\n\n    const [totalRequests, avgResponseTime, requestsByApp] = await Promise.all([\n      // Total requests\n      this.prisma.apiUsage.count({ where }),\n\n      // Average response time\n      this.prisma.apiUsage.aggregate({\n        where,\n        _avg: {\n          responseTime: true,\n        },\n      }),\n\n      // Requests by app\n      this.prisma.apiUsage.groupBy({\n        by: ['appId'],\n        where,\n        _count: true,\n        orderBy: {\n          _count: {\n            appId: 'desc',\n          },\n        },\n      }),\n    ]);\n\n    // Get app details for requests by app\n    const appIds = requestsByApp\n      .map(r => r.appId)\n      .filter((id): id is string => id !== null);\n\n    const apps = await this.prisma.oAuthApp.findMany({\n      where: {\n        id: {\n          in: appIds,\n        },\n      },\n      select: {\n        id: true,\n        name: true,\n      },\n    });\n\n    const appMap = new Map(apps.map(a => [a.id, a.name]));\n\n    return {\n      totalRequests,\n      averageResponseTime: avgResponseTime._avg.responseTime || 0,\n      requestsByApp: requestsByApp.map(r => ({\n        appId: r.appId,\n        appName: r.appId ? appMap.get(r.appId) || 'Unknown' : 'Direct API',\n        count: r._count,\n      })),\n    };\n  }\n\n  /**\n   * Clean up old usage data (older than 90 days)\n   * Should be run periodically via a cron job\n   */\n  async cleanupOldData() {\n    const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);\n\n    const result = await this.prisma.apiUsage.deleteMany({\n      where: {\n        timestamp: {\n          lt: ninetyDaysAgo,\n        },\n      },\n    });\n\n    return {\n      deletedCount: result.count,\n    };\n  }\n}\n"],"names":["ApiUsageService","recordRequest","data","prisma","apiUsage","create","appId","companyId","userId","endpoint","method","statusCode","responseTime","ipAddress","userAgent","timestamp","Date","error","console","getHourlyRequestCount","oneHourAgo","now","result","count","where","gte","getDailyRequestCount","oneDayAgo","getAppUsageStats","startDate","endDate","lte","totalRequests","avgResponseTime","statusCodeDistribution","Promise","all","aggregate","_avg","groupBy","by","_count","orderBy","topEndpoints","take","averageResponseTime","map","s","e","getCompanyUsageStats","requestsByApp","appIds","r","filter","id","apps","oAuthApp","findMany","in","select","name","appMap","Map","a","appName","get","cleanupOldData","ninetyDaysAgo","deleteMany","lt","deletedCount"],"mappings":"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"}