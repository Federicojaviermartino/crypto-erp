{"version":3,"sources":["../../src/config/database.config.ts"],"sourcesContent":["/**\n * Database configuration for multi-region deployment.\n * Supports read replicas across different geographic regions.\n */\n\nexport interface DatabaseRegionConfig {\n  region: string;\n  writeUrl: string;\n  readUrls: string[];\n}\n\nexport interface DatabaseConfig {\n  primary: {\n    region: string;\n    url: string;\n  };\n  replicas: Array<{\n    region: string;\n    url: string;\n  }>;\n  connectionPooling: {\n    min: number;\n    max: number;\n    acquireTimeout: number;\n    idleTimeout: number;\n  };\n}\n\n/**\n * Load database configuration from environment variables.\n * Supports multiple read replicas for different regions.\n *\n * Environment variables:\n * - DATABASE_URL: Primary database (write)\n * - DATABASE_READ_REPLICA_EU: EU read replica\n * - DATABASE_READ_REPLICA_US: US read replica\n * - DATABASE_READ_REPLICA_ASIA: Asia read replica\n */\nexport function getDatabaseConfig(): DatabaseConfig {\n  const primaryUrl = process.env['DATABASE_URL'];\n  if (!primaryUrl) {\n    throw new Error('DATABASE_URL is required');\n  }\n\n  const replicas: Array<{ region: string; url: string }> = [];\n\n  // Add EU replica if configured\n  if (process.env['DATABASE_READ_REPLICA_EU']) {\n    replicas.push({\n      region: 'eu',\n      url: process.env['DATABASE_READ_REPLICA_EU'],\n    });\n  }\n\n  // Add US replica if configured\n  if (process.env['DATABASE_READ_REPLICA_US']) {\n    replicas.push({\n      region: 'us',\n      url: process.env['DATABASE_READ_REPLICA_US'],\n    });\n  }\n\n  // Add Asia replica if configured\n  if (process.env['DATABASE_READ_REPLICA_ASIA']) {\n    replicas.push({\n      region: 'asia',\n      url: process.env['DATABASE_READ_REPLICA_ASIA'],\n    });\n  }\n\n  return {\n    primary: {\n      region: process.env['DATABASE_PRIMARY_REGION'] || 'eu',\n      url: primaryUrl,\n    },\n    replicas,\n    connectionPooling: {\n      min: parseInt(process.env['DATABASE_POOL_MIN'] || '2', 10),\n      max: parseInt(process.env['DATABASE_POOL_MAX'] || '10', 10),\n      acquireTimeout: parseInt(\n        process.env['DATABASE_ACQUIRE_TIMEOUT'] || '30000',\n        10,\n      ),\n      idleTimeout: parseInt(\n        process.env['DATABASE_IDLE_TIMEOUT'] || '10000',\n        10,\n      ),\n    },\n  };\n}\n\n/**\n * Detect user's region based on request headers.\n * Falls back to primary region if detection fails.\n */\nexport function detectRegionFromRequest(\n  headers: Record<string, string | string[] | undefined>,\n): string {\n  // Try CloudFront-Viewer-Country header (AWS CloudFront)\n  const cloudFrontCountry = headers['cloudfront-viewer-country'];\n  if (cloudFrontCountry && typeof cloudFrontCountry === 'string') {\n    return mapCountryToRegion(cloudFrontCountry);\n  }\n\n  // Try CF-IPCountry header (Cloudflare)\n  const cfCountry = headers['cf-ipcountry'];\n  if (cfCountry && typeof cfCountry === 'string') {\n    return mapCountryToRegion(cfCountry);\n  }\n\n  // Try X-AppEngine-Country header (Google Cloud)\n  const gaeCountry = headers['x-appengine-country'];\n  if (gaeCountry && typeof gaeCountry === 'string') {\n    return mapCountryToRegion(gaeCountry);\n  }\n\n  // Default to primary region\n  return process.env['DATABASE_PRIMARY_REGION'] || 'eu';\n}\n\n/**\n * Map ISO country code to database region.\n */\nfunction mapCountryToRegion(countryCode: string): string {\n  const euCountries = [\n    'AT',\n    'BE',\n    'BG',\n    'HR',\n    'CY',\n    'CZ',\n    'DK',\n    'EE',\n    'FI',\n    'FR',\n    'DE',\n    'GR',\n    'HU',\n    'IE',\n    'IT',\n    'LV',\n    'LT',\n    'LU',\n    'MT',\n    'NL',\n    'PL',\n    'PT',\n    'RO',\n    'SK',\n    'SI',\n    'ES',\n    'SE',\n    'GB',\n    'CH',\n    'NO',\n    'IS',\n  ];\n\n  const usCountries = ['US', 'CA', 'MX', 'BR', 'AR', 'CL', 'CO', 'PE'];\n\n  const asiaCountries = [\n    'CN',\n    'JP',\n    'KR',\n    'IN',\n    'SG',\n    'HK',\n    'TW',\n    'TH',\n    'MY',\n    'ID',\n    'PH',\n    'VN',\n    'AU',\n    'NZ',\n  ];\n\n  if (euCountries.includes(countryCode.toUpperCase())) {\n    return 'eu';\n  }\n\n  if (usCountries.includes(countryCode.toUpperCase())) {\n    return 'us';\n  }\n\n  if (asiaCountries.includes(countryCode.toUpperCase())) {\n    return 'asia';\n  }\n\n  // Default to EU for unknown countries\n  return 'eu';\n}\n"],"names":["detectRegionFromRequest","getDatabaseConfig","primaryUrl","process","env","Error","replicas","push","region","url","primary","connectionPooling","min","parseInt","max","acquireTimeout","idleTimeout","headers","cloudFrontCountry","mapCountryToRegion","cfCountry","gaeCountry","countryCode","euCountries","usCountries","asiaCountries","includes","toUpperCase"],"mappings":"AAAA;;;CAGC;;;;;;;;;;;QA4FeA;eAAAA;;QAzDAC;eAAAA;;;AAAT,SAASA;IACd,MAAMC,aAAaC,QAAQC,GAAG,CAAC,eAAe;IAC9C,IAAI,CAACF,YAAY;QACf,MAAM,IAAIG,MAAM;IAClB;IAEA,MAAMC,WAAmD,EAAE;IAE3D,+BAA+B;IAC/B,IAAIH,QAAQC,GAAG,CAAC,2BAA2B,EAAE;QAC3CE,SAASC,IAAI,CAAC;YACZC,QAAQ;YACRC,KAAKN,QAAQC,GAAG,CAAC,2BAA2B;QAC9C;IACF;IAEA,+BAA+B;IAC/B,IAAID,QAAQC,GAAG,CAAC,2BAA2B,EAAE;QAC3CE,SAASC,IAAI,CAAC;YACZC,QAAQ;YACRC,KAAKN,QAAQC,GAAG,CAAC,2BAA2B;QAC9C;IACF;IAEA,iCAAiC;IACjC,IAAID,QAAQC,GAAG,CAAC,6BAA6B,EAAE;QAC7CE,SAASC,IAAI,CAAC;YACZC,QAAQ;YACRC,KAAKN,QAAQC,GAAG,CAAC,6BAA6B;QAChD;IACF;IAEA,OAAO;QACLM,SAAS;YACPF,QAAQL,QAAQC,GAAG,CAAC,0BAA0B,IAAI;YAClDK,KAAKP;QACP;QACAI;QACAK,mBAAmB;YACjBC,KAAKC,SAASV,QAAQC,GAAG,CAAC,oBAAoB,IAAI,KAAK;YACvDU,KAAKD,SAASV,QAAQC,GAAG,CAAC,oBAAoB,IAAI,MAAM;YACxDW,gBAAgBF,SACdV,QAAQC,GAAG,CAAC,2BAA2B,IAAI,SAC3C;YAEFY,aAAaH,SACXV,QAAQC,GAAG,CAAC,wBAAwB,IAAI,SACxC;QAEJ;IACF;AACF;AAMO,SAASJ,wBACdiB,OAAsD;IAEtD,wDAAwD;IACxD,MAAMC,oBAAoBD,OAAO,CAAC,4BAA4B;IAC9D,IAAIC,qBAAqB,OAAOA,sBAAsB,UAAU;QAC9D,OAAOC,mBAAmBD;IAC5B;IAEA,uCAAuC;IACvC,MAAME,YAAYH,OAAO,CAAC,eAAe;IACzC,IAAIG,aAAa,OAAOA,cAAc,UAAU;QAC9C,OAAOD,mBAAmBC;IAC5B;IAEA,gDAAgD;IAChD,MAAMC,aAAaJ,OAAO,CAAC,sBAAsB;IACjD,IAAII,cAAc,OAAOA,eAAe,UAAU;QAChD,OAAOF,mBAAmBE;IAC5B;IAEA,4BAA4B;IAC5B,OAAOlB,QAAQC,GAAG,CAAC,0BAA0B,IAAI;AACnD;AAEA;;CAEC,GACD,SAASe,mBAAmBG,WAAmB;IAC7C,MAAMC,cAAc;QAClB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,MAAMC,cAAc;QAAC;QAAM;QAAM;QAAM;QAAM;QAAM;QAAM;QAAM;KAAK;IAEpE,MAAMC,gBAAgB;QACpB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,IAAIF,YAAYG,QAAQ,CAACJ,YAAYK,WAAW,KAAK;QACnD,OAAO;IACT;IAEA,IAAIH,YAAYE,QAAQ,CAACJ,YAAYK,WAAW,KAAK;QACnD,OAAO;IACT;IAEA,IAAIF,cAAcC,QAAQ,CAACJ,YAAYK,WAAW,KAAK;QACrD,OAAO;IACT;IAEA,sCAAsC;IACtC,OAAO;AACT"}