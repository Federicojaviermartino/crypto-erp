{"version":3,"sources":["../../../../src/modules/crypto/services/wallets.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ConflictException, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateWalletDto, UpdateWalletDto } from '../dto/index.js';\nimport { Wallet, SyncStatus } from '@prisma/client';\nimport { CovalentClient, CovalentBalance } from '../blockchain/covalent.client.js';\n\nexport interface WalletWithBalances extends Wallet {\n  balances?: CovalentBalance[];\n  totalValueEur?: number;\n}\n\n@Injectable()\nexport class WalletsService {\n  private readonly logger = new Logger(WalletsService.name);\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly covalent: CovalentClient,\n  ) {}\n\n  async findAll(companyId: string): Promise<Wallet[]> {\n    return this.prisma.wallet.findMany({\n      where: { companyId },\n      orderBy: [{ isActive: 'desc' }, { createdAt: 'desc' }],\n    });\n  }\n\n  async findById(companyId: string, id: string): Promise<Wallet> {\n    const wallet = await this.prisma.wallet.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!wallet) {\n      throw new NotFoundException(`Wallet with ID ${id} not found`);\n    }\n\n    return wallet;\n  }\n\n  async findByAddress(companyId: string, chain: string, address: string): Promise<Wallet | null> {\n    return this.prisma.wallet.findFirst({\n      where: {\n        companyId,\n        chain: chain.toLowerCase(),\n        address: address.toLowerCase(),\n      },\n    });\n  }\n\n  async create(companyId: string, dto: CreateWalletDto): Promise<Wallet> {\n    const normalizedAddress = dto.address.toLowerCase();\n    const normalizedChain = dto.chain.toLowerCase();\n\n    // Check for duplicate wallet\n    const existing = await this.findByAddress(companyId, normalizedChain, normalizedAddress);\n    if (existing) {\n      throw new ConflictException(\n        `Wallet ${normalizedAddress} on ${normalizedChain} already exists`,\n      );\n    }\n\n    return this.prisma.wallet.create({\n      data: {\n        address: normalizedAddress,\n        chain: normalizedChain,\n        label: dto.label,\n        type: dto.type || 'EXTERNAL',\n        accountCode: dto.accountCode,\n        syncStatus: 'PENDING',\n        companyId,\n      },\n    });\n  }\n\n  async update(companyId: string, id: string, dto: UpdateWalletDto): Promise<Wallet> {\n    await this.findById(companyId, id);\n\n    return this.prisma.wallet.update({\n      where: { id },\n      data: {\n        ...(dto.label !== undefined && { label: dto.label }),\n        ...(dto.type !== undefined && { type: dto.type }),\n        ...(dto.accountCode !== undefined && { accountCode: dto.accountCode }),\n        ...(dto.isActive !== undefined && { isActive: dto.isActive }),\n      },\n    });\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    const wallet = await this.findById(companyId, id);\n\n    // Check for transactions linked to this wallet\n    const txCount = await this.prisma.cryptoTransaction.count({\n      where: { walletId: id },\n    });\n\n    if (txCount > 0) {\n      throw new ConflictException(\n        `Cannot delete wallet with ${txCount} transactions. Deactivate instead.`,\n      );\n    }\n\n    await this.prisma.wallet.delete({ where: { id } });\n  }\n\n  async getWalletWithBalances(companyId: string, id: string): Promise<WalletWithBalances> {\n    const wallet = await this.findById(companyId, id);\n\n    if (!this.covalent.isConfigured()) {\n      this.logger.warn('Covalent API not configured - cannot fetch balances');\n      return wallet;\n    }\n\n    try {\n      const balances = await this.covalent.getBalances(wallet.chain, wallet.address);\n\n      const totalValueEur = balances.reduce((sum, b) => sum + (b.quote || 0), 0);\n\n      return {\n        ...wallet,\n        balances,\n        totalValueEur,\n      };\n    } catch (error) {\n      this.logger.error(`Failed to fetch balances for wallet ${id}:`, error);\n      return wallet;\n    }\n  }\n\n  async setSyncStatus(\n    id: string,\n    status: SyncStatus,\n    error?: string | null,\n    lastBlock?: bigint,\n  ): Promise<void> {\n    await this.prisma.wallet.update({\n      where: { id },\n      data: {\n        syncStatus: status,\n        syncError: error || null,\n        ...(status === 'SYNCED' && { lastSyncAt: new Date() }),\n        ...(lastBlock !== undefined && { lastSyncBlock: lastBlock }),\n      },\n    });\n  }\n\n  async getWalletsForSync(companyId?: string): Promise<Wallet[]> {\n    return this.prisma.wallet.findMany({\n      where: {\n        isActive: true,\n        ...(companyId && { companyId }),\n        syncStatus: { not: 'SYNCING' },\n      },\n      orderBy: { lastSyncAt: 'asc' },\n    });\n  }\n\n  async countTransactions(walletId: string): Promise<number> {\n    return this.prisma.cryptoTransaction.count({\n      where: { walletId },\n    });\n  }\n\n  async getWalletStats(companyId: string, id: string): Promise<{\n    transactionCount: number;\n    lastTransaction: Date | null;\n    uniqueAssets: number;\n  }> {\n    const wallet = await this.findById(companyId, id);\n\n    const [transactionCount, lastTx, assets] = await Promise.all([\n      this.prisma.cryptoTransaction.count({\n        where: { walletId: id },\n      }),\n      this.prisma.cryptoTransaction.findFirst({\n        where: { walletId: id },\n        orderBy: { blockTimestamp: 'desc' },\n        select: { blockTimestamp: true },\n      }),\n      this.prisma.cryptoTransaction.groupBy({\n        by: ['assetIn', 'assetOut'],\n        where: { walletId: id },\n      }),\n    ]);\n\n    // Count unique assets\n    const uniqueAssetSet = new Set<string>();\n    assets.forEach(a => {\n      if (a.assetIn) uniqueAssetSet.add(a.assetIn);\n      if (a.assetOut) uniqueAssetSet.add(a.assetOut);\n    });\n\n    return {\n      transactionCount,\n      lastTransaction: lastTx?.blockTimestamp || null,\n      uniqueAssets: uniqueAssetSet.size,\n    };\n  }\n}\n"],"names":["WalletsService","findAll","companyId","prisma","wallet","findMany","where","orderBy","isActive","createdAt","findById","id","findFirst","NotFoundException","findByAddress","chain","address","toLowerCase","create","dto","normalizedAddress","normalizedChain","existing","ConflictException","data","label","type","accountCode","syncStatus","update","undefined","delete","txCount","cryptoTransaction","count","walletId","getWalletWithBalances","covalent","isConfigured","logger","warn","balances","getBalances","totalValueEur","reduce","sum","b","quote","error","setSyncStatus","status","lastBlock","syncError","lastSyncAt","Date","lastSyncBlock","getWalletsForSync","not","countTransactions","getWalletStats","transactionCount","lastTx","assets","Promise","all","blockTimestamp","select","groupBy","by","uniqueAssetSet","Set","forEach","a","assetIn","add","assetOut","lastTransaction","uniqueAssets","size","Logger","name"],"mappings":"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"}