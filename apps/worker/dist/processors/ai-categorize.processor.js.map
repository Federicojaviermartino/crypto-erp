{"version":3,"sources":["../../src/processors/ai-categorize.processor.ts"],"sourcesContent":["import { Processor, WorkerHost } from '@nestjs/bullmq';\nimport { Logger } from '@nestjs/common';\nimport { Job } from 'bullmq';\nimport { PrismaService } from '@crypto-erp/database';\nimport { ConfigService } from '@nestjs/config';\nimport Anthropic from '@anthropic-ai/sdk';\nimport OpenAI from 'openai';\nimport { Prisma } from '@prisma/client';\n\nconst QUEUE_NAME = 'ai-categorize';\n\ninterface CategorizeJobData {\n  transactionIds: string[];\n  companyId: string;\n}\n\ninterface CategorizationResult {\n  type: string;\n  subtype?: string;\n  confidence: number;\n  reasoning: string;\n}\n\ninterface JobResult {\n  success: boolean;\n  processedCount: number;\n  successCount: number;\n  failedIds: string[];\n  error?: string;\n}\n\n@Processor(QUEUE_NAME, {\n  concurrency: 3, // Process 3 jobs in parallel\n})\nexport class AiCategorizeProcessor extends WorkerHost {\n  private readonly logger = new Logger(AiCategorizeProcessor.name);\n  private anthropic?: Anthropic;\n  private openai?: OpenAI;\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly config: ConfigService,\n  ) {\n    super();\n\n    const anthropicKey = this.config.get<string>('ANTHROPIC_API_KEY');\n    const openaiKey = this.config.get<string>('OPENAI_API_KEY');\n\n    if (anthropicKey) {\n      this.anthropic = new Anthropic({ apiKey: anthropicKey });\n    }\n\n    if (openaiKey) {\n      this.openai = new OpenAI({ apiKey: openaiKey });\n    }\n  }\n\n  async process(job: Job<CategorizeJobData>): Promise<JobResult> {\n    const { transactionIds, companyId } = job.data;\n\n    this.logger.log(\n      `Starting AI categorization for ${transactionIds.length} transactions (company: ${companyId})`\n    );\n\n    if (!this.anthropic && !this.openai) {\n      this.logger.error('No AI provider configured');\n      return {\n        success: false,\n        processedCount: 0,\n        successCount: 0,\n        failedIds: transactionIds,\n        error: 'No AI provider configured (ANTHROPIC_API_KEY or OPENAI_API_KEY required)',\n      };\n    }\n\n    let successCount = 0;\n    const failedIds: string[] = [];\n\n    // Update job progress\n    await job.updateProgress(0);\n\n    for (let i = 0; i < transactionIds.length; i++) {\n      const txId = transactionIds[i];\n\n      try {\n        // Fetch transaction\n        const tx = await this.prisma.cryptoTransaction.findUnique({\n          where: { id: txId },\n          include: {\n            wallet: {\n              select: { chain: true, address: true },\n            },\n          },\n        });\n\n        if (!tx) {\n          this.logger.warn(`Transaction ${txId} not found`);\n          failedIds.push(txId);\n          continue;\n        }\n\n        // Skip if already manually categorized\n        if (tx.manualType) {\n          this.logger.debug(`Transaction ${txId} already manually categorized - skipping`);\n          successCount++;\n          continue;\n        }\n\n        // Categorize with AI\n        const categorization = await this.categorizeTransaction(tx);\n\n        // Update transaction\n        await this.prisma.cryptoTransaction.update({\n          where: { id: txId },\n          data: {\n            aiCategorized: true,\n            type: categorization.type as any,\n            subtype: categorization.subtype,\n            aiConfidence: new Prisma.Decimal(categorization.confidence),\n            aiReasoning: categorization.reasoning,\n            status: categorization.confidence >= 0.8 ? 'COMPLETED' : 'NEEDS_REVIEW',\n          },\n        });\n\n        successCount++;\n        this.logger.debug(\n          `Categorized ${txId} as ${categorization.type} (confidence: ${categorization.confidence})`\n        );\n      } catch (error) {\n        this.logger.error(`Failed to categorize transaction ${txId}:`, error);\n        failedIds.push(txId);\n      }\n\n      // Update progress\n      const progress = Math.round(((i + 1) / transactionIds.length) * 100);\n      await job.updateProgress(progress);\n    }\n\n    const result: JobResult = {\n      success: failedIds.length === 0,\n      processedCount: transactionIds.length,\n      successCount,\n      failedIds,\n    };\n\n    this.logger.log(\n      `AI categorization completed: ${successCount}/${transactionIds.length} successful`\n    );\n\n    return result;\n  }\n\n  private async categorizeTransaction(tx: any): Promise<CategorizationResult> {\n    const context = this.buildContext(tx);\n\n    // Try Anthropic first (Claude Haiku - fast and cheap)\n    if (this.anthropic) {\n      try {\n        return await this.categorizeWithAnthropic(context);\n      } catch (error) {\n        this.logger.warn('Anthropic categorization failed, trying OpenAI', error);\n      }\n    }\n\n    // Fallback to OpenAI (GPT-4o-mini)\n    if (this.openai) {\n      try {\n        return await this.categorizeWithOpenAI(context);\n      } catch (error) {\n        this.logger.error('OpenAI categorization failed', error);\n        throw error;\n      }\n    }\n\n    throw new Error('No AI provider available');\n  }\n\n  private buildContext(tx: any): string {\n    return `Analyze this crypto transaction and categorize it:\n\nChain: ${tx.wallet.chain}\nTransaction Hash: ${tx.txHash}\nType (auto-detected): ${tx.type}\nSubtype: ${tx.subtype || 'N/A'}\n\nAsset In: ${tx.assetIn || 'N/A'}\nAmount In: ${tx.amountIn || 'N/A'}\nPrice In EUR: ${tx.priceInEur || 'N/A'}\n\nAsset Out: ${tx.assetOut || 'N/A'}\nAmount Out: ${tx.amountOut || 'N/A'}\nPrice Out EUR: ${tx.priceOutEur || 'N/A'}\n\nFee Asset: ${tx.feeAsset || 'N/A'}\nFee Amount: ${tx.feeAmount || 'N/A'}\n\nBlock Timestamp: ${tx.blockTimestamp}\n\nValid types:\n- TRANSFER_IN: Receiving crypto (deposit, transfer received)\n- TRANSFER_OUT: Sending crypto (withdrawal, transfer sent)\n- SWAP: Exchange one crypto for another (DEX/CEX trade)\n- CLAIM_REWARD: Claiming staking/farming rewards\n- STAKE: Locking crypto for staking\n- UNSTAKE: Unlocking staked crypto\n- AIRDROP: Free token distribution\n\nReturn ONLY valid JSON in this format (no markdown, no code blocks):\n{\n  \"type\": \"one of the valid types above\",\n  \"subtype\": \"optional detailed classification like 'UNISWAP_SWAP', 'LIDO_STAKE', etc\",\n  \"confidence\": 0.0 to 1.0,\n  \"reasoning\": \"brief explanation of why you chose this classification\"\n}`;\n  }\n\n  private async categorizeWithAnthropic(context: string): Promise<CategorizationResult> {\n    const response = await this.anthropic!.messages.create({\n      model: 'claude-3-haiku-20240307',\n      max_tokens: 500,\n      messages: [\n        {\n          role: 'user',\n          content: context,\n        },\n      ],\n    });\n\n    const content = response.content[0];\n    if (content.type !== 'text') {\n      throw new Error('Unexpected response type from Anthropic');\n    }\n\n    return this.parseCategorizationResponse(content.text);\n  }\n\n  private async categorizeWithOpenAI(context: string): Promise<CategorizationResult> {\n    const response = await this.openai!.chat.completions.create({\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'user',\n          content: context,\n        },\n      ],\n      max_tokens: 500,\n      temperature: 0.1,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('Empty response from OpenAI');\n    }\n\n    return this.parseCategorizationResponse(content);\n  }\n\n  private parseCategorizationResponse(response: string): CategorizationResult {\n    try {\n      // Remove markdown code blocks if present\n      let cleaned = response.trim();\n      if (cleaned.startsWith('```json')) {\n        cleaned = cleaned.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n      } else if (cleaned.startsWith('```')) {\n        cleaned = cleaned.replace(/```\\n?/g, '');\n      }\n\n      const result = JSON.parse(cleaned);\n\n      // Validate required fields\n      if (!result.type || typeof result.confidence !== 'number') {\n        throw new Error('Invalid categorization response format');\n      }\n\n      // Clamp confidence to [0, 1]\n      result.confidence = Math.max(0, Math.min(1, result.confidence));\n\n      return result;\n    } catch (error) {\n      this.logger.error('Failed to parse AI response:', response, error);\n      throw new Error('Invalid AI response format');\n    }\n  }\n}\n"],"names":["AiCategorizeProcessor","QUEUE_NAME","WorkerHost","process","job","transactionIds","companyId","data","logger","log","length","anthropic","openai","error","success","processedCount","successCount","failedIds","updateProgress","i","txId","tx","prisma","cryptoTransaction","findUnique","where","id","include","wallet","select","chain","address","warn","push","manualType","debug","categorization","categorizeTransaction","update","aiCategorized","type","subtype","aiConfidence","Prisma","Decimal","confidence","aiReasoning","reasoning","status","progress","Math","round","result","context","buildContext","categorizeWithAnthropic","categorizeWithOpenAI","Error","txHash","assetIn","amountIn","priceInEur","assetOut","amountOut","priceOutEur","feeAsset","feeAmount","blockTimestamp","response","messages","create","model","max_tokens","role","content","parseCategorizationResponse","text","chat","completions","temperature","choices","message","cleaned","trim","startsWith","replace","JSON","parse","max","min","config","Logger","name","anthropicKey","get","openaiKey","Anthropic","apiKey","OpenAI","concurrency"],"mappings":"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"}