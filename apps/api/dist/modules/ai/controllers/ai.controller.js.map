{"version":3,"sources":["../../../../src/modules/ai/controllers/ai.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Body,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n  UseInterceptors,\n  UploadedFile,\n  BadRequestException,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiConsumes,\n  ApiBody,\n} from '@nestjs/swagger';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { JwtAuthGuard } from '../../../common/guards/index.js';\nimport { AiService } from '../services/ai.service.js';\nimport { OcrService } from '../services/ocr.service.js';\nimport {\n  ChatRequestDto,\n  AnalyzeTransactionDto,\n  GenerateReportDto,\n  ExplainCryptoTaxDto,\n  OcrResponseDto,\n  OcrStatusResponseDto,\n} from '../dto/index.js';\n\n@ApiTags('AI Assistant')\n@ApiBearerAuth()\n@UseGuards(JwtAuthGuard)\n@Controller('ai')\nexport class AiController {\n  constructor(\n    private readonly aiService: AiService,\n    private readonly ocrService: OcrService,\n  ) {}\n\n  @Post('chat')\n  @ApiOperation({ summary: 'Chat with AI assistant' })\n  @ApiResponse({ status: 200, description: 'AI response' })\n  @HttpCode(HttpStatus.OK)\n  async chat(@Body() dto: ChatRequestDto): Promise<{ response: string }> {\n    const response = await this.aiService.chat(dto.messages, dto.context);\n    return { response };\n  }\n\n  @Post('analyze-transaction')\n  @ApiOperation({ summary: 'Analyze a transaction and suggest accounts' })\n  @ApiResponse({ status: 200, description: 'Analysis result' })\n  @HttpCode(HttpStatus.OK)\n  async analyzeTransaction(@Body() dto: AnalyzeTransactionDto) {\n    return this.aiService.analyzeTransaction(dto.description);\n  }\n\n  @Post('generate-report')\n  @ApiOperation({ summary: 'Generate an AI-powered report' })\n  @ApiResponse({ status: 200, description: 'Generated report' })\n  @HttpCode(HttpStatus.OK)\n  async generateReport(@Body() dto: GenerateReportDto): Promise<{ report: string }> {\n    const report = await this.aiService.generateReport(dto.reportType, dto.data);\n    return { report };\n  }\n\n  @Post('explain-crypto-tax')\n  @ApiOperation({ summary: 'Explain crypto tax implications' })\n  @ApiResponse({ status: 200, description: 'Tax explanation' })\n  @HttpCode(HttpStatus.OK)\n  async explainCryptoTax(@Body() dto: ExplainCryptoTaxDto): Promise<{ explanation: string }> {\n    const explanation = await this.aiService.explainCryptoTax(dto.transactions);\n    return { explanation };\n  }\n\n  // ============================================================================\n  // OCR Endpoints\n  // ============================================================================\n\n  @Post('ocr/extract-invoice')\n  @ApiOperation({\n    summary: 'Extract invoice data from image/PDF using OCR',\n    description:\n      'Upload an invoice image (JPEG, PNG) or PDF to extract structured data using OCR and AI.',\n  })\n  @ApiConsumes('multipart/form-data')\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        file: {\n          type: 'string',\n          format: 'binary',\n          description: 'Invoice image (JPEG, PNG) or PDF file',\n        },\n      },\n      required: ['file'],\n    },\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'Extracted invoice data',\n    type: OcrResponseDto,\n  })\n  @ApiResponse({ status: 400, description: 'Invalid file type or no file provided' })\n  @UseInterceptors(\n    FileInterceptor('file', {\n      limits: {\n        fileSize: 10 * 1024 * 1024, // 10MB max\n      },\n      fileFilter: (req, file, callback) => {\n        const allowedMimes = [\n          'image/jpeg',\n          'image/png',\n          'image/webp',\n          'application/pdf',\n        ];\n        if (allowedMimes.includes(file.mimetype)) {\n          callback(null, true);\n        } else {\n          callback(\n            new BadRequestException(\n              `Invalid file type. Allowed: ${allowedMimes.join(', ')}`,\n            ),\n            false,\n          );\n        }\n      },\n    }),\n  )\n  @HttpCode(HttpStatus.OK)\n  async extractInvoice(\n    @UploadedFile() file: Express.Multer.File,\n  ): Promise<OcrResponseDto> {\n    if (!file) {\n      throw new BadRequestException('No file provided');\n    }\n\n    const result = await this.ocrService.extractInvoiceData(\n      file.buffer,\n      file.mimetype,\n    );\n\n    return {\n      success: result.success,\n      data: result.data\n        ? {\n            ...result.data,\n            // Remove rawText from response to reduce payload size\n            // rawText is kept internally for debugging\n          }\n        : null,\n      error: result.error,\n    };\n  }\n\n  @Get('ocr/status')\n  @ApiOperation({\n    summary: 'Get OCR service status',\n    description: 'Check which OCR providers are available and enabled.',\n  })\n  @ApiResponse({\n    status: 200,\n    description: 'OCR service status',\n    type: OcrStatusResponseDto,\n  })\n  getOcrStatus(): OcrStatusResponseDto {\n    return this.ocrService.getStatus();\n  }\n}\n"],"names":["AiController","chat","dto","response","aiService","messages","context","analyzeTransaction","description","generateReport","report","reportType","data","explainCryptoTax","explanation","transactions","extractInvoice","file","BadRequestException","result","ocrService","extractInvoiceData","buffer","mimetype","success","error","getOcrStatus","getStatus","summary","status","OK","schema","type","properties","format","required","OcrResponseDto","limits","fileSize","fileFilter","req","callback","allowedMimes","includes","join","OcrStatusResponseDto"],"mappings":";;;;+BAqCaA;;;eAAAA;;;wBA1BN;yBAQA;iCACyB;uBACH;2BACH;4BACC;wBAQpB;;;;;;;;;;;;;;;AAMA,IAAA,AAAMA,eAAN,MAAMA;IAMX,MAIMC,KAAK,AAAQC,GAAmB,EAAiC;QACrE,MAAMC,WAAW,MAAM,IAAI,CAACC,SAAS,CAACH,IAAI,CAACC,IAAIG,QAAQ,EAAEH,IAAII,OAAO;QACpE,OAAO;YAAEH;QAAS;IACpB;IAEA,MAIMI,mBAAmB,AAAQL,GAA0B,EAAE;QAC3D,OAAO,IAAI,CAACE,SAAS,CAACG,kBAAkB,CAACL,IAAIM,WAAW;IAC1D;IAEA,MAIMC,eAAe,AAAQP,GAAsB,EAA+B;QAChF,MAAMQ,SAAS,MAAM,IAAI,CAACN,SAAS,CAACK,cAAc,CAACP,IAAIS,UAAU,EAAET,IAAIU,IAAI;QAC3E,OAAO;YAAEF;QAAO;IAClB;IAEA,MAIMG,iBAAiB,AAAQX,GAAwB,EAAoC;QACzF,MAAMY,cAAc,MAAM,IAAI,CAACV,SAAS,CAACS,gBAAgB,CAACX,IAAIa,YAAY;QAC1E,OAAO;YAAED;QAAY;IACvB;IAEA,+EAA+E;IAC/E,gBAAgB;IAChB,+EAA+E;IAE/E,MAoDME,eACJ,AAAgBC,IAAyB,EAChB;QACzB,IAAI,CAACA,MAAM;YACT,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QAEA,MAAMC,SAAS,MAAM,IAAI,CAACC,UAAU,CAACC,kBAAkB,CACrDJ,KAAKK,MAAM,EACXL,KAAKM,QAAQ;QAGf,OAAO;YACLC,SAASL,OAAOK,OAAO;YACvBZ,MAAMO,OAAOP,IAAI,GACb;gBACE,GAAGO,OAAOP,IAAI;YAGhB,IACA;YACJa,OAAON,OAAOM,KAAK;QACrB;IACF;IAYAC,eAAqC;QACnC,OAAO,IAAI,CAACN,UAAU,CAACO,SAAS;IAClC;IArIA,YACE,AAAiBvB,SAAoB,EACrC,AAAiBgB,UAAsB,CACvC;aAFiBhB,YAAAA;aACAgB,aAAAA;IAChB;AAmIL;;;;QAhIkBQ,SAAS;;;QACVC,QAAQ;QAAKrB,aAAa;;6CACpBsB;;;;;;;;;;;QAOLF,SAAS;;;QACVC,QAAQ;QAAKrB,aAAa;;6CACpBsB;;;;;;;;;;;QAMLF,SAAS;;;QACVC,QAAQ;QAAKrB,aAAa;;6CACpBsB;;;;;;;;;;;QAOLF,SAAS;;;QACVC,QAAQ;QAAKrB,aAAa;;6CACpBsB;;;;;;;;;;;QAYnBF,SAAS;QACTpB,aACE;;;;QAIFuB,QAAQ;YACNC,MAAM;YACNC,YAAY;gBACVhB,MAAM;oBACJe,MAAM;oBACNE,QAAQ;oBACR1B,aAAa;gBACf;YACF;YACA2B,UAAU;gBAAC;aAAO;QACpB;;;QAGAN,QAAQ;QACRrB,aAAa;QACbwB,MAAMI,sBAAc;;;QAEPP,QAAQ;QAAKrB,aAAa;;;QAGrC6B,QAAQ;YACNC,UAAU,KAAK,OAAO;QACxB;QACAC,YAAY,CAACC,KAAKvB,MAAMwB;YACtB,MAAMC,eAAe;gBACnB;gBACA;gBACA;gBACA;aACD;YACD,IAAIA,aAAaC,QAAQ,CAAC1B,KAAKM,QAAQ,GAAG;gBACxCkB,SAAS,MAAM;YACjB,OAAO;gBACLA,SACE,IAAIvB,2BAAmB,CACrB,CAAC,4BAA4B,EAAEwB,aAAaE,IAAI,CAAC,OAAO,GAE1D;YAEJ;QACF;;6CAGiBd;;;;yDAEW,yCAAA,OAAO,wCAAP,OAAO;;;;;;;QA0BrCF,SAAS;QACTpB,aAAa;;;QAGbqB,QAAQ;QACRrB,aAAa;QACbwB,MAAMa,4BAAoB"}