{"version":3,"sources":["../../../src/modules/fiscal/libro-registro.service.ts"],"sourcesContent":["import { Injectable, Logger, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { Invoice, InvoiceDirection } from '@prisma/client';\nimport * as ExcelJS from 'exceljs';\nimport { createWriteStream } from 'fs';\nimport { Decimal } from '@prisma/client/runtime/library';\n\ninterface LibroRegistroEntry {\n  fecha: Date;\n  numeroFactura: string;\n  serie: string;\n  nifContraparte: string;\n  nombreContraparte: string;\n  baseImponible: Decimal;\n  tipoImpositivo: number;\n  cuotaIVA: Decimal;\n  total: Decimal;\n  retencionIRPF?: Decimal;\n  observaciones?: string;\n  verifactuId?: string;\n}\n\ninterface LibroRegistroData {\n  empresa: {\n    nombre: string;\n    nif: string;\n  };\n  periodo: {\n    fechaInicio: Date;\n    fechaFin: Date;\n  };\n  facturasEmitidas: LibroRegistroEntry[];\n  facturasRecibidas: LibroRegistroEntry[];\n  totales: {\n    emitidas: {\n      baseImponible: Decimal;\n      cuotaIVA: Decimal;\n      total: Decimal;\n    };\n    recibidas: {\n      baseImponible: Decimal;\n      cuotaIVA: Decimal;\n      total: Decimal;\n    };\n  };\n}\n\n@Injectable()\nexport class LibroRegistroService {\n  private readonly logger = new Logger(LibroRegistroService.name);\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Generate Libro Registro data for a company and period\n   */\n  async generateLibroRegistro(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n  ): Promise<LibroRegistroData> {\n    this.logger.log(\n      `Generating Libro Registro for company ${companyId} from ${startDate.toISOString()} to ${endDate.toISOString()}`,\n    );\n\n    // Get company\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    if (!company) {\n      throw new NotFoundException(`Company ${companyId} not found`);\n    }\n\n    // Get issued invoices (facturas emitidas)\n    const issuedInvoices = await this.prisma.invoice.findMany({\n      where: {\n        companyId,\n        direction: InvoiceDirection.SALE,\n        issueDate: {\n          gte: startDate,\n          lte: endDate,\n        },\n        status: {\n          in: ['SENT', 'PAID', 'OVERDUE'],\n        },\n      },\n      include: {\n        contact: true,\n        items: true,\n      },\n      orderBy: [{ issueDate: 'asc' }, { number: 'asc' }],\n    });\n\n    // Get received invoices (facturas recibidas)\n    const receivedInvoices = await this.prisma.invoice.findMany({\n      where: {\n        companyId,\n        direction: InvoiceDirection.PURCHASE,\n        issueDate: {\n          gte: startDate,\n          lte: endDate,\n        },\n        status: {\n          in: ['SENT', 'PAID', 'OVERDUE'],\n        },\n      },\n      include: {\n        contact: true,\n        items: true,\n      },\n      orderBy: [{ issueDate: 'asc' }, { number: 'asc' }],\n    });\n\n    // Transform invoices to libro registro entries\n    const facturasEmitidas = issuedInvoices.map((invoice) =>\n      this.invoiceToLibroEntry(invoice),\n    );\n    const facturasRecibidas = receivedInvoices.map((invoice) =>\n      this.invoiceToLibroEntry(invoice),\n    );\n\n    // Calculate totals\n    const totales = this.calculateTotales(facturasEmitidas, facturasRecibidas);\n\n    return {\n      empresa: {\n        nombre: company.name,\n        nif: company.taxId,\n      },\n      periodo: {\n        fechaInicio: startDate,\n        fechaFin: endDate,\n      },\n      facturasEmitidas,\n      facturasRecibidas,\n      totales,\n    };\n  }\n\n  /**\n   * Transform Invoice to LibroRegistroEntry\n   */\n  private invoiceToLibroEntry(invoice: Invoice & { items: any[]; contact?: any }): LibroRegistroEntry {\n    // Calculate totals\n    let baseImponible = new Decimal(0);\n    let cuotaIVA = new Decimal(0);\n\n    invoice.items.forEach((item) => {\n      const itemBase = new Decimal(item.quantity).times(item.unitPrice);\n      const itemTax = itemBase.times(item.taxRate).dividedBy(100);\n\n      baseImponible = baseImponible.plus(itemBase);\n      cuotaIVA = cuotaIVA.plus(itemTax);\n    });\n\n    const total = baseImponible.plus(cuotaIVA);\n\n    // Extract tax rate (assume first item's tax rate for simplicity)\n    const tipoImpositivo = invoice.items.length > 0 ? invoice.items[0].taxRate : 21;\n\n    return {\n      fecha: invoice.issueDate,\n      numeroFactura: invoice.number,\n      serie: invoice.series || 'A',\n      nifContraparte: invoice.counterpartyTaxId || 'N/A',\n      nombreContraparte: invoice.counterpartyName || invoice.contact?.name || 'N/A',\n      baseImponible,\n      tipoImpositivo,\n      cuotaIVA,\n      total,\n      retencionIRPF: invoice.withholdingAmount ? new Decimal(invoice.withholdingAmount) : undefined,\n      observaciones: invoice.notes || undefined,\n      verifactuId: invoice.verifactuId || undefined,\n    };\n  }\n\n  /**\n   * Calculate totals\n   */\n  private calculateTotales(\n    facturasEmitidas: LibroRegistroEntry[],\n    facturasRecibidas: LibroRegistroEntry[],\n  ) {\n    const sumEntries = (entries: LibroRegistroEntry[]) => {\n      return entries.reduce(\n        (acc, entry) => ({\n          baseImponible: acc.baseImponible.plus(entry.baseImponible),\n          cuotaIVA: acc.cuotaIVA.plus(entry.cuotaIVA),\n          total: acc.total.plus(entry.total),\n        }),\n        {\n          baseImponible: new Decimal(0),\n          cuotaIVA: new Decimal(0),\n          total: new Decimal(0),\n        },\n      );\n    };\n\n    return {\n      emitidas: sumEntries(facturasEmitidas),\n      recibidas: sumEntries(facturasRecibidas),\n    };\n  }\n\n  /**\n   * Export to CSV\n   */\n  async exportToCSV(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n    type: 'emitidas' | 'recibidas' = 'emitidas',\n  ): Promise<string> {\n    const data = await this.generateLibroRegistro(companyId, startDate, endDate);\n\n    const entries = type === 'emitidas' ? data.facturasEmitidas : data.facturasRecibidas;\n\n    // Generate CSV header\n    const headers = [\n      'Fecha',\n      'Serie',\n      'Número',\n      'NIF Contraparte',\n      'Nombre Contraparte',\n      'Base Imponible',\n      'Tipo IVA (%)',\n      'Cuota IVA',\n      'Total',\n      'Retención IRPF',\n      'Verifactu ID',\n      'Observaciones',\n    ];\n\n    // Generate CSV rows\n    const rows = entries.map((entry) => [\n      entry.fecha.toISOString().split('T')[0],\n      entry.serie,\n      entry.numeroFactura,\n      entry.nifContraparte,\n      entry.nombreContraparte,\n      entry.baseImponible.toFixed(2),\n      entry.tipoImpositivo.toFixed(2),\n      entry.cuotaIVA.toFixed(2),\n      entry.total.toFixed(2),\n      entry.retencionIRPF?.toFixed(2) || '0.00',\n      entry.verifactuId || '',\n      entry.observaciones || '',\n    ]);\n\n    // Combine headers and rows\n    const csvLines = [headers, ...rows].map((row) => row.map((cell) => `\"${cell}\"`).join(',')).join('\\n');\n\n    return csvLines;\n  }\n\n  /**\n   * Export to Excel\n   */\n  async exportToExcel(\n    companyId: string,\n    startDate: Date,\n    endDate: Date,\n    filePath: string,\n  ): Promise<void> {\n    const data = await this.generateLibroRegistro(companyId, startDate, endDate);\n\n    const workbook = new ExcelJS.Workbook();\n\n    // Add company info\n    workbook.creator = data.empresa.nombre;\n    workbook.created = new Date();\n\n    // Sheet 1: Facturas Emitidas\n    const sheetEmitidas = workbook.addWorksheet('Facturas Emitidas');\n    this.addSheetData(sheetEmitidas, data.facturasEmitidas, 'Facturas Emitidas', data);\n\n    // Sheet 2: Facturas Recibidas\n    const sheetRecibidas = workbook.addWorksheet('Facturas Recibidas');\n    this.addSheetData(sheetRecibidas, data.facturasRecibidas, 'Facturas Recibidas', data);\n\n    // Sheet 3: Resumen\n    const sheetResumen = workbook.addWorksheet('Resumen');\n    this.addResumenSheet(sheetResumen, data);\n\n    // Save to file\n    await workbook.xlsx.writeFile(filePath);\n\n    this.logger.log(`Excel exported to ${filePath}`);\n  }\n\n  /**\n   * Add data to Excel sheet\n   */\n  private addSheetData(\n    sheet: ExcelJS.Worksheet,\n    entries: LibroRegistroEntry[],\n    title: string,\n    data: LibroRegistroData,\n  ): void {\n    // Title row\n    sheet.mergeCells('A1:L1');\n    const titleCell = sheet.getCell('A1');\n    titleCell.value = `${title} - ${data.empresa.nombre} (${data.empresa.nif})`;\n    titleCell.font = { bold: true, size: 14 };\n    titleCell.alignment = { horizontal: 'center' };\n\n    // Period row\n    sheet.mergeCells('A2:L2');\n    const periodCell = sheet.getCell('A2');\n    periodCell.value = `Período: ${data.periodo.fechaInicio.toLocaleDateString('es-ES')} - ${data.periodo.fechaFin.toLocaleDateString('es-ES')}`;\n    periodCell.alignment = { horizontal: 'center' };\n\n    // Empty row\n    sheet.addRow([]);\n\n    // Headers\n    const headerRow = sheet.addRow([\n      'Fecha',\n      'Serie',\n      'Número',\n      'NIF Contraparte',\n      'Nombre Contraparte',\n      'Base Imponible',\n      'Tipo IVA (%)',\n      'Cuota IVA',\n      'Total',\n      'Retención IRPF',\n      'Verifactu ID',\n      'Observaciones',\n    ]);\n\n    headerRow.font = { bold: true };\n    headerRow.fill = {\n      type: 'pattern',\n      pattern: 'solid',\n      fgColor: { argb: 'FFD3D3D3' },\n    };\n\n    // Data rows\n    entries.forEach((entry) => {\n      sheet.addRow([\n        entry.fecha.toLocaleDateString('es-ES'),\n        entry.serie,\n        entry.numeroFactura,\n        entry.nifContraparte,\n        entry.nombreContraparte,\n        parseFloat(entry.baseImponible.toFixed(2)),\n        entry.tipoImpositivo,\n        parseFloat(entry.cuotaIVA.toFixed(2)),\n        parseFloat(entry.total.toFixed(2)),\n        entry.retencionIRPF ? parseFloat(entry.retencionIRPF.toFixed(2)) : 0,\n        entry.verifactuId || '',\n        entry.observaciones || '',\n      ]);\n    });\n\n    // Column widths\n    sheet.getColumn(1).width = 12; // Fecha\n    sheet.getColumn(2).width = 8;  // Serie\n    sheet.getColumn(3).width = 15; // Número\n    sheet.getColumn(4).width = 12; // NIF\n    sheet.getColumn(5).width = 30; // Nombre\n    sheet.getColumn(6).width = 15; // Base\n    sheet.getColumn(7).width = 12; // Tipo IVA\n    sheet.getColumn(8).width = 12; // Cuota IVA\n    sheet.getColumn(9).width = 12; // Total\n    sheet.getColumn(10).width = 15; // IRPF\n    sheet.getColumn(11).width = 20; // Verifactu ID\n    sheet.getColumn(12).width = 30; // Observaciones\n\n    // Number formatting\n    for (let i = 5; i <= sheet.rowCount; i++) {\n      sheet.getCell(`F${i}`).numFmt = '#,##0.00 €'; // Base Imponible\n      sheet.getCell(`G${i}`).numFmt = '0.00 \"%\"';   // Tipo IVA\n      sheet.getCell(`H${i}`).numFmt = '#,##0.00 €'; // Cuota IVA\n      sheet.getCell(`I${i}`).numFmt = '#,##0.00 €'; // Total\n      sheet.getCell(`J${i}`).numFmt = '#,##0.00 €'; // IRPF\n    }\n  }\n\n  /**\n   * Add summary sheet\n   */\n  private addResumenSheet(sheet: ExcelJS.Worksheet, data: LibroRegistroData): void {\n    // Title\n    sheet.mergeCells('A1:D1');\n    const titleCell = sheet.getCell('A1');\n    titleCell.value = `Resumen - ${data.empresa.nombre}`;\n    titleCell.font = { bold: true, size: 14 };\n    titleCell.alignment = { horizontal: 'center' };\n\n    // Empty row\n    sheet.addRow([]);\n\n    // Facturas Emitidas Summary\n    sheet.addRow(['FACTURAS EMITIDAS', '', '', '']).font = { bold: true };\n    sheet.addRow([\n      'Base Imponible:',\n      parseFloat(data.totales.emitidas.baseImponible.toFixed(2)),\n      '€',\n      '',\n    ]);\n    sheet.addRow([\n      'Cuota IVA:',\n      parseFloat(data.totales.emitidas.cuotaIVA.toFixed(2)),\n      '€',\n      '',\n    ]);\n    sheet.addRow([\n      'TOTAL:',\n      parseFloat(data.totales.emitidas.total.toFixed(2)),\n      '€',\n      '',\n    ]).font = { bold: true };\n\n    // Empty row\n    sheet.addRow([]);\n\n    // Facturas Recibidas Summary\n    sheet.addRow(['FACTURAS RECIBIDAS', '', '', '']).font = { bold: true };\n    sheet.addRow([\n      'Base Imponible:',\n      parseFloat(data.totales.recibidas.baseImponible.toFixed(2)),\n      '€',\n      '',\n    ]);\n    sheet.addRow([\n      'Cuota IVA:',\n      parseFloat(data.totales.recibidas.cuotaIVA.toFixed(2)),\n      '€',\n      '',\n    ]);\n    sheet.addRow([\n      'TOTAL:',\n      parseFloat(data.totales.recibidas.total.toFixed(2)),\n      '€',\n      '',\n    ]).font = { bold: true };\n\n    // Empty row\n    sheet.addRow([]);\n\n    // Balance\n    const balanceBase = data.totales.emitidas.baseImponible.minus(\n      data.totales.recibidas.baseImponible,\n    );\n    const balanceIVA = data.totales.emitidas.cuotaIVA.minus(data.totales.recibidas.cuotaIVA);\n    const balanceTotal = data.totales.emitidas.total.minus(data.totales.recibidas.total);\n\n    sheet.addRow(['BALANCE (Emitidas - Recibidas)', '', '', '']).font = {\n      bold: true,\n      color: { argb: 'FF0000FF' },\n    };\n    sheet.addRow([\n      'Base Imponible:',\n      parseFloat(balanceBase.toFixed(2)),\n      '€',\n      balanceBase.isNegative() ? '(A favor AEAT)' : '(A favor empresa)',\n    ]);\n    sheet.addRow([\n      'Cuota IVA:',\n      parseFloat(balanceIVA.toFixed(2)),\n      '€',\n      balanceIVA.isNegative() ? '(A devolver)' : '(A ingresar)',\n    ]);\n    sheet.addRow([\n      'TOTAL:',\n      parseFloat(balanceTotal.toFixed(2)),\n      '€',\n      '',\n    ]).font = { bold: true };\n\n    // Column widths\n    sheet.getColumn(1).width = 20;\n    sheet.getColumn(2).width = 15;\n    sheet.getColumn(3).width = 5;\n    sheet.getColumn(4).width = 20;\n\n    // Number formatting\n    for (let i = 4; i <= 13; i++) {\n      if (sheet.getRow(i).getCell(2).value !== '') {\n        sheet.getRow(i).getCell(2).numFmt = '#,##0.00';\n      }\n    }\n  }\n}\n"],"names":["LibroRegistroService","generateLibroRegistro","companyId","startDate","endDate","logger","log","toISOString","company","prisma","findUnique","where","id","NotFoundException","issuedInvoices","invoice","findMany","direction","InvoiceDirection","SALE","issueDate","gte","lte","status","in","include","contact","items","orderBy","number","receivedInvoices","PURCHASE","facturasEmitidas","map","invoiceToLibroEntry","facturasRecibidas","totales","calculateTotales","empresa","nombre","name","nif","taxId","periodo","fechaInicio","fechaFin","baseImponible","Decimal","cuotaIVA","forEach","item","itemBase","quantity","times","unitPrice","itemTax","taxRate","dividedBy","plus","total","tipoImpositivo","length","fecha","numeroFactura","serie","series","nifContraparte","counterpartyTaxId","nombreContraparte","counterpartyName","retencionIRPF","withholdingAmount","undefined","observaciones","notes","verifactuId","sumEntries","entries","reduce","acc","entry","emitidas","recibidas","exportToCSV","type","data","headers","rows","split","toFixed","csvLines","row","cell","join","exportToExcel","filePath","workbook","ExcelJS","Workbook","creator","created","Date","sheetEmitidas","addWorksheet","addSheetData","sheetRecibidas","sheetResumen","addResumenSheet","xlsx","writeFile","sheet","title","mergeCells","titleCell","getCell","value","font","bold","size","alignment","horizontal","periodCell","toLocaleDateString","addRow","headerRow","fill","pattern","fgColor","argb","parseFloat","getColumn","width","i","rowCount","numFmt","balanceBase","minus","balanceIVA","balanceTotal","color","isNegative","getRow","Logger"],"mappings":"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"}