{"version":3,"sources":["../../../../src/modules/accounting/services/fiscal-years.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  ConflictException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateFiscalYearDto } from '../dto/index.js';\nimport { FiscalYear, Prisma } from '@prisma/client';\n\n@Injectable()\nexport class FiscalYearsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAll(companyId: string): Promise<FiscalYear[]> {\n    return this.prisma.fiscalYear.findMany({\n      where: { companyId },\n      orderBy: { startDate: 'desc' },\n    });\n  }\n\n  async findById(companyId: string, id: string): Promise<FiscalYear> {\n    const fiscalYear = await this.prisma.fiscalYear.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!fiscalYear) {\n      throw new NotFoundException(`Fiscal year with ID ${id} not found`);\n    }\n\n    return fiscalYear;\n  }\n\n  async findCurrent(companyId: string): Promise<FiscalYear | null> {\n    const today = new Date();\n\n    return this.prisma.fiscalYear.findFirst({\n      where: {\n        companyId,\n        startDate: { lte: today },\n        endDate: { gte: today },\n        isClosed: false,\n      },\n    });\n  }\n\n  async findByDate(companyId: string, date: Date): Promise<FiscalYear | null> {\n    return this.prisma.fiscalYear.findFirst({\n      where: {\n        companyId,\n        startDate: { lte: date },\n        endDate: { gte: date },\n      },\n    });\n  }\n\n  async create(companyId: string, dto: CreateFiscalYearDto): Promise<FiscalYear> {\n    const startDate = new Date(dto.startDate);\n    const endDate = new Date(dto.endDate);\n\n    // Validate dates\n    if (endDate <= startDate) {\n      throw new BadRequestException('End date must be after start date');\n    }\n\n    // Check for overlapping fiscal years\n    const overlapping = await this.prisma.fiscalYear.findFirst({\n      where: {\n        companyId,\n        OR: [\n          {\n            startDate: { lte: startDate },\n            endDate: { gte: startDate },\n          },\n          {\n            startDate: { lte: endDate },\n            endDate: { gte: endDate },\n          },\n          {\n            startDate: { gte: startDate },\n            endDate: { lte: endDate },\n          },\n        ],\n      },\n    });\n\n    if (overlapping) {\n      throw new ConflictException(\n        `Fiscal year overlaps with existing fiscal year: ${overlapping.name}`,\n      );\n    }\n\n    // Check for duplicate name\n    const existingName = await this.prisma.fiscalYear.findFirst({\n      where: { companyId, name: dto.name },\n    });\n\n    if (existingName) {\n      throw new ConflictException(`Fiscal year with name ${dto.name} already exists`);\n    }\n\n    return this.prisma.fiscalYear.create({\n      data: {\n        name: dto.name,\n        startDate,\n        endDate,\n        notes: dto.notes ?? null,\n        companyId,\n        isClosed: false,\n      },\n    });\n  }\n\n  async update(\n    companyId: string,\n    id: string,\n    dto: Partial<CreateFiscalYearDto>,\n  ): Promise<FiscalYear> {\n    const existing = await this.findById(companyId, id);\n\n    if (existing.isClosed) {\n      throw new ConflictException('Cannot modify a closed fiscal year');\n    }\n\n    const updateData: Prisma.FiscalYearUpdateInput = {};\n\n    if (dto.name) {\n      const existingName = await this.prisma.fiscalYear.findFirst({\n        where: { companyId, name: dto.name, NOT: { id } },\n      });\n      if (existingName) {\n        throw new ConflictException(`Fiscal year with name ${dto.name} already exists`);\n      }\n      updateData.name = dto.name;\n    }\n\n    if (dto.startDate || dto.endDate) {\n      const startDate = dto.startDate ? new Date(dto.startDate) : existing.startDate;\n      const endDate = dto.endDate ? new Date(dto.endDate) : existing.endDate;\n\n      if (endDate <= startDate) {\n        throw new BadRequestException('End date must be after start date');\n      }\n\n      // Check for overlapping fiscal years (excluding current)\n      const overlapping = await this.prisma.fiscalYear.findFirst({\n        where: {\n          companyId,\n          NOT: { id },\n          OR: [\n            {\n              startDate: { lte: startDate },\n              endDate: { gte: startDate },\n            },\n            {\n              startDate: { lte: endDate },\n              endDate: { gte: endDate },\n            },\n            {\n              startDate: { gte: startDate },\n              endDate: { lte: endDate },\n            },\n          ],\n        },\n      });\n\n      if (overlapping) {\n        throw new ConflictException(\n          `Fiscal year overlaps with existing fiscal year: ${overlapping.name}`,\n        );\n      }\n\n      if (dto.startDate) updateData.startDate = startDate;\n      if (dto.endDate) updateData.endDate = endDate;\n    }\n\n    if (dto.notes !== undefined) {\n      updateData.notes = dto.notes;\n    }\n\n    return this.prisma.fiscalYear.update({\n      where: { id },\n      data: updateData,\n    });\n  }\n\n  async close(companyId: string, id: string): Promise<FiscalYear> {\n    const fiscalYear = await this.findById(companyId, id);\n\n    if (fiscalYear.isClosed) {\n      throw new ConflictException('Fiscal year is already closed');\n    }\n\n    // Check for draft journal entries\n    const draftEntries = await this.prisma.journalEntry.count({\n      where: {\n        companyId,\n        fiscalYearId: id,\n        status: 'DRAFT',\n      },\n    });\n\n    if (draftEntries > 0) {\n      throw new BadRequestException(\n        `Cannot close fiscal year with ${draftEntries} draft journal entries. Post or void them first.`,\n      );\n    }\n\n    return this.prisma.fiscalYear.update({\n      where: { id },\n      data: {\n        isClosed: true,\n        closedAt: new Date(),\n      },\n    });\n  }\n\n  async reopen(companyId: string, id: string): Promise<FiscalYear> {\n    const fiscalYear = await this.findById(companyId, id);\n\n    if (!fiscalYear.isClosed) {\n      throw new ConflictException('Fiscal year is not closed');\n    }\n\n    return this.prisma.fiscalYear.update({\n      where: { id },\n      data: {\n        isClosed: false,\n        closedAt: null,\n      },\n    });\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    await this.findById(companyId, id);\n\n    // Check for journal entries\n    const entriesCount = await this.prisma.journalEntry.count({\n      where: { companyId, fiscalYearId: id },\n    });\n\n    if (entriesCount > 0) {\n      throw new ConflictException(\n        `Cannot delete fiscal year with ${entriesCount} journal entries`,\n      );\n    }\n\n    await this.prisma.fiscalYear.delete({ where: { id } });\n  }\n\n  async getStats(\n    companyId: string,\n    id: string,\n  ): Promise<{\n    totalEntries: number;\n    postedEntries: number;\n    draftEntries: number;\n    voidedEntries: number;\n    totalDebits: number;\n    totalCredits: number;\n  }> {\n    await this.findById(companyId, id);\n\n    const [entryCounts, totals] = await Promise.all([\n      this.prisma.journalEntry.groupBy({\n        by: ['status'],\n        where: { companyId, fiscalYearId: id },\n        _count: true,\n      }),\n      this.prisma.journalLine.aggregate({\n        where: {\n          journalEntry: {\n            companyId,\n            fiscalYearId: id,\n            status: 'POSTED',\n          },\n        },\n        _sum: {\n          debit: true,\n          credit: true,\n        },\n      }),\n    ]);\n\n    const statusCounts = Object.fromEntries(\n      entryCounts.map((e) => [e.status, e._count]),\n    );\n\n    return {\n      totalEntries: Object.values(statusCounts).reduce((a, b) => a + b, 0),\n      postedEntries: statusCounts['POSTED'] || 0,\n      draftEntries: statusCounts['DRAFT'] || 0,\n      voidedEntries: statusCounts['REVERSED'] || 0,\n      totalDebits: totals._sum.debit?.toNumber() || 0,\n      totalCredits: totals._sum.credit?.toNumber() || 0,\n    };\n  }\n}\n"],"names":["FiscalYearsService","findAll","companyId","prisma","fiscalYear","findMany","where","orderBy","startDate","findById","id","findFirst","NotFoundException","findCurrent","today","Date","lte","endDate","gte","isClosed","findByDate","date","create","dto","BadRequestException","overlapping","OR","ConflictException","name","existingName","data","notes","update","existing","updateData","NOT","undefined","close","draftEntries","journalEntry","count","fiscalYearId","status","closedAt","reopen","delete","entriesCount","getStats","entryCounts","totals","Promise","all","groupBy","by","_count","journalLine","aggregate","_sum","debit","credit","statusCounts","Object","fromEntries","map","e","totalEntries","values","reduce","a","b","postedEntries","voidedEntries","totalDebits","toNumber","totalCredits"],"mappings":"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"}