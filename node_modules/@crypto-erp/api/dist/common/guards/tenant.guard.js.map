{"version":3,"sources":["../../../src/common/guards/tenant.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  BadRequestException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport type { RequestWithUser } from '../decorators/current-user.decorator.js';\nimport type { RequestWithCompany } from '../decorators/current-company.decorator.js';\n\n/**\n * Multi-tenancy guard.\n * Validates user access to the requested company.\n */\n@Injectable()\nexport class TenantGuard implements CanActivate {\n  constructor(private prisma: PrismaService) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context\n      .switchToHttp()\n      .getRequest<RequestWithUser & RequestWithCompany>();\n\n    const user = request.user;\n    if (!user) {\n      throw new ForbiddenException('User not authenticated');\n    }\n\n    const companyId = this.extractCompanyId(request);\n    if (!companyId) {\n      throw new BadRequestException(\n        'Company ID required. Use X-Company-Id header.',\n      );\n    }\n\n    const uuidRegex =\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n    if (!uuidRegex.test(companyId)) {\n      throw new BadRequestException('Invalid company ID format');\n    }\n\n    const companyUser = await this.prisma.companyUser.findUnique({\n      where: {\n        userId_companyId: { userId: user.sub, companyId },\n      },\n      include: { company: true },\n    });\n\n    if (!companyUser) {\n      throw new ForbiddenException('Access denied to this company');\n    }\n\n    if (companyUser.company.deletedAt) {\n      throw new ForbiddenException('Company has been deleted');\n    }\n\n    request.companyContext = {\n      company: companyUser.company,\n      role: companyUser.role,\n    };\n\n    return true;\n  }\n\n  private extractCompanyId(request: RequestWithUser): string | null {\n    const header = request.headers['x-company-id'];\n    if (typeof header === 'string') return header;\n\n    const params = request.params as Record<string, string>;\n    if (params['companyId']) return params['companyId'];\n\n    const query = request.query as Record<string, unknown>;\n    if (typeof query['companyId'] === 'string') return query['companyId'];\n\n    return null;\n  }\n}"],"names":["TenantGuard","canActivate","context","request","switchToHttp","getRequest","user","ForbiddenException","companyId","extractCompanyId","BadRequestException","uuidRegex","test","companyUser","prisma","findUnique","where","userId_companyId","userId","sub","include","company","deletedAt","companyContext","role","header","headers","params","query"],"mappings":";;;;+BAgBaA;;;eAAAA;;;wBAVN;0BACuB;;;;;;;;;;AASvB,IAAA,AAAMA,cAAN,MAAMA;IAGX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,UAAUD,QACbE,YAAY,GACZC,UAAU;QAEb,MAAMC,OAAOH,QAAQG,IAAI;QACzB,IAAI,CAACA,MAAM;YACT,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,MAAMC,YAAY,IAAI,CAACC,gBAAgB,CAACN;QACxC,IAAI,CAACK,WAAW;YACd,MAAM,IAAIE,2BAAmB,CAC3B;QAEJ;QAEA,MAAMC,YACJ;QACF,IAAI,CAACA,UAAUC,IAAI,CAACJ,YAAY;YAC9B,MAAM,IAAIE,2BAAmB,CAAC;QAChC;QAEA,MAAMG,cAAc,MAAM,IAAI,CAACC,MAAM,CAACD,WAAW,CAACE,UAAU,CAAC;YAC3DC,OAAO;gBACLC,kBAAkB;oBAAEC,QAAQZ,KAAKa,GAAG;oBAAEX;gBAAU;YAClD;YACAY,SAAS;gBAAEC,SAAS;YAAK;QAC3B;QAEA,IAAI,CAACR,aAAa;YAChB,MAAM,IAAIN,0BAAkB,CAAC;QAC/B;QAEA,IAAIM,YAAYQ,OAAO,CAACC,SAAS,EAAE;YACjC,MAAM,IAAIf,0BAAkB,CAAC;QAC/B;QAEAJ,QAAQoB,cAAc,GAAG;YACvBF,SAASR,YAAYQ,OAAO;YAC5BG,MAAMX,YAAYW,IAAI;QACxB;QAEA,OAAO;IACT;IAEQf,iBAAiBN,OAAwB,EAAiB;QAChE,MAAMsB,SAAStB,QAAQuB,OAAO,CAAC,eAAe;QAC9C,IAAI,OAAOD,WAAW,UAAU,OAAOA;QAEvC,MAAME,SAASxB,QAAQwB,MAAM;QAC7B,IAAIA,MAAM,CAAC,YAAY,EAAE,OAAOA,MAAM,CAAC,YAAY;QAEnD,MAAMC,QAAQzB,QAAQyB,KAAK;QAC3B,IAAI,OAAOA,KAAK,CAAC,YAAY,KAAK,UAAU,OAAOA,KAAK,CAAC,YAAY;QAErE,OAAO;IACT;IA3DA,YAAY,AAAQd,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AA4D9C"}