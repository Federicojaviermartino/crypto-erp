{"version":3,"sources":["../../../src/modules/auth/two-factor.controller.ts"],"sourcesContent":["import { Controller, Get, Post, Delete, Body, UseGuards, UnauthorizedException } from '@nestjs/common';\nimport { TwoFactorService } from './services/two-factor.service';\nimport { JwtAuthGuard } from './guards/jwt-auth.guard';\nimport { GetUser } from './decorators/get-user.decorator';\nimport { Enable2FADto } from './dto/enable-2fa.dto';\nimport { Verify2FADto } from './dto/verify-2fa.dto';\nimport { Disable2FADto } from './dto/disable-2fa.dto';\nimport { PrismaService } from '@crypto-erp/database';\nimport * as bcrypt from 'bcrypt';\n\n@Controller('auth/2fa')\n@UseGuards(JwtAuthGuard)\nexport class TwoFactorController {\n  constructor(\n    private readonly twoFactorService: TwoFactorService,\n    private readonly prisma: PrismaService,\n  ) {}\n\n  /**\n   * Generate 2FA secret and QR code\n   * Step 1: User requests to enable 2FA\n   */\n  @Get('generate')\n  async generate(@GetUser('id') userId: string) {\n    const { secret, qrCode, backupCodes } = await this.twoFactorService.generateSecret(userId);\n\n    return {\n      secret,\n      qrCode,\n      backupCodes,\n      message: 'Scan the QR code with your authenticator app and verify with a token to enable 2FA',\n    };\n  }\n\n  /**\n   * Enable 2FA after user verifies the token\n   * Step 2: User scans QR and provides first token\n   */\n  @Post('enable')\n  async enable(@GetUser('id') userId: string, @Body() dto: Enable2FADto) {\n    await this.twoFactorService.enable2FA(userId, dto.secret, dto.token, dto.backupCodes);\n\n    return {\n      message: '2FA enabled successfully',\n      backupCodes: dto.backupCodes,\n    };\n  }\n\n  /**\n   * Disable 2FA (requires password confirmation)\n   */\n  @Delete('disable')\n  async disable(@GetUser('id') userId: string, @Body() dto: Disable2FADto) {\n    // Verify password first\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('User not found');\n    }\n\n    const isValidPassword = await bcrypt.compare(dto.password, user.passwordHash);\n\n    if (!isValidPassword) {\n      throw new UnauthorizedException('Invalid password');\n    }\n\n    await this.twoFactorService.disable2FA(userId);\n\n    return {\n      message: '2FA disabled successfully',\n    };\n  }\n\n  /**\n   * Verify a 2FA token (for testing)\n   */\n  @Post('verify')\n  async verify(@GetUser('id') userId: string, @Body() dto: Verify2FADto) {\n    const isValid = await this.twoFactorService.verifyUserToken(userId, dto.token);\n\n    if (!isValid) {\n      throw new UnauthorizedException('Invalid 2FA token');\n    }\n\n    return {\n      message: 'Token verified successfully',\n    };\n  }\n\n  /**\n   * Get 2FA status for current user\n   */\n  @Get('status')\n  async getStatus(@GetUser('id') userId: string) {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      select: {\n        twoFactorEnabled: true,\n      },\n    });\n\n    const remainingBackupCodes = user?.twoFactorEnabled\n      ? await this.twoFactorService.getRemainingBackupCodes(userId)\n      : 0;\n\n    return {\n      enabled: user?.twoFactorEnabled || false,\n      remainingBackupCodes,\n    };\n  }\n\n  /**\n   * Regenerate backup codes\n   */\n  @Post('backup-codes/regenerate')\n  async regenerateBackupCodes(@GetUser('id') userId: string) {\n    const backupCodes = await this.twoFactorService.regenerateBackupCodes(userId);\n\n    return {\n      message: 'Backup codes regenerated successfully',\n      backupCodes,\n    };\n  }\n}\n"],"names":["TwoFactorController","generate","userId","secret","qrCode","backupCodes","twoFactorService","generateSecret","message","enable","dto","enable2FA","token","disable","user","prisma","findUnique","where","id","UnauthorizedException","isValidPassword","bcrypt","compare","password","passwordHash","disable2FA","verify","isValid","verifyUserToken","getStatus","select","twoFactorEnabled","remainingBackupCodes","getRemainingBackupCodes","enabled","regenerateBackupCodes"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZyE;kCACrD;8BACJ;kCACL;8BACK;8BACA;+BACC;0BACA;gEACN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIjB,IAAA,AAAMA,sBAAN,MAAMA;IAMX;;;GAGC,GACD,MACMC,SAAS,AAAeC,MAAc,EAAE;QAC5C,MAAM,EAAEC,MAAM,EAAEC,MAAM,EAAEC,WAAW,EAAE,GAAG,MAAM,IAAI,CAACC,gBAAgB,CAACC,cAAc,CAACL;QAEnF,OAAO;YACLC;YACAC;YACAC;YACAG,SAAS;QACX;IACF;IAEA;;;GAGC,GACD,MACMC,OAAO,AAAeP,MAAc,EAAE,AAAQQ,GAAiB,EAAE;QACrE,MAAM,IAAI,CAACJ,gBAAgB,CAACK,SAAS,CAACT,QAAQQ,IAAIP,MAAM,EAAEO,IAAIE,KAAK,EAAEF,IAAIL,WAAW;QAEpF,OAAO;YACLG,SAAS;YACTH,aAAaK,IAAIL,WAAW;QAC9B;IACF;IAEA;;GAEC,GACD,MACMQ,QAAQ,AAAeX,MAAc,EAAE,AAAQQ,GAAkB,EAAE;QACvE,wBAAwB;QACxB,MAAMI,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIhB;YAAO;QACtB;QAEA,IAAI,CAACY,MAAM;YACT,MAAM,IAAIK,6BAAqB,CAAC;QAClC;QAEA,MAAMC,kBAAkB,MAAMC,QAAOC,OAAO,CAACZ,IAAIa,QAAQ,EAAET,KAAKU,YAAY;QAE5E,IAAI,CAACJ,iBAAiB;YACpB,MAAM,IAAID,6BAAqB,CAAC;QAClC;QAEA,MAAM,IAAI,CAACb,gBAAgB,CAACmB,UAAU,CAACvB;QAEvC,OAAO;YACLM,SAAS;QACX;IACF;IAEA;;GAEC,GACD,MACMkB,OAAO,AAAexB,MAAc,EAAE,AAAQQ,GAAiB,EAAE;QACrE,MAAMiB,UAAU,MAAM,IAAI,CAACrB,gBAAgB,CAACsB,eAAe,CAAC1B,QAAQQ,IAAIE,KAAK;QAE7E,IAAI,CAACe,SAAS;YACZ,MAAM,IAAIR,6BAAqB,CAAC;QAClC;QAEA,OAAO;YACLX,SAAS;QACX;IACF;IAEA;;GAEC,GACD,MACMqB,UAAU,AAAe3B,MAAc,EAAE;QAC7C,MAAMY,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIhB;YAAO;YACpB4B,QAAQ;gBACNC,kBAAkB;YACpB;QACF;QAEA,MAAMC,uBAAuBlB,MAAMiB,mBAC/B,MAAM,IAAI,CAACzB,gBAAgB,CAAC2B,uBAAuB,CAAC/B,UACpD;QAEJ,OAAO;YACLgC,SAASpB,MAAMiB,oBAAoB;YACnCC;QACF;IACF;IAEA;;GAEC,GACD,MACMG,sBAAsB,AAAejC,MAAc,EAAE;QACzD,MAAMG,cAAc,MAAM,IAAI,CAACC,gBAAgB,CAAC6B,qBAAqB,CAACjC;QAEtE,OAAO;YACLM,SAAS;YACTH;QACF;IACF;IA/GA,YACE,AAAiBC,gBAAkC,EACnD,AAAiBS,MAAqB,CACtC;aAFiBT,mBAAAA;aACAS,SAAAA;IAChB;AA6GL"}