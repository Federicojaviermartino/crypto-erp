{"version":3,"sources":["../../../../src/modules/auth/controllers/sso.controller.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { SsoController } from './sso.controller';\nimport { AuthService } from '../auth.service';\nimport { ConfigService } from '@nestjs/config';\n\ndescribe('SsoController', () => {\n  let controller: SsoController;\n  let authService: AuthService;\n  let configService: ConfigService;\n\n  const mockAuthService = {\n    generateTokens: jest.fn(),\n    getSamlMetadata: jest.fn(),\n  };\n\n  const mockConfigService = {\n    get: jest.fn((key: string) => {\n      if (key === 'WEB_URL') return 'http://localhost:4200';\n      return null;\n    }),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      controllers: [SsoController],\n      providers: [\n        {\n          provide: AuthService,\n          useValue: mockAuthService,\n        },\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n      ],\n    }).compile();\n\n    controller = module.get<SsoController>(SsoController);\n    authService = module.get<AuthService>(AuthService);\n    configService = module.get<ConfigService>(ConfigService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(controller).toBeDefined();\n  });\n\n  describe('googleCallback', () => {\n    it('should redirect to frontend with tokens', async () => {\n      const mockUser = {\n        id: 'user-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n      };\n\n      const mockTokens = {\n        accessToken: 'access-token-123',\n        refreshToken: 'refresh-token-123',\n        expiresIn: 900,\n        user: mockUser,\n      };\n\n      const req = { user: mockUser } as any;\n      const res = { redirect: jest.fn() } as any;\n\n      mockAuthService.generateTokens.mockResolvedValue(mockTokens);\n\n      await controller.googleCallback(req, res);\n\n      expect(authService.generateTokens).toHaveBeenCalledWith(mockUser);\n      expect(res.redirect).toHaveBeenCalledWith(\n        'http://localhost:4200/auth/callback?token=access-token-123&refreshToken=refresh-token-123',\n      );\n    });\n  });\n\n  describe('azureCallback', () => {\n    it('should redirect to frontend with tokens', async () => {\n      const mockUser = { id: 'user-123' };\n      const mockTokens = {\n        accessToken: 'access-token-123',\n        refreshToken: 'refresh-token-123',\n      };\n\n      const req = { user: mockUser } as any;\n      const res = { redirect: jest.fn() } as any;\n\n      mockAuthService.generateTokens.mockResolvedValue(mockTokens);\n\n      await controller.azureCallback(req, res);\n\n      expect(authService.generateTokens).toHaveBeenCalledWith(mockUser);\n      expect(res.redirect).toHaveBeenCalled();\n    });\n  });\n\n  describe('samlCallback', () => {\n    it('should redirect to frontend with tokens', async () => {\n      const mockUser = { id: 'user-123' };\n      const mockTokens = {\n        accessToken: 'access-token-123',\n        refreshToken: 'refresh-token-123',\n      };\n\n      const req = { user: mockUser } as any;\n      const res = { redirect: jest.fn() } as any;\n\n      mockAuthService.generateTokens.mockResolvedValue(mockTokens);\n\n      await controller.samlCallback(req, res);\n\n      expect(authService.generateTokens).toHaveBeenCalledWith(mockUser);\n      expect(res.redirect).toHaveBeenCalled();\n    });\n  });\n\n  describe('samlMetadata', () => {\n    it('should return SAML metadata XML', async () => {\n      const mockMetadata = '<?xml version=\"1.0\"?><EntityDescriptor>...</EntityDescriptor>';\n      const res = {\n        type: jest.fn().mockReturnThis(),\n        send: jest.fn(),\n      } as any;\n\n      mockAuthService.getSamlMetadata.mockReturnValue(mockMetadata);\n\n      await controller.samlMetadata(res);\n\n      expect(authService.getSamlMetadata).toHaveBeenCalled();\n      expect(res.type).toHaveBeenCalledWith('application/xml');\n      expect(res.send).toHaveBeenCalledWith(mockMetadata);\n    });\n  });\n});\n"],"names":["describe","controller","authService","configService","mockAuthService","generateTokens","jest","fn","getSamlMetadata","mockConfigService","get","key","beforeEach","module","Test","createTestingModule","controllers","SsoController","providers","provide","AuthService","useValue","ConfigService","compile","clearAllMocks","it","expect","toBeDefined","mockUser","id","email","firstName","lastName","mockTokens","accessToken","refreshToken","expiresIn","user","req","res","redirect","mockResolvedValue","googleCallback","toHaveBeenCalledWith","azureCallback","toHaveBeenCalled","samlCallback","mockMetadata","type","mockReturnThis","send","mockReturnValue","samlMetadata"],"mappings":";;;;yBAAoC;+BACN;6BACF;wBACE;AAE9BA,SAAS,iBAAiB;IACxB,IAAIC;IACJ,IAAIC;IACJ,IAAIC;IAEJ,MAAMC,kBAAkB;QACtBC,gBAAgBC,KAAKC,EAAE;QACvBC,iBAAiBF,KAAKC,EAAE;IAC1B;IAEA,MAAME,oBAAoB;QACxBC,KAAKJ,KAAKC,EAAE,CAAC,CAACI;YACZ,IAAIA,QAAQ,WAAW,OAAO;YAC9B,OAAO;QACT;IACF;IAEAC,WAAW;QACT,MAAMC,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,aAAa;gBAACC,4BAAa;aAAC;YAC5BC,WAAW;gBACT;oBACEC,SAASC,wBAAW;oBACpBC,UAAUjB;gBACZ;gBACA;oBACEe,SAASG,qBAAa;oBACtBD,UAAUZ;gBACZ;aACD;QACH,GAAGc,OAAO;QAEVtB,aAAaY,OAAOH,GAAG,CAAgBO,4BAAa;QACpDf,cAAcW,OAAOH,GAAG,CAAcU,wBAAW;QACjDjB,gBAAgBU,OAAOH,GAAG,CAAgBY,qBAAa;QAEvDhB,KAAKkB,aAAa;IACpB;IAEAC,GAAG,qBAAqB;QACtBC,OAAOzB,YAAY0B,WAAW;IAChC;IAEA3B,SAAS,kBAAkB;QACzByB,GAAG,2CAA2C;YAC5C,MAAMG,WAAW;gBACfC,IAAI;gBACJC,OAAO;gBACPC,WAAW;gBACXC,UAAU;YACZ;YAEA,MAAMC,aAAa;gBACjBC,aAAa;gBACbC,cAAc;gBACdC,WAAW;gBACXC,MAAMT;YACR;YAEA,MAAMU,MAAM;gBAAED,MAAMT;YAAS;YAC7B,MAAMW,MAAM;gBAAEC,UAAUlC,KAAKC,EAAE;YAAG;YAElCH,gBAAgBC,cAAc,CAACoC,iBAAiB,CAACR;YAEjD,MAAMhC,WAAWyC,cAAc,CAACJ,KAAKC;YAErCb,OAAOxB,YAAYG,cAAc,EAAEsC,oBAAoB,CAACf;YACxDF,OAAOa,IAAIC,QAAQ,EAAEG,oBAAoB,CACvC;QAEJ;IACF;IAEA3C,SAAS,iBAAiB;QACxByB,GAAG,2CAA2C;YAC5C,MAAMG,WAAW;gBAAEC,IAAI;YAAW;YAClC,MAAMI,aAAa;gBACjBC,aAAa;gBACbC,cAAc;YAChB;YAEA,MAAMG,MAAM;gBAAED,MAAMT;YAAS;YAC7B,MAAMW,MAAM;gBAAEC,UAAUlC,KAAKC,EAAE;YAAG;YAElCH,gBAAgBC,cAAc,CAACoC,iBAAiB,CAACR;YAEjD,MAAMhC,WAAW2C,aAAa,CAACN,KAAKC;YAEpCb,OAAOxB,YAAYG,cAAc,EAAEsC,oBAAoB,CAACf;YACxDF,OAAOa,IAAIC,QAAQ,EAAEK,gBAAgB;QACvC;IACF;IAEA7C,SAAS,gBAAgB;QACvByB,GAAG,2CAA2C;YAC5C,MAAMG,WAAW;gBAAEC,IAAI;YAAW;YAClC,MAAMI,aAAa;gBACjBC,aAAa;gBACbC,cAAc;YAChB;YAEA,MAAMG,MAAM;gBAAED,MAAMT;YAAS;YAC7B,MAAMW,MAAM;gBAAEC,UAAUlC,KAAKC,EAAE;YAAG;YAElCH,gBAAgBC,cAAc,CAACoC,iBAAiB,CAACR;YAEjD,MAAMhC,WAAW6C,YAAY,CAACR,KAAKC;YAEnCb,OAAOxB,YAAYG,cAAc,EAAEsC,oBAAoB,CAACf;YACxDF,OAAOa,IAAIC,QAAQ,EAAEK,gBAAgB;QACvC;IACF;IAEA7C,SAAS,gBAAgB;QACvByB,GAAG,mCAAmC;YACpC,MAAMsB,eAAe;YACrB,MAAMR,MAAM;gBACVS,MAAM1C,KAAKC,EAAE,GAAG0C,cAAc;gBAC9BC,MAAM5C,KAAKC,EAAE;YACf;YAEAH,gBAAgBI,eAAe,CAAC2C,eAAe,CAACJ;YAEhD,MAAM9C,WAAWmD,YAAY,CAACb;YAE9Bb,OAAOxB,YAAYM,eAAe,EAAEqC,gBAAgB;YACpDnB,OAAOa,IAAIS,IAAI,EAAEL,oBAAoB,CAAC;YACtCjB,OAAOa,IAAIW,IAAI,EAAEP,oBAAoB,CAACI;QACxC;IACF;AACF"}