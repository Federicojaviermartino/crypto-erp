{"version":3,"sources":["../../../../src/modules/oauth/interceptors/api-usage.interceptor.ts"],"sourcesContent":["import {\n  Injectable,\n  NestInterceptor,\n  ExecutionContext,\n  CallHandler,\n} from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { ApiUsageService } from '../api-usage.service.js';\n\n/**\n * API Usage Tracking Interceptor\n * Automatically tracks all API requests for OAuth apps\n *\n * Tracks:\n * - Request endpoint and method\n * - Response status code\n * - Response time\n * - IP address and user agent\n */\n@Injectable()\nexport class ApiUsageInterceptor implements NestInterceptor {\n  constructor(private readonly apiUsageService: ApiUsageService) {}\n\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    const request = context.switchToHttp().getRequest();\n    const response = context.switchToHttp().getResponse();\n\n    const startTime = Date.now();\n\n    return next.handle().pipe(\n      tap({\n        next: () => {\n          this.trackRequest(request, response, startTime);\n        },\n        error: () => {\n          this.trackRequest(request, response, startTime);\n        },\n      }),\n    );\n  }\n\n  private trackRequest(request: any, response: any, startTime: number) {\n    const responseTime = Date.now() - startTime;\n\n    // Only track if OAuth context is available\n    const oauth = request.oauth;\n    if (!oauth) {\n      return;\n    }\n\n    // Extract request details\n    const endpoint = request.route?.path || request.url;\n    const method = request.method;\n    const statusCode = response.statusCode;\n    const ipAddress = this.getIpAddress(request);\n    const userAgent = request.headers['user-agent'];\n\n    // Record usage asynchronously (don't block response)\n    this.apiUsageService\n      .recordRequest({\n        appId: oauth.app.id,\n        companyId: oauth.companyId,\n        userId: oauth.userId,\n        endpoint,\n        method,\n        statusCode,\n        responseTime,\n        ipAddress,\n        userAgent,\n      })\n      .catch(error => {\n        console.error('Failed to track API usage:', error);\n      });\n  }\n\n  private getIpAddress(request: any): string | undefined {\n    // Try various headers for the real IP (behind proxies)\n    return (\n      request.headers['x-forwarded-for']?.split(',')[0] ||\n      request.headers['x-real-ip'] ||\n      request.connection?.remoteAddress ||\n      request.socket?.remoteAddress\n    );\n  }\n}\n"],"names":["ApiUsageInterceptor","intercept","context","next","request","switchToHttp","getRequest","response","getResponse","startTime","Date","now","handle","pipe","tap","trackRequest","error","responseTime","oauth","endpoint","route","path","url","method","statusCode","ipAddress","getIpAddress","userAgent","headers","apiUsageService","recordRequest","appId","app","id","companyId","userId","catch","console","split","connection","remoteAddress","socket"],"mappings":";;;;+BAqBaA;;;eAAAA;;;wBAhBN;2BAEa;iCACY;;;;;;;;;;AAazB,IAAA,AAAMA,sBAAN,MAAMA;IAGXC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACvE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,WAAWL,QAAQG,YAAY,GAAGG,WAAW;QAEnD,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,OAAOR,KAAKS,MAAM,GAAGC,IAAI,CACvBC,IAAAA,cAAG,EAAC;YACFX,MAAM;gBACJ,IAAI,CAACY,YAAY,CAACX,SAASG,UAAUE;YACvC;YACAO,OAAO;gBACL,IAAI,CAACD,YAAY,CAACX,SAASG,UAAUE;YACvC;QACF;IAEJ;IAEQM,aAAaX,OAAY,EAAEG,QAAa,EAAEE,SAAiB,EAAE;QACnE,MAAMQ,eAAeP,KAAKC,GAAG,KAAKF;QAElC,2CAA2C;QAC3C,MAAMS,QAAQd,QAAQc,KAAK;QAC3B,IAAI,CAACA,OAAO;YACV;QACF;QAEA,0BAA0B;QAC1B,MAAMC,WAAWf,QAAQgB,KAAK,EAAEC,QAAQjB,QAAQkB,GAAG;QACnD,MAAMC,SAASnB,QAAQmB,MAAM;QAC7B,MAAMC,aAAajB,SAASiB,UAAU;QACtC,MAAMC,YAAY,IAAI,CAACC,YAAY,CAACtB;QACpC,MAAMuB,YAAYvB,QAAQwB,OAAO,CAAC,aAAa;QAE/C,qDAAqD;QACrD,IAAI,CAACC,eAAe,CACjBC,aAAa,CAAC;YACbC,OAAOb,MAAMc,GAAG,CAACC,EAAE;YACnBC,WAAWhB,MAAMgB,SAAS;YAC1BC,QAAQjB,MAAMiB,MAAM;YACpBhB;YACAI;YACAC;YACAP;YACAQ;YACAE;QACF,GACCS,KAAK,CAACpB,CAAAA;YACLqB,QAAQrB,KAAK,CAAC,8BAA8BA;QAC9C;IACJ;IAEQU,aAAatB,OAAY,EAAsB;QACrD,uDAAuD;QACvD,OACEA,QAAQwB,OAAO,CAAC,kBAAkB,EAAEU,MAAM,IAAI,CAAC,EAAE,IACjDlC,QAAQwB,OAAO,CAAC,YAAY,IAC5BxB,QAAQmC,UAAU,EAAEC,iBACpBpC,QAAQqC,MAAM,EAAED;IAEpB;IA9DA,YAAY,AAAiBX,eAAgC,CAAE;aAAlCA,kBAAAA;IAAmC;AA+DlE"}