{"version":3,"sources":["../../src/processors/journal-entry.processor.ts"],"sourcesContent":["import { Processor, WorkerHost, OnWorkerEvent } from '@nestjs/bullmq';\nimport { Logger } from '@nestjs/common';\nimport { Job } from 'bullmq';\nimport { PrismaService } from '@crypto-erp/database';\nimport { Decimal } from 'decimal.js';\n\nconst QUEUE_NAME = 'journal-entry';\n\ninterface JournalEntryJobData {\n  transactionId: string;\n  companyId: string;\n  autoPost?: boolean;\n}\n\ninterface JournalEntryResult {\n  success: boolean;\n  journalEntryId?: string;\n  errors?: string[];\n}\n\ninterface JournalLineData {\n  accountId: string;\n  lineNumber: number;\n  debit: Decimal;\n  credit: Decimal;\n  description: string;\n}\n\n// Spanish PGC account mapping for crypto operations\nconst CRYPTO_ACCOUNTS = {\n  // Assets\n  CRYPTO_WALLET: '5700', // Crypto wallets (sub-account per wallet)\n  CRYPTO_INVENTORY: '305', // Crypto inventory (if trading activity)\n  LONG_TERM_CRYPTO: '250', // Long-term crypto investments\n  BANK: '572', // Bank account\n\n  // Income\n  EXCHANGE_GAIN: '768', // Positive exchange differences (crypto gains)\n  OTHER_FINANCIAL_INCOME: '769', // Staking, airdrops\n  SALES: '700', // Sales income\n\n  // Expenses\n  EXCHANGE_LOSS: '668', // Negative exchange differences (crypto losses)\n  FEES: '662', // Transaction fees\n  PURCHASES: '600', // Purchases\n} as const;\n\n@Processor(QUEUE_NAME)\nexport class JournalEntryProcessor extends WorkerHost {\n  private readonly logger = new Logger(JournalEntryProcessor.name);\n\n  constructor(private readonly prisma: PrismaService) {\n    super();\n  }\n\n  async process(job: Job<JournalEntryJobData>): Promise<JournalEntryResult> {\n    const { transactionId, companyId, autoPost = false } = job.data;\n\n    this.logger.log(`Processing journal entry for transaction ${transactionId}`);\n\n    const result: JournalEntryResult = {\n      success: false,\n      errors: [],\n    };\n\n    try {\n      // Get transaction with related data\n      const transaction = await this.prisma.cryptoTransaction.findUnique({\n        where: { id: transactionId },\n        include: {\n          wallet: true,\n        },\n      });\n\n      if (!transaction) {\n        throw new Error(`Transaction ${transactionId} not found`);\n      }\n\n      // Check if journal entry already exists\n      const existingEntry = await this.prisma.journalEntry.findFirst({\n        where: {\n          companyId,\n          reference: `CRYPTO-${transaction.txHash.slice(0, 16)}`,\n        },\n      });\n\n      if (existingEntry) {\n        this.logger.warn(`Journal entry already exists for transaction ${transactionId}`);\n        result.success = true;\n        result.journalEntryId = existingEntry.id;\n        return result;\n      }\n\n      // Get current fiscal year (using isClosed = false for open years)\n      const fiscalYear = await this.prisma.fiscalYear.findFirst({\n        where: {\n          companyId,\n          isClosed: false,\n          startDate: { lte: transaction.blockTimestamp },\n          endDate: { gte: transaction.blockTimestamp },\n        },\n      });\n\n      if (!fiscalYear) {\n        throw new Error('No open fiscal year found for transaction date');\n      }\n\n      // Generate journal entry based on transaction type\n      const entryData = await this.generateEntryData(transaction, companyId);\n\n      if (!entryData) {\n        this.logger.warn(`No journal entry generated for transaction type: ${transaction.type}`);\n        result.success = true;\n        return result;\n      }\n\n      // Create journal entry with proper line numbers\n      const journalEntry = await this.prisma.journalEntry.create({\n        data: {\n          companyId,\n          fiscalYearId: fiscalYear.id,\n          number: await this.getNextEntryNumber(companyId, fiscalYear.id),\n          date: transaction.blockTimestamp,\n          description: entryData.description,\n          reference: `CRYPTO-${transaction.txHash.slice(0, 16)}`,\n          status: autoPost ? 'POSTED' : 'DRAFT',\n          lines: {\n            create: entryData.lines.map((line) => ({\n              accountId: line.accountId,\n              lineNumber: line.lineNumber,\n              debit: line.debit,\n              credit: line.credit,\n              description: line.description,\n            })),\n          },\n        },\n      });\n\n      // Link transaction to journal entry (use COMPLETED status)\n      await this.prisma.cryptoTransaction.update({\n        where: { id: transactionId },\n        data: {\n          journalEntryId: journalEntry.id,\n          status: 'COMPLETED',\n        },\n      });\n\n      result.success = true;\n      result.journalEntryId = journalEntry.id;\n\n      this.logger.log(`Journal entry ${journalEntry.id} created for transaction ${transactionId}`);\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      result.errors?.push(errorMessage);\n      this.logger.error(`Failed to create journal entry: ${errorMessage}`);\n      throw error;\n    }\n\n    return result;\n  }\n\n  /**\n   * Generate journal entry data based on transaction type\n   */\n  private async generateEntryData(\n    transaction: {\n      type: string;\n      assetIn: string | null;\n      amountIn: unknown;\n      assetOut: string | null;\n      amountOut: unknown;\n      priceInEur: unknown;\n      priceOutEur: unknown;\n      feeAsset: string | null;\n      feeAmount: unknown;\n      feeEur: unknown;\n      walletId: string;\n      wallet: { label: string | null; companyId: string };\n    },\n    companyId: string,\n  ): Promise<{\n    description: string;\n    lines: JournalLineData[];\n  } | null> {\n    const amountIn = new Decimal(String(transaction.amountIn || '0'));\n    const amountOut = new Decimal(String(transaction.amountOut || '0'));\n    const priceInEur = new Decimal(String(transaction.priceInEur || '0'));\n    const priceOutEur = new Decimal(String(transaction.priceOutEur || '0'));\n    const feeEur = new Decimal(String(transaction.feeEur || '0'));\n\n    const valueInEur = amountIn.mul(priceInEur);\n    const valueOutEur = amountOut.mul(priceOutEur);\n\n    // Get or create wallet account\n    const walletAccount = await this.getOrCreateAccount(\n      companyId,\n      `${CRYPTO_ACCOUNTS.CRYPTO_WALLET}${transaction.walletId.slice(-4)}`,\n      `Wallet ${transaction.wallet?.label || transaction.walletId.slice(-8)}`,\n    );\n\n    let lineNumber = 1;\n    const lines: JournalLineData[] = [];\n\n    switch (transaction.type) {\n      case 'TRANSFER_IN':\n        // Incoming transfer - crypto enters the wallet\n        lines.push({\n          accountId: walletAccount.id,\n          lineNumber: lineNumber++,\n          debit: valueInEur,\n          credit: new Decimal(0),\n          description: `${transaction.assetIn} @ ${priceInEur.toFixed(4)} EUR`,\n        });\n        lines.push({\n          accountId: await this.getAccountId(companyId, CRYPTO_ACCOUNTS.BANK),\n          lineNumber: lineNumber++,\n          debit: new Decimal(0),\n          credit: valueInEur.plus(feeEur),\n          description: 'Salida banco',\n        });\n        if (feeEur.gt(0)) {\n          lines.push({\n            accountId: await this.getAccountId(companyId, CRYPTO_ACCOUNTS.FEES),\n            lineNumber: lineNumber++,\n            debit: feeEur,\n            credit: new Decimal(0),\n            description: 'Comisión transacción',\n          });\n        }\n        return {\n          description: `Entrada ${amountIn.toFixed(8)} ${transaction.assetIn}`,\n          lines,\n        };\n\n      case 'TRANSFER_OUT':\n        // Outgoing transfer - crypto leaves the wallet with potential gain/loss\n        const costBasis = await this.calculateFIFOCostBasis(\n          companyId,\n          transaction.assetOut || '',\n          amountOut,\n        );\n        const gainLoss = valueOutEur.minus(costBasis);\n        const isGain = gainLoss.gte(0);\n\n        lines.push({\n          accountId: await this.getAccountId(companyId, CRYPTO_ACCOUNTS.BANK),\n          lineNumber: lineNumber++,\n          debit: valueOutEur.minus(feeEur),\n          credit: new Decimal(0),\n          description: 'Entrada banco',\n        });\n        lines.push({\n          accountId: walletAccount.id,\n          lineNumber: lineNumber++,\n          debit: new Decimal(0),\n          credit: costBasis,\n          description: `Coste adquisición ${transaction.assetOut}`,\n        });\n        lines.push({\n          accountId: await this.getAccountId(\n            companyId,\n            isGain ? CRYPTO_ACCOUNTS.EXCHANGE_GAIN : CRYPTO_ACCOUNTS.EXCHANGE_LOSS,\n          ),\n          lineNumber: lineNumber++,\n          debit: isGain ? new Decimal(0) : gainLoss.abs(),\n          credit: isGain ? gainLoss : new Decimal(0),\n          description: isGain ? 'Ganancia patrimonial' : 'Pérdida patrimonial',\n        });\n        if (feeEur.gt(0)) {\n          lines.push({\n            accountId: await this.getAccountId(companyId, CRYPTO_ACCOUNTS.FEES),\n            lineNumber: lineNumber++,\n            debit: feeEur,\n            credit: new Decimal(0),\n            description: 'Comisión transacción',\n          });\n        }\n        return {\n          description: `Salida ${amountOut.toFixed(8)} ${transaction.assetOut}`,\n          lines,\n        };\n\n      case 'CLAIM_REWARD':\n      case 'AIRDROP':\n        // Income from staking rewards or airdrops\n        lines.push({\n          accountId: walletAccount.id,\n          lineNumber: lineNumber++,\n          debit: valueInEur,\n          credit: new Decimal(0),\n          description: `${transaction.assetIn} recibido`,\n        });\n        lines.push({\n          accountId: await this.getAccountId(companyId, CRYPTO_ACCOUNTS.OTHER_FINANCIAL_INCOME),\n          lineNumber: lineNumber++,\n          debit: new Decimal(0),\n          credit: valueInEur,\n          description: 'Ingreso financiero',\n        });\n        return {\n          description: `${transaction.type === 'CLAIM_REWARD' ? 'Recompensa staking' : 'Airdrop'} ${amountIn.toFixed(8)} ${transaction.assetIn}`,\n          lines,\n        };\n\n      case 'SWAP':\n        // Swaps: credit out asset, debit in asset\n        lines.push({\n          accountId: walletAccount.id,\n          lineNumber: lineNumber++,\n          debit: valueInEur,\n          credit: new Decimal(0),\n          description: `${transaction.assetIn} recibido`,\n        });\n        lines.push({\n          accountId: walletAccount.id,\n          lineNumber: lineNumber++,\n          debit: new Decimal(0),\n          credit: valueOutEur,\n          description: `${transaction.assetOut} entregado`,\n        });\n        // If there's a difference, record gain/loss\n        const swapDiff = valueInEur.minus(valueOutEur);\n        if (swapDiff.abs().gt(0.01)) {\n          lines.push({\n            accountId: await this.getAccountId(\n              companyId,\n              swapDiff.gte(0) ? CRYPTO_ACCOUNTS.EXCHANGE_GAIN : CRYPTO_ACCOUNTS.EXCHANGE_LOSS,\n            ),\n            lineNumber: lineNumber++,\n            debit: swapDiff.lt(0) ? swapDiff.abs() : new Decimal(0),\n            credit: swapDiff.gte(0) ? swapDiff : new Decimal(0),\n            description: swapDiff.gte(0) ? 'Ganancia swap' : 'Pérdida swap',\n          });\n        }\n        return {\n          description: `Swap ${amountOut.toFixed(8)} ${transaction.assetOut} → ${amountIn.toFixed(8)} ${transaction.assetIn}`,\n          lines,\n        };\n\n      case 'STAKE':\n      case 'UNSTAKE':\n      case 'LIQUIDITY_ADD':\n      case 'LIQUIDITY_REMOVE':\n      case 'BRIDGE_IN':\n      case 'BRIDGE_OUT':\n        // These are typically asset movements without P&L\n        // Record the movement but don't generate income/expense\n        if (amountIn.gt(0)) {\n          lines.push({\n            accountId: walletAccount.id,\n            lineNumber: lineNumber++,\n            debit: valueInEur,\n            credit: new Decimal(0),\n            description: `${transaction.assetIn} ${transaction.type}`,\n          });\n        }\n        if (amountOut.gt(0)) {\n          lines.push({\n            accountId: walletAccount.id,\n            lineNumber: lineNumber++,\n            debit: new Decimal(0),\n            credit: valueOutEur,\n            description: `${transaction.assetOut} ${transaction.type}`,\n          });\n        }\n        if (lines.length === 0) return null;\n        return {\n          description: `${transaction.type} ${amountIn.gt(0) ? amountIn.toFixed(8) + ' ' + transaction.assetIn : ''} ${amountOut.gt(0) ? amountOut.toFixed(8) + ' ' + transaction.assetOut : ''}`.trim(),\n          lines,\n        };\n\n      case 'NFT_MINT':\n      case 'NFT_TRANSFER':\n      case 'NFT_SALE':\n      case 'APPROVE':\n      case 'CONTRACT_INTERACTION':\n      case 'UNKNOWN':\n        // Skip these transaction types for now\n        return null;\n\n      default:\n        this.logger.warn(`Unknown transaction type: ${transaction.type}`);\n        return null;\n    }\n  }\n\n  /**\n   * Get or create a ledger account\n   */\n  private async getOrCreateAccount(\n    companyId: string,\n    code: string,\n    name: string,\n  ): Promise<{ id: string }> {\n    let account = await this.prisma.account.findFirst({\n      where: { companyId, code },\n    });\n\n    if (!account) {\n      account = await this.prisma.account.create({\n        data: {\n          companyId,\n          code,\n          name,\n          type: 'ASSET',\n          isActive: true,\n        },\n      });\n    }\n\n    return account;\n  }\n\n  /**\n   * Get account ID by code\n   */\n  private async getAccountId(companyId: string, code: string): Promise<string> {\n    const account = await this.prisma.account.findFirst({\n      where: { companyId, code: { startsWith: code } },\n    });\n\n    if (!account) {\n      throw new Error(`Account with code ${code} not found for company ${companyId}`);\n    }\n\n    return account.id;\n  }\n\n  /**\n   * Calculate FIFO cost basis for a sale\n   * Uses cryptoAsset relation via symbol lookup\n   */\n  private async calculateFIFOCostBasis(\n    companyId: string,\n    assetSymbol: string,\n    amount: Decimal,\n  ): Promise<Decimal> {\n    // First find the cryptoAsset\n    const cryptoAsset = await this.prisma.cryptoAsset.findFirst({\n      where: { companyId, symbol: assetSymbol },\n    });\n\n    if (!cryptoAsset) {\n      this.logger.warn(`CryptoAsset ${assetSymbol} not found for company ${companyId}`);\n      return new Decimal(0);\n    }\n\n    // Get acquisition lots ordered by date (FIFO)\n    const lots = await this.prisma.cryptoLot.findMany({\n      where: {\n        companyId,\n        cryptoAssetId: cryptoAsset.id,\n        remainingAmount: { gt: 0 },\n      },\n      orderBy: { acquiredAt: 'asc' },\n    });\n\n    let remainingToSell = amount;\n    let totalCost = new Decimal(0);\n\n    for (const lot of lots) {\n      if (remainingToSell.lte(0)) break;\n\n      const lotRemaining = new Decimal(String(lot.remainingAmount));\n      const lotCostPerUnit = new Decimal(String(lot.costPerUnit));\n      const useFromLot = Decimal.min(remainingToSell, lotRemaining);\n\n      totalCost = totalCost.plus(useFromLot.mul(lotCostPerUnit));\n      remainingToSell = remainingToSell.minus(useFromLot);\n\n      // Update lot remaining amount\n      await this.prisma.cryptoLot.update({\n        where: { id: lot.id },\n        data: {\n          remainingAmount: lotRemaining.minus(useFromLot),\n        },\n      });\n    }\n\n    return totalCost;\n  }\n\n  /**\n   * Get next entry number for the fiscal year\n   */\n  private async getNextEntryNumber(companyId: string, fiscalYearId: string): Promise<number> {\n    const lastEntry = await this.prisma.journalEntry.findFirst({\n      where: { companyId, fiscalYearId },\n      orderBy: { number: 'desc' },\n    });\n\n    return (lastEntry?.number || 0) + 1;\n  }\n\n  @OnWorkerEvent('completed')\n  onCompleted(job: Job<JournalEntryJobData>) {\n    this.logger.debug(`Journal entry job ${job.id} completed`);\n  }\n\n  @OnWorkerEvent('failed')\n  onFailed(job: Job<JournalEntryJobData> | undefined, error: Error) {\n    this.logger.error(`Journal entry job failed: ${error.message}`);\n  }\n}\n"],"names":["JournalEntryProcessor","QUEUE_NAME","CRYPTO_ACCOUNTS","CRYPTO_WALLET","CRYPTO_INVENTORY","LONG_TERM_CRYPTO","BANK","EXCHANGE_GAIN","OTHER_FINANCIAL_INCOME","SALES","EXCHANGE_LOSS","FEES","PURCHASES","WorkerHost","process","job","transactionId","companyId","autoPost","data","logger","log","result","success","errors","transaction","prisma","cryptoTransaction","findUnique","where","id","include","wallet","Error","existingEntry","journalEntry","findFirst","reference","txHash","slice","warn","journalEntryId","fiscalYear","isClosed","startDate","lte","blockTimestamp","endDate","gte","entryData","generateEntryData","type","create","fiscalYearId","number","getNextEntryNumber","date","description","status","lines","map","line","accountId","lineNumber","debit","credit","update","error","errorMessage","message","push","amountIn","Decimal","String","amountOut","priceInEur","priceOutEur","feeEur","valueInEur","mul","valueOutEur","walletAccount","getOrCreateAccount","walletId","label","assetIn","toFixed","getAccountId","plus","gt","costBasis","calculateFIFOCostBasis","assetOut","gainLoss","minus","isGain","abs","swapDiff","lt","length","trim","code","name","account","isActive","startsWith","assetSymbol","amount","cryptoAsset","symbol","lots","cryptoLot","findMany","cryptoAssetId","remainingAmount","orderBy","acquiredAt","remainingToSell","totalCost","lot","lotRemaining","lotCostPerUnit","costPerUnit","useFromLot","min","lastEntry","onCompleted","debug","onFailed","Logger"],"mappings":"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"}