{"version":3,"sources":["../../../../src/modules/auth/strategies/jwt.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PrismaService } from '@crypto-erp/database';\nimport type { JwtPayload } from '../../../common/decorators/current-user.decorator.js';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy, 'jwt') {\n  constructor(\n    configService: ConfigService,\n    private prisma: PrismaService,\n  ) {\n    const secret = configService.get<string>('jwt.secret');\n    if (!secret) {\n      throw new Error('JWT_SECRET is not defined');\n    }\n\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: secret,\n    });\n  }\n\n  async validate(payload: JwtPayload): Promise<JwtPayload> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: payload.sub },\n      select: { id: true, email: true, isActive: true },\n    });\n\n    if (!user || !user.isActive) {\n      throw new UnauthorizedException('User not found or inactive');\n    }\n\n    return { sub: payload.sub, email: payload.email };\n  }\n}\n"],"names":["JwtStrategy","PassportStrategy","Strategy","validate","payload","user","prisma","findUnique","where","id","sub","select","email","isActive","UnauthorizedException","configService","secret","get","Error","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","ignoreExpiration","secretOrKey"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARqC;wBACpB;0BACG;6BACI;0BACP;;;;;;;;;;AAIvB,IAAA,AAAMA,cAAN,MAAMA,oBAAoBC,IAAAA,0BAAgB,EAACC,qBAAQ,EAAE;IAiB1D,MAAMC,SAASC,OAAmB,EAAuB;QACvD,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIL,QAAQM,GAAG;YAAC;YACzBC,QAAQ;gBAAEF,IAAI;gBAAMG,OAAO;gBAAMC,UAAU;YAAK;QAClD;QAEA,IAAI,CAACR,QAAQ,CAACA,KAAKQ,QAAQ,EAAE;YAC3B,MAAM,IAAIC,6BAAqB,CAAC;QAClC;QAEA,OAAO;YAAEJ,KAAKN,QAAQM,GAAG;YAAEE,OAAOR,QAAQQ,KAAK;QAAC;IAClD;IA3BA,YACEG,aAA4B,EAC5B,AAAQT,MAAqB,CAC7B;QACA,MAAMU,SAASD,cAAcE,GAAG,CAAS;QACzC,IAAI,CAACD,QAAQ;YACX,MAAM,IAAIE,MAAM;QAClB;QAEA,KAAK,CAAC;YACJC,gBAAgBC,uBAAU,CAACC,2BAA2B;YACtDC,kBAAkB;YAClBC,aAAaP;QACf,SAXQV,SAAAA;IAYV;AAcF"}