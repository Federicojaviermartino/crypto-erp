# Render Blueprint for Crypto ERP
# https://render.com/docs/blueprint-spec
# Cost-optimized: API only ($7/month) + External DB (Supabase/Neon free)

services:
  # ============================================================================
  # NestJS API Backend (Main Application)
  # ============================================================================
  - type: web
    name: crypto-erp-api
    env: node
    region: frankfurt
    plan: starter
    buildCommand: npm ci && npm run build:api && npm run db:migrate:prod
    startCommand: npm run start:api:prod
    healthCheckPath: /api/v1/health/liveness
    envVars:
      # Environment
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: API_PREFIX
        value: api/v1

      # Database (External - Supabase/Neon free tier)
      # Add manually after creating DB in Supabase or Neon
      - key: DATABASE_URL
        sync: false

      # Redis (Upstash free tier)
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        sync: false
      - key: REDIS_PASSWORD
        sync: false
      - key: REDIS_DB
        value: 0

      # JWT Authentication
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: JWT_EXPIRATION
        value: 1h
      - key: JWT_REFRESH_EXPIRATION
        value: 7d

      # Encryption (for OAuth tokens, etc.)
      - key: ENCRYPTION_KEY
        generateValue: true

      # CORS
      - key: CORS_ORIGINS
        sync: false

      # AI (OpenAI for chat and OCR)
      - key: OPENAI_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false

      # Blockchain APIs
      - key: COVALENT_API_KEY
        sync: false

      # Error Tracking (Sentry)
      - key: SENTRY_DSN
        sync: false

  # ============================================================================
  # Angular Frontend (Static Site) - FREE
  # ============================================================================
  - type: web
    name: crypto-erp-web
    env: static
    buildCommand: npm ci && npm run build:web
    staticPublishPath: ./apps/web/dist/web/browser
    routes:
      # Proxy API requests to backend
      - type: rewrite
        source: /api/*
        destination: https://crypto-erp-api.onrender.com/api/*
      # SPA fallback
      - type: rewrite
        source: /*
        destination: /index.html
    headers:
      # Security headers
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin

# No managed database - using external free tier (Supabase/Neon)
