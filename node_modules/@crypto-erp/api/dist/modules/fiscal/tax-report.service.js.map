{"version":3,"sources":["../../../src/modules/fiscal/tax-report.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\n\n/**\n * Servicio de Reportes Fiscales FIFO\n * Calcula ganancias/pérdidas patrimoniales según método FIFO\n * para la declaración del IRPF en España\n */\n\ninterface CostLot {\n  id: string;\n  assetSymbol: string;\n  quantity: number;\n  costBasisEur: number; // Precio de adquisición por unidad\n  acquisitionDate: Date;\n  source: string;\n  remaining: number; // Cantidad restante en el lote\n}\n\ninterface CapitalGain {\n  sellTransactionId: string;\n  assetSymbol: string;\n  sellDate: Date;\n  sellQuantity: number;\n  sellPriceEur: number;\n  sellTotalEur: number;\n\n  // Lotes consumidos (FIFO)\n  lots: Array<{\n    acquisitionDate: Date;\n    quantityUsed: number;\n    costBasisPerUnit: number;\n    costBasisTotal: number;\n  }>;\n\n  // Cálculo de ganancia/pérdida\n  totalCostBasis: number;\n  capitalGain: number; // Positivo = ganancia, Negativo = pérdida\n\n  // Clasificación temporal (España)\n  holdingPeriodDays: number;\n  isShortTerm: boolean; // < 1 año\n\n  // Tipo impositivo aproximado\n  taxBracket: number;\n  estimatedTax: number;\n}\n\ninterface TaxReportSummary {\n  year: number;\n  generatedAt: Date;\n\n  // Resumen por período\n  shortTermGains: number; // < 1 año\n  shortTermLosses: number;\n  longTermGains: number; // >= 1 año\n  longTermLosses: number;\n\n  // Totales\n  totalGains: number;\n  totalLosses: number;\n  netCapitalGain: number;\n\n  // Impuestos estimados\n  estimatedTax: number;\n\n  // Detalle de operaciones\n  transactions: CapitalGain[];\n\n  // Por activo\n  byAsset: Record<string, {\n    symbol: string;\n    totalGain: number;\n    totalLoss: number;\n    netGain: number;\n    transactionCount: number;\n  }>;\n}\n\n@Injectable()\nexport class TaxReportService {\n  private readonly logger = new Logger(TaxReportService.name);\n\n  // Tramos IRPF base del ahorro 2024 (España)\n  private readonly taxBrackets = [\n    { limit: 6000, rate: 0.19 },\n    { limit: 50000, rate: 0.21 },\n    { limit: 200000, rate: 0.23 },\n    { limit: 300000, rate: 0.27 },\n    { limit: Infinity, rate: 0.28 },\n  ];\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Genera el informe fiscal completo para un año\n   */\n  async generateTaxReport(companyId: string, year: number): Promise<TaxReportSummary> {\n    const startDate = new Date(year, 0, 1);\n    const endDate = new Date(year, 11, 31, 23, 59, 59);\n\n    // Obtener wallets de la compañía\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    // Obtener todas las transacciones de venta del año (TRANSFER_OUT y SWAP)\n    const sellTransactions = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_OUT', 'SWAP'] },\n        blockTimestamp: {\n          gte: startDate,\n          lte: endDate,\n        },\n      },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n\n    const transactions: CapitalGain[] = [];\n    const byAsset: TaxReportSummary['byAsset'] = {};\n\n    // Obtener todos los lotes de compra históricos\n    const costLots = await this.buildCostLots(companyId, walletIds, endDate);\n\n    for (const sellTx of sellTransactions) {\n      const assetSymbol = sellTx.assetOut || 'UNKNOWN';\n      const assetLots = costLots.get(assetSymbol) || [];\n      const capitalGain = this.calculateCapitalGain(sellTx, assetLots);\n\n      if (capitalGain) {\n        transactions.push(capitalGain);\n\n        // Agregar al resumen por activo\n        if (!byAsset[assetSymbol]) {\n          byAsset[assetSymbol] = {\n            symbol: assetSymbol,\n            totalGain: 0,\n            totalLoss: 0,\n            netGain: 0,\n            transactionCount: 0,\n          };\n        }\n\n        byAsset[assetSymbol].transactionCount++;\n        if (capitalGain.capitalGain >= 0) {\n          byAsset[assetSymbol].totalGain += capitalGain.capitalGain;\n        } else {\n          byAsset[assetSymbol].totalLoss += Math.abs(capitalGain.capitalGain);\n        }\n        byAsset[assetSymbol].netGain += capitalGain.capitalGain;\n      }\n    }\n\n    // Calcular totales\n    let shortTermGains = 0;\n    let shortTermLosses = 0;\n    let longTermGains = 0;\n    let longTermLosses = 0;\n\n    for (const tx of transactions) {\n      if (tx.isShortTerm) {\n        if (tx.capitalGain >= 0) {\n          shortTermGains += tx.capitalGain;\n        } else {\n          shortTermLosses += Math.abs(tx.capitalGain);\n        }\n      } else {\n        if (tx.capitalGain >= 0) {\n          longTermGains += tx.capitalGain;\n        } else {\n          longTermLosses += Math.abs(tx.capitalGain);\n        }\n      }\n    }\n\n    const totalGains = shortTermGains + longTermGains;\n    const totalLosses = shortTermLosses + longTermLosses;\n    const netCapitalGain = totalGains - totalLosses;\n\n    // Calcular impuesto estimado\n    const estimatedTax = this.calculateTax(Math.max(0, netCapitalGain));\n\n    const summary: TaxReportSummary = {\n      year,\n      generatedAt: new Date(),\n      shortTermGains,\n      shortTermLosses,\n      longTermGains,\n      longTermLosses,\n      totalGains,\n      totalLosses,\n      netCapitalGain,\n      estimatedTax,\n      transactions,\n      byAsset,\n    };\n\n    this.logger.log(\n      `Tax report generated for ${year}: ${transactions.length} transactions, ` +\n      `net gain: ${netCapitalGain.toFixed(2)} EUR, estimated tax: ${estimatedTax.toFixed(2)} EUR`\n    );\n\n    return summary;\n  }\n\n  /**\n   * Construye los lotes de costo (FIFO) a partir de las compras\n   */\n  private async buildCostLots(\n    companyId: string,\n    walletIds: string[],\n    upToDate: Date,\n  ): Promise<Map<string, CostLot[]>> {\n    // Transacciones de entrada (compras/depósitos)\n    const buyTransactions = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_IN', 'CLAIM_REWARD', 'AIRDROP'] },\n        blockTimestamp: { lte: upToDate },\n      },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n\n    // Transacciones de salida previas\n    const sellTransactions = await this.prisma.cryptoTransaction.findMany({\n      where: {\n        walletId: { in: walletIds },\n        type: { in: ['TRANSFER_OUT', 'SWAP'] },\n        blockTimestamp: { lte: upToDate },\n      },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n\n    const lotsByAsset = new Map<string, CostLot[]>();\n\n    // Crear lotes de compra\n    for (const tx of buyTransactions) {\n      const assetSymbol = tx.assetIn || 'UNKNOWN';\n      if (!lotsByAsset.has(assetSymbol)) {\n        lotsByAsset.set(assetSymbol, []);\n      }\n\n      const quantity = tx.amountIn?.toNumber() || 0;\n      const priceEur = tx.priceInEur?.toNumber() || 0;\n      const totalEur = quantity * priceEur;\n      const costBasis = quantity > 0 ? totalEur / quantity : 0;\n\n      lotsByAsset.get(assetSymbol)!.push({\n        id: tx.id,\n        assetSymbol,\n        quantity,\n        costBasisEur: costBasis,\n        acquisitionDate: tx.blockTimestamp,\n        source: tx.subtype || 'MANUAL',\n        remaining: quantity,\n      });\n    }\n\n    // Consumir lotes según ventas previas (FIFO)\n    for (const sellTx of sellTransactions) {\n      const assetSymbol = sellTx.assetOut || 'UNKNOWN';\n      const lots = lotsByAsset.get(assetSymbol) || [];\n      let remaining = sellTx.amountOut?.toNumber() || 0;\n\n      for (const lot of lots) {\n        if (remaining <= 0) break;\n        if (lot.remaining <= 0) continue;\n\n        const toConsume = Math.min(lot.remaining, remaining);\n        lot.remaining -= toConsume;\n        remaining -= toConsume;\n      }\n    }\n\n    return lotsByAsset;\n  }\n\n  /**\n   * Calcula la ganancia/pérdida patrimonial de una venta usando FIFO\n   */\n  private calculateCapitalGain(\n    sellTx: {\n      id: string;\n      amountOut: { toNumber(): number } | null;\n      priceOutEur: { toNumber(): number } | null;\n      assetOut: string | null;\n      blockTimestamp: Date;\n    },\n    lots: CostLot[],\n  ): CapitalGain | null {\n    const sellQuantity = sellTx.amountOut?.toNumber() || 0;\n    const sellPriceEur = sellTx.priceOutEur?.toNumber() || 0;\n    const sellTotalEur = sellQuantity * sellPriceEur;\n    const assetSymbol = sellTx.assetOut || 'UNKNOWN';\n\n    if (sellQuantity <= 0 || sellTotalEur <= 0) {\n      return null;\n    }\n\n    let remaining = sellQuantity;\n    let totalCostBasis = 0;\n    const usedLots: CapitalGain['lots'] = [];\n    let earliestAcquisition: Date | null = null;\n\n    // Consumir lotes FIFO\n    for (const lot of lots) {\n      if (remaining <= 0) break;\n      if (lot.remaining <= 0) continue;\n\n      const toUse = Math.min(lot.remaining, remaining);\n      const lotCost = toUse * lot.costBasisEur;\n\n      usedLots.push({\n        acquisitionDate: lot.acquisitionDate,\n        quantityUsed: toUse,\n        costBasisPerUnit: lot.costBasisEur,\n        costBasisTotal: lotCost,\n      });\n\n      totalCostBasis += lotCost;\n      remaining -= toUse;\n      lot.remaining -= toUse;\n\n      if (!earliestAcquisition || lot.acquisitionDate < earliestAcquisition) {\n        earliestAcquisition = lot.acquisitionDate;\n      }\n    }\n\n    // Si no hay lotes suficientes, calcular con costo 0 (como si fuera ganancia total)\n    if (remaining > 0) {\n      this.logger.warn(\n        `Insufficient cost basis for sell transaction ${sellTx.id}. ` +\n        `Missing ${remaining} units of ${assetSymbol}`\n      );\n    }\n\n    const capitalGain = sellTotalEur - totalCostBasis;\n\n    // Calcular período de tenencia usando la fecha más antigua\n    const holdingPeriodDays = earliestAcquisition\n      ? Math.floor((sellTx.blockTimestamp.getTime() - earliestAcquisition.getTime()) / (1000 * 60 * 60 * 24))\n      : 0;\n\n    const isShortTerm = holdingPeriodDays < 365;\n\n    // Calcular impuesto estimado de esta operación\n    const taxBracket = this.getTaxBracket(capitalGain);\n    const estimatedTax = capitalGain > 0 ? capitalGain * taxBracket : 0;\n\n    return {\n      sellTransactionId: sellTx.id,\n      assetSymbol,\n      sellDate: sellTx.blockTimestamp,\n      sellQuantity,\n      sellPriceEur,\n      sellTotalEur,\n      lots: usedLots,\n      totalCostBasis,\n      capitalGain,\n      holdingPeriodDays,\n      isShortTerm,\n      taxBracket,\n      estimatedTax,\n    };\n  }\n\n  /**\n   * Calcula el impuesto según tramos de la base del ahorro\n   */\n  private calculateTax(gain: number): number {\n    if (gain <= 0) return 0;\n\n    let tax = 0;\n    let remaining = gain;\n    let previousLimit = 0;\n\n    for (const bracket of this.taxBrackets) {\n      const bracketAmount = Math.min(remaining, bracket.limit - previousLimit);\n      if (bracketAmount <= 0) break;\n\n      tax += bracketAmount * bracket.rate;\n      remaining -= bracketAmount;\n      previousLimit = bracket.limit;\n    }\n\n    return tax;\n  }\n\n  /**\n   * Obtiene el tramo impositivo aproximado\n   */\n  private getTaxBracket(gain: number): number {\n    if (gain <= 0) return 0;\n\n    for (const bracket of this.taxBrackets) {\n      if (gain <= bracket.limit) {\n        return bracket.rate;\n      }\n    }\n    return this.taxBrackets[this.taxBrackets.length - 1].rate;\n  }\n\n  /**\n   * Exporta el informe a CSV\n   */\n  async exportToCSV(companyId: string, year: number): Promise<string> {\n    const report = await this.generateTaxReport(companyId, year);\n\n    const headers = [\n      'Fecha Venta',\n      'Activo',\n      'Cantidad',\n      'Precio Venta (EUR)',\n      'Total Venta (EUR)',\n      'Fecha Adquisición',\n      'Costo Base (EUR)',\n      'Ganancia/Pérdida (EUR)',\n      'Días Tenencia',\n      'Tipo',\n      'Tramo IRPF',\n      'Impuesto Est. (EUR)',\n    ];\n\n    const rows = report.transactions.flatMap(tx => {\n      if (tx.lots.length === 0) {\n        return [[\n          tx.sellDate.toISOString().split('T')[0],\n          tx.assetSymbol,\n          tx.sellQuantity.toFixed(8),\n          tx.sellPriceEur.toFixed(2),\n          tx.sellTotalEur.toFixed(2),\n          'N/A',\n          '0.00',\n          tx.capitalGain.toFixed(2),\n          tx.holdingPeriodDays.toString(),\n          tx.isShortTerm ? 'Corto plazo' : 'Largo plazo',\n          (tx.taxBracket * 100).toFixed(0) + '%',\n          tx.estimatedTax.toFixed(2),\n        ]];\n      }\n\n      return tx.lots.map((lot, index) => [\n        tx.sellDate.toISOString().split('T')[0],\n        tx.assetSymbol,\n        lot.quantityUsed.toFixed(8),\n        tx.sellPriceEur.toFixed(2),\n        (lot.quantityUsed * tx.sellPriceEur).toFixed(2),\n        lot.acquisitionDate.toISOString().split('T')[0],\n        lot.costBasisTotal.toFixed(2),\n        index === 0 ? tx.capitalGain.toFixed(2) : '',\n        tx.holdingPeriodDays.toString(),\n        tx.isShortTerm ? 'Corto plazo' : 'Largo plazo',\n        (tx.taxBracket * 100).toFixed(0) + '%',\n        index === 0 ? tx.estimatedTax.toFixed(2) : '',\n      ]);\n    });\n\n    const summary = [\n      '',\n      'RESUMEN',\n      `Año;${year}`,\n      `Ganancias corto plazo;${report.shortTermGains.toFixed(2)}`,\n      `Pérdidas corto plazo;${report.shortTermLosses.toFixed(2)}`,\n      `Ganancias largo plazo;${report.longTermGains.toFixed(2)}`,\n      `Pérdidas largo plazo;${report.longTermLosses.toFixed(2)}`,\n      `Total ganancias;${report.totalGains.toFixed(2)}`,\n      `Total pérdidas;${report.totalLosses.toFixed(2)}`,\n      `Ganancia neta;${report.netCapitalGain.toFixed(2)}`,\n      `Impuesto estimado;${report.estimatedTax.toFixed(2)}`,\n    ];\n\n    return [\n      headers.join(';'),\n      ...rows.map(row => row.join(';')),\n      ...summary,\n    ].join('\\n');\n  }\n\n  /**\n   * Genera datos para el Modelo 100 (IRPF)\n   */\n  async generateIRPFData(companyId: string, year: number): Promise<{\n    baseImponibleAhorro: number;\n    gananciasPatrimoniales: number;\n    perdidasPatrimoniales: number;\n    saldoNeto: number;\n    cuotaIntegra: number;\n  }> {\n    const report = await this.generateTaxReport(companyId, year);\n\n    return {\n      baseImponibleAhorro: Math.max(0, report.netCapitalGain),\n      gananciasPatrimoniales: report.totalGains,\n      perdidasPatrimoniales: report.totalLosses,\n      saldoNeto: report.netCapitalGain,\n      cuotaIntegra: report.estimatedTax,\n    };\n  }\n}\n"],"names":["TaxReportService","generateTaxReport","companyId","year","startDate","Date","endDate","wallets","prisma","wallet","findMany","where","select","id","walletIds","map","w","sellTransactions","cryptoTransaction","walletId","in","type","blockTimestamp","gte","lte","orderBy","transactions","byAsset","costLots","buildCostLots","sellTx","assetSymbol","assetOut","assetLots","get","capitalGain","calculateCapitalGain","push","symbol","totalGain","totalLoss","netGain","transactionCount","Math","abs","shortTermGains","shortTermLosses","longTermGains","longTermLosses","tx","isShortTerm","totalGains","totalLosses","netCapitalGain","estimatedTax","calculateTax","max","summary","generatedAt","logger","log","length","toFixed","upToDate","buyTransactions","lotsByAsset","Map","assetIn","has","set","quantity","amountIn","toNumber","priceEur","priceInEur","totalEur","costBasis","costBasisEur","acquisitionDate","source","subtype","remaining","lots","amountOut","lot","toConsume","min","sellQuantity","sellPriceEur","priceOutEur","sellTotalEur","totalCostBasis","usedLots","earliestAcquisition","toUse","lotCost","quantityUsed","costBasisPerUnit","costBasisTotal","warn","holdingPeriodDays","floor","getTime","taxBracket","getTaxBracket","sellTransactionId","sellDate","gain","tax","previousLimit","bracket","taxBrackets","bracketAmount","limit","rate","exportToCSV","report","headers","rows","flatMap","toISOString","split","toString","index","join","row","generateIRPFData","baseImponibleAhorro","gananciasPatrimoniales","perdidasPatrimoniales","saldoNeto","cuotaIntegra","Logger","name","Infinity"],"mappings":"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"}