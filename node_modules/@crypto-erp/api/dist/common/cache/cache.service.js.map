{"version":3,"sources":["../../../src/common/cache/cache.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Redis } from 'ioredis';\n\nexport interface CacheOptions {\n  ttl?: number; // Time to live in seconds\n  prefix?: string;\n}\n\n@Injectable()\nexport class CacheService {\n  private readonly logger = new Logger(CacheService.name);\n  private redis: Redis | null = null;\n  private readonly defaultTTL = 3600; // 1 hour\n\n  constructor(private configService: ConfigService) {\n    this.initializeRedis();\n  }\n\n  private initializeRedis(): void {\n    try {\n      const redisUrl = this.configService.get<string>('REDIS_URL');\n      if (redisUrl) {\n        this.redis = new Redis(redisUrl, {\n          maxRetriesPerRequest: 3,\n          retryStrategy: (times) => {\n            if (times > 3) {\n              this.logger.error('Redis connection failed after 3 retries');\n              return null;\n            }\n            return Math.min(times * 200, 1000);\n          },\n        });\n\n        this.redis.on('connect', () => {\n          this.logger.log('Redis connected successfully');\n        });\n\n        this.redis.on('error', (err) => {\n          this.logger.error('Redis connection error:', err);\n        });\n      } else {\n        this.logger.warn('Redis URL not configured, caching will be disabled');\n      }\n    } catch (error) {\n      this.logger.error('Failed to initialize Redis:', error);\n    }\n  }\n\n  /**\n   * Get a value from cache\n   */\n  async get<T>(key: string, options?: CacheOptions): Promise<T | null> {\n    if (!this.redis) return null;\n\n    try {\n      const fullKey = this.buildKey(key, options);\n      const value = await this.redis.get(fullKey);\n\n      if (!value) return null;\n\n      return JSON.parse(value) as T;\n    } catch (error) {\n      this.logger.error(`Cache get error for key ${key}:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Set a value in cache\n   */\n  async set<T>(key: string, value: T, options?: CacheOptions): Promise<void> {\n    if (!this.redis) return;\n\n    try {\n      const fullKey = this.buildKey(key, options);\n      const ttl = options?.ttl || this.defaultTTL;\n      const serialized = JSON.stringify(value);\n\n      await this.redis.setex(fullKey, ttl, serialized);\n    } catch (error) {\n      this.logger.error(`Cache set error for key ${key}:`, error);\n    }\n  }\n\n  /**\n   * Delete a value from cache\n   */\n  async delete(key: string, options?: CacheOptions): Promise<void> {\n    if (!this.redis) return;\n\n    try {\n      const fullKey = this.buildKey(key, options);\n      await this.redis.del(fullKey);\n    } catch (error) {\n      this.logger.error(`Cache delete error for key ${key}:`, error);\n    }\n  }\n\n  /**\n   * Delete multiple keys by pattern\n   */\n  async deletePattern(pattern: string, options?: CacheOptions): Promise<void> {\n    if (!this.redis) return;\n\n    try {\n      const fullPattern = this.buildKey(pattern, options);\n      const keys = await this.redis.keys(fullPattern);\n\n      if (keys.length > 0) {\n        await this.redis.del(...keys);\n        this.logger.log(`Deleted ${keys.length} keys matching pattern: ${fullPattern}`);\n      }\n    } catch (error) {\n      this.logger.error(`Cache delete pattern error for ${pattern}:`, error);\n    }\n  }\n\n  /**\n   * Get or set pattern - fetch from cache or execute function and cache result\n   */\n  async getOrSet<T>(\n    key: string,\n    fetchFn: () => Promise<T>,\n    options?: CacheOptions\n  ): Promise<T> {\n    // Try to get from cache first\n    const cached = await this.get<T>(key, options);\n    if (cached !== null) {\n      this.logger.debug(`Cache hit for key: ${key}`);\n      return cached;\n    }\n\n    // Cache miss - fetch data\n    this.logger.debug(`Cache miss for key: ${key}, fetching...`);\n    const data = await fetchFn();\n\n    // Store in cache for next time\n    await this.set(key, data, options);\n\n    return data;\n  }\n\n  /**\n   * Invalidate all cache entries for a company\n   */\n  async invalidateCompanyCache(companyId: string): Promise<void> {\n    await this.deletePattern(`company:${companyId}:*`);\n  }\n\n  /**\n   * Invalidate all cache entries for a user\n   */\n  async invalidateUserCache(userId: string): Promise<void> {\n    await this.deletePattern(`user:${userId}:*`);\n  }\n\n  /**\n   * Build full cache key with prefix\n   */\n  private buildKey(key: string, options?: CacheOptions): string {\n    const prefix = options?.prefix || 'crypto-erp';\n    return `${prefix}:${key}`;\n  }\n\n  /**\n   * Health check\n   */\n  async isHealthy(): Promise<boolean> {\n    if (!this.redis) return false;\n\n    try {\n      const result = await this.redis.ping();\n      return result === 'PONG';\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Get cache statistics\n   */\n  async getStats(): Promise<{ hits: number; misses: number; keys: number }> {\n    if (!this.redis) {\n      return { hits: 0, misses: 0, keys: 0 };\n    }\n\n    try {\n      const info = await this.redis.info('stats');\n      const hits = this.parseInfoValue(info, 'keyspace_hits');\n      const misses = this.parseInfoValue(info, 'keyspace_misses');\n\n      const dbSize = await this.redis.dbsize();\n\n      return {\n        hits,\n        misses,\n        keys: dbSize,\n      };\n    } catch (error) {\n      this.logger.error('Failed to get cache stats:', error);\n      return { hits: 0, misses: 0, keys: 0 };\n    }\n  }\n\n  private parseInfoValue(info: string, key: string): number {\n    const match = info.match(new RegExp(`${key}:(\\\\d+)`));\n    return match ? parseInt(match[1], 10) : 0;\n  }\n\n  /**\n   * Clear all cache\n   */\n  async clearAll(): Promise<void> {\n    if (!this.redis) return;\n\n    try {\n      await this.redis.flushdb();\n      this.logger.log('All cache cleared');\n    } catch (error) {\n      this.logger.error('Failed to clear cache:', error);\n    }\n  }\n\n  /**\n   * Cleanup on module destroy\n   */\n  async onModuleDestroy() {\n    if (this.redis) {\n      await this.redis.quit();\n    }\n  }\n}\n"],"names":["CacheService","initializeRedis","redisUrl","configService","get","redis","Redis","maxRetriesPerRequest","retryStrategy","times","logger","error","Math","min","on","log","err","warn","key","options","fullKey","buildKey","value","JSON","parse","set","ttl","defaultTTL","serialized","stringify","setex","delete","del","deletePattern","pattern","fullPattern","keys","length","getOrSet","fetchFn","cached","debug","data","invalidateCompanyCache","companyId","invalidateUserCache","userId","prefix","isHealthy","result","ping","getStats","hits","misses","info","parseInfoValue","dbSize","dbsize","match","RegExp","parseInt","clearAll","flushdb","onModuleDestroy","quit","Logger","name"],"mappings":"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"}