{"version":3,"sources":["../../../src/modules/fiscal/tax-report.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Param,\n  Headers,\n  BadRequestException,\n  Res,\n} from '@nestjs/common';\nimport { Response } from 'express';\nimport { TaxReportService } from './tax-report.service.js';\n\n@Controller('fiscal/tax-report')\nexport class TaxReportController {\n  constructor(private readonly taxReportService: TaxReportService) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  @Get(':year')\n  async getTaxReport(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2015 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.taxReportService.generateTaxReport(companyId, year);\n  }\n\n  @Get(':year/summary')\n  async getTaxSummary(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2015 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    const report = await this.taxReportService.generateTaxReport(companyId, year);\n\n    // Return only summary without full transaction list\n    return {\n      year: report.year,\n      generatedAt: report.generatedAt,\n      shortTermGains: report.shortTermGains,\n      shortTermLosses: report.shortTermLosses,\n      longTermGains: report.longTermGains,\n      longTermLosses: report.longTermLosses,\n      totalGains: report.totalGains,\n      totalLosses: report.totalLosses,\n      netCapitalGain: report.netCapitalGain,\n      estimatedTax: report.estimatedTax,\n      transactionCount: report.transactions.length,\n      byAsset: report.byAsset,\n    };\n  }\n\n  @Get(':year/irpf')\n  async getIRPFData(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2015 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.taxReportService.generateIRPFData(companyId, year);\n  }\n\n  @Get(':year/export/csv')\n  async exportCSV(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n    @Res() res: Response,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2015 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    const csv = await this.taxReportService.exportToCSV(companyId, year);\n\n    res.setHeader('Content-Type', 'text/csv; charset=utf-8');\n    res.setHeader('Content-Disposition', `attachment; filename=tax_report_${year}.csv`);\n    res.send('\\uFEFF' + csv); // BOM for Excel UTF-8\n  }\n}\n"],"names":["TaxReportController","getCompanyId","headers","companyId","BadRequestException","getTaxReport","yearStr","year","parseInt","isNaN","Date","getFullYear","taxReportService","generateTaxReport","getTaxSummary","report","generatedAt","shortTermGains","shortTermLosses","longTermGains","longTermLosses","totalGains","totalLosses","netCapitalGain","estimatedTax","transactionCount","transactions","length","byAsset","getIRPFData","generateIRPFData","exportCSV","res","csv","exportToCSV","setHeader","send"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBALN;yBACkB;kCACQ;;;;;;;;;;;;;;;AAG1B,IAAA,AAAMA,sBAAN,MAAMA;IAGHC,aAAaC,OAA+B,EAAU;QAC5D,MAAMC,YAAYD,OAAO,CAAC,eAAe;QACzC,IAAI,CAACC,WAAW;YACd,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QACA,OAAOD;IACT;IAEA,MACME,aACJ,AAAWH,OAA+B,EAC1C,AAAeI,OAAe,EAC9B;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,MAAMK,OAAOC,SAASF,SAAS;QAE/B,IAAIG,MAAMF,SAASA,OAAO,QAAQA,OAAO,IAAIG,OAAOC,WAAW,IAAI;YACjE,MAAM,IAAIP,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACQ,gBAAgB,CAACC,iBAAiB,CAACV,WAAWI;IAC5D;IAEA,MACMO,cACJ,AAAWZ,OAA+B,EAC1C,AAAeI,OAAe,EAC9B;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,MAAMK,OAAOC,SAASF,SAAS;QAE/B,IAAIG,MAAMF,SAASA,OAAO,QAAQA,OAAO,IAAIG,OAAOC,WAAW,IAAI;YACjE,MAAM,IAAIP,2BAAmB,CAAC;QAChC;QAEA,MAAMW,SAAS,MAAM,IAAI,CAACH,gBAAgB,CAACC,iBAAiB,CAACV,WAAWI;QAExE,oDAAoD;QACpD,OAAO;YACLA,MAAMQ,OAAOR,IAAI;YACjBS,aAAaD,OAAOC,WAAW;YAC/BC,gBAAgBF,OAAOE,cAAc;YACrCC,iBAAiBH,OAAOG,eAAe;YACvCC,eAAeJ,OAAOI,aAAa;YACnCC,gBAAgBL,OAAOK,cAAc;YACrCC,YAAYN,OAAOM,UAAU;YAC7BC,aAAaP,OAAOO,WAAW;YAC/BC,gBAAgBR,OAAOQ,cAAc;YACrCC,cAAcT,OAAOS,YAAY;YACjCC,kBAAkBV,OAAOW,YAAY,CAACC,MAAM;YAC5CC,SAASb,OAAOa,OAAO;QACzB;IACF;IAEA,MACMC,YACJ,AAAW3B,OAA+B,EAC1C,AAAeI,OAAe,EAC9B;QACA,MAAMH,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,MAAMK,OAAOC,SAASF,SAAS;QAE/B,IAAIG,MAAMF,SAASA,OAAO,QAAQA,OAAO,IAAIG,OAAOC,WAAW,IAAI;YACjE,MAAM,IAAIP,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACQ,gBAAgB,CAACkB,gBAAgB,CAAC3B,WAAWI;IAC3D;IAEA,MACMwB,UACJ,AAAW7B,OAA+B,EAC1C,AAAeI,OAAe,EAC9B,AAAO0B,GAAa,EACpB;QACA,MAAM7B,YAAY,IAAI,CAACF,YAAY,CAACC;QACpC,MAAMK,OAAOC,SAASF,SAAS;QAE/B,IAAIG,MAAMF,SAASA,OAAO,QAAQA,OAAO,IAAIG,OAAOC,WAAW,IAAI;YACjE,MAAM,IAAIP,2BAAmB,CAAC;QAChC;QAEA,MAAM6B,MAAM,MAAM,IAAI,CAACrB,gBAAgB,CAACsB,WAAW,CAAC/B,WAAWI;QAE/DyB,IAAIG,SAAS,CAAC,gBAAgB;QAC9BH,IAAIG,SAAS,CAAC,uBAAuB,CAAC,gCAAgC,EAAE5B,KAAK,IAAI,CAAC;QAClFyB,IAAII,IAAI,CAAC,WAAWH,MAAM,sBAAsB;IAClD;IAzFA,YAAY,AAAiBrB,gBAAkC,CAAE;aAApCA,mBAAAA;IAAqC;AA0FpE"}