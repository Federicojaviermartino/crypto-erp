{"version":3,"sources":["../../../src/modules/gdpr/gdpr.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Delete,\n  Body,\n  UseGuards,\n  UnauthorizedException,\n  Header,\n} from '@nestjs/common';\nimport { GDPRService } from './gdpr.service';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\nimport { GetUser } from '../auth/decorators/get-user.decorator';\nimport { DeleteAccountDto } from './dto/delete-account.dto';\nimport { PrismaService } from '@crypto-erp/database';\nimport * as bcrypt from 'bcrypt';\n\n@Controller('gdpr')\n@UseGuards(JwtAuthGuard)\nexport class GDPRController {\n  constructor(\n    private readonly gdprService: GDPRService,\n    private readonly prisma: PrismaService,\n  ) {}\n\n  /**\n   * Export all user data (GDPR Right to Data Portability)\n   */\n  @Get('export')\n  @Header('Content-Type', 'application/json')\n  @Header('Content-Disposition', 'attachment; filename=\"my-data-export.json\"')\n  async exportMyData(@GetUser('id') userId: string) {\n    const data = await this.gdprService.exportUserData(userId);\n\n    return data;\n  }\n\n  /**\n   * Check if user can delete their account\n   */\n  @Get('can-delete')\n  async canDeleteAccount(@GetUser('id') userId: string) {\n    return this.gdprService.canDeleteUser(userId);\n  }\n\n  /**\n   * Delete user account (GDPR Right to be Forgotten)\n   * Requires password confirmation\n   */\n  @Delete('delete-account')\n  async deleteMyAccount(\n    @GetUser('id') userId: string,\n    @Body() dto: DeleteAccountDto,\n  ) {\n    // Verify password first\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n    });\n\n    if (!user) {\n      throw new UnauthorizedException('User not found');\n    }\n\n    const isValidPassword = await bcrypt.compare(dto.password, user.passwordHash);\n\n    if (!isValidPassword) {\n      throw new UnauthorizedException('Invalid password');\n    }\n\n    // Check if user can be deleted\n    const { canDelete, reasons } = await this.gdprService.canDeleteUser(userId);\n\n    if (!canDelete) {\n      throw new UnauthorizedException({\n        message: 'Cannot delete account',\n        reasons,\n      });\n    }\n\n    // Delete the account\n    await this.gdprService.deleteUserData(userId, dto.confirmation);\n\n    return {\n      message: 'Your account has been successfully deleted. All personal data has been anonymized.',\n    };\n  }\n}\n"],"names":["GDPRController","exportMyData","userId","data","gdprService","exportUserData","canDeleteAccount","canDeleteUser","deleteMyAccount","dto","user","prisma","findUnique","where","id","UnauthorizedException","isValidPassword","bcrypt","compare","password","passwordHash","canDelete","reasons","message","deleteUserData","confirmation"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBAVN;6BACqB;8BACC;kCACL;kCACS;0BACH;gEACN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIjB,IAAA,AAAMA,iBAAN,MAAMA;IAMX;;GAEC,GACD,MAGMC,aAAa,AAAeC,MAAc,EAAE;QAChD,MAAMC,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,cAAc,CAACH;QAEnD,OAAOC;IACT;IAEA;;GAEC,GACD,MACMG,iBAAiB,AAAeJ,MAAc,EAAE;QACpD,OAAO,IAAI,CAACE,WAAW,CAACG,aAAa,CAACL;IACxC;IAEA;;;GAGC,GACD,MACMM,gBACJ,AAAeN,MAAc,EAC7B,AAAQO,GAAqB,EAC7B;QACA,wBAAwB;QACxB,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIZ;YAAO;QACtB;QAEA,IAAI,CAACQ,MAAM;YACT,MAAM,IAAIK,6BAAqB,CAAC;QAClC;QAEA,MAAMC,kBAAkB,MAAMC,QAAOC,OAAO,CAACT,IAAIU,QAAQ,EAAET,KAAKU,YAAY;QAE5E,IAAI,CAACJ,iBAAiB;YACpB,MAAM,IAAID,6BAAqB,CAAC;QAClC;QAEA,+BAA+B;QAC/B,MAAM,EAAEM,SAAS,EAAEC,OAAO,EAAE,GAAG,MAAM,IAAI,CAAClB,WAAW,CAACG,aAAa,CAACL;QAEpE,IAAI,CAACmB,WAAW;YACd,MAAM,IAAIN,6BAAqB,CAAC;gBAC9BQ,SAAS;gBACTD;YACF;QACF;QAEA,qBAAqB;QACrB,MAAM,IAAI,CAAClB,WAAW,CAACoB,cAAc,CAACtB,QAAQO,IAAIgB,YAAY;QAE9D,OAAO;YACLF,SAAS;QACX;IACF;IAjEA,YACE,AAAiBnB,WAAwB,EACzC,AAAiBO,MAAqB,CACtC;aAFiBP,cAAAA;aACAO,SAAAA;IAChB;AA+DL"}