{"version":3,"sources":["../../../../src/modules/auth/strategies/azure-ad.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { BearerStrategy } from 'passport-azure-ad';\nimport { ConfigService } from '@nestjs/config';\nimport { AuthService } from '../auth.service';\n\n@Injectable()\nexport class AzureADStrategy extends PassportStrategy(BearerStrategy, 'azure-ad') {\n  constructor(\n    private configService: ConfigService,\n    private authService: AuthService,\n  ) {\n    super({\n      identityMetadata: `https://login.microsoftonline.com/${configService.get('AZURE_TENANT_ID')}/v2.0/.well-known/openid-configuration`,\n      clientID: configService.get<string>('AZURE_CLIENT_ID'),\n      validateIssuer: true,\n      issuer: `https://login.microsoftonline.com/${configService.get('AZURE_TENANT_ID')}/v2.0`,\n      passReqToCallback: false,\n      loggingLevel: 'warn',\n      scope: ['email', 'profile', 'openid'],\n    });\n  }\n\n  async validate(payload: any): Promise<any> {\n    try {\n      const { oid, preferred_username, name, email } = payload;\n\n      if (!email && !preferred_username) {\n        throw new UnauthorizedException('No email found in Azure AD profile');\n      }\n\n      const userEmail = email || preferred_username;\n      const nameParts = name?.split(' ') || ['', ''];\n\n      // Auto-provision or find existing SSO user\n      const user = await this.authService.findOrCreateSSOUser({\n        ssoProvider: 'azure',\n        ssoId: oid,\n        email: userEmail,\n        firstName: nameParts[0],\n        lastName: nameParts.slice(1).join(' ') || nameParts[0],\n        ssoMetadata: {\n          tenantId: payload.tid,\n          upn: payload.upn,\n          roles: payload.roles || [],\n        },\n      });\n\n      return user;\n    } catch (error) {\n      throw new UnauthorizedException(error.message);\n    }\n  }\n}\n"],"names":["AzureADStrategy","PassportStrategy","BearerStrategy","validate","payload","oid","preferred_username","name","email","UnauthorizedException","userEmail","nameParts","split","user","authService","findOrCreateSSOUser","ssoProvider","ssoId","firstName","lastName","slice","join","ssoMetadata","tenantId","tid","upn","roles","error","message","configService","identityMetadata","get","clientID","validateIssuer","issuer","passReqToCallback","loggingLevel","scope"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPqC;0BACjB;iCACF;wBACD;6BACF;;;;;;;;;;AAGrB,IAAA,AAAMA,kBAAN,MAAMA,wBAAwBC,IAAAA,0BAAgB,EAACC,+BAAc,EAAE;IAgBpE,MAAMC,SAASC,OAAY,EAAgB;QACzC,IAAI;YACF,MAAM,EAAEC,GAAG,EAAEC,kBAAkB,EAAEC,IAAI,EAAEC,KAAK,EAAE,GAAGJ;YAEjD,IAAI,CAACI,SAAS,CAACF,oBAAoB;gBACjC,MAAM,IAAIG,6BAAqB,CAAC;YAClC;YAEA,MAAMC,YAAYF,SAASF;YAC3B,MAAMK,YAAYJ,MAAMK,MAAM,QAAQ;gBAAC;gBAAI;aAAG;YAE9C,2CAA2C;YAC3C,MAAMC,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,mBAAmB,CAAC;gBACtDC,aAAa;gBACbC,OAAOZ;gBACPG,OAAOE;gBACPQ,WAAWP,SAAS,CAAC,EAAE;gBACvBQ,UAAUR,UAAUS,KAAK,CAAC,GAAGC,IAAI,CAAC,QAAQV,SAAS,CAAC,EAAE;gBACtDW,aAAa;oBACXC,UAAUnB,QAAQoB,GAAG;oBACrBC,KAAKrB,QAAQqB,GAAG;oBAChBC,OAAOtB,QAAQsB,KAAK,IAAI,EAAE;gBAC5B;YACF;YAEA,OAAOb;QACT,EAAE,OAAOc,OAAO;YACd,MAAM,IAAIlB,6BAAqB,CAACkB,MAAMC,OAAO;QAC/C;IACF;IA5CA,YACE,AAAQC,aAA4B,EACpC,AAAQf,WAAwB,CAChC;QACA,KAAK,CAAC;YACJgB,kBAAkB,CAAC,kCAAkC,EAAED,cAAcE,GAAG,CAAC,mBAAmB,sCAAsC,CAAC;YACnIC,UAAUH,cAAcE,GAAG,CAAS;YACpCE,gBAAgB;YAChBC,QAAQ,CAAC,kCAAkC,EAAEL,cAAcE,GAAG,CAAC,mBAAmB,KAAK,CAAC;YACxFI,mBAAmB;YACnBC,cAAc;YACdC,OAAO;gBAAC;gBAAS;gBAAW;aAAS;QACvC,SAXQR,gBAAAA,oBACAf,cAAAA;IAWV;AAgCF"}