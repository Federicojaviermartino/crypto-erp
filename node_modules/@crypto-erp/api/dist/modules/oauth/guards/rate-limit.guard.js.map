{"version":3,"sources":["../../../../src/modules/oauth/guards/rate-limit.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  CanActivate,\n  ExecutionContext,\n  HttpException,\n  HttpStatus,\n} from '@nestjs/common';\nimport { ApiUsageService } from '../api-usage.service.js';\nimport { OAuthService } from '../oauth.service.js';\n\n/**\n * Enhanced Rate Limiting Guard for OAuth Apps\n * Checks both hourly rate limits and daily quotas\n *\n * Usage:\n * @UseGuards(OAuthGuard, OAuthRateLimitGuard)\n * async someEndpoint() { ... }\n */\n@Injectable()\nexport class OAuthRateLimitGuard implements CanActivate {\n  constructor(\n    private readonly apiUsageService: ApiUsageService,\n    private readonly oauthService: OAuthService,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const response = context.switchToHttp().getResponse();\n\n    // Check if request has OAuth context (set by OAuthGuard)\n    const oauth = request.oauth;\n    if (!oauth || !oauth.app) {\n      // Not an OAuth request, allow through\n      return true;\n    }\n\n    const appId = oauth.app.id;\n\n    // Get app details for rate limits\n    const app = await this.oauthService.getAppByClientId(oauth.app.clientId);\n\n    // Check hourly rate limit\n    const hourlyCount = await this.apiUsageService.getHourlyRequestCount(appId);\n    if (hourlyCount >= app.rateLimit) {\n      const resetTime = new Date(\n        Math.ceil(Date.now() / (60 * 60 * 1000)) * 60 * 60 * 1000,\n      );\n\n      response.setHeader('X-RateLimit-Limit', app.rateLimit.toString());\n      response.setHeader('X-RateLimit-Remaining', '0');\n      response.setHeader(\n        'X-RateLimit-Reset',\n        Math.floor(resetTime.getTime() / 1000).toString(),\n      );\n      response.setHeader('Retry-After', Math.ceil((resetTime.getTime() - Date.now()) / 1000).toString());\n\n      throw new HttpException(\n        {\n          statusCode: HttpStatus.TOO_MANY_REQUESTS,\n          message: `Rate limit exceeded. Limit: ${app.rateLimit} requests per hour`,\n          error: 'Too Many Requests',\n          retryAfter: Math.ceil((resetTime.getTime() - Date.now()) / 1000),\n        },\n        HttpStatus.TOO_MANY_REQUESTS,\n      );\n    }\n\n    // Check daily quota\n    const dailyCount = await this.apiUsageService.getDailyRequestCount(appId);\n    if (dailyCount >= app.dailyQuota) {\n      const resetTime = new Date();\n      resetTime.setHours(24, 0, 0, 0); // Midnight next day\n\n      response.setHeader('X-DailyQuota-Limit', app.dailyQuota.toString());\n      response.setHeader('X-DailyQuota-Remaining', '0');\n      response.setHeader(\n        'X-DailyQuota-Reset',\n        Math.floor(resetTime.getTime() / 1000).toString(),\n      );\n\n      throw new HttpException(\n        {\n          statusCode: HttpStatus.TOO_MANY_REQUESTS,\n          message: `Daily quota exceeded. Limit: ${app.dailyQuota} requests per day`,\n          error: 'Too Many Requests',\n          retryAfter: Math.ceil((resetTime.getTime() - Date.now()) / 1000),\n        },\n        HttpStatus.TOO_MANY_REQUESTS,\n      );\n    }\n\n    // Set rate limit headers\n    response.setHeader('X-RateLimit-Limit', app.rateLimit.toString());\n    response.setHeader(\n      'X-RateLimit-Remaining',\n      (app.rateLimit - hourlyCount - 1).toString(),\n    );\n    const hourlyResetTime = new Date(\n      Math.ceil(Date.now() / (60 * 60 * 1000)) * 60 * 60 * 1000,\n    );\n    response.setHeader(\n      'X-RateLimit-Reset',\n      Math.floor(hourlyResetTime.getTime() / 1000).toString(),\n    );\n\n    response.setHeader('X-DailyQuota-Limit', app.dailyQuota.toString());\n    response.setHeader(\n      'X-DailyQuota-Remaining',\n      (app.dailyQuota - dailyCount - 1).toString(),\n    );\n    const dailyResetTime = new Date();\n    dailyResetTime.setHours(24, 0, 0, 0);\n    response.setHeader(\n      'X-DailyQuota-Reset',\n      Math.floor(dailyResetTime.getTime() / 1000).toString(),\n    );\n\n    return true;\n  }\n}\n"],"names":["OAuthRateLimitGuard","canActivate","context","request","switchToHttp","getRequest","response","getResponse","oauth","app","appId","id","oauthService","getAppByClientId","clientId","hourlyCount","apiUsageService","getHourlyRequestCount","rateLimit","resetTime","Date","Math","ceil","now","setHeader","toString","floor","getTime","HttpException","statusCode","HttpStatus","TOO_MANY_REQUESTS","message","error","retryAfter","dailyCount","getDailyRequestCount","dailyQuota","setHours","hourlyResetTime","dailyResetTime"],"mappings":"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"}