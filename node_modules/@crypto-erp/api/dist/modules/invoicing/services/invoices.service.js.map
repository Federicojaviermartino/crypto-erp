{"version":3,"sources":["../../../../src/modules/invoicing/services/invoices.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  BadRequestException,\n  ConflictException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateInvoiceDto, QueryInvoicesDto } from '../dto/index.js';\nimport { Invoice, InvoiceLine, Prisma, InvoiceStatus, InvoiceDirection, InvoiceType } from '@prisma/client';\nimport { VerifactuService } from '../verifactu/verifactu.service.js';\n\ntype InvoiceWithRelations = Invoice & {\n  lines: InvoiceLine[];\n  contact: {\n    id: string;\n    name: string;\n    taxId: string | null;\n    email: string | null;\n  } | null;\n  series: {\n    id: string;\n    prefix: string | null;\n    name: string;\n  };\n};\n\n@Injectable()\nexport class InvoicesService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly verifactuService: VerifactuService,\n  ) {}\n\n  async findAll(\n    companyId: string,\n    query: QueryInvoicesDto,\n  ): Promise<{ invoices: InvoiceWithRelations[]; total: number }> {\n    const where: Prisma.InvoiceWhereInput = {\n      companyId,\n      ...(query.status && { status: query.status as InvoiceStatus }),\n      ...(query.direction && { direction: query.direction as InvoiceDirection }),\n      ...(query.contactId && { contactId: query.contactId }),\n      ...(query.seriesId && { seriesId: query.seriesId }),\n      ...(query.startDate && { issueDate: { gte: new Date(query.startDate) } }),\n      ...(query.endDate && { issueDate: { lte: new Date(query.endDate) } }),\n      ...(query.verifactuRegistered !== undefined && {\n        verifactuHash: query.verifactuRegistered ? { not: null } : null,\n      }),\n      ...(query.search && {\n        OR: [\n          { fullNumber: { contains: query.search, mode: 'insensitive' as const } },\n          { counterpartyName: { contains: query.search, mode: 'insensitive' as const } },\n        ],\n      }),\n    };\n\n    const [invoices, total] = await Promise.all([\n      this.prisma.invoice.findMany({\n        where,\n        include: {\n          lines: true,\n          contact: {\n            select: { id: true, name: true, taxId: true, email: true },\n          },\n          series: {\n            select: { id: true, prefix: true, name: true },\n          },\n        },\n        orderBy: [{ issueDate: 'desc' }, { number: 'desc' }],\n        skip: query.skip || 0,\n        take: query.take || 50,\n      }),\n      this.prisma.invoice.count({ where }),\n    ]);\n\n    return { invoices: invoices as InvoiceWithRelations[], total };\n  }\n\n  async findById(companyId: string, id: string): Promise<InvoiceWithRelations> {\n    const invoice = await this.prisma.invoice.findFirst({\n      where: { id, companyId },\n      include: {\n        lines: true,\n        contact: {\n          select: { id: true, name: true, taxId: true, email: true },\n        },\n        series: {\n          select: { id: true, prefix: true, name: true },\n        },\n      },\n    });\n\n    if (!invoice) {\n      throw new NotFoundException(`Invoice with ID ${id} not found`);\n    }\n\n    return invoice as InvoiceWithRelations;\n  }\n\n  async create(\n    companyId: string,\n    _userId: string,\n    dto: CreateInvoiceDto,\n    direction: InvoiceDirection = 'ISSUED',\n  ): Promise<InvoiceWithRelations> {\n    // Validate contact exists\n    const contact = dto.contactId ? await this.prisma.contact.findFirst({\n      where: { id: dto.contactId, companyId },\n    }) : null;\n\n    if (dto.contactId && !contact) {\n      throw new NotFoundException('Contact not found');\n    }\n\n    // Get or validate series\n    const series = dto.seriesId\n      ? await this.prisma.invoiceSeries.findFirst({\n          where: { id: dto.seriesId, companyId },\n        })\n      : await this.prisma.invoiceSeries.findFirst({\n          where: { companyId, isDefault: true },\n        });\n\n    if (!series) {\n      throw new BadRequestException('No invoice series found. Please create one first.');\n    }\n\n    // Generate invoice number\n    const { number, fullNumber } = await this.generateInvoiceNumber(companyId, series.id);\n\n    // Calculate totals\n    const totals = this.calculateTotals(dto.lines);\n\n    // Create invoice with lines\n    const invoice = await this.prisma.invoice.create({\n      data: {\n        number,\n        fullNumber,\n        type: (dto.type as InvoiceType) || InvoiceType.STANDARD,\n        direction,\n        issueDate: new Date(dto.date),\n        dueDate: dto.dueDate ? new Date(dto.dueDate) : null,\n        status: 'DRAFT',\n        subtotal: totals.subtotal,\n        totalTax: totals.taxAmount,\n        total: totals.totalAmount,\n        taxableBase: totals.subtotal,\n        notes: dto.notes || null,\n        counterpartyName: contact?.name || dto.counterpartyName || 'N/A',\n        counterpartyTaxId: contact?.taxId || dto.counterpartyTaxId,\n        counterpartyAddress: contact?.address || dto.counterpartyAddress,\n        counterpartyCity: contact?.city || dto.counterpartyCity,\n        counterpartyCountry: contact?.country || dto.counterpartyCountry || 'ES',\n        companyId,\n        contactId: dto.contactId || null,\n        seriesId: series.id,\n        lines: {\n          create: dto.lines.map((line, index) => ({\n            lineNumber: index + 1,\n            description: line.description,\n            quantity: line.quantity,\n            unitPrice: line.unitPrice,\n            taxRate: line.vatRate ?? 21,\n            discount: line.discountPercent ?? 0,\n            subtotal: line.quantity * line.unitPrice * (1 - (line.discountPercent || 0) / 100),\n            taxAmount: line.quantity * line.unitPrice * (1 - (line.discountPercent || 0) / 100) * ((line.vatRate || 21) / 100),\n            total: this.calculateLineTotal(line),\n          })),\n        },\n      },\n      include: {\n        lines: true,\n        contact: {\n          select: { id: true, name: true, taxId: true, email: true },\n        },\n        series: {\n          select: { id: true, prefix: true, name: true },\n        },\n      },\n    });\n\n    return invoice as InvoiceWithRelations;\n  }\n\n  async update(\n    companyId: string,\n    id: string,\n    dto: Partial<CreateInvoiceDto>,\n  ): Promise<InvoiceWithRelations> {\n    const existing = await this.findById(companyId, id);\n\n    if (existing.status !== 'DRAFT') {\n      throw new ConflictException('Only draft invoices can be modified');\n    }\n\n    // Update lines if provided\n    if (dto.lines) {\n      // Delete existing lines\n      await this.prisma.invoiceLine.deleteMany({\n        where: { invoiceId: id },\n      });\n\n      // Calculate new totals\n      const totals = this.calculateTotals(dto.lines);\n\n      // Create new lines and update invoice\n      await this.prisma.invoice.update({\n        where: { id },\n        data: {\n          subtotal: totals.subtotal,\n          totalTax: totals.taxAmount,\n          total: totals.totalAmount,\n          taxableBase: totals.subtotal,\n          lines: {\n            create: dto.lines.map((line, index) => ({\n              lineNumber: index + 1,\n              description: line.description,\n              quantity: line.quantity,\n              unitPrice: line.unitPrice,\n              taxRate: line.vatRate ?? 21,\n              discount: line.discountPercent ?? 0,\n              subtotal: line.quantity * line.unitPrice * (1 - (line.discountPercent || 0) / 100),\n              taxAmount: line.quantity * line.unitPrice * (1 - (line.discountPercent || 0) / 100) * ((line.vatRate || 21) / 100),\n              total: this.calculateLineTotal(line),\n            })),\n          },\n        },\n      });\n    }\n\n    // Update other fields\n    await this.prisma.invoice.update({\n      where: { id },\n      data: {\n        ...(dto.contactId && { contactId: dto.contactId }),\n        ...(dto.date && { issueDate: new Date(dto.date) }),\n        ...(dto.dueDate && { dueDate: new Date(dto.dueDate) }),\n        ...(dto.notes !== undefined && { notes: dto.notes }),\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async issue(companyId: string, id: string): Promise<InvoiceWithRelations> {\n    const invoice = await this.findById(companyId, id);\n\n    if (invoice.status !== 'DRAFT') {\n      throw new ConflictException('Only draft invoices can be issued');\n    }\n\n    // For outgoing invoices, register with Verifactu\n    if (invoice.direction === 'ISSUED') {\n      try {\n        const verifactuRecord = await this.verifactuService.generateVerifactuRecord(companyId, id);\n        if (!verifactuRecord) {\n          throw new BadRequestException('Verifactu registration failed');\n        }\n      } catch (error) {\n        // Log but don't fail - Verifactu may not be required\n        console.warn('Verifactu registration skipped:', error);\n      }\n    }\n\n    await this.prisma.invoice.update({\n      where: { id },\n      data: {\n        status: 'ISSUED',\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async markAsPaid(\n    companyId: string,\n    id: string,\n    paidAt?: Date,\n  ): Promise<InvoiceWithRelations> {\n    const invoice = await this.findById(companyId, id);\n\n    if (!['ISSUED', 'SENT'].includes(invoice.status)) {\n      throw new ConflictException('Only issued or sent invoices can be marked as paid');\n    }\n\n    await this.prisma.invoice.update({\n      where: { id },\n      data: {\n        status: 'PAID',\n        paidAt: paidAt || new Date(),\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async cancel(companyId: string, id: string): Promise<InvoiceWithRelations> {\n    const invoice = await this.findById(companyId, id);\n\n    if (invoice.status === 'CANCELLED') {\n      throw new ConflictException('Invoice is already cancelled');\n    }\n\n    // If invoice was issued and registered with Verifactu, we need to issue a rectificative\n    if (invoice.verifactuHash) {\n      throw new BadRequestException(\n        'Cannot cancel a Verifactu-registered invoice. Create a rectificative invoice instead.',\n      );\n    }\n\n    await this.prisma.invoice.update({\n      where: { id },\n      data: { status: 'CANCELLED' },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    const invoice = await this.findById(companyId, id);\n\n    if (invoice.status !== 'DRAFT') {\n      throw new ConflictException('Only draft invoices can be deleted');\n    }\n\n    await this.prisma.$transaction([\n      this.prisma.invoiceLine.deleteMany({ where: { invoiceId: id } }),\n      this.prisma.invoice.delete({ where: { id } }),\n    ]);\n  }\n\n  async getVerifactuQR(companyId: string, id: string): Promise<string> {\n    const invoice = await this.prisma.invoice.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!invoice) {\n      throw new NotFoundException('Invoice not found');\n    }\n\n    if (!invoice.verifactuQrData) {\n      throw new BadRequestException('Invoice is not registered with Verifactu');\n    }\n\n    return invoice.verifactuQrData;\n  }\n\n  private async generateInvoiceNumber(\n    companyId: string,\n    seriesId: string,\n  ): Promise<{ number: number; fullNumber: string }> {\n    const series = await this.prisma.invoiceSeries.findUnique({\n      where: { id: seriesId },\n    });\n\n    if (!series) {\n      throw new NotFoundException('Invoice series not found');\n    }\n\n    const year = new Date().getFullYear();\n    const nextNumber = series.nextNumber;\n\n    // Update the next number\n    await this.prisma.invoiceSeries.update({\n      where: { id: seriesId },\n      data: { nextNumber: nextNumber + 1 },\n    });\n\n    // Format: PREFIX-YEAR-NUMBER (e.g., F-2024-000001)\n    const prefix = series.prefix || series.code;\n    const fullNumber = `${prefix}-${year}-${String(nextNumber).padStart(series.digitCount, '0')}`;\n\n    return { number: nextNumber, fullNumber };\n  }\n\n  private calculateTotals(lines: CreateInvoiceDto['lines']): {\n    subtotal: number;\n    taxAmount: number;\n    totalAmount: number;\n  } {\n    let subtotal = 0;\n    let taxAmount = 0;\n\n    for (const line of lines) {\n      const lineTotal = line.quantity * line.unitPrice;\n      const discount = lineTotal * ((line.discountPercent || 0) / 100);\n      const lineSubtotal = lineTotal - discount;\n      const lineVat = lineSubtotal * ((line.vatRate || 21) / 100);\n\n      subtotal += lineSubtotal;\n      taxAmount += lineVat;\n    }\n\n    return {\n      subtotal,\n      taxAmount,\n      totalAmount: subtotal + taxAmount,\n    };\n  }\n\n  private calculateLineTotal(line: CreateInvoiceDto['lines'][0]): number {\n    const lineTotal = line.quantity * line.unitPrice;\n    const discount = lineTotal * ((line.discountPercent || 0) / 100);\n    const lineSubtotal = lineTotal - discount;\n    const lineVat = lineSubtotal * ((line.vatRate || 21) / 100);\n    return lineSubtotal + lineVat;\n  }\n}\n"],"names":["InvoicesService","findAll","companyId","query","where","status","direction","contactId","seriesId","startDate","issueDate","gte","Date","endDate","lte","verifactuRegistered","undefined","verifactuHash","not","search","OR","fullNumber","contains","mode","counterpartyName","invoices","total","Promise","all","prisma","invoice","findMany","include","lines","contact","select","id","name","taxId","email","series","prefix","orderBy","number","skip","take","count","findById","findFirst","NotFoundException","create","_userId","dto","invoiceSeries","isDefault","BadRequestException","generateInvoiceNumber","totals","calculateTotals","data","type","InvoiceType","STANDARD","date","dueDate","subtotal","totalTax","taxAmount","totalAmount","taxableBase","notes","counterpartyTaxId","counterpartyAddress","address","counterpartyCity","city","counterpartyCountry","country","map","line","index","lineNumber","description","quantity","unitPrice","taxRate","vatRate","discount","discountPercent","calculateLineTotal","update","existing","ConflictException","invoiceLine","deleteMany","invoiceId","issue","verifactuRecord","verifactuService","generateVerifactuRecord","error","console","warn","markAsPaid","paidAt","includes","cancel","delete","$transaction","getVerifactuQR","verifactuQrData","findUnique","year","getFullYear","nextNumber","code","String","padStart","digitCount","lineTotal","lineSubtotal","lineVat"],"mappings":"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"}