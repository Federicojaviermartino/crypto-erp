{"version":3,"sources":["../../../../src/modules/invoicing/verifactu/verifactu.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { AEATClientService } from './aeat-client.service.js';\nimport * as crypto from 'crypto';\n\n/**\n * Verifactu - Sistema de Verificación de Facturas\n * Implementación según Real Decreto 1007/2023\n *\n * Características principales:\n * - Huella digital encadenada (cada factura contiene hash de la anterior)\n * - Código QR para verificación\n * - Envío a la AEAT en tiempo real o diferido\n * - Registro de eventos inmutable\n */\n\ninterface VerifactuInvoiceData {\n  // Identificación de la factura\n  numeroFactura: string;\n  serieFactura: string;\n  fechaExpedicion: Date;\n\n  // Emisor\n  nifEmisor: string;\n  nombreEmisor: string;\n\n  // Receptor\n  nifReceptor?: string;\n  nombreReceptor: string;\n\n  // Importes\n  baseImponible: number;\n  tipoIva: number;\n  cuotaIva: number;\n  totalFactura: number;\n\n  // Tipo de operación\n  tipoFactura: 'F1' | 'F2' | 'R1' | 'R2' | 'R3' | 'R4' | 'R5';\n  descripcion: string;\n}\n\ninterface VerifactuRecord {\n  // Huella digital\n  huella: string;\n  huellaAnterior: string | null;\n\n  // Datos de la factura\n  factura: VerifactuInvoiceData;\n\n  // Código QR\n  codigoQR: string;\n  urlVerificacion: string;\n\n  // Estado\n  estado: 'PENDIENTE' | 'ENVIADO' | 'ACEPTADO' | 'RECHAZADO';\n  fechaRegistro: Date;\n  fechaEnvio?: Date;\n\n  // Respuesta AEAT\n  csvAeat?: string;\n  errores?: string[];\n}\n\n@Injectable()\nexport class VerifactuService {\n  private readonly logger = new Logger(VerifactuService.name);\n\n  // Entorno de la AEAT (producción o pruebas)\n  private readonly aeatUrl = process.env.AEAT_VERIFACTU_URL || 'https://prewww1.aeat.es/wlpl/TGVI-JDIT/ws/VeriFactuSV.wsdl';\n  private readonly isProduction = process.env.NODE_ENV === 'production';\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly aeatClient: AEATClientService,\n  ) {}\n\n  /**\n   * Genera el registro Verifactu para una factura\n   */\n  async generateVerifactuRecord(\n    companyId: string,\n    invoiceId: string,\n  ): Promise<VerifactuRecord> {\n    // Obtener la factura con relaciones\n    const invoice = await this.prisma.invoice.findFirst({\n      where: { id: invoiceId, companyId },\n      include: {\n        lines: true,\n        contact: true,\n        series: true,\n      },\n    });\n\n    if (!invoice) {\n      throw new Error(`Invoice ${invoiceId} not found`);\n    }\n\n    // Obtener datos de la empresa\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    if (!company) {\n      throw new Error(`Company ${companyId} not found`);\n    }\n\n    // Calcular IVA promedio de las líneas\n    const avgTaxRate = invoice.lines.length > 0\n      ? invoice.lines.reduce((sum, l) => sum + (l.taxRate?.toNumber() || 21), 0) / invoice.lines.length\n      : 21;\n\n    // Convertir a datos Verifactu\n    const invoiceData: VerifactuInvoiceData = {\n      numeroFactura: invoice.fullNumber,\n      serieFactura: invoice.series?.prefix || invoice.series?.code || 'A',\n      fechaExpedicion: invoice.issueDate,\n      nifEmisor: company.taxId || '',\n      nombreEmisor: company.name,\n      nifReceptor: invoice.contact?.taxId || invoice.counterpartyTaxId || undefined,\n      nombreReceptor: invoice.contact?.name || invoice.counterpartyName,\n      baseImponible: invoice.subtotal.toNumber(),\n      tipoIva: avgTaxRate,\n      cuotaIva: invoice.totalTax.toNumber(),\n      totalFactura: invoice.total.toNumber(),\n      tipoFactura: this.getInvoiceType(invoice.type),\n      descripcion: invoice.lines.map(l => l.description).join(', ').substring(0, 250),\n    };\n\n    // Obtener huella de la factura anterior\n    const previousRecord = await this.getLastVerifactuRecord(companyId);\n    const huellaAnterior = previousRecord?.huella || null;\n\n    // Generar huella digital\n    const huella = this.generateHuella(invoiceData, huellaAnterior);\n\n    // Generar código QR\n    const { codigoQR, urlVerificacion } = this.generateQRCode(invoiceData, huella);\n\n    // Crear registro\n    const record: VerifactuRecord = {\n      huella,\n      huellaAnterior,\n      factura: invoiceData,\n      codigoQR,\n      urlVerificacion,\n      estado: 'PENDIENTE',\n      fechaRegistro: new Date(),\n    };\n\n    // Guardar en la base de datos\n    await this.saveVerifactuRecord(companyId, invoiceId, record);\n\n    this.logger.log(\n      `Verifactu record generated for invoice ${invoice.fullNumber}: ${huella.substring(0, 16)}...`\n    );\n\n    return record;\n  }\n\n  /**\n   * Genera la huella digital encadenada según especificación Verifactu\n   * SHA-256 de los datos concatenados\n   */\n  private generateHuella(\n    data: VerifactuInvoiceData,\n    huellaAnterior: string | null,\n  ): string {\n    // Concatenar campos en orden específico según normativa\n    const contenido = [\n      data.nifEmisor,\n      data.numeroFactura,\n      data.serieFactura,\n      data.fechaExpedicion.toISOString().split('T')[0],\n      data.tipoFactura,\n      data.baseImponible.toFixed(2),\n      data.cuotaIva.toFixed(2),\n      data.totalFactura.toFixed(2),\n      huellaAnterior || '', // Encadenamiento\n    ].join('|');\n\n    return crypto\n      .createHash('sha256')\n      .update(contenido, 'utf8')\n      .digest('hex')\n      .toUpperCase();\n  }\n\n  /**\n   * Genera el código QR y URL de verificación\n   */\n  private generateQRCode(\n    data: VerifactuInvoiceData,\n    huella: string,\n  ): { codigoQR: string; urlVerificacion: string } {\n    // URL de verificación de la AEAT\n    const baseUrl = 'https://www2.agenciatributaria.gob.es/wlpl/TGVI-JDIT/VerificadorFacturasRF';\n\n    const params = new URLSearchParams({\n      nif: data.nifEmisor,\n      numserie: `${data.serieFactura}${data.numeroFactura}`,\n      fecha: data.fechaExpedicion.toISOString().split('T')[0],\n      importe: data.totalFactura.toFixed(2),\n      huella: huella.substring(0, 16), // Primeros 16 caracteres\n    });\n\n    const urlVerificacion = `${baseUrl}?${params.toString()}`;\n\n    // El código QR contiene la URL de verificación\n    // En producción, esto se convertiría en una imagen QR real\n    const codigoQR = urlVerificacion;\n\n    return { codigoQR, urlVerificacion };\n  }\n\n  /**\n   * Envía el registro Verifactu a la AEAT\n   */\n  async sendToAEAT(companyId: string, invoiceId: string): Promise<{\n    success: boolean;\n    csv?: string;\n    errors?: string[];\n  }> {\n    const record = await this.getVerifactuRecord(companyId, invoiceId);\n\n    if (!record) {\n      throw new Error('Verifactu record not found');\n    }\n\n    if (record.estado === 'ACEPTADO') {\n      return { success: true, csv: record.csvAeat };\n    }\n\n    // Generate XML for submission\n    const xml = this.generateXML(record);\n\n    this.logger.log(`Submitting invoice ${record.factura.numeroFactura} to AEAT`);\n\n    // Submit to AEAT using the client\n    const response = await this.aeatClient.submitInvoice({\n      xml,\n      nifEmisor: record.factura.nifEmisor,\n      invoiceNumber: record.factura.numeroFactura,\n    });\n\n    if (response.success) {\n      await this.updateVerifactuRecord(companyId, invoiceId, {\n        estado: 'ACEPTADO',\n        fechaEnvio: new Date(),\n        csvAeat: response.csv,\n      });\n\n      this.logger.log(\n        `Invoice ${record.factura.numeroFactura} accepted by AEAT. CSV: ${response.csv}`\n      );\n\n      return { success: true, csv: response.csv };\n    } else {\n      const errorMessages = response.errors?.map(e => `${e.code}: ${e.message}`) || [];\n\n      await this.updateVerifactuRecord(companyId, invoiceId, {\n        estado: 'RECHAZADO',\n        fechaEnvio: new Date(),\n        errores: errorMessages,\n      });\n\n      this.logger.error(\n        `Invoice ${record.factura.numeroFactura} rejected by AEAT: ${errorMessages.join(', ')}`\n      );\n\n      return {\n        success: false,\n        errors: errorMessages,\n      };\n    }\n  }\n\n  /**\n   * Genera el XML según esquema Verifactu para envío a AEAT\n   */\n  generateXML(record: VerifactuRecord): string {\n    const { factura, huella, huellaAnterior } = record;\n\n    // XML simplificado - en producción usar el esquema XSD completo\n    return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\n                  xmlns:vf=\"https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/tike/cont/ws/SusntratFactuRAltaActualizacion.xsd\">\n  <soapenv:Header/>\n  <soapenv:Body>\n    <vf:RegistroAlta>\n      <vf:IDVersion>1.0</vf:IDVersion>\n      <vf:IDEmisor>\n        <vf:NIF>${factura.nifEmisor}</vf:NIF>\n        <vf:NombreRazon>${this.escapeXml(factura.nombreEmisor)}</vf:NombreRazon>\n      </vf:IDEmisor>\n      <vf:Factura>\n        <vf:NumSerieFactura>${factura.serieFactura}${factura.numeroFactura}</vf:NumSerieFactura>\n        <vf:FechaExpedicion>${factura.fechaExpedicion.toISOString().split('T')[0]}</vf:FechaExpedicion>\n        <vf:TipoFactura>${factura.tipoFactura}</vf:TipoFactura>\n        <vf:Descripcion>${this.escapeXml(factura.descripcion)}</vf:Descripcion>\n        <vf:Destinatario>\n          ${factura.nifReceptor ? `<vf:NIF>${factura.nifReceptor}</vf:NIF>` : ''}\n          <vf:NombreRazon>${this.escapeXml(factura.nombreReceptor)}</vf:NombreRazon>\n        </vf:Destinatario>\n        <vf:Desglose>\n          <vf:DesgloseTipo>\n            <vf:TipoImpositivo>${factura.tipoIva.toFixed(2)}</vf:TipoImpositivo>\n            <vf:BaseImponible>${factura.baseImponible.toFixed(2)}</vf:BaseImponible>\n            <vf:CuotaRepercutida>${factura.cuotaIva.toFixed(2)}</vf:CuotaRepercutida>\n          </vf:DesgloseTipo>\n        </vf:Desglose>\n        <vf:ImporteTotal>${factura.totalFactura.toFixed(2)}</vf:ImporteTotal>\n      </vf:Factura>\n      <vf:Huella>\n        <vf:Huella>${huella}</vf:Huella>\n        ${huellaAnterior ? `<vf:HuellaAnterior>${huellaAnterior}</vf:HuellaAnterior>` : ''}\n      </vf:Huella>\n    </vf:RegistroAlta>\n  </soapenv:Body>\n</soapenv:Envelope>`;\n  }\n\n  /**\n   * Obtiene el estado de verificación de una factura\n   */\n  async getVerificationStatus(companyId: string, invoiceId: string): Promise<{\n    verified: boolean;\n    estado: string;\n    urlVerificacion?: string;\n    csvAeat?: string;\n  }> {\n    const record = await this.getVerifactuRecord(companyId, invoiceId);\n\n    if (!record) {\n      return {\n        verified: false,\n        estado: 'NO_REGISTRADO',\n      };\n    }\n\n    return {\n      verified: record.estado === 'ACEPTADO',\n      estado: record.estado,\n      urlVerificacion: record.urlVerificacion,\n      csvAeat: record.csvAeat,\n    };\n  }\n\n  /**\n   * Valida la integridad de la cadena de huellas\n   */\n  async validateChainIntegrity(companyId: string): Promise<{\n    valid: boolean;\n    errors: string[];\n    totalRecords: number;\n  }> {\n    // Obtener todas las facturas con hash verifactu ordenadas\n    const invoices = await this.prisma.invoice.findMany({\n      where: {\n        companyId,\n        verifactuHash: { not: null },\n      },\n      orderBy: [\n        { issueDate: 'asc' },\n        { number: 'asc' },\n      ],\n      select: {\n        id: true,\n        fullNumber: true,\n        verifactuHash: true,\n      },\n    });\n\n    const errors: string[] = [];\n\n    // La validación de cadena simplificada - verificar que cada factura tiene hash\n    for (const invoice of invoices) {\n      if (!invoice.verifactuHash) {\n        errors.push(`Factura ${invoice.fullNumber}: Sin hash Verifactu registrado`);\n      }\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors,\n      totalRecords: invoices.length,\n    };\n  }\n\n  // Helpers privados\n\n  private getInvoiceType(type: string): VerifactuInvoiceData['tipoFactura'] {\n    const typeMap: Record<string, VerifactuInvoiceData['tipoFactura']> = {\n      STANDARD: 'F1',\n      SIMPLIFIED: 'F2',\n      CREDIT_NOTE: 'R1',\n      DEBIT_NOTE: 'R2',\n    };\n    return typeMap[type] || 'F1';\n  }\n\n  private escapeXml(str: string): string {\n    return str\n      .replace(/&/g, '&amp;')\n      .replace(/</g, '&lt;')\n      .replace(/>/g, '&gt;')\n      .replace(/\"/g, '&quot;')\n      .replace(/'/g, '&apos;');\n  }\n\n  private async getLastVerifactuRecord(companyId: string): Promise<{ huella: string } | null> {\n    const result = await this.prisma.invoice.findFirst({\n      where: {\n        companyId,\n        verifactuHash: { not: null },\n      },\n      orderBy: [\n        { issueDate: 'desc' },\n        { number: 'desc' },\n      ],\n      select: { verifactuHash: true },\n    });\n\n    if (result?.verifactuHash) {\n      return { huella: result.verifactuHash };\n    }\n    return null;\n  }\n\n  private async getVerifactuRecord(\n    companyId: string,\n    invoiceId: string,\n  ): Promise<VerifactuRecord | null> {\n    const invoice = await this.prisma.invoice.findFirst({\n      where: { id: invoiceId, companyId },\n      include: {\n        lines: true,\n        contact: true,\n        series: true,\n      },\n    });\n\n    if (!invoice?.verifactuHash) {\n      return null;\n    }\n\n    // Obtener datos de la empresa\n    const company = await this.prisma.company.findUnique({\n      where: { id: companyId },\n    });\n\n    // Calcular IVA promedio\n    const avgTaxRate = invoice.lines.length > 0\n      ? invoice.lines.reduce((sum, l) => sum + (l.taxRate?.toNumber() || 21), 0) / invoice.lines.length\n      : 21;\n\n    // Reconstruir el registro desde los datos de la factura\n    const factura: VerifactuInvoiceData = {\n      numeroFactura: invoice.fullNumber,\n      serieFactura: invoice.series?.prefix || invoice.series?.code || 'A',\n      fechaExpedicion: invoice.issueDate,\n      nifEmisor: company?.taxId || '',\n      nombreEmisor: company?.name || '',\n      nifReceptor: invoice.contact?.taxId || invoice.counterpartyTaxId || undefined,\n      nombreReceptor: invoice.contact?.name || invoice.counterpartyName,\n      baseImponible: invoice.subtotal.toNumber(),\n      tipoIva: avgTaxRate,\n      cuotaIva: invoice.totalTax.toNumber(),\n      totalFactura: invoice.total.toNumber(),\n      tipoFactura: this.getInvoiceType(invoice.type),\n      descripcion: invoice.lines.map(l => l.description).join(', ').substring(0, 250),\n    };\n\n    return {\n      huella: invoice.verifactuHash,\n      huellaAnterior: null, // No almacenamos esto directamente\n      factura,\n      codigoQR: invoice.verifactuQrData || '',\n      urlVerificacion: invoice.verifactuQrData || '',\n      estado: 'ACEPTADO', // Si tiene hash, asumimos aceptado\n      fechaRegistro: invoice.createdAt,\n    };\n  }\n\n  private async saveVerifactuRecord(\n    _companyId: string,\n    invoiceId: string,\n    record: VerifactuRecord,\n  ): Promise<void> {\n    await this.prisma.invoice.update({\n      where: { id: invoiceId },\n      data: {\n        verifactuHash: record.huella,\n        verifactuQrData: record.codigoQR,\n      },\n    });\n  }\n\n  private async updateVerifactuRecord(\n    _companyId: string,\n    invoiceId: string,\n    updates: Partial<VerifactuRecord>,\n  ): Promise<void> {\n    await this.prisma.invoice.update({\n      where: { id: invoiceId },\n      data: {\n        ...(updates.huella && { verifactuHash: updates.huella }),\n        ...(updates.codigoQR && { verifactuQrData: updates.codigoQR }),\n      },\n    });\n  }\n}\n"],"names":["VerifactuService","generateVerifactuRecord","companyId","invoiceId","invoice","prisma","findFirst","where","id","include","lines","contact","series","Error","company","findUnique","avgTaxRate","length","reduce","sum","l","taxRate","toNumber","invoiceData","numeroFactura","fullNumber","serieFactura","prefix","code","fechaExpedicion","issueDate","nifEmisor","taxId","nombreEmisor","name","nifReceptor","counterpartyTaxId","undefined","nombreReceptor","counterpartyName","baseImponible","subtotal","tipoIva","cuotaIva","totalTax","totalFactura","total","tipoFactura","getInvoiceType","type","descripcion","map","description","join","substring","previousRecord","getLastVerifactuRecord","huellaAnterior","huella","generateHuella","codigoQR","urlVerificacion","generateQRCode","record","factura","estado","fechaRegistro","Date","saveVerifactuRecord","logger","log","data","contenido","toISOString","split","toFixed","crypto","createHash","update","digest","toUpperCase","baseUrl","params","URLSearchParams","nif","numserie","fecha","importe","toString","sendToAEAT","getVerifactuRecord","success","csv","csvAeat","xml","generateXML","response","aeatClient","submitInvoice","invoiceNumber","updateVerifactuRecord","fechaEnvio","errorMessages","errors","e","message","errores","error","escapeXml","getVerificationStatus","verified","validateChainIntegrity","invoices","findMany","verifactuHash","not","orderBy","number","select","push","valid","totalRecords","typeMap","STANDARD","SIMPLIFIED","CREDIT_NOTE","DEBIT_NOTE","str","replace","result","verifactuQrData","createdAt","_companyId","updates","Logger","aeatUrl","process","env","AEAT_VERIFACTU_URL","isProduction","NODE_ENV"],"mappings":"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"}