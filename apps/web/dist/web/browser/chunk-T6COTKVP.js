import{a as R}from"./chunk-TRXNC6YO.js";import"./chunk-R5763NNK.js";import{a as W,c as G,e as Y,r as J}from"./chunk-OE3B74VB.js";import{a as X}from"./chunk-JU2KEDBD.js";import"./chunk-FXBJWTCM.js";import{$a as x,Da as C,Db as U,Fa as v,Gb as $,Ha as T,Ia as z,Ja as f,La as H,Ma as O,Na as w,Oa as i,Pa as a,Qa as M,Ra as b,Sa as p,Ta as h,U as V,Va as S,Wa as k,Xa as D,Ya as j,Za as o,_a as E,aa as d,ba as m,bb as B,cb as q,db as K,fb as L,hb as N,jb as Q,na as I,ra as l,sa as P,xa as _}from"./chunk-2V2B4KT2.js";import{a as F,b as A}from"./chunk-35PI25VP.js";var ee=["messagesContainer"],te=["inputField"],ne=(s,u)=>u.timestamp;function ie(s,u){if(s&1){let e=b();i(0,"div",12)(1,"span",25),o(2,"\u{1F4AC}"),a(),i(3,"h3"),o(4,"\xA1Hola! Soy tu asistente contable"),a(),i(5,"p"),o(6,"Puedo ayudarte con:"),a(),i(7,"div",26)(8,"button",27),p("click",function(){d(e);let t=h();return m(t.sendSuggestion("\xBFC\xF3mo registro una factura de compra?"))}),o(9," \u{1F4C4} Registrar facturas "),a(),i(10,"button",27),p("click",function(){d(e);let t=h();return m(t.sendSuggestion("\xBFC\xF3mo funciona el c\xE1lculo FIFO en crypto?"))}),o(11," \u{1F4B0} Fiscalidad crypto "),a(),i(12,"button",27),p("click",function(){d(e);let t=h();return m(t.sendSuggestion("\xBFQu\xE9 es Verifactu y c\xF3mo afecta a mi empresa?"))}),o(13," \u{1F4CB} Verifactu "),a(),i(14,"button",27),p("click",function(){d(e);let t=h();return m(t.sendSuggestion("\xBFC\xF3mo cierro el ejercicio fiscal?"))}),o(15," \u{1F4CA} Cierre fiscal "),a()()()}}function ae(s,u){if(s&1&&(i(0,"div",28)(1,"div",29),o(2),a(),i(3,"div",30),M(4,"div",31),i(5,"span",32),o(6),N(7,"date"),a()()()),s&2){let e=u.$implicit,n=h();z(e.role),l(2),x(" ",e.role==="user"?"\u{1F464}":"\u{1F916}"," "),l(2),v("innerHTML",n.formatMessage(e.content),I),l(2),E(Q(7,5,e.timestamp,"HH:mm"))}}function se(s,u){s&1&&(i(0,"div",14)(1,"div",29),o(2,"\u{1F916}"),a(),i(3,"div",30)(4,"div",33),M(5,"span")(6,"span")(7,"span"),a()()())}function oe(s,u){if(s&1){let e=b();i(0,"button",37),p("click",function(){let t=d(e).$implicit,r=h(2);return m(r.useSuggestion(t))}),o(1),a()}if(s&2){let e=u.$implicit;l(),x(" ",e," ")}}function re(s,u){if(s&1&&(i(0,"div",15)(1,"p",34),o(2,"Preguntas sugeridas:"),a(),i(3,"div",35),O(4,oe,2,1,"button",36,H),a()()),s&2){let e=h();l(4),w(e.suggestedFollowUps())}}function ce(s,u){if(s&1){let e=b();i(0,"div",17)(1,"span",38),o(2,"\u{1F4CE}"),a(),i(3,"span",39),o(4),a(),i(5,"button",40),p("click",function(){d(e);let t=h();return m(t.removeAttachment())}),o(6,"\xD7"),a()()}if(s&2){let e,n=h();l(4),E((e=n.attachedFile())==null?null:e.name)}}function le(s,u){s&1&&M(0,"span",23)}function ge(s,u){s&1&&o(0," \u27A4 ")}var Me=(()=>{class s{api;auth;messagesContainer;inputField;messages=_([]);loading=_(!1);userInput="";shouldScroll=!1;attachedFile=_(null);language=_("es");suggestedFollowUps=_([]);STORAGE_KEY="ai_chat_history";constructor(e,n){this.api=e,this.auth=n}ngOnInit(){this.loadChatHistory()}ngOnDestroy(){this.saveChatHistory()}ngAfterViewChecked(){this.shouldScroll&&(this.scrollToBottom(),this.shouldScroll=!1)}onEnterPress(e){e.shiftKey||(e.preventDefault(),this.sendMessage())}sendSuggestion(e){this.userInput=e,this.sendMessage()}sendMessage(){let e=this.userInput.trim(),n=this.attachedFile();if(!e&&!n||this.loading())return;let t={role:"user",content:e,timestamp:new Date,hasAttachment:!!n,attachmentName:n?.name};if(this.messages.update(c=>[...c,t]),this.userInput="",this.loading.set(!0),this.shouldScroll=!0,n){this.sendMessageWithFile(n,e);return}let r=this.messages().map(c=>({role:c.role,content:c.content})),g={companyId:this.auth.getCompanyId(),useRAG:!0,language:this.language()};this.api.post("/ai/chat",{messages:r,context:g}).subscribe({next:c=>{let y={role:"assistant",content:c.response,timestamp:new Date};this.messages.update(Z=>[...Z,y]),this.extractSuggestedFollowUps(c.response),this.saveChatHistory(),this.loading.set(!1),this.shouldScroll=!0},error:()=>{let c={role:"assistant",content:this.language()==="es"?"Lo siento, ha ocurrido un error. Por favor, intenta de nuevo.":"Sorry, an error occurred. Please try again.",timestamp:new Date};this.messages.update(y=>[...y,c]),this.loading.set(!1),this.shouldScroll=!0}})}sendMessageWithFile(e,n){let t=new FormData;t.append("file",e),t.append("message",n),t.append("context",JSON.stringify({companyId:this.auth.getCompanyId(),language:this.language()})),this.api.post("/ai/chat-with-file",t).subscribe({next:r=>{let g={role:"assistant",content:r.response,timestamp:new Date};this.messages.update(c=>[...c,g]),this.attachedFile.set(null),this.saveChatHistory(),this.loading.set(!1),this.shouldScroll=!0},error:()=>{let r={role:"assistant",content:"Error al procesar el archivo adjunto.",timestamp:new Date};this.messages.update(g=>[...g,r]),this.attachedFile.set(null),this.loading.set(!1),this.shouldScroll=!0}})}clearChat(){this.messages.set([]),this.suggestedFollowUps.set([]),localStorage.removeItem(this.getStorageKey())}onFileSelected(e){let n=e.target;n.files&&n.files[0]&&this.attachedFile.set(n.files[0])}removeAttachment(){this.attachedFile.set(null)}toggleLanguage(){this.language.set(this.language()==="es"?"en":"es")}useSuggestion(e){this.userInput=e,this.sendMessage()}formatMessage(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}loadChatHistory(){let e=localStorage.getItem(this.getStorageKey());if(e)try{let n=JSON.parse(e);this.messages.set(n.map(t=>A(F({},t),{timestamp:new Date(t.timestamp)}))),this.shouldScroll=!0}catch(n){console.error("Failed to load chat history:",n)}}saveChatHistory(){try{localStorage.setItem(this.getStorageKey(),JSON.stringify(this.messages()))}catch(e){console.error("Failed to save chat history:",e)}}getStorageKey(){let e=this.auth.getCompanyId()||"default";return`${this.STORAGE_KEY}_${e}`}extractSuggestedFollowUps(e){let n=/\[Pregunta sugerida: (.*?)\]/g,t=Array.from(e.matchAll(n));if(t.length>0){let r=t.map(g=>g[1].trim());this.suggestedFollowUps.set(r)}}scrollToBottom(){if(this.messagesContainer){let e=this.messagesContainer.nativeElement;e.scrollTop=e.scrollHeight}}static \u0275fac=function(n){return new(n||s)(P(X),P(R))};static \u0275cmp=V({type:s,selectors:[["app-ai-chat"]],viewQuery:function(n,t){if(n&1&&(S(ee,5),S(te,5)),n&2){let r;k(r=D())&&(t.messagesContainer=r.first),k(r=D())&&(t.inputField=r.first)}},standalone:!0,features:[L],decls:36,vars:14,consts:[["messagesContainer",""],["fileInput",""],["inputField",""],[1,"chat-container"],[1,"chat-header"],[1,"header-info"],[1,"ai-avatar"],[1,"text-muted"],[1,"header-actions"],[1,"btn","btn-sm",3,"click"],[1,"btn","btn-sm","btn-secondary",3,"click"],[1,"chat-messages"],[1,"welcome-message"],[1,"message",3,"class"],[1,"message","assistant"],[1,"suggested-questions"],[1,"chat-input"],[1,"attachment-preview"],[1,"input-container"],["type","file","accept","image/*,application/pdf",2,"display","none",3,"change"],["title","Adjuntar archivo",1,"attach-btn",3,"click","disabled"],["placeholder","Escribe tu pregunta...","rows","1",3,"ngModelChange","keydown.enter","ngModel","disabled"],[1,"send-btn",3,"click","disabled"],[1,"spinner-sm"],[1,"input-hint"],[1,"welcome-icon"],[1,"suggestions"],[1,"suggestion",3,"click"],[1,"message"],[1,"message-avatar"],[1,"message-content"],[1,"message-text",3,"innerHTML"],[1,"message-time"],[1,"typing-indicator"],[1,"suggested-label"],[1,"suggestions-grid"],[1,"suggestion-btn"],[1,"suggestion-btn",3,"click"],[1,"attachment-icon"],[1,"attachment-name"],[1,"remove-attachment-btn",3,"click"]],template:function(n,t){if(n&1){let r=b();i(0,"div",3)(1,"header",4)(2,"div",5)(3,"span",6),o(4,"\u{1F916}"),a(),i(5,"div")(6,"h2"),o(7,"Asistente Contable IA"),a(),i(8,"p",7),o(9,"Experto en PGC, Verifactu y Crypto"),a()()(),i(10,"div",8)(11,"button",9),p("click",function(){return d(r),m(t.toggleLanguage())}),o(12),a(),i(13,"button",10),p("click",function(){return d(r),m(t.clearChat())}),o(14," Limpiar Chat "),a()()(),i(15,"div",11,0),C(17,ie,16,0,"div",12),O(18,ae,8,8,"div",13,ne),C(20,se,8,0,"div",14),a(),C(21,re,6,0,"div",15),i(22,"div",16),C(23,ce,7,1,"div",17),i(24,"div",18)(25,"input",19,1),p("change",function(c){return d(r),m(t.onFileSelected(c))}),a(),i(27,"button",20),p("click",function(){d(r);let c=j(26);return m(c.click())}),o(28," \u{1F4CE} "),a(),i(29,"textarea",21,2),K("ngModelChange",function(c){return d(r),q(t.userInput,c)||(t.userInput=c),m(c)}),p("keydown.enter",function(c){return d(r),m(t.onEnterPress(c))}),a(),i(31,"button",22),p("click",function(){return d(r),m(t.sendMessage())}),C(32,le,1,0,"span",23)(33,ge,1,0),a()(),i(34,"p",24),o(35,"Enter para enviar, Shift+Enter para nueva l\xEDnea \u2022 Adjunta im\xE1genes o PDFs"),a()()()}n&2&&(l(11),T("btn-primary",t.language()==="es")("btn-secondary",t.language()==="en"),l(),x(" ",t.language()==="es"?"\u{1F1EA}\u{1F1F8} ES":"\u{1F1EC}\u{1F1E7} EN"," "),l(5),f(17,t.messages().length===0?17:-1),l(),w(t.messages()),l(2),f(20,t.loading()?20:-1),l(),f(21,t.suggestedFollowUps().length>0&&!t.loading()?21:-1),l(2),f(23,t.attachedFile()?23:-1),l(4),v("disabled",t.loading()),l(2),B("ngModel",t.userInput),v("disabled",t.loading()),l(2),v("disabled",t.loading()||!t.userInput.trim()&&!t.attachedFile()),l(),f(32,t.loading()?32:33))},dependencies:[$,U,J,W,G,Y],styles:[".chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:calc(100vh - 60px);background:var(--gray-50)}.chat-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:var(--spacing-md) var(--spacing-xl);background:var(--white);border-bottom:1px solid var(--gray-200)}.chat-header[_ngcontent-%COMP%]   .header-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--spacing-md)}.chat-header[_ngcontent-%COMP%]   .header-info[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.125rem}.chat-header[_ngcontent-%COMP%]   .header-info[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:.75rem}.chat-header[_ngcontent-%COMP%]   .ai-avatar[_ngcontent-%COMP%]{font-size:2rem}.chat-messages[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:var(--spacing-xl);display:flex;flex-direction:column;gap:var(--spacing-md)}.welcome-message[_ngcontent-%COMP%]{text-align:center;padding:var(--spacing-2xl)}.welcome-message[_ngcontent-%COMP%]   .welcome-icon[_ngcontent-%COMP%]{font-size:3rem;display:block;margin-bottom:var(--spacing-md)}.welcome-message[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 var(--spacing-sm)}.welcome-message[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--gray-500);margin-bottom:var(--spacing-lg)}.welcome-message[_ngcontent-%COMP%]   .suggestions[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:var(--spacing-sm);justify-content:center}.welcome-message[_ngcontent-%COMP%]   .suggestion[_ngcontent-%COMP%]{padding:var(--spacing-sm) var(--spacing-md);background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-full);cursor:pointer;font-size:.875rem;transition:all var(--transition-fast)}.welcome-message[_ngcontent-%COMP%]   .suggestion[_ngcontent-%COMP%]:hover{border-color:var(--primary);background:#eff6ff}.message[_ngcontent-%COMP%]{display:flex;gap:var(--spacing-md);max-width:80%}.message.user[_ngcontent-%COMP%]{align-self:flex-end;flex-direction:row-reverse}.message.user[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:var(--primary);color:var(--white)}.message.user[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{color:#ffffffb3}.message.assistant[_ngcontent-%COMP%]{align-self:flex-start}.message.assistant[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background:var(--white);border:1px solid var(--gray-200)}.message-avatar[_ngcontent-%COMP%]{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;background:var(--gray-100);border-radius:var(--radius-full);flex-shrink:0}.message-content[_ngcontent-%COMP%]{padding:var(--spacing-md);border-radius:var(--radius-lg)}.message-content[_ngcontent-%COMP%]   .message-text[_ngcontent-%COMP%]{white-space:pre-wrap;line-height:1.6}.message-content[_ngcontent-%COMP%]   .message-text[_ngcontent-%COMP%]   [_ngcontent-%COMP%]:deep(code){background:#0000001a;padding:2px 6px;border-radius:var(--radius-sm);font-family:monospace}.message-content[_ngcontent-%COMP%]   .message-text[_ngcontent-%COMP%]   [_ngcontent-%COMP%]:deep(ul), .message-content[_ngcontent-%COMP%]   .message-text[_ngcontent-%COMP%]   [_ngcontent-%COMP%]:deep(ol){margin:var(--spacing-sm) 0;padding-left:var(--spacing-lg)}.message-content[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{display:block;font-size:.7rem;margin-top:var(--spacing-xs);color:var(--gray-400)}.typing-indicator[_ngcontent-%COMP%]{display:flex;gap:4px;padding:var(--spacing-sm) 0}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{width:8px;height:8px;background:var(--gray-400);border-radius:50%;animation:_ngcontent-%COMP%_typing 1.4s infinite ease-in-out}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){animation-delay:.2s}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(3){animation-delay:.4s}@keyframes _ngcontent-%COMP%_typing{0%,60%,to{transform:translateY(0)}30%{transform:translateY(-8px)}}.chat-input[_ngcontent-%COMP%]{padding:var(--spacing-md) var(--spacing-xl);background:var(--white);border-top:1px solid var(--gray-200)}.chat-input[_ngcontent-%COMP%]   .input-container[_ngcontent-%COMP%]{display:flex;gap:var(--spacing-sm);background:var(--gray-50);border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:var(--spacing-sm)}.chat-input[_ngcontent-%COMP%]   .input-container[_ngcontent-%COMP%]:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px #3b82f61a}.chat-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{flex:1;border:none;background:transparent;resize:none;font-size:.875rem;padding:var(--spacing-sm);max-height:120px}.chat-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{outline:none}.chat-input[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:var(--gray-400)}.chat-input[_ngcontent-%COMP%]   .send-btn[_ngcontent-%COMP%]{width:40px;height:40px;border:none;background:var(--primary);color:var(--white);border-radius:var(--radius-md);cursor:pointer;font-size:1.25rem;display:flex;align-items:center;justify-content:center;transition:all var(--transition-fast)}.chat-input[_ngcontent-%COMP%]   .send-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--primary-dark)}.chat-input[_ngcontent-%COMP%]   .send-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.chat-input[_ngcontent-%COMP%]   .input-hint[_ngcontent-%COMP%]{font-size:.7rem;color:var(--gray-400);text-align:center;margin:var(--spacing-xs) 0 0}.spinner-sm[_ngcontent-%COMP%]{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:var(--white);border-radius:50%;animation:_ngcontent-%COMP%_spin .8s linear infinite}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.suggested-questions[_ngcontent-%COMP%]{padding:var(--spacing-md) var(--spacing-xl);background:#fffbeb;border-top:1px solid #fbbf24}.suggested-questions[_ngcontent-%COMP%]   .suggested-label[_ngcontent-%COMP%]{margin:0 0 var(--spacing-sm);font-size:.875rem;font-weight:600;color:var(--gray-700)}.suggested-questions[_ngcontent-%COMP%]   .suggestions-grid[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:var(--spacing-xs)}.suggested-questions[_ngcontent-%COMP%]   .suggestion-btn[_ngcontent-%COMP%]{padding:var(--spacing-xs) var(--spacing-sm);background:var(--white);border:1px solid #fbbf24;border-radius:var(--radius-md);cursor:pointer;font-size:.875rem;color:var(--gray-700);transition:all var(--transition-fast)}.suggested-questions[_ngcontent-%COMP%]   .suggestion-btn[_ngcontent-%COMP%]:hover{background:#fef3c7;border-color:#f59e0b}.attachment-preview[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-sm);background:#eff6ff;border:1px solid #3b82f6;border-radius:var(--radius-md);margin-bottom:var(--spacing-sm)}.attachment-preview[_ngcontent-%COMP%]   .attachment-icon[_ngcontent-%COMP%]{font-size:1.25rem}.attachment-preview[_ngcontent-%COMP%]   .attachment-name[_ngcontent-%COMP%]{flex:1;font-size:.875rem;color:var(--gray-700);font-weight:500}.attachment-preview[_ngcontent-%COMP%]   .remove-attachment-btn[_ngcontent-%COMP%]{width:24px;height:24px;border:none;background:#ef4444;color:var(--white);border-radius:var(--radius-sm);cursor:pointer;font-size:1.125rem;line-height:1;transition:background var(--transition-fast)}.attachment-preview[_ngcontent-%COMP%]   .remove-attachment-btn[_ngcontent-%COMP%]:hover{background:#dc2626}.attach-btn[_ngcontent-%COMP%]{width:40px;height:40px;border:none;background:transparent;cursor:pointer;font-size:1.25rem;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-md);transition:all var(--transition-fast)}.attach-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:var(--gray-200)}.attach-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.header-actions[_ngcontent-%COMP%]{display:flex;gap:var(--spacing-sm)}"]})}return s})();export{Me as AiChatComponent};
