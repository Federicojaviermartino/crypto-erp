{"version":3,"sources":["../../../src/common/filters/sentry-exception.filter.ts"],"sourcesContent":["import { ExceptionFilter, Catch, ArgumentsHost, HttpException, HttpStatus } from '@nestjs/common';\nimport * as Sentry from '@sentry/node';\n\n@Catch()\nexport class SentryExceptionFilter implements ExceptionFilter {\n  catch(exception: unknown, host: ArgumentsHost) {\n    const ctx = host.switchToHttp();\n    const request = ctx.getRequest();\n    const response = ctx.getResponse();\n\n    // Determine status code\n    const status =\n      exception instanceof HttpException\n        ? exception.getStatus()\n        : HttpStatus.INTERNAL_SERVER_ERROR;\n\n    // Determine error message\n    const message =\n      exception instanceof HttpException\n        ? exception.message\n        : 'Internal server error';\n\n    // Capture in Sentry (only for 500 errors or non-HTTP exceptions)\n    if (status >= 500 || !(exception instanceof HttpException)) {\n      Sentry.captureException(exception, {\n        user: request.user\n          ? {\n              id: request.user.id,\n              email: request.user.email,\n            }\n          : undefined,\n        tags: {\n          companyId: request.companyId,\n          endpoint: request.url,\n          method: request.method,\n        },\n        extra: {\n          body: request.body,\n          params: request.params,\n          query: request.query,\n        },\n      });\n    }\n\n    // Send response to client\n    const errorResponse: any = {\n      statusCode: status,\n      timestamp: new Date().toISOString(),\n      path: request.url,\n      method: request.method,\n    };\n\n    if (exception instanceof HttpException) {\n      const exceptionResponse = exception.getResponse();\n      if (typeof exceptionResponse === 'object') {\n        Object.assign(errorResponse, exceptionResponse);\n      } else {\n        errorResponse.message = exceptionResponse;\n      }\n    } else {\n      errorResponse.message = message;\n    }\n\n    response.status(status).json(errorResponse);\n  }\n}\n"],"names":["SentryExceptionFilter","catch","exception","host","ctx","switchToHttp","request","getRequest","response","getResponse","status","HttpException","getStatus","HttpStatus","INTERNAL_SERVER_ERROR","message","Sentry","captureException","user","id","email","undefined","tags","companyId","endpoint","url","method","extra","body","params","query","errorResponse","statusCode","timestamp","Date","toISOString","path","exceptionResponse","Object","assign","json"],"mappings":";;;;+BAIaA;;;eAAAA;;;wBAJoE;8DACzD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,wBAAN,MAAMA;IACXC,MAAMC,SAAkB,EAAEC,IAAmB,EAAE;QAC7C,MAAMC,MAAMD,KAAKE,YAAY;QAC7B,MAAMC,UAAUF,IAAIG,UAAU;QAC9B,MAAMC,WAAWJ,IAAIK,WAAW;QAEhC,wBAAwB;QACxB,MAAMC,SACJR,qBAAqBS,qBAAa,GAC9BT,UAAUU,SAAS,KACnBC,kBAAU,CAACC,qBAAqB;QAEtC,0BAA0B;QAC1B,MAAMC,UACJb,qBAAqBS,qBAAa,GAC9BT,UAAUa,OAAO,GACjB;QAEN,iEAAiE;QACjE,IAAIL,UAAU,OAAO,CAAER,CAAAA,qBAAqBS,qBAAa,AAAD,GAAI;YAC1DK,MAAOC,gBAAgB,CAACf,WAAW;gBACjCgB,MAAMZ,QAAQY,IAAI,GACd;oBACEC,IAAIb,QAAQY,IAAI,CAACC,EAAE;oBACnBC,OAAOd,QAAQY,IAAI,CAACE,KAAK;gBAC3B,IACAC;gBACJC,MAAM;oBACJC,WAAWjB,QAAQiB,SAAS;oBAC5BC,UAAUlB,QAAQmB,GAAG;oBACrBC,QAAQpB,QAAQoB,MAAM;gBACxB;gBACAC,OAAO;oBACLC,MAAMtB,QAAQsB,IAAI;oBAClBC,QAAQvB,QAAQuB,MAAM;oBACtBC,OAAOxB,QAAQwB,KAAK;gBACtB;YACF;QACF;QAEA,0BAA0B;QAC1B,MAAMC,gBAAqB;YACzBC,YAAYtB;YACZuB,WAAW,IAAIC,OAAOC,WAAW;YACjCC,MAAM9B,QAAQmB,GAAG;YACjBC,QAAQpB,QAAQoB,MAAM;QACxB;QAEA,IAAIxB,qBAAqBS,qBAAa,EAAE;YACtC,MAAM0B,oBAAoBnC,UAAUO,WAAW;YAC/C,IAAI,OAAO4B,sBAAsB,UAAU;gBACzCC,OAAOC,MAAM,CAACR,eAAeM;YAC/B,OAAO;gBACLN,cAAchB,OAAO,GAAGsB;YAC1B;QACF,OAAO;YACLN,cAAchB,OAAO,GAAGA;QAC1B;QAEAP,SAASE,MAAM,CAACA,QAAQ8B,IAAI,CAACT;IAC/B;AACF"}