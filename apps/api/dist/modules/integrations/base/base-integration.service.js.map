{"version":3,"sources":["../../../../src/modules/integrations/base/base-integration.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CryptoService } from '../../auth/services/crypto.service.js';\n\n/**\n * Base Integration Service\n * Provides common functionality for all integrations\n */\n@Injectable()\nexport class BaseIntegrationService {\n  constructor(\n    protected readonly prisma: PrismaService,\n    protected readonly cryptoService: CryptoService,\n  ) {}\n\n  /**\n   * Create or update integration\n   */\n  async saveIntegration(data: {\n    companyId: string;\n    provider: string;\n    name: string;\n    accessToken: string;\n    refreshToken?: string;\n    expiresIn?: number;\n    metadata?: Record<string, any>;\n  }) {\n    // Encrypt tokens\n    const encryptedAccessToken = this.cryptoService.encrypt(data.accessToken);\n    const encryptedRefreshToken = data.refreshToken\n      ? this.cryptoService.encrypt(data.refreshToken)\n      : null;\n\n    // Calculate expiration\n    const expiresAt = data.expiresIn\n      ? new Date(Date.now() + data.expiresIn * 1000)\n      : null;\n\n    // Upsert integration\n    return this.prisma.integration.upsert({\n      where: {\n        companyId_provider: {\n          companyId: data.companyId,\n          provider: data.provider,\n        },\n      },\n      create: {\n        companyId: data.companyId,\n        provider: data.provider,\n        name: data.name,\n        accessToken: encryptedAccessToken,\n        refreshToken: encryptedRefreshToken,\n        expiresAt,\n        metadata: data.metadata || {},\n      },\n      update: {\n        name: data.name,\n        accessToken: encryptedAccessToken,\n        refreshToken: encryptedRefreshToken,\n        expiresAt,\n        metadata: data.metadata || {},\n        isActive: true,\n      },\n    });\n  }\n\n  /**\n   * Get integration for company and provider\n   */\n  async getIntegration(companyId: string, provider: string) {\n    return this.prisma.integration.findUnique({\n      where: {\n        companyId_provider: {\n          companyId,\n          provider,\n        },\n      },\n    });\n  }\n\n  /**\n   * Get decrypted access token\n   */\n  getDecryptedAccessToken(integration: { accessToken: string | null }): string | null {\n    if (!integration.accessToken) {\n      return null;\n    }\n\n    try {\n      return this.cryptoService.decrypt(integration.accessToken);\n    } catch (error) {\n      console.error('Failed to decrypt access token:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Get decrypted refresh token\n   */\n  getDecryptedRefreshToken(integration: { refreshToken: string | null }): string | null {\n    if (!integration.refreshToken) {\n      return null;\n    }\n\n    try {\n      return this.cryptoService.decrypt(integration.refreshToken);\n    } catch (error) {\n      console.error('Failed to decrypt refresh token:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Update sync status\n   */\n  async updateSyncStatus(\n    integrationId: string,\n    status: 'success' | 'error' | 'partial',\n    error?: string,\n  ) {\n    return this.prisma.integration.update({\n      where: { id: integrationId },\n      data: {\n        lastSyncAt: new Date(),\n        lastSyncStatus: status,\n        lastSyncError: error || null,\n      },\n    });\n  }\n\n  /**\n   * List all integrations for company\n   */\n  async listIntegrations(companyId: string) {\n    return this.prisma.integration.findMany({\n      where: { companyId },\n      select: {\n        id: true,\n        provider: true,\n        name: true,\n        syncEnabled: true,\n        syncFrequency: true,\n        lastSyncAt: true,\n        lastSyncStatus: true,\n        isActive: true,\n        createdAt: true,\n        expiresAt: true,\n      },\n      orderBy: { createdAt: 'desc' },\n    });\n  }\n\n  /**\n   * Disconnect integration\n   */\n  async disconnectIntegration(integrationId: string, companyId: string) {\n    const integration = await this.prisma.integration.findFirst({\n      where: {\n        id: integrationId,\n        companyId,\n      },\n    });\n\n    if (!integration) {\n      throw new Error('Integration not found');\n    }\n\n    return this.prisma.integration.update({\n      where: { id: integrationId },\n      data: {\n        isActive: false,\n        syncEnabled: false,\n      },\n    });\n  }\n\n  /**\n   * Delete integration\n   */\n  async deleteIntegration(integrationId: string, companyId: string) {\n    const integration = await this.prisma.integration.findFirst({\n      where: {\n        id: integrationId,\n        companyId,\n      },\n    });\n\n    if (!integration) {\n      throw new Error('Integration not found');\n    }\n\n    return this.prisma.integration.delete({\n      where: { id: integrationId },\n    });\n  }\n}\n"],"names":["BaseIntegrationService","saveIntegration","data","encryptedAccessToken","cryptoService","encrypt","accessToken","encryptedRefreshToken","refreshToken","expiresAt","expiresIn","Date","now","prisma","integration","upsert","where","companyId_provider","companyId","provider","create","name","metadata","update","isActive","getIntegration","findUnique","getDecryptedAccessToken","decrypt","error","console","getDecryptedRefreshToken","updateSyncStatus","integrationId","status","id","lastSyncAt","lastSyncStatus","lastSyncError","listIntegrations","findMany","select","syncEnabled","syncFrequency","createdAt","orderBy","disconnectIntegration","findFirst","Error","deleteIntegration","delete"],"mappings":"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"}