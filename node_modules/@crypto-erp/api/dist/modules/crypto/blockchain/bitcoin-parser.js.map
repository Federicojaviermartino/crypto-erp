{"version":3,"sources":["../../../../src/modules/crypto/blockchain/bitcoin-parser.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { CryptoTxType } from '@prisma/client';\n\nexport interface BitcoinTransaction {\n  txid: string;\n  hash: string;\n  version: number;\n  size: number;\n  vsize: number;\n  weight: number;\n  locktime: number;\n  vin: BitcoinInput[];\n  vout: BitcoinOutput[];\n  blockhash?: string;\n  confirmations?: number;\n  time?: number;\n  blocktime?: number;\n  fee?: number;\n}\n\nexport interface BitcoinInput {\n  txid: string;\n  vout: number;\n  scriptSig: {\n    asm: string;\n    hex: string;\n  };\n  sequence: number;\n  addresses?: string[];\n  value?: number;\n}\n\nexport interface BitcoinOutput {\n  value: number;\n  n: number;\n  scriptPubKey: {\n    asm: string;\n    hex: string;\n    type: string;\n    addresses?: string[];\n  };\n}\n\nexport interface ParsedBitcoinTransaction {\n  type: CryptoTxType;\n  subtype?: string;\n  assetIn?: string;\n  amountIn?: string;\n  assetOut?: string;\n  amountOut?: string;\n  feeAsset: 'BTC';\n  feeAmount?: string;\n  confidence: number;\n  reasoning: string;\n}\n\n/**\n * Bitcoin Transaction Parser\n *\n * Bitcoin uses UTXO (Unspent Transaction Output) model, different from Ethereum's account model.\n * Each transaction consumes previous outputs (inputs) and creates new outputs.\n *\n * Limitations:\n * - No native smart contracts (no DEX swaps on-chain)\n * - No native staking (consensus is PoW)\n * - Transfers only (TRANSFER_IN, TRANSFER_OUT, CONSOLIDATION)\n *\n * Advanced features (Lightning Network, Taproot) are out of scope for MVP.\n */\n@Injectable()\nexport class BitcoinParser {\n  private readonly logger = new Logger(BitcoinParser.name);\n  private readonly SATOSHIS_PER_BTC = 100_000_000;\n\n  /**\n   * Parse Bitcoin transaction into standard format\n   */\n  parseTransaction(\n    tx: BitcoinTransaction,\n    walletAddress: string,\n  ): ParsedBitcoinTransaction {\n    try {\n      // Calculate amounts for this wallet\n      const inputAmount = this.calculateInputAmount(tx, walletAddress);\n      const outputAmount = this.calculateOutputAmount(tx, walletAddress);\n      const fee = tx.fee || 0;\n\n      // Determine transaction type\n      if (inputAmount > 0 && outputAmount > 0) {\n        // Self-transfer or consolidation\n        return this.parseConsolidation(inputAmount, outputAmount, fee);\n      } else if (inputAmount > 0 && outputAmount === 0) {\n        // Sent BTC (all outputs go to other addresses)\n        return this.parseTransferOut(inputAmount, fee);\n      } else if (inputAmount === 0 && outputAmount > 0) {\n        // Received BTC (inputs from other addresses)\n        return this.parseTransferIn(outputAmount);\n      } else {\n        // No involvement with this address\n        return {\n          type: 'OTHER',\n          feeAsset: 'BTC',\n          confidence: 0.5,\n          reasoning: 'Transaction does not involve this address',\n        };\n      }\n    } catch (error) {\n      this.logger.error(`Failed to parse Bitcoin transaction: ${error.message}`);\n      return {\n        type: 'OTHER',\n        feeAsset: 'BTC',\n        confidence: 0.1,\n        reasoning: `Parse error: ${error.message}`,\n      };\n    }\n  }\n\n  /**\n   * Calculate total BTC amount in inputs from this wallet\n   */\n  private calculateInputAmount(tx: BitcoinTransaction, address: string): number {\n    let total = 0;\n\n    for (const input of tx.vin) {\n      if (input.addresses && input.addresses.includes(address) && input.value) {\n        total += input.value;\n      }\n    }\n\n    return total;\n  }\n\n  /**\n   * Calculate total BTC amount in outputs to this wallet\n   */\n  private calculateOutputAmount(tx: BitcoinTransaction, address: string): number {\n    let total = 0;\n\n    for (const output of tx.vout) {\n      if (\n        output.scriptPubKey.addresses &&\n        output.scriptPubKey.addresses.includes(address)\n      ) {\n        total += output.value;\n      }\n    }\n\n    return total;\n  }\n\n  /**\n   * Parse consolidation transaction (wallet sent to itself)\n   */\n  private parseConsolidation(\n    inputAmount: number,\n    outputAmount: number,\n    fee: number,\n  ): ParsedBitcoinTransaction {\n    const netChange = outputAmount - inputAmount;\n\n    if (Math.abs(netChange) < 0.00001) {\n      // Pure consolidation (UTXO optimization)\n      return {\n        type: 'OTHER',\n        subtype: 'consolidation',\n        assetIn: 'BTC',\n        amountIn: this.satoshisToBtc(outputAmount),\n        assetOut: 'BTC',\n        amountOut: this.satoshisToBtc(inputAmount),\n        feeAsset: 'BTC',\n        feeAmount: this.satoshisToBtc(fee),\n        confidence: 0.95,\n        reasoning: `UTXO consolidation: ${tx.vin.length} inputs â†’ ${tx.vout.length} outputs`,\n      };\n    } else if (netChange > 0) {\n      // Partial send with change back\n      return {\n        type: 'TRANSFER_OUT',\n        assetOut: 'BTC',\n        amountOut: this.satoshisToBtc(inputAmount - outputAmount),\n        feeAsset: 'BTC',\n        feeAmount: this.satoshisToBtc(fee),\n        confidence: 0.9,\n        reasoning: `Sent BTC with change returned`,\n      };\n    } else {\n      // Should not happen (received more than sent)\n      return {\n        type: 'TRANSFER_IN',\n        assetIn: 'BTC',\n        amountIn: this.satoshisToBtc(Math.abs(netChange)),\n        feeAsset: 'BTC',\n        confidence: 0.7,\n        reasoning: 'Unusual transaction: received more than sent',\n      };\n    }\n  }\n\n  /**\n   * Parse outgoing transfer\n   */\n  private parseTransferOut(\n    inputAmount: number,\n    fee: number,\n  ): ParsedBitcoinTransaction {\n    return {\n      type: 'TRANSFER_OUT',\n      assetOut: 'BTC',\n      amountOut: this.satoshisToBtc(inputAmount),\n      feeAsset: 'BTC',\n      feeAmount: this.satoshisToBtc(fee),\n      confidence: 1.0,\n      reasoning: `Sent ${this.satoshisToBtc(inputAmount)} BTC`,\n    };\n  }\n\n  /**\n   * Parse incoming transfer\n   */\n  private parseTransferIn(outputAmount: number): ParsedBitcoinTransaction {\n    return {\n      type: 'TRANSFER_IN',\n      assetIn: 'BTC',\n      amountIn: this.satoshisToBtc(outputAmount),\n      feeAsset: 'BTC',\n      confidence: 1.0,\n      reasoning: `Received ${this.satoshisToBtc(outputAmount)} BTC`,\n    };\n  }\n\n  /**\n   * Convert satoshis to BTC string\n   */\n  private satoshisToBtc(satoshis: number): string {\n    return (satoshis / this.SATOSHIS_PER_BTC).toFixed(8);\n  }\n\n  /**\n   * Detect if transaction is SegWit\n   */\n  isSegWit(tx: BitcoinTransaction): boolean {\n    return tx.vsize < tx.size;\n  }\n\n  /**\n   * Detect if transaction is Taproot (P2TR)\n   */\n  isTaproot(tx: BitcoinTransaction): boolean {\n    return tx.vout.some(\n      output => output.scriptPubKey.type === 'witness_v1_taproot',\n    );\n  }\n\n  /**\n   * Calculate effective fee rate (sat/vByte)\n   */\n  calculateFeeRate(tx: BitcoinTransaction): number {\n    if (!tx.fee || !tx.vsize) return 0;\n    return Math.round(tx.fee / tx.vsize);\n  }\n}\n"],"names":["BitcoinParser","parseTransaction","tx","walletAddress","inputAmount","calculateInputAmount","outputAmount","calculateOutputAmount","fee","parseConsolidation","parseTransferOut","parseTransferIn","type","feeAsset","confidence","reasoning","error","logger","message","address","total","input","vin","addresses","includes","value","output","vout","scriptPubKey","netChange","Math","abs","subtype","assetIn","amountIn","satoshisToBtc","assetOut","amountOut","feeAmount","length","satoshis","SATOSHIS_PER_BTC","toFixed","isSegWit","vsize","size","isTaproot","some","calculateFeeRate","round","Logger","name"],"mappings":";;;;+BAsEaA;;;eAAAA;;;wBAtEsB;;;;;;;AAsE5B,IAAA,AAAMA,gBAAN,MAAMA;IAIX;;GAEC,GACDC,iBACEC,GAAsB,EACtBC,aAAqB,EACK;QAC1B,IAAI;YACF,oCAAoC;YACpC,MAAMC,cAAc,IAAI,CAACC,oBAAoB,CAACH,KAAIC;YAClD,MAAMG,eAAe,IAAI,CAACC,qBAAqB,CAACL,KAAIC;YACpD,MAAMK,MAAMN,IAAGM,GAAG,IAAI;YAEtB,6BAA6B;YAC7B,IAAIJ,cAAc,KAAKE,eAAe,GAAG;gBACvC,iCAAiC;gBACjC,OAAO,IAAI,CAACG,kBAAkB,CAACL,aAAaE,cAAcE;YAC5D,OAAO,IAAIJ,cAAc,KAAKE,iBAAiB,GAAG;gBAChD,+CAA+C;gBAC/C,OAAO,IAAI,CAACI,gBAAgB,CAACN,aAAaI;YAC5C,OAAO,IAAIJ,gBAAgB,KAAKE,eAAe,GAAG;gBAChD,6CAA6C;gBAC7C,OAAO,IAAI,CAACK,eAAe,CAACL;YAC9B,OAAO;gBACL,mCAAmC;gBACnC,OAAO;oBACLM,MAAM;oBACNC,UAAU;oBACVC,YAAY;oBACZC,WAAW;gBACb;YACF;QACF,EAAE,OAAOC,OAAO;YACd,IAAI,CAACC,MAAM,CAACD,KAAK,CAAC,CAAC,qCAAqC,EAAEA,MAAME,OAAO,EAAE;YACzE,OAAO;gBACLN,MAAM;gBACNC,UAAU;gBACVC,YAAY;gBACZC,WAAW,CAAC,aAAa,EAAEC,MAAME,OAAO,EAAE;YAC5C;QACF;IACF;IAEA;;GAEC,GACD,AAAQb,qBAAqBH,GAAsB,EAAEiB,OAAe,EAAU;QAC5E,IAAIC,QAAQ;QAEZ,KAAK,MAAMC,SAASnB,IAAGoB,GAAG,CAAE;YAC1B,IAAID,MAAME,SAAS,IAAIF,MAAME,SAAS,CAACC,QAAQ,CAACL,YAAYE,MAAMI,KAAK,EAAE;gBACvEL,SAASC,MAAMI,KAAK;YACtB;QACF;QAEA,OAAOL;IACT;IAEA;;GAEC,GACD,AAAQb,sBAAsBL,GAAsB,EAAEiB,OAAe,EAAU;QAC7E,IAAIC,QAAQ;QAEZ,KAAK,MAAMM,UAAUxB,IAAGyB,IAAI,CAAE;YAC5B,IACED,OAAOE,YAAY,CAACL,SAAS,IAC7BG,OAAOE,YAAY,CAACL,SAAS,CAACC,QAAQ,CAACL,UACvC;gBACAC,SAASM,OAAOD,KAAK;YACvB;QACF;QAEA,OAAOL;IACT;IAEA;;GAEC,GACD,AAAQX,mBACNL,WAAmB,EACnBE,YAAoB,EACpBE,GAAW,EACe;QAC1B,MAAMqB,YAAYvB,eAAeF;QAEjC,IAAI0B,KAAKC,GAAG,CAACF,aAAa,SAAS;YACjC,yCAAyC;YACzC,OAAO;gBACLjB,MAAM;gBACNoB,SAAS;gBACTC,SAAS;gBACTC,UAAU,IAAI,CAACC,aAAa,CAAC7B;gBAC7B8B,UAAU;gBACVC,WAAW,IAAI,CAACF,aAAa,CAAC/B;gBAC9BS,UAAU;gBACVyB,WAAW,IAAI,CAACH,aAAa,CAAC3B;gBAC9BM,YAAY;gBACZC,WAAW,CAAC,oBAAoB,EAAEb,GAAGoB,GAAG,CAACiB,MAAM,CAAC,UAAU,EAAErC,GAAGyB,IAAI,CAACY,MAAM,CAAC,QAAQ,CAAC;YACtF;QACF,OAAO,IAAIV,YAAY,GAAG;YACxB,gCAAgC;YAChC,OAAO;gBACLjB,MAAM;gBACNwB,UAAU;gBACVC,WAAW,IAAI,CAACF,aAAa,CAAC/B,cAAcE;gBAC5CO,UAAU;gBACVyB,WAAW,IAAI,CAACH,aAAa,CAAC3B;gBAC9BM,YAAY;gBACZC,WAAW,CAAC,6BAA6B,CAAC;YAC5C;QACF,OAAO;YACL,8CAA8C;YAC9C,OAAO;gBACLH,MAAM;gBACNqB,SAAS;gBACTC,UAAU,IAAI,CAACC,aAAa,CAACL,KAAKC,GAAG,CAACF;gBACtChB,UAAU;gBACVC,YAAY;gBACZC,WAAW;YACb;QACF;IACF;IAEA;;GAEC,GACD,AAAQL,iBACNN,WAAmB,EACnBI,GAAW,EACe;QAC1B,OAAO;YACLI,MAAM;YACNwB,UAAU;YACVC,WAAW,IAAI,CAACF,aAAa,CAAC/B;YAC9BS,UAAU;YACVyB,WAAW,IAAI,CAACH,aAAa,CAAC3B;YAC9BM,YAAY;YACZC,WAAW,CAAC,KAAK,EAAE,IAAI,CAACoB,aAAa,CAAC/B,aAAa,IAAI,CAAC;QAC1D;IACF;IAEA;;GAEC,GACD,AAAQO,gBAAgBL,YAAoB,EAA4B;QACtE,OAAO;YACLM,MAAM;YACNqB,SAAS;YACTC,UAAU,IAAI,CAACC,aAAa,CAAC7B;YAC7BO,UAAU;YACVC,YAAY;YACZC,WAAW,CAAC,SAAS,EAAE,IAAI,CAACoB,aAAa,CAAC7B,cAAc,IAAI,CAAC;QAC/D;IACF;IAEA;;GAEC,GACD,AAAQ6B,cAAcK,QAAgB,EAAU;QAC9C,OAAO,AAACA,CAAAA,WAAW,IAAI,CAACC,gBAAgB,AAAD,EAAGC,OAAO,CAAC;IACpD;IAEA;;GAEC,GACDC,SAASzC,GAAsB,EAAW;QACxC,OAAOA,IAAG0C,KAAK,GAAG1C,IAAG2C,IAAI;IAC3B;IAEA;;GAEC,GACDC,UAAU5C,GAAsB,EAAW;QACzC,OAAOA,IAAGyB,IAAI,CAACoB,IAAI,CACjBrB,CAAAA,SAAUA,OAAOE,YAAY,CAAChB,IAAI,KAAK;IAE3C;IAEA;;GAEC,GACDoC,iBAAiB9C,GAAsB,EAAU;QAC/C,IAAI,CAACA,IAAGM,GAAG,IAAI,CAACN,IAAG0C,KAAK,EAAE,OAAO;QACjC,OAAOd,KAAKmB,KAAK,CAAC/C,IAAGM,GAAG,GAAGN,IAAG0C,KAAK;IACrC;;aA5LiB3B,SAAS,IAAIiC,cAAM,CAAClD,cAAcmD,IAAI;aACtCV,mBAAmB;;AA4LtC"}