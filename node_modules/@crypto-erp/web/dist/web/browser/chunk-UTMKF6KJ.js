import{c as R}from"./chunk-R5763NNK.js";import{a as L,b as d,c as B,d as G,f as j,g as z,h as $,i as Q,j as U,k as H,l as J,m as K,n as W,p as X,q as Y,s as Z}from"./chunk-OE3B74VB.js";import{a as ee}from"./chunk-JU2KEDBD.js";import"./chunk-FXBJWTCM.js";import{$a as b,Da as S,Fa as f,Fb as N,Gb as q,Ha as D,Ja as x,La as M,Ma as w,Na as P,Oa as i,Pa as t,Qa as v,Ra as h,Sa as g,Ta as m,U as A,Ya as V,Za as r,_a as O,aa as p,ab as k,ba as u,fb as T,hb as y,jb as E,ra as l,sa as I,xa as C}from"./chunk-2V2B4KT2.js";import"./chunk-35PI25VP.js";var te=(a,c)=>c.id;function ie(a,c){if(a&1){let e=h();i(0,"div",40),g("click",function(){p(e),m();let o=V(11);return u(o.click())}),i(1,"span",41),r(2,"\u{1F4C1}"),t(),i(3,"p",42),r(4,"Click para seleccionar factura (imagen o PDF)"),t(),i(5,"small",43),r(6,"El OCR extraer\xE1 autom\xE1ticamente los datos"),t()()}}function ne(a,c){if(a&1){let e=h();i(0,"button",53),g("click",function(){p(e);let o=m(2);return u(o.extractInvoiceData())}),r(1," \u{1F50D} Extraer Datos con OCR "),t()}}function re(a,c){a&1&&(i(0,"div",50),v(1,"span",54),i(2,"span"),r(3,"Procesando factura con OCR..."),t()())}function oe(a,c){if(a&1&&(i(0,"div",55),r(1),y(2,"number"),t()),a&2){let e=m(2);D("high",e.ocrConfidence()>.8)("medium",e.ocrConfidence()>.6&&e.ocrConfidence()<=.8)("low",e.ocrConfidence()<=.6),l(),b(" Confianza: ",E(2,7,e.ocrConfidence()*100,"1.0-0"),"% ")}}function ae(a,c){if(a&1&&(i(0,"div",52),r(1),t()),a&2){let e=m(2);l(),b(" \u274C ",e.ocrError()," ")}}function le(a,c){if(a&1){let e=h();i(0,"div",44)(1,"div",45)(2,"span",46),r(3,"\u{1F4C4}"),t(),i(4,"span",47),r(5),t(),i(6,"button",48),g("click",function(){p(e);let o=m();return u(o.removeFile())}),r(7," \xD7 Quitar "),t()(),S(8,ne,2,0,"button",49)(9,re,4,0,"div",50)(10,oe,3,10,"div",51)(11,ae,2,1,"div",52),t()}if(a&2){let e,n=m();l(5),O((e=n.selectedFile())==null?null:e.name),l(3),x(8,n.ocrProcessing()?-1:8),l(),x(9,n.ocrProcessing()?9:-1),l(),x(10,n.ocrConfidence()?10:-1),l(),x(11,n.ocrError()?11:-1)}}function ce(a,c){if(a&1&&(i(0,"option",16),r(1),t()),a&2){let e=c.$implicit;f("value",e.id),l(),k("",e.name," (",e.taxId||"Sin NIF",")")}}function se(a,c){if(a&1){let e=h();i(0,"button",48),g("click",function(){p(e);let o=m().$index,s=m();return u(s.removeLine(o))}),r(1,"\xD7"),t()}}function de(a,c){if(a&1&&(i(0,"tr",30)(1,"td"),v(2,"input",56),t(),i(3,"td"),v(4,"input",57),t(),i(5,"td"),v(6,"input",58),t(),i(7,"td")(8,"select",59)(9,"option",16),r(10,"21%"),t(),i(11,"option",16),r(12,"10%"),t(),i(13,"option",16),r(14,"4%"),t(),i(15,"option",16),r(16,"0%"),t()()(),i(17,"td",60)(18,"strong"),r(19),y(20,"number"),t()(),i(21,"td"),S(22,se,2,0,"button",61),t()()),a&2){let e=c.$index,n=m();f("formGroupName",e),l(9),f("value",21),l(2),f("value",10),l(2),f("value",4),l(2),f("value",0),l(4),b("",E(20,7,n.getLineTotal(e),"1.2-2")," \u20AC"),l(3),x(22,n.linesArray.length>1?22:-1)}}function me(a,c){if(a&1&&(i(0,"div",34),r(1),t()),a&2){let e=m();l(),O(e.error())}}var he=(()=>{class a{fb;api;router;form;contacts=C([]);saving=C(!1);error=C(null);issueAfterSave=!1;selectedFile=C(null);ocrProcessing=C(!1);ocrError=C(null);ocrConfidence=C(null);constructor(e,n,o){this.fb=e,this.api=n,this.router=o,this.form=this.fb.group({contactId:["",d.required],date:[new Date().toISOString().split("T")[0],d.required],dueDate:[""],notes:[""],lines:this.fb.array([])}),this.addLine()}ngOnInit(){this.loadContacts()}get linesArray(){return this.form.get("lines")}loadContacts(){this.api.get("/contacts",{type:"CUSTOMER"}).subscribe({next:e=>this.contacts.set(e.contacts||[])})}addLine(){this.linesArray.push(this.fb.group({description:["",d.required],quantity:[1,[d.required,d.min(0)]],unitPrice:[0,[d.required,d.min(0)]],vatRate:[21]}))}removeLine(e){this.linesArray.removeAt(e)}getLineTotal(e){let n=this.linesArray.at(e),o=n.get("quantity")?.value||0,s=n.get("unitPrice")?.value||0,_=n.get("vatRate")?.value||0,F=o*s;return F+F*_/100}subtotal(){return this.linesArray.controls.reduce((e,n)=>{let o=n.get("quantity")?.value||0,s=n.get("unitPrice")?.value||0;return e+o*s},0)}vatAmount(){return this.linesArray.controls.reduce((e,n)=>{let o=n.get("quantity")?.value||0,s=n.get("unitPrice")?.value||0,_=n.get("vatRate")?.value||0;return e+o*s*_/100},0)}total(){return this.subtotal()+this.vatAmount()}cancel(){this.router.navigate(["/invoicing/invoices"])}saveAndIssue(){this.issueAfterSave=!0,this.onSubmit()}onSubmit(){if(this.form.invalid){this.form.markAllAsTouched();return}this.saving.set(!0),this.error.set(null),this.api.post("/invoices/sales",this.form.value).subscribe({next:e=>{this.issueAfterSave?this.api.patch(`/invoices/${e.id}/issue`,{}).subscribe({next:()=>this.router.navigate(["/invoicing/invoices"]),error:n=>{this.saving.set(!1),this.error.set(n.error?.message||"Error al emitir")}}):this.router.navigate(["/invoicing/invoices"])},error:e=>{this.saving.set(!1),this.issueAfterSave=!1,this.error.set(e.error?.message||"Error al guardar")}})}onFileSelected(e){let n=e.target;n.files&&n.files[0]&&(this.selectedFile.set(n.files[0]),this.ocrError.set(null),this.ocrConfidence.set(null))}removeFile(){this.selectedFile.set(null),this.ocrError.set(null),this.ocrConfidence.set(null)}extractInvoiceData(){let e=this.selectedFile();if(!e)return;this.ocrProcessing.set(!0),this.ocrError.set(null);let n=new FormData;n.append("file",e),this.api.post("/ai/ocr/extract-invoice",n).subscribe({next:o=>{o.success&&o.data?(this.populateFormFromOcr(o.data),this.ocrConfidence.set(o.data.confidence)):this.ocrError.set(o.error||"No se pudieron extraer los datos"),this.ocrProcessing.set(!1)},error:o=>{this.ocrError.set(o.error?.message||"Error al procesar la factura"),this.ocrProcessing.set(!1)}})}populateFormFromOcr(e){if(e.invoiceDate&&this.form.patchValue({date:e.invoiceDate}),e.dueDate&&this.form.patchValue({dueDate:e.dueDate}),e.issuerName&&e.issuerTaxId){let n=this.contacts().find(o=>o.taxId===e.issuerTaxId);n&&this.form.patchValue({contactId:n.id})}if(e.lineItems&&e.lineItems.length>0){for(;this.linesArray.length>0;)this.linesArray.removeAt(0);e.lineItems.forEach(n=>{this.linesArray.push(this.fb.group({description:[n.description||"",d.required],quantity:[n.quantity||1,[d.required,d.min(0)]],unitPrice:[n.unitPrice||0,[d.required,d.min(0)]],vatRate:[e.taxRate||21]}))})}}static \u0275fac=function(n){return new(n||a)(I(Y),I(ee),I(R))};static \u0275cmp=A({type:a,selectors:[["app-invoice-form"]],standalone:!0,features:[T],decls:91,vars:17,consts:[["fileInput",""],[1,"page"],[1,"page-header"],[1,"card","mb-lg","ocr-section"],[1,"card-header"],[1,"card-body"],[1,"ocr-upload"],["type","file","accept","image/*,application/pdf",2,"display","none",3,"change"],[1,"upload-prompt"],[3,"ngSubmit","formGroup"],[1,"card","mb-lg"],[1,"form-row"],[1,"form-group",2,"flex","2"],[1,"form-label"],["formControlName","contactId",1,"form-select"],["value",""],[3,"value"],[1,"form-group"],["type","date","formControlName","date",1,"form-input"],["type","date","formControlName","dueDate",1,"form-input"],["formControlName","notes","rows","2","placeholder","Notas o comentarios",1,"form-textarea"],[1,"card-header","d-flex","justify-between","align-center"],["type","button",1,"btn","btn-sm","btn-secondary",3,"click"],[1,"card-body",2,"padding","0"],[1,"table"],[2,"width","100px"],[2,"width","120px"],[2,"width","80px"],[2,"width","50px"],["formArrayName","lines"],[3,"formGroupName"],[1,"totals-card","card","mb-lg"],[1,"totals-row"],[1,"totals-row","total"],[1,"alert","alert-danger","mb-lg"],[1,"d-flex","gap-md","justify-between"],["type","button",1,"btn","btn-secondary",3,"click"],[1,"d-flex","gap-md"],["type","submit",1,"btn","btn-secondary",3,"disabled"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"upload-prompt",3,"click"],[1,"upload-icon"],[1,"upload-text"],[1,"upload-hint"],[1,"file-selected"],[1,"file-info"],[1,"file-icon"],[1,"file-name"],["type","button",1,"btn","btn-sm","btn-danger",3,"click"],["type","button",1,"btn","btn-primary"],[1,"ocr-loading"],[1,"confidence-badge",3,"high","medium","low"],[1,"error-message"],["type","button",1,"btn","btn-primary",3,"click"],[1,"spinner"],[1,"confidence-badge"],["type","text","formControlName","description","placeholder","Descripci\xF3n",1,"form-input"],["type","number","formControlName","quantity","min","0","step","0.01",1,"form-input","text-right"],["type","number","formControlName","unitPrice","min","0","step","0.01",1,"form-input","text-right"],["formControlName","vatRate",1,"form-select"],[1,"text-right"],["type","button",1,"btn","btn-sm","btn-danger"]],template:function(n,o){if(n&1){let s=h();i(0,"div",1)(1,"header",2)(2,"h1"),r(3,"Nueva Factura de Venta"),t()(),i(4,"div",3)(5,"div",4)(6,"h3"),r(7,"\u{1F4C4} Auto-rellenar con OCR"),t()(),i(8,"div",5)(9,"div",6)(10,"input",7,0),g("change",function(F){return p(s),u(o.onFileSelected(F))}),t(),S(12,ie,7,0,"div",8)(13,le,12,5),t()()(),i(14,"form",9),g("ngSubmit",function(){return p(s),u(o.onSubmit())}),i(15,"div",10)(16,"div",5)(17,"div",11)(18,"div",12)(19,"label",13),r(20,"Cliente *"),t(),i(21,"select",14)(22,"option",15),r(23,"Seleccionar cliente"),t(),w(24,ce,2,3,"option",16,te),t()(),i(26,"div",17)(27,"label",13),r(28,"Fecha *"),t(),v(29,"input",18),t(),i(30,"div",17)(31,"label",13),r(32,"Vencimiento"),t(),v(33,"input",19),t()(),i(34,"div",17)(35,"label",13),r(36,"Notas"),t(),v(37,"textarea",20),t()()(),i(38,"div",10)(39,"div",21)(40,"h3"),r(41,"L\xEDneas de Factura"),t(),i(42,"button",22),g("click",function(){return p(s),u(o.addLine())}),r(43," + A\xF1adir L\xEDnea "),t()(),i(44,"div",23)(45,"table",24)(46,"thead")(47,"tr")(48,"th"),r(49,"Descripci\xF3n"),t(),i(50,"th",25),r(51,"Cantidad"),t(),i(52,"th",26),r(53,"Precio"),t(),i(54,"th",27),r(55,"IVA %"),t(),i(56,"th",26),r(57,"Total"),t(),v(58,"th",28),t()(),i(59,"tbody",29),w(60,de,23,10,"tr",30,M),t()()()(),i(62,"div",31)(63,"div",5)(64,"div",32)(65,"span"),r(66,"Base Imponible:"),t(),i(67,"span"),r(68),y(69,"number"),t()(),i(70,"div",32)(71,"span"),r(72,"IVA:"),t(),i(73,"span"),r(74),y(75,"number"),t()(),i(76,"div",33)(77,"span"),r(78,"TOTAL:"),t(),i(79,"span"),r(80),y(81,"number"),t()()()(),S(82,me,2,1,"div",34),i(83,"div",35)(84,"button",36),g("click",function(){return p(s),u(o.cancel())}),r(85,"Cancelar"),t(),i(86,"div",37)(87,"button",38),r(88," Guardar Borrador "),t(),i(89,"button",39),g("click",function(){return p(s),u(o.saveAndIssue())}),r(90," Guardar y Emitir "),t()()()()()}n&2&&(l(12),x(12,o.selectedFile()?13:12),l(2),f("formGroup",o.form),l(10),P(o.contacts()),l(36),P(o.linesArray.controls),l(8),b("",E(69,8,o.subtotal(),"1.2-2")," \u20AC"),l(6),b("",E(75,11,o.vatAmount(),"1.2-2")," \u20AC"),l(6),b("",E(81,14,o.total(),"1.2-2")," \u20AC"),l(2),x(82,o.error()?82:-1),l(5),f("disabled",o.saving()),l(2),f("disabled",o.saving()))},dependencies:[q,N,Z,j,K,W,L,z,J,B,G,X,$,H,Q,U],styles:[".page[_ngcontent-%COMP%]{padding:var(--spacing-xl);max-width:1000px}.form-row[_ngcontent-%COMP%]{display:flex;gap:var(--spacing-md)}.form-row[_ngcontent-%COMP%]   .form-group[_ngcontent-%COMP%]{flex:1}.totals-card[_ngcontent-%COMP%]{max-width:300px;margin-left:auto}.totals-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:var(--spacing-sm) 0}.totals-row.total[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:600;border-top:2px solid var(--gray-200);margin-top:var(--spacing-sm);padding-top:var(--spacing-md)}.alert[_ngcontent-%COMP%]{padding:var(--spacing-md);border-radius:var(--radius-md)}.alert-danger[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.ocr-section[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border:2px dashed #0ea5e9}.ocr-upload[_ngcontent-%COMP%]{min-height:120px;display:flex;align-items:center;justify-content:center}.upload-prompt[_ngcontent-%COMP%]{text-align:center;cursor:pointer;padding:var(--spacing-lg);transition:all var(--transition-fast)}.upload-prompt[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.upload-prompt[_ngcontent-%COMP%]   .upload-icon[_ngcontent-%COMP%]{font-size:3rem;display:block;margin-bottom:var(--spacing-sm)}.upload-prompt[_ngcontent-%COMP%]   .upload-text[_ngcontent-%COMP%]{font-weight:600;color:var(--gray-700);margin:0 0 var(--spacing-xs)}.upload-prompt[_ngcontent-%COMP%]   .upload-hint[_ngcontent-%COMP%]{color:var(--gray-500);font-size:.875rem}.file-selected[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column;gap:var(--spacing-md)}.file-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--white);border-radius:var(--radius-md)}.file-info[_ngcontent-%COMP%]   .file-icon[_ngcontent-%COMP%]{font-size:1.5rem}.file-info[_ngcontent-%COMP%]   .file-name[_ngcontent-%COMP%]{flex:1;font-weight:500;color:var(--gray-700)}.ocr-loading[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-md);background:var(--white);border-radius:var(--radius-md);color:var(--gray-600)}.confidence-badge[_ngcontent-%COMP%]{padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);font-weight:600;text-align:center}.confidence-badge.high[_ngcontent-%COMP%]{background:#d1fae5;color:#065f46}.confidence-badge.medium[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.confidence-badge.low[_ngcontent-%COMP%]{background:#fee2e2;color:#991b1b}.error-message[_ngcontent-%COMP%]{padding:var(--spacing-md);background:#fee2e2;color:#991b1b;border-radius:var(--radius-md);font-weight:500}"]})}return a})();export{he as InvoiceFormComponent};
