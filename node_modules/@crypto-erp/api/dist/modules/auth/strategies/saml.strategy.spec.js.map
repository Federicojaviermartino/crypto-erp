{"version":3,"sources":["../../../../src/modules/auth/strategies/saml.strategy.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { SamlStrategy } from './saml.strategy';\nimport { AuthService } from '../auth.service';\nimport { ConfigService } from '@nestjs/config';\nimport { UnauthorizedException } from '@nestjs/common';\n\ndescribe('SamlStrategy', () => {\n  let strategy: SamlStrategy;\n  let authService: AuthService;\n\n  const mockConfigService = {\n    get: jest.fn((key: string) => {\n      const config = {\n        SAML_ENTRY_POINT: 'https://idp.example.com/sso',\n        SAML_ISSUER: 'crypto-erp',\n        SAML_CALLBACK_URL: 'http://localhost:3000/auth/sso/saml/callback',\n        SAML_CERT: 'test-cert',\n      };\n      return config[key];\n    }),\n  };\n\n  const mockAuthService = {\n    findOrCreateSSOUser: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        SamlStrategy,\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n        {\n          provide: AuthService,\n          useValue: mockAuthService,\n        },\n      ],\n    }).compile();\n\n    strategy = module.get<SamlStrategy>(SamlStrategy);\n    authService = module.get<AuthService>(AuthService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(strategy).toBeDefined();\n  });\n\n  describe('validate', () => {\n    it('should validate SAML profile with all fields', async () => {\n      const mockProfile = {\n        nameID: 'saml-user-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        displayName: 'John Doe',\n        sessionIndex: 'session-123',\n      } as any;\n\n      const mockUser = {\n        id: 'user-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n      };\n\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      const result = await strategy.validate(mockProfile);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith({\n        ssoProvider: 'saml',\n        ssoId: 'saml-user-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        ssoMetadata: {\n          sessionIndex: 'session-123',\n          attributes: mockProfile,\n        },\n      });\n\n      expect(result).toEqual(mockUser);\n    });\n\n    it('should use nameID if email is missing', async () => {\n      const mockProfile = {\n        nameID: 'user@example.com',\n        displayName: 'John Doe',\n      } as any;\n\n      const mockUser = { id: 'user-123' };\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      await strategy.validate(mockProfile);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith(\n        expect.objectContaining({\n          email: 'user@example.com',\n        }),\n      );\n    });\n\n    it('should parse name from displayName if firstName/lastName missing', async () => {\n      const mockProfile = {\n        nameID: 'user-123',\n        email: 'user@example.com',\n        displayName: 'John Michael Doe',\n      } as any;\n\n      const mockUser = { id: 'user-123' };\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      await strategy.validate(mockProfile);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith(\n        expect.objectContaining({\n          firstName: 'John',\n          lastName: 'Michael Doe',\n        }),\n      );\n    });\n\n    it('should throw error if no email or nameID', async () => {\n      const mockProfile = {\n        displayName: 'John Doe',\n      } as any;\n\n      await expect(strategy.validate(mockProfile)).rejects.toThrow(UnauthorizedException);\n    });\n\n    it('should handle service errors', async () => {\n      const mockProfile = {\n        nameID: 'user-123',\n        email: 'user@example.com',\n      } as any;\n\n      const error = new Error('Database error');\n      mockAuthService.findOrCreateSSOUser.mockRejectedValue(error);\n\n      await expect(strategy.validate(mockProfile)).rejects.toThrow(UnauthorizedException);\n    });\n  });\n});\n"],"names":["describe","strategy","authService","mockConfigService","get","jest","fn","key","config","SAML_ENTRY_POINT","SAML_ISSUER","SAML_CALLBACK_URL","SAML_CERT","mockAuthService","findOrCreateSSOUser","beforeEach","module","Test","createTestingModule","providers","SamlStrategy","provide","ConfigService","useValue","AuthService","compile","clearAllMocks","it","expect","toBeDefined","mockProfile","nameID","email","firstName","lastName","displayName","sessionIndex","mockUser","id","mockResolvedValue","result","validate","toHaveBeenCalledWith","ssoProvider","ssoId","ssoMetadata","attributes","toEqual","objectContaining","rejects","toThrow","UnauthorizedException","error","Error","mockRejectedValue"],"mappings":"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"}