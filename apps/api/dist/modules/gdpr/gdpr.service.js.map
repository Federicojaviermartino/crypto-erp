{"version":3,"sources":["../../../src/modules/gdpr/gdpr.service.ts"],"sourcesContent":["import { Injectable, BadRequestException, Logger } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { AuditService } from '../audit/audit.service';\nimport { AuditAction, UserRole } from '@prisma/client';\n\nexport interface GDPRExportData {\n  user: {\n    id: string;\n    email: string;\n    firstName: string;\n    lastName: string;\n    createdAt: Date;\n  };\n  companies: Array<{\n    id: string;\n    name: string;\n    role: UserRole;\n  }>;\n  data: {\n    invoices: any[];\n    contacts: any[];\n    cryptoTransactions: any[];\n    wallets: any[];\n    auditLogs: any[];\n  };\n  exportedAt: Date;\n  format: string;\n}\n\n@Injectable()\nexport class GDPRService {\n  private readonly logger = new Logger(GDPRService.name);\n\n  constructor(\n    private prisma: PrismaService,\n    private audit: AuditService,\n  ) {}\n\n  /**\n   * Export all user data for GDPR compliance\n   */\n  async exportUserData(userId: string): Promise<GDPRExportData> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        companyUsers: {\n          include: {\n            company: true,\n          },\n        },\n      },\n    });\n\n    if (!user) {\n      throw new BadRequestException('User not found');\n    }\n\n    // Get company IDs where user is a member\n    const companyIds = user.companyUsers.map((cu) => cu.companyId);\n\n    // Collect all user data across related entities\n    const [\n      invoices,\n      contacts,\n      cryptoTransactions,\n      wallets,\n      auditLogs,\n    ] = await Promise.all([\n      // Invoices from user's companies\n      this.prisma.invoice.findMany({\n        where: { companyId: { in: companyIds } },\n      }),\n      // Contacts from user's companies\n      this.prisma.contact.findMany({\n        where: { companyId: { in: companyIds } },\n      }),\n      // Crypto transactions from user's companies\n      this.prisma.cryptoTransaction.findMany({\n        where: {\n          wallet: {\n            companyId: { in: companyIds },\n          },\n        },\n      }),\n      // Wallets from user's companies\n      this.prisma.wallet.findMany({\n        where: { companyId: { in: companyIds } },\n      }),\n      // User's audit logs\n      this.audit.exportForGDPR(userId),\n    ]);\n\n    const exportData: GDPRExportData = {\n      user: {\n        id: user.id,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        createdAt: user.createdAt,\n      },\n      companies: user.companyUsers.map((cu) => ({\n        id: cu.company.id,\n        name: cu.company.name,\n        role: cu.role,\n      })),\n      data: {\n        invoices,\n        contacts,\n        cryptoTransactions,\n        wallets,\n        auditLogs,\n      },\n      exportedAt: new Date(),\n      format: 'JSON',\n    };\n\n    // Log the export action\n    await this.audit.log({\n      userId,\n      action: AuditAction.EXPORT,\n      entity: 'User',\n      entityId: userId,\n      metadata: {\n        gdprExport: true,\n        exportSize: JSON.stringify(exportData).length,\n      },\n    });\n\n    this.logger.log(`GDPR data export completed for user ${userId}`);\n\n    return exportData;\n  }\n\n  /**\n   * Delete user data (anonymization for data integrity)\n   */\n  async deleteUserData(userId: string, confirmation: string): Promise<void> {\n    if (confirmation !== 'DELETE MY DATA') {\n      throw new BadRequestException('Invalid confirmation text');\n    }\n\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        companyUsers: true,\n      },\n    });\n\n    if (!user) {\n      throw new BadRequestException('User not found');\n    }\n\n    // Check if user is OWNER of any company\n    const ownedCompanies = user.companyUsers.filter(\n      (cu) => cu.role === UserRole.OWNER,\n    );\n\n    if (ownedCompanies.length > 0) {\n      throw new BadRequestException(\n        'Cannot delete account while you own companies. Please transfer ownership first or delete the companies.',\n      );\n    }\n\n    // Log the deletion before anonymizing\n    await this.audit.log({\n      userId,\n      action: AuditAction.DELETE,\n      entity: 'User',\n      entityId: userId,\n      metadata: {\n        gdprDeletion: true,\n        companiesRemoved: user.companyUsers.length,\n      },\n    });\n\n    // Anonymize user data instead of hard delete (for referential integrity)\n    await this.prisma.$transaction([\n      // Anonymize user\n      this.prisma.user.update({\n        where: { id: userId },\n        data: {\n          email: `deleted-${userId}@anonymized.local`,\n          firstName: 'Deleted',\n          lastName: 'User',\n          passwordHash: 'DELETED',\n          avatarUrl: null,\n          isActive: false,\n          twoFactorEnabled: false,\n          twoFactorSecret: null,\n          twoFactorBackupCodes: null,\n        },\n      }),\n      // Remove user from all companies\n      this.prisma.companyUser.deleteMany({\n        where: { userId },\n      }),\n      // Cancel pending invitations sent by this user\n      this.prisma.companyInvitation.updateMany({\n        where: {\n          inviterId: userId,\n          status: 'PENDING',\n        },\n        data: {\n          status: 'CANCELLED',\n        },\n      }),\n    ]);\n\n    this.logger.log(`GDPR account deletion completed for user ${userId}`);\n  }\n\n  /**\n   * Check if user can be deleted\n   */\n  async canDeleteUser(userId: string): Promise<{\n    canDelete: boolean;\n    reasons: string[];\n  }> {\n    const user = await this.prisma.user.findUnique({\n      where: { id: userId },\n      include: {\n        companyUsers: {\n          include: {\n            company: true,\n          },\n        },\n      },\n    });\n\n    if (!user) {\n      return { canDelete: false, reasons: ['User not found'] };\n    }\n\n    const reasons: string[] = [];\n\n    // Check for owned companies\n    const ownedCompanies = user.companyUsers.filter(\n      (cu) => cu.role === UserRole.OWNER,\n    );\n\n    if (ownedCompanies.length > 0) {\n      reasons.push(\n        `You are the owner of ${ownedCompanies.length} company/companies: ${ownedCompanies.map((cu) => cu.company.name).join(', ')}`,\n      );\n    }\n\n    return {\n      canDelete: reasons.length === 0,\n      reasons,\n    };\n  }\n}\n"],"names":["GDPRService","exportUserData","userId","user","prisma","findUnique","where","id","include","companyUsers","company","BadRequestException","companyIds","map","cu","companyId","invoices","contacts","cryptoTransactions","wallets","auditLogs","Promise","all","invoice","findMany","in","contact","cryptoTransaction","wallet","audit","exportForGDPR","exportData","email","firstName","lastName","createdAt","companies","name","role","data","exportedAt","Date","format","log","action","AuditAction","EXPORT","entity","entityId","metadata","gdprExport","exportSize","JSON","stringify","length","logger","deleteUserData","confirmation","ownedCompanies","filter","UserRole","OWNER","DELETE","gdprDeletion","companiesRemoved","$transaction","update","passwordHash","avatarUrl","isActive","twoFactorEnabled","twoFactorSecret","twoFactorBackupCodes","companyUser","deleteMany","companyInvitation","updateMany","inviterId","status","canDeleteUser","canDelete","reasons","push","join","Logger"],"mappings":";;;;+BA8BaA;;;eAAAA;;;wBA9B2C;0BAC1B;8BACD;wBACS;;;;;;;;;;AA2B/B,IAAA,AAAMA,cAAN,MAAMA;IAQX;;GAEC,GACD,MAAMC,eAAeC,MAAc,EAA2B;QAC5D,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIL;YAAO;YACpBM,SAAS;gBACPC,cAAc;oBACZD,SAAS;wBACPE,SAAS;oBACX;gBACF;YACF;QACF;QAEA,IAAI,CAACP,MAAM;YACT,MAAM,IAAIQ,2BAAmB,CAAC;QAChC;QAEA,yCAAyC;QACzC,MAAMC,aAAaT,KAAKM,YAAY,CAACI,GAAG,CAAC,CAACC,KAAOA,GAAGC,SAAS;QAE7D,gDAAgD;QAChD,MAAM,CACJC,UACAC,UACAC,oBACAC,SACAC,UACD,GAAG,MAAMC,QAAQC,GAAG,CAAC;YACpB,iCAAiC;YACjC,IAAI,CAAClB,MAAM,CAACmB,OAAO,CAACC,QAAQ,CAAC;gBAC3BlB,OAAO;oBAAES,WAAW;wBAAEU,IAAIb;oBAAW;gBAAE;YACzC;YACA,iCAAiC;YACjC,IAAI,CAACR,MAAM,CAACsB,OAAO,CAACF,QAAQ,CAAC;gBAC3BlB,OAAO;oBAAES,WAAW;wBAAEU,IAAIb;oBAAW;gBAAE;YACzC;YACA,4CAA4C;YAC5C,IAAI,CAACR,MAAM,CAACuB,iBAAiB,CAACH,QAAQ,CAAC;gBACrClB,OAAO;oBACLsB,QAAQ;wBACNb,WAAW;4BAAEU,IAAIb;wBAAW;oBAC9B;gBACF;YACF;YACA,gCAAgC;YAChC,IAAI,CAACR,MAAM,CAACwB,MAAM,CAACJ,QAAQ,CAAC;gBAC1BlB,OAAO;oBAAES,WAAW;wBAAEU,IAAIb;oBAAW;gBAAE;YACzC;YACA,oBAAoB;YACpB,IAAI,CAACiB,KAAK,CAACC,aAAa,CAAC5B;SAC1B;QAED,MAAM6B,aAA6B;YACjC5B,MAAM;gBACJI,IAAIJ,KAAKI,EAAE;gBACXyB,OAAO7B,KAAK6B,KAAK;gBACjBC,WAAW9B,KAAK8B,SAAS;gBACzBC,UAAU/B,KAAK+B,QAAQ;gBACvBC,WAAWhC,KAAKgC,SAAS;YAC3B;YACAC,WAAWjC,KAAKM,YAAY,CAACI,GAAG,CAAC,CAACC,KAAQ,CAAA;oBACxCP,IAAIO,GAAGJ,OAAO,CAACH,EAAE;oBACjB8B,MAAMvB,GAAGJ,OAAO,CAAC2B,IAAI;oBACrBC,MAAMxB,GAAGwB,IAAI;gBACf,CAAA;YACAC,MAAM;gBACJvB;gBACAC;gBACAC;gBACAC;gBACAC;YACF;YACAoB,YAAY,IAAIC;YAChBC,QAAQ;QACV;QAEA,wBAAwB;QACxB,MAAM,IAAI,CAACb,KAAK,CAACc,GAAG,CAAC;YACnBzC;YACA0C,QAAQC,mBAAW,CAACC,MAAM;YAC1BC,QAAQ;YACRC,UAAU9C;YACV+C,UAAU;gBACRC,YAAY;gBACZC,YAAYC,KAAKC,SAAS,CAACtB,YAAYuB,MAAM;YAC/C;QACF;QAEA,IAAI,CAACC,MAAM,CAACZ,GAAG,CAAC,CAAC,oCAAoC,EAAEzC,QAAQ;QAE/D,OAAO6B;IACT;IAEA;;GAEC,GACD,MAAMyB,eAAetD,MAAc,EAAEuD,YAAoB,EAAiB;QACxE,IAAIA,iBAAiB,kBAAkB;YACrC,MAAM,IAAI9C,2BAAmB,CAAC;QAChC;QAEA,MAAMR,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIL;YAAO;YACpBM,SAAS;gBACPC,cAAc;YAChB;QACF;QAEA,IAAI,CAACN,MAAM;YACT,MAAM,IAAIQ,2BAAmB,CAAC;QAChC;QAEA,wCAAwC;QACxC,MAAM+C,iBAAiBvD,KAAKM,YAAY,CAACkD,MAAM,CAC7C,CAAC7C,KAAOA,GAAGwB,IAAI,KAAKsB,gBAAQ,CAACC,KAAK;QAGpC,IAAIH,eAAeJ,MAAM,GAAG,GAAG;YAC7B,MAAM,IAAI3C,2BAAmB,CAC3B;QAEJ;QAEA,sCAAsC;QACtC,MAAM,IAAI,CAACkB,KAAK,CAACc,GAAG,CAAC;YACnBzC;YACA0C,QAAQC,mBAAW,CAACiB,MAAM;YAC1Bf,QAAQ;YACRC,UAAU9C;YACV+C,UAAU;gBACRc,cAAc;gBACdC,kBAAkB7D,KAAKM,YAAY,CAAC6C,MAAM;YAC5C;QACF;QAEA,yEAAyE;QACzE,MAAM,IAAI,CAAClD,MAAM,CAAC6D,YAAY,CAAC;YAC7B,iBAAiB;YACjB,IAAI,CAAC7D,MAAM,CAACD,IAAI,CAAC+D,MAAM,CAAC;gBACtB5D,OAAO;oBAAEC,IAAIL;gBAAO;gBACpBqC,MAAM;oBACJP,OAAO,CAAC,QAAQ,EAAE9B,OAAO,iBAAiB,CAAC;oBAC3C+B,WAAW;oBACXC,UAAU;oBACViC,cAAc;oBACdC,WAAW;oBACXC,UAAU;oBACVC,kBAAkB;oBAClBC,iBAAiB;oBACjBC,sBAAsB;gBACxB;YACF;YACA,iCAAiC;YACjC,IAAI,CAACpE,MAAM,CAACqE,WAAW,CAACC,UAAU,CAAC;gBACjCpE,OAAO;oBAAEJ;gBAAO;YAClB;YACA,+CAA+C;YAC/C,IAAI,CAACE,MAAM,CAACuE,iBAAiB,CAACC,UAAU,CAAC;gBACvCtE,OAAO;oBACLuE,WAAW3E;oBACX4E,QAAQ;gBACV;gBACAvC,MAAM;oBACJuC,QAAQ;gBACV;YACF;SACD;QAED,IAAI,CAACvB,MAAM,CAACZ,GAAG,CAAC,CAAC,yCAAyC,EAAEzC,QAAQ;IACtE;IAEA;;GAEC,GACD,MAAM6E,cAAc7E,MAAc,EAG/B;QACD,MAAMC,OAAO,MAAM,IAAI,CAACC,MAAM,CAACD,IAAI,CAACE,UAAU,CAAC;YAC7CC,OAAO;gBAAEC,IAAIL;YAAO;YACpBM,SAAS;gBACPC,cAAc;oBACZD,SAAS;wBACPE,SAAS;oBACX;gBACF;YACF;QACF;QAEA,IAAI,CAACP,MAAM;YACT,OAAO;gBAAE6E,WAAW;gBAAOC,SAAS;oBAAC;iBAAiB;YAAC;QACzD;QAEA,MAAMA,UAAoB,EAAE;QAE5B,4BAA4B;QAC5B,MAAMvB,iBAAiBvD,KAAKM,YAAY,CAACkD,MAAM,CAC7C,CAAC7C,KAAOA,GAAGwB,IAAI,KAAKsB,gBAAQ,CAACC,KAAK;QAGpC,IAAIH,eAAeJ,MAAM,GAAG,GAAG;YAC7B2B,QAAQC,IAAI,CACV,CAAC,qBAAqB,EAAExB,eAAeJ,MAAM,CAAC,oBAAoB,EAAEI,eAAe7C,GAAG,CAAC,CAACC,KAAOA,GAAGJ,OAAO,CAAC2B,IAAI,EAAE8C,IAAI,CAAC,OAAO;QAEhI;QAEA,OAAO;YACLH,WAAWC,QAAQ3B,MAAM,KAAK;YAC9B2B;QACF;IACF;IAzNA,YACE,AAAQ7E,MAAqB,EAC7B,AAAQyB,KAAmB,CAC3B;aAFQzB,SAAAA;aACAyB,QAAAA;aAJO0B,SAAS,IAAI6B,cAAM,CAACpF,YAAYqC,IAAI;IAKlD;AAuNL"}