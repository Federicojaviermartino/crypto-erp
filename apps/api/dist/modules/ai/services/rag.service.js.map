{"version":3,"sources":["../../../../src/modules/ai/services/rag.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { EmbeddingsService, SearchResult } from './embeddings.service';\n\n/**\n * RAG (Retrieval Augmented Generation) Service\n * Mejora las respuestas del chatbot con contexto relevante de la base de conocimientos\n */\n\nexport interface RAGContext {\n  query: string;\n  relevantDocuments: SearchResult[];\n  enhancedPrompt: string;\n  tokensUsed: number;\n}\n\nexport interface RAGConfig {\n  maxDocuments: number;\n  minSimilarity: number;\n  maxContextTokens: number;\n  includeMetadata: boolean;\n}\n\nconst DEFAULT_CONFIG: RAGConfig = {\n  maxDocuments: 5,\n  minSimilarity: 0.7,\n  maxContextTokens: 2000,\n  includeMetadata: true,\n};\n\n@Injectable()\nexport class RAGService {\n  private readonly logger = new Logger(RAGService.name);\n\n  constructor(private readonly embeddingsService: EmbeddingsService) {}\n\n  /**\n   * Busca contexto relevante para una consulta\n   */\n  async retrieveContext(\n    companyId: string,\n    query: string,\n    category?: string,\n    config: Partial<RAGConfig> = {},\n  ): Promise<RAGContext> {\n    const finalConfig = { ...DEFAULT_CONFIG, ...config };\n\n    // Buscar documentos similares\n    const documents = await this.embeddingsService.searchSimilar(\n      companyId,\n      query,\n      finalConfig.maxDocuments,\n      category,\n    );\n\n    // Filtrar por similitud mínima\n    const relevantDocs = documents.filter(\n      (doc) => doc.similarity >= finalConfig.minSimilarity,\n    );\n\n    // Construir contexto\n    const context = this.buildContext(relevantDocs, finalConfig);\n\n    // Generar prompt mejorado\n    const enhancedPrompt = this.buildEnhancedPrompt(query, context);\n\n    this.logger.debug(\n      `RAG context: ${relevantDocs.length} docs, ~${context.tokens} tokens`,\n    );\n\n    return {\n      query,\n      relevantDocuments: relevantDocs,\n      enhancedPrompt,\n      tokensUsed: context.tokens,\n    };\n  }\n\n  /**\n   * Construye el contexto a partir de los documentos relevantes\n   */\n  private buildContext(\n    documents: SearchResult[],\n    config: RAGConfig,\n  ): { text: string; tokens: number } {\n    let contextText = '';\n    let estimatedTokens = 0;\n    const tokensPerChar = 0.25; // Aproximación: 1 token ≈ 4 caracteres\n\n    for (const doc of documents) {\n      const docText = config.includeMetadata\n        ? `[${(doc.metadata?.title as string) || 'Documento'}]\\n${doc.content}\\n\\n`\n        : `${doc.content}\\n\\n`;\n\n      const docTokens = Math.ceil(docText.length * tokensPerChar);\n\n      if (estimatedTokens + docTokens > config.maxContextTokens) {\n        // Truncar si excede el límite\n        const remainingTokens = config.maxContextTokens - estimatedTokens;\n        const remainingChars = Math.floor(remainingTokens / tokensPerChar);\n        contextText += docText.slice(0, remainingChars) + '...';\n        estimatedTokens = config.maxContextTokens;\n        break;\n      }\n\n      contextText += docText;\n      estimatedTokens += docTokens;\n    }\n\n    return { text: contextText.trim(), tokens: estimatedTokens };\n  }\n\n  /**\n   * Construye el prompt mejorado con contexto\n   */\n  private buildEnhancedPrompt(query: string, context: { text: string }): string {\n    if (!context.text) {\n      return query;\n    }\n\n    return `Contexto relevante de la base de conocimientos:\n---\n${context.text}\n---\n\nBasándote en el contexto anterior cuando sea relevante, responde a la siguiente pregunta:\n${query}`;\n  }\n\n  /**\n   * Procesa una consulta con RAG y devuelve el prompt optimizado\n   * para diferentes categorías de conocimiento\n   */\n  async processQuery(\n    companyId: string,\n    query: string,\n    options: {\n      categories?: string[];\n      config?: Partial<RAGConfig>;\n    } = {},\n  ): Promise<RAGContext> {\n    const categories = options.categories || [\n      'normativa-iva',\n      'modelos-aeat',\n      'fiscalidad-crypto',\n      'verifactu',\n      'pgc',\n      'modelo-303',\n      'modelo-200',\n      'boicac',\n      'pgc-detallado',\n    ];\n\n    // Buscar en todas las categorías relevantes\n    const allDocuments: SearchResult[] = [];\n\n    for (const category of categories) {\n      const docs = await this.embeddingsService.searchSimilar(\n        companyId,\n        query,\n        options.config?.maxDocuments || 3,\n        category,\n      );\n      allDocuments.push(...docs);\n    }\n\n    // Ordenar por similitud y tomar los mejores\n    const sortedDocs = allDocuments\n      .sort((a, b) => b.similarity - a.similarity)\n      .slice(0, options.config?.maxDocuments || DEFAULT_CONFIG.maxDocuments);\n\n    const config = { ...DEFAULT_CONFIG, ...options.config };\n    const relevantDocs = sortedDocs.filter(\n      (doc) => doc.similarity >= config.minSimilarity,\n    );\n\n    const context = this.buildContext(relevantDocs, config);\n    const enhancedPrompt = this.buildEnhancedPrompt(query, context);\n\n    return {\n      query,\n      relevantDocuments: relevantDocs,\n      enhancedPrompt,\n      tokensUsed: context.tokens,\n    };\n  }\n\n  /**\n   * Detecta la intención de la consulta para mejorar la búsqueda\n   */\n  detectQueryIntent(query: string): {\n    categories: string[];\n    isQuestion: boolean;\n    keywords: string[];\n  } {\n    const lowerQuery = query.toLowerCase();\n    const categories: string[] = [];\n    const keywords: string[] = [];\n\n    // Detectar categorías relevantes\n    if (\n      lowerQuery.includes('iva') ||\n      lowerQuery.includes('impuesto') ||\n      lowerQuery.includes('tipo')\n    ) {\n      categories.push('normativa-iva');\n      keywords.push('IVA', 'impuesto');\n    }\n\n    if (\n      lowerQuery.includes('modelo') ||\n      lowerQuery.includes('declaración') ||\n      lowerQuery.includes('303') ||\n      lowerQuery.includes('721') ||\n      lowerQuery.includes('720')\n    ) {\n      categories.push('modelos-aeat');\n      keywords.push('modelo', 'declaración');\n    }\n\n    if (\n      lowerQuery.includes('crypto') ||\n      lowerQuery.includes('bitcoin') ||\n      lowerQuery.includes('cripto') ||\n      lowerQuery.includes('fifo')\n    ) {\n      categories.push('fiscalidad-crypto');\n      keywords.push('crypto', 'criptomonedas');\n    }\n\n    if (\n      lowerQuery.includes('verifactu') ||\n      lowerQuery.includes('huella') ||\n      lowerQuery.includes('qr')\n    ) {\n      categories.push('verifactu');\n      keywords.push('verifactu', 'huella');\n    }\n\n    if (\n      lowerQuery.includes('cuenta') ||\n      lowerQuery.includes('pgc') ||\n      lowerQuery.includes('contabil')\n    ) {\n      categories.push('pgc');\n      categories.push('pgc-detallado');\n      keywords.push('contabilidad', 'PGC');\n    }\n\n    if (\n      lowerQuery.includes('303') ||\n      lowerQuery.includes('trimestral')\n    ) {\n      categories.push('modelo-303');\n      keywords.push('Modelo 303', 'IVA trimestral');\n    }\n\n    if (\n      lowerQuery.includes('200') ||\n      lowerQuery.includes('sociedades') ||\n      lowerQuery.includes('is ')\n    ) {\n      categories.push('modelo-200');\n      keywords.push('Modelo 200', 'Impuesto Sociedades');\n    }\n\n    if (\n      lowerQuery.includes('boicac') ||\n      lowerQuery.includes('icac') ||\n      lowerQuery.includes('amortiza')\n    ) {\n      categories.push('boicac');\n      keywords.push('BOICAC', 'contabilización');\n    }\n\n    // Si no se detecta ninguna categoría, usar todas\n    if (categories.length === 0) {\n      categories.push(\n        'normativa-iva',\n        'modelos-aeat',\n        'fiscalidad-crypto',\n        'verifactu',\n        'pgc',\n        'modelo-303',\n        'modelo-200',\n        'boicac',\n        'pgc-detallado',\n      );\n    }\n\n    // Detectar si es pregunta\n    const isQuestion =\n      lowerQuery.includes('?') ||\n      lowerQuery.startsWith('qué') ||\n      lowerQuery.startsWith('cómo') ||\n      lowerQuery.startsWith('cuál') ||\n      lowerQuery.startsWith('cuándo') ||\n      lowerQuery.startsWith('dónde') ||\n      lowerQuery.startsWith('por qué');\n\n    return { categories, isQuestion, keywords };\n  }\n\n  /**\n   * Consulta inteligente que detecta intención y busca contexto\n   */\n  async smartQuery(\n    companyId: string,\n    query: string,\n    config?: Partial<RAGConfig>,\n    language?: 'es' | 'en',\n  ): Promise<RAGContext> {\n    const intent = this.detectQueryIntent(query);\n\n    // Añadir sufijo de idioma a las categorías si es inglés\n    const categories = language === 'en'\n      ? intent.categories.map(cat => `${cat}-en`)\n      : intent.categories;\n\n    return this.processQuery(companyId, query, {\n      categories,\n      config: {\n        ...config,\n        // Ajustar similitud mínima según tipo de consulta\n        minSimilarity: intent.isQuestion ? 0.65 : 0.75,\n      },\n    });\n  }\n}\n"],"names":["RAGService","DEFAULT_CONFIG","maxDocuments","minSimilarity","maxContextTokens","includeMetadata","retrieveContext","companyId","query","category","config","finalConfig","documents","embeddingsService","searchSimilar","relevantDocs","filter","doc","similarity","context","buildContext","enhancedPrompt","buildEnhancedPrompt","logger","debug","length","tokens","relevantDocuments","tokensUsed","contextText","estimatedTokens","tokensPerChar","docText","metadata","title","content","docTokens","Math","ceil","remainingTokens","remainingChars","floor","slice","text","trim","processQuery","options","categories","allDocuments","docs","push","sortedDocs","sort","a","b","detectQueryIntent","lowerQuery","toLowerCase","keywords","includes","isQuestion","startsWith","smartQuery","language","intent","map","cat","Logger","name"],"mappings":"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"}