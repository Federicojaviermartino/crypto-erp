{"version":3,"sources":["../../src/middleware/cdn.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\n\n/**\n * CDN Middleware for setting cache headers and edge caching.\n * Optimizes content delivery through CloudFront or Cloudflare.\n */\n@Injectable()\nexport class CdnMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    const path = req.path;\n\n    // Static assets - aggressive caching (1 year)\n    if (this.isStaticAsset(path)) {\n      res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n      res.setHeader('CDN-Cache-Control', 'public, max-age=31536000');\n    }\n    // API documentation - moderate caching (1 hour)\n    else if (path.startsWith('/api-docs') || path.startsWith('/docs')) {\n      res.setHeader('Cache-Control', 'public, max-age=3600, s-maxage=3600');\n      res.setHeader('CDN-Cache-Control', 'public, max-age=3600');\n    }\n    // Health checks - short caching (30 seconds)\n    else if (path.startsWith('/health')) {\n      res.setHeader('Cache-Control', 'public, max-age=30, s-maxage=30');\n      res.setHeader('CDN-Cache-Control', 'public, max-age=30');\n    }\n    // Dynamic API endpoints - no caching\n    else {\n      res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n      res.setHeader('CDN-Cache-Control', 'private, no-cache');\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n    }\n\n    // Security headers\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n    res.setHeader('X-Frame-Options', 'DENY');\n    res.setHeader('X-XSS-Protection', '1; mode=block');\n    res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');\n\n    // CORS headers for CDN\n    if (process.env['NODE_ENV'] === 'production') {\n      res.setHeader('Access-Control-Allow-Credentials', 'true');\n      res.setHeader('Vary', 'Origin, CloudFront-Viewer-Country');\n    }\n\n    next();\n  }\n\n  /**\n   * Check if the path is a static asset.\n   */\n  private isStaticAsset(path: string): boolean {\n    const staticExtensions = [\n      '.js',\n      '.css',\n      '.png',\n      '.jpg',\n      '.jpeg',\n      '.gif',\n      '.svg',\n      '.ico',\n      '.woff',\n      '.woff2',\n      '.ttf',\n      '.eot',\n      '.otf',\n      '.mp4',\n      '.webm',\n      '.webp',\n    ];\n\n    return (\n      staticExtensions.some((ext) => path.endsWith(ext)) ||\n      path.startsWith('/static/')\n    );\n  }\n}\n"],"names":["CdnMiddleware","use","req","res","next","path","isStaticAsset","setHeader","startsWith","process","env","staticExtensions","some","ext","endsWith"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBAR8B;;;;;;;AAQpC,IAAA,AAAMA,gBAAN,MAAMA;IACXC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB,EAAE;QACnD,MAAMC,OAAOH,IAAIG,IAAI;QAErB,8CAA8C;QAC9C,IAAI,IAAI,CAACC,aAAa,CAACD,OAAO;YAC5BF,IAAII,SAAS,CAAC,iBAAiB;YAC/BJ,IAAII,SAAS,CAAC,qBAAqB;QACrC,OAEK,IAAIF,KAAKG,UAAU,CAAC,gBAAgBH,KAAKG,UAAU,CAAC,UAAU;YACjEL,IAAII,SAAS,CAAC,iBAAiB;YAC/BJ,IAAII,SAAS,CAAC,qBAAqB;QACrC,OAEK,IAAIF,KAAKG,UAAU,CAAC,YAAY;YACnCL,IAAII,SAAS,CAAC,iBAAiB;YAC/BJ,IAAII,SAAS,CAAC,qBAAqB;QACrC,OAEK;YACHJ,IAAII,SAAS,CAAC,iBAAiB;YAC/BJ,IAAII,SAAS,CAAC,qBAAqB;YACnCJ,IAAII,SAAS,CAAC,UAAU;YACxBJ,IAAII,SAAS,CAAC,WAAW;QAC3B;QAEA,mBAAmB;QACnBJ,IAAII,SAAS,CAAC,0BAA0B;QACxCJ,IAAII,SAAS,CAAC,mBAAmB;QACjCJ,IAAII,SAAS,CAAC,oBAAoB;QAClCJ,IAAII,SAAS,CAAC,mBAAmB;QAEjC,uBAAuB;QACvB,IAAIE,QAAQC,GAAG,CAAC,WAAW,KAAK,cAAc;YAC5CP,IAAII,SAAS,CAAC,oCAAoC;YAClDJ,IAAII,SAAS,CAAC,QAAQ;QACxB;QAEAH;IACF;IAEA;;GAEC,GACD,AAAQE,cAAcD,IAAY,EAAW;QAC3C,MAAMM,mBAAmB;YACvB;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,OACEA,iBAAiBC,IAAI,CAAC,CAACC,MAAQR,KAAKS,QAAQ,CAACD,SAC7CR,KAAKG,UAAU,CAAC;IAEpB;AACF"}