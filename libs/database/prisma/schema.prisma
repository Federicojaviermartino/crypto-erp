// Prisma Schema for Crypto ERP
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
    engineType      = "library"
previewFeatures = ["postgresqlExtensions", "fullTextSearch"]
    binaryTargets   = ["native", "rhel-openssl-3.0.x", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), uuidOssp(map: "uuid-ossp")]
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

/// User account for authentication
model User {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  firstName    String   @map("first_name") @db.VarChar(100)
  lastName     String   @map("last_name") @db.VarChar(100)
  avatarUrl    String?  @map("avatar_url") @db.VarChar(500)
  isActive     Boolean  @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")

  // Two-Factor Authentication
  twoFactorEnabled    Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret     String?  @map("two_factor_secret") @db.VarChar(500) // TOTP secret encrypted
  twoFactorBackupCodes String? @map("two_factor_backup_codes") @db.Text // Encrypted JSON array

  // SSO/SAML Authentication
  ssoProvider    String?  @map("sso_provider") @db.VarChar(50) // "google", "azure", "okta", "saml"
  ssoId          String?  @map("sso_id") @db.VarChar(255) // External SSO user ID
  ssoMetadata    Json?    @map("sso_metadata") @default("{}") // Provider-specific metadata

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  companyUsers    CompanyUser[]
  aiConversations AiConversation[]
  invitationsSent CompanyInvitation[] @relation("InvitationsSent")
  invitationsAccepted CompanyInvitation[] @relation("InvitationsAccepted")
  auditLogs       AuditLog[]
  onboarding      UserOnboarding?
  analyticsEvents AnalyticsEvent[]
  oauthAppsCreated OAuthApp[]
  oauthTokens     OAuthToken[]
  apiUsage        ApiUsage[]

  @@index([email])
  @@index([ssoProvider, ssoId])
  @@unique([ssoProvider, ssoId])
  @@map("users")
}

/// Company (tenant) - main multi-tenancy entity
model Company {
  id                         String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                       String               @db.VarChar(255)
  legalName                  String?              @map("legal_name") @db.VarChar(255)
  taxId                      String               @map("tax_id") @db.VarChar(20)
  taxIdType                  TaxIdType            @default(CIF) @map("tax_id_type")
  address                    String?              @db.VarChar(500)
  city                       String?              @db.VarChar(100)
  province                   String?              @db.VarChar(100)
  postalCode                 String?              @map("postal_code") @db.VarChar(10)
  country                    String               @default("ES") @db.VarChar(2)
  region                     String               @default("eu") @db.VarChar(10) // Database region (eu, us, asia)
  phone                      String?              @db.VarChar(20)
  email                      String?              @db.VarChar(255)
  website                    String?              @db.VarChar(255)
  currency                   String               @default("EUR") @db.VarChar(3)
  fiscalYearStart            Int                  @default(1) @map("fiscal_year_start") // Month (1-12)
  logo                       String?              @db.VarChar(500)

  // Verifactu configuration
  verifactuEnabled           Boolean              @default(false) @map("verifactu_enabled")
  verifactuId                String?              @map("verifactu_id") @db.VarChar(50)
  verifactuLastHash          String?              @map("verifactu_last_hash") @db.VarChar(64)

  // Crypto configuration
  defaultCryptoClassification CryptoClassification @default(INVENTORY) @map("default_crypto_classification")

  // Settings (JSON for flexibility)
  settings                   Json?                @default("{}")

  createdAt                  DateTime             @default(now()) @map("created_at")
  updatedAt                  DateTime             @updatedAt @map("updated_at")
  deletedAt                  DateTime?            @map("deleted_at")

  // Relations
  companyUsers     CompanyUser[]
  fiscalYears      FiscalYear[]
  accounts         Account[]
  journalEntries   JournalEntry[]
  invoices         Invoice[]
  invoiceSeries    InvoiceSeries[]
  contacts         Contact[]
  wallets          Wallet[]
  cryptoAssets     CryptoAsset[]
  cryptoLots       CryptoLot[]
  exchangeAccounts ExchangeAccount[]
  aiConversations  AiConversation[]
  documents        Document[]
  invitations      CompanyInvitation[]
  auditLogs        AuditLog[]
  webhookSubscriptions WebhookSubscription[]
  analyticsEvents  AnalyticsEvent[]
  oauthApps        OAuthApp[]
  oauthTokens      OAuthToken[]
  apiUsage         ApiUsage[]
  integrations     Integration[]
  whiteLabelConfig WhiteLabelConfig?
  partnerCustomer  PartnerCustomer?

  @@index([taxId])
  @@map("companies")
}

/// User-Company relationship with role
model CompanyUser {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  role      UserRole @default(USER)
  isDefault Boolean  @default(false) @map("is_default") // Default company for user
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("company_users")
}

/// Customer/Supplier contact
model Contact {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String      @map("company_id") @db.Uuid
  type        ContactType @default(CUSTOMER)
  name        String      @db.VarChar(255)
  legalName   String?     @map("legal_name") @db.VarChar(255)
  taxId       String?     @map("tax_id") @db.VarChar(20)
  taxIdType   TaxIdType?  @map("tax_id_type")
  address     String?     @db.VarChar(500)
  city        String?     @db.VarChar(100)
  postalCode  String?     @map("postal_code") @db.VarChar(10)
  country     String      @default("ES") @db.VarChar(2)
  phone       String?     @db.VarChar(20)
  email       String?     @db.VarChar(255)
  website     String?     @db.VarChar(255)
  notes       String?
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@index([companyId, type])
  @@index([companyId, taxId])
  @@map("contacts")
}

// ============================================================================
// ACCOUNTING ENTITIES
// ============================================================================

/// Fiscal year period
model FiscalYear {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId String    @map("company_id") @db.Uuid
  name      String    @db.VarChar(20) // "2024", "2025"
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime  @map("end_date") @db.Date
  isClosed  Boolean   @default(false) @map("is_closed")
  closedAt  DateTime? @map("closed_at")
  closedBy  String?   @map("closed_by") @db.Uuid
  notes     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  company        Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([companyId, name])
  @@index([companyId, startDate, endDate])
  @@map("fiscal_years")
}

/// Chart of accounts
model Account {
  id           String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId    String      @map("company_id") @db.Uuid
  code         String      @db.VarChar(20) // "430", "572001", "305BTC"
  name         String      @db.VarChar(255) // "Customers", "Bank Santander", "Bitcoin"
  type         AccountType
  parentCode   String?     @map("parent_code") @db.VarChar(20) // For hierarchy
  description  String?
  
  // Crypto-specific
  isCrypto     Boolean     @default(false) @map("is_crypto")
  cryptoAssetId String?    @map("crypto_asset_id") @db.Uuid

  // Control flags
  isActive     Boolean     @default(true) @map("is_active")
  isSystem     Boolean     @default(false) @map("is_system") // Cannot be deleted
  allowDirectPosting Boolean @default(true) @map("allow_direct_posting")

  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cryptoAsset  CryptoAsset? @relation(fields: [cryptoAssetId], references: [id])
  journalLines JournalLine[]

  @@unique([companyId, code])
  @@index([companyId, type])
  @@index([companyId, parentCode])
  @@map("accounts")
}

/// Journal entry header
model JournalEntry {
  id            String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId     String         @map("company_id") @db.Uuid
  fiscalYearId  String         @map("fiscal_year_id") @db.Uuid
  number        Int            // Sequential number within fiscal year
  date          DateTime       @db.Date
  description   String         @db.VarChar(500)
  reference     String?        @db.VarChar(100) // External reference
  referenceType ReferenceType? @map("reference_type")

  // Source tracking
  sourceType    SourceType?    @map("source_type")
  sourceId      String?        @map("source_id") @db.VarChar(100)

  // Status
  status        JournalStatus  @default(DRAFT)
  isPosted      Boolean        @default(false) @map("is_posted")
  postedAt      DateTime?      @map("posted_at")
  postedBy      String?        @map("posted_by") @db.Uuid

  // Reversal
  isReversal    Boolean        @default(false) @map("is_reversal")
  reversalOf    String?        @map("reversal_of") @db.Uuid
  reversedBy    String?        @map("reversed_by") @db.Uuid

  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  company    Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  fiscalYear FiscalYear    @relation(fields: [fiscalYearId], references: [id])
  lines      JournalLine[]

  @@unique([companyId, fiscalYearId, number])
  @@index([companyId, date])
  @@index([companyId, status])
  @@index([sourceType, sourceId])
  @@map("journal_entries")
}

/// Journal entry line (debit or credit)
model JournalLine {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  journalEntryId String   @map("journal_entry_id") @db.Uuid
  accountId      String   @map("account_id") @db.Uuid
  lineNumber     Int      @map("line_number")
  description    String?  @db.VarChar(255)

  // Amounts in base currency (EUR)
  debit          Decimal  @default(0) @db.Decimal(18, 8)
  credit         Decimal  @default(0) @db.Decimal(18, 8)

  // Crypto amounts (optional)
  cryptoAmount   Decimal? @map("crypto_amount") @db.Decimal(28, 18)
  cryptoAsset    String?  @map("crypto_asset") @db.VarChar(20) // "BTC", "ETH"
  cryptoPrice    Decimal? @map("crypto_price") @db.Decimal(18, 8) // EUR price at tx time

  // Analytics (optional)
  costCenter     String?  @map("cost_center") @db.VarChar(50)
  project        String?  @db.VarChar(50)

  createdAt      DateTime @default(now()) @map("created_at")

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id])

  @@unique([journalEntryId, lineNumber])
  @@index([journalEntryId])
  @@index([accountId])
  @@map("journal_lines")
}

// ============================================================================
// INVOICING ENTITIES
// ============================================================================

/// Invoice series configuration
model InvoiceSeries {
  id          String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String      @map("company_id") @db.Uuid
  code        String      @db.VarChar(10) // "F", "R", "A"
  name        String      @db.VarChar(100) // "Standard Invoices"
  type        InvoiceType
  prefix      String?     @db.VarChar(20) // "2024-"
  suffix      String?     @db.VarChar(20)
  nextNumber  Int         @default(1) @map("next_number")
  digitCount  Int         @default(6) @map("digit_count") // Padding zeros
  isDefault   Boolean     @default(false) @map("is_default")
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@unique([companyId, code])
  @@map("invoice_series")
}

/// Invoice header
model Invoice {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId           String           @map("company_id") @db.Uuid
  seriesId            String           @map("series_id") @db.Uuid
  contactId           String?          @map("contact_id") @db.Uuid

  // Invoice identification
  number              Int
  fullNumber          String           @map("full_number") @db.VarChar(50) // "F2024-000001"
  type                InvoiceType
  status              InvoiceStatus    @default(DRAFT)
  direction           InvoiceDirection

  // Dates
  issueDate           DateTime         @map("issue_date") @db.Date
  dueDate             DateTime?        @map("due_date") @db.Date
  operationDate       DateTime?        @map("operation_date") @db.Date
  paidAt              DateTime?        @map("paid_at")

  // Counterparty (denormalized for invoice immutability)
  counterpartyName    String           @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxId   String?          @map("counterparty_tax_id") @db.VarChar(20)
  counterpartyAddress String?          @map("counterparty_address") @db.VarChar(500)
  counterpartyCity    String?          @map("counterparty_city") @db.VarChar(100)
  counterpartyCountry String           @default("ES") @map("counterparty_country") @db.VarChar(2)

  // Amounts
  subtotal            Decimal          @db.Decimal(18, 2)
  discountAmount      Decimal          @default(0) @map("discount_amount") @db.Decimal(18, 2)
  taxableBase         Decimal          @map("taxable_base") @db.Decimal(18, 2)
  totalTax            Decimal          @map("total_tax") @db.Decimal(18, 2)
  total               Decimal          @db.Decimal(18, 2)
  currency            String           @default("EUR") @db.VarChar(3)
  exchangeRate        Decimal          @default(1) @map("exchange_rate") @db.Decimal(12, 6)

  // Crypto payment (optional)
  cryptoPayment       Boolean          @default(false) @map("crypto_payment")
  cryptoAsset         String?          @map("crypto_asset") @db.VarChar(20)
  cryptoAmount        Decimal?         @map("crypto_amount") @db.Decimal(28, 18)
  cryptoRate          Decimal?         @map("crypto_rate") @db.Decimal(18, 8)
  cryptoTxHash        String?          @map("crypto_tx_hash") @db.VarChar(100)

  // Verifactu compliance
  verifactuHash       String?          @map("verifactu_hash") @db.VarChar(64)
  verifactuPrevHash   String?          @map("verifactu_prev_hash") @db.VarChar(64)
  verifactuQrData     String?          @map("verifactu_qr_data") @db.VarChar(500)
  verifactuSentAt     DateTime?        @map("verifactu_sent_at")
  verifactuResponse   Json?            @map("verifactu_response")
  verifactuStatus     VerifactuStatus? @map("verifactu_status")

  // Notes
  notes               String?
  internalNotes       String?          @map("internal_notes")
  paymentTerms        String?          @map("payment_terms") @db.VarChar(255)
  paymentMethod       String?          @map("payment_method") @db.VarChar(50)

  // Accounting link
  journalEntryId      String?          @map("journal_entry_id") @db.Uuid

  // PDF storage
  pdfUrl              String?          @map("pdf_url") @db.VarChar(500)

  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")

  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  series           InvoiceSeries     @relation(fields: [seriesId], references: [id])
  contact          Contact?          @relation(fields: [contactId], references: [id])
  lines            InvoiceLine[]
  taxes            InvoiceTax[]
  verifactuRecords VerifactuRecord[]

  @@unique([companyId, seriesId, number])
  @@index([companyId, status])
  @@index([companyId, issueDate])
  @@index([companyId, direction])
  @@index([verifactuHash])
  @@map("invoices")
}

/// Invoice line item
model InvoiceLine {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId   String  @map("invoice_id") @db.Uuid
  lineNumber  Int     @map("line_number")

  description String  @db.VarChar(500)
  quantity    Decimal @db.Decimal(18, 4)
  unitPrice   Decimal @map("unit_price") @db.Decimal(18, 4)
  discount    Decimal @default(0) @db.Decimal(5, 2) // Percentage

  subtotal    Decimal @db.Decimal(18, 2)
  taxRate     Decimal @map("tax_rate") @db.Decimal(5, 2) // 21.00, 10.00, 4.00, 0.00
  taxAmount   Decimal @map("tax_amount") @db.Decimal(18, 2)
  total       Decimal @db.Decimal(18, 2)

  // Optional account mapping for automatic journal entry
  accountCode String? @map("account_code") @db.VarChar(20)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, lineNumber])
  @@map("invoice_lines")
}

/// Invoice tax breakdown (for multi-rate invoices)
model InvoiceTax {
  id          String  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId   String  @map("invoice_id") @db.Uuid
  taxRate     Decimal @map("tax_rate") @db.Decimal(5, 2)
  taxableBase Decimal @map("taxable_base") @db.Decimal(18, 2)
  taxAmount   Decimal @map("tax_amount") @db.Decimal(18, 2)
  taxType     TaxType @default(IVA) @map("tax_type")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, taxRate, taxType])
  @@map("invoice_taxes")
}

// ============================================================================
// CRYPTOCURRENCY ENTITIES
// ============================================================================

/// Crypto asset definition
model CryptoAsset {
  id             String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId      String               @map("company_id") @db.Uuid

  symbol         String               @db.VarChar(20) // "BTC", "ETH"
  name           String               @db.VarChar(100) // "Bitcoin", "Ethereum"
  decimals       Int                  @default(18)
  contractAddress String?             @map("contract_address") @db.VarChar(100) // For tokens

  // Classification for accounting
  classification CryptoClassification @default(INVENTORY)

  // CoinGecko ID for price fetching
  coingeckoId    String?              @map("coingecko_id") @db.VarChar(100)

  // Current price cache
  lastPrice      Decimal?             @map("last_price") @db.Decimal(18, 8)
  lastPriceAt    DateTime?            @map("last_price_at")

  isActive       Boolean              @default(true) @map("is_active")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  company  Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  accounts Account[]
  lots     CryptoLot[]

  @@unique([companyId, symbol])
  @@map("crypto_assets")
}

/// Blockchain wallet
model Wallet {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String     @map("company_id") @db.Uuid

  address     String     @db.VarChar(100)
  chain       String     @db.VarChar(50) // "ethereum", "polygon", "bsc"
  label       String?    @db.VarChar(100) // User-friendly name
  type        WalletType @default(EXTERNAL)

  // Sync status
  lastSyncAt  DateTime?  @map("last_sync_at")
  lastSyncBlock BigInt?  @map("last_sync_block")
  syncStatus  SyncStatus @default(PENDING) @map("sync_status")
  syncError   String?    @map("sync_error")

  // Linked account for automatic journal entries
  accountCode String?    @map("account_code") @db.VarChar(20)

  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  company      Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions CryptoTransaction[]

  @@unique([companyId, chain, address])
  @@index([companyId, isActive])
  @@map("wallets")
}

/// Exchange account (Binance, Coinbase, etc.)
model ExchangeAccount {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId    String     @map("company_id") @db.Uuid

  exchange     String     @db.VarChar(50) // "binance", "coinbase", "kraken"
  label        String?    @db.VarChar(100)
  apiKey       String?    @map("api_key") @db.VarChar(255) // Encrypted
  apiSecret    String?    @map("api_secret") @db.VarChar(255) // Encrypted
  isReadOnly   Boolean    @default(true) @map("is_read_only")

  // Sync status
  lastSyncAt   DateTime?  @map("last_sync_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  syncError    String?    @map("sync_error")

  // For Model 721 reporting
  country      String     @default("MT") @db.VarChar(2) // Exchange country

  isActive     Boolean    @default(true) @map("is_active")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, exchange, apiKey])
  @@map("exchange_accounts")
}

/// Blockchain transaction
model CryptoTransaction {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  walletId        String       @map("wallet_id") @db.Uuid

  // Blockchain data
  txHash          String       @map("tx_hash") @db.VarChar(100)
  blockNumber     BigInt       @map("block_number")
  blockTimestamp  DateTime     @map("block_timestamp")
  chain           String       @db.VarChar(50)

  // Transaction classification
  type            CryptoTxType
  subtype         String?      @db.VarChar(50) // "uniswap_v3", "lido_stake", etc.

  // Amounts
  assetIn         String?      @map("asset_in") @db.VarChar(20)
  amountIn        Decimal?     @map("amount_in") @db.Decimal(28, 18)
  assetOut        String?      @map("asset_out") @db.VarChar(20)
  amountOut       Decimal?     @map("amount_out") @db.Decimal(28, 18)

  // Fees
  feeAsset        String?      @map("fee_asset") @db.VarChar(20)
  feeAmount       Decimal?     @map("fee_amount") @db.Decimal(28, 18)

  // EUR pricing at transaction time
  priceInEur      Decimal?     @map("price_in_eur") @db.Decimal(18, 8)
  priceOutEur     Decimal?     @map("price_out_eur") @db.Decimal(18, 8)
  feeEur          Decimal?     @map("fee_eur") @db.Decimal(18, 8)

  // Cost basis (FIFO calculation)
  costBasis       Decimal?     @map("cost_basis") @db.Decimal(18, 8)
  realizedGain    Decimal?     @map("realized_gain") @db.Decimal(18, 8)

  // AI categorization
  aiCategorized   Boolean      @default(false) @map("ai_categorized")
  aiConfidence    Decimal?     @map("ai_confidence") @db.Decimal(5, 4)
  aiReasoning     String?      @map("ai_reasoning")

  // Manual override
  manualType      CryptoTxType? @map("manual_type")
  manualNotes     String?      @map("manual_notes")

  // Accounting link
  journalEntryId  String?      @map("journal_entry_id") @db.Uuid

  // Processing status
  status          TxStatus     @default(PENDING)

  // Raw data for debugging
  rawData         Json?        @map("raw_data")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, txHash])
  @@index([walletId, blockTimestamp])
  @@index([walletId, type])
  @@index([status])
  @@map("crypto_transactions")
}

/// FIFO cost basis lot
model CryptoLot {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId       String   @map("company_id") @db.Uuid
  cryptoAssetId   String   @map("crypto_asset_id") @db.Uuid

  // Acquisition data
  acquiredAt      DateTime @map("acquired_at")
  acquiredAmount  Decimal  @map("acquired_amount") @db.Decimal(28, 18)
  costBasisEur    Decimal  @map("cost_basis_eur") @db.Decimal(18, 8)
  costPerUnit     Decimal  @map("cost_per_unit") @db.Decimal(18, 8)

  // Remaining for FIFO
  remainingAmount Decimal  @map("remaining_amount") @db.Decimal(28, 18)

  // Source tracking
  sourceTxId      String?  @map("source_tx_id") @db.VarChar(100)
  sourceType      String?  @map("source_type") @db.VarChar(50) // "purchase", "staking", "airdrop"

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cryptoAsset CryptoAsset @relation(fields: [cryptoAssetId], references: [id])

  @@index([companyId, cryptoAssetId, acquiredAt])
  @@index([companyId, remainingAmount])
  @@map("crypto_lots")
}

/// Price history for cost basis calculations
model PriceHistory {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  symbol    String   @db.VarChar(20)
  priceEur  Decimal  @map("price_eur") @db.Decimal(18, 8)
  source    String   @db.VarChar(50) // "coingecko", "manual", "exchange"
  timestamp DateTime @default(now())

  @@index([symbol, timestamp])
  @@map("price_history")
}

/// Verifactu record for tracking AEAT submissions
model VerifactuRecord {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId   String   @map("invoice_id") @db.Uuid

  // Hash chain
  hash        String   @db.VarChar(64)
  prevHash    String?  @map("prev_hash") @db.VarChar(64)

  // XML content
  xmlContent  String   @map("xml_content")

  // Submission state
  state       VerifactuRecordState @default(PENDING)
  csv         String?  @db.VarChar(100) // AEAT CSV code

  // Tracking
  sentAt      DateTime? @map("sent_at")
  retryCount  Int       @default(0) @map("retry_count")
  aeatResponse Json?    @map("aeat_response")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([state])
  @@map("verifactu_records")
}

enum VerifactuRecordState {
  PENDING
  ENVIANDO
  ACEPTADO
  RECHAZADO
  ERROR
}

// ============================================================================
// AI ENTITIES
// ============================================================================

/// AI conversation session
model AiConversation {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid

  title     String?  @db.VarChar(255)
  context   Json?    // Serialized context data

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company  Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AiMessage[]

  @@index([companyId, userId])
  @@map("ai_conversations")
}

/// AI chat message
model AiMessage {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid

  role           AiRole
  content        String

  // Token usage tracking
  inputTokens    Int?     @map("input_tokens")
  outputTokens   Int?     @map("output_tokens")

  // Provider info
  provider       String?  @db.VarChar(50) // "anthropic", "openai", "ollama"
  model          String?  @db.VarChar(100) // "claude-3-5-sonnet", "gpt-4o"
  latencyMs      Int?     @map("latency_ms")

  createdAt      DateTime @default(now()) @map("created_at")

  conversation AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

/// Document for RAG knowledge base
model Document {
  id        String                         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId String                         @map("company_id") @db.Uuid

  title     String                         @db.VarChar(255)
  content   String                         // Full text content
  type      DocumentType
  sourceUrl String?                        @map("source_url") @db.VarChar(500)
  metadata  Json?

  // Vector embedding for similarity search (1536 dimensions for OpenAI)
  embedding Unsupported("vector(1536)")?

  createdAt DateTime                       @default(now()) @map("created_at")
  updatedAt DateTime                       @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, type])
  @@map("documents")
}

// ============================================================================
// INVITATIONS & AUDIT
// ============================================================================

/// Company invitation for team members
model CompanyInvitation {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email       String           @db.VarChar(255)
  role        UserRole         @default(USER)
  token       String           @unique @default(uuid()) @db.Uuid
  status      InvitationStatus @default(PENDING)

  companyId   String           @map("company_id") @db.Uuid
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  inviterId   String           @map("inviter_id") @db.Uuid
  inviter     User             @relation("InvitationsSent", fields: [inviterId], references: [id])

  expiresAt   DateTime         @map("expires_at")
  acceptedAt  DateTime?        @map("accepted_at")
  acceptedBy  String?          @map("accepted_by") @db.Uuid
  acceptedUser User?           @relation("InvitationsAccepted", fields: [acceptedBy], references: [id])

  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@unique([email, companyId])
  @@index([token])
  @@index([companyId])
  @@index([status])
  @@map("company_invitations")
}

/// Audit log for tracking operations
model AuditLog {
  id        String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  userId    String      @map("user_id") @db.Uuid
  user      User        @relation(fields: [userId], references: [id])

  companyId String?     @map("company_id") @db.Uuid
  company   Company?    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  action    AuditAction
  entity    String      @db.VarChar(100) // e.g., "Invoice", "CryptoTransaction"
  entityId  String      @map("entity_id") @db.VarChar(100) // ID of the entity

  changes   Json?       // Before/after diff
  metadata  Json?       // Request IP, user agent, etc.

  createdAt DateTime    @default(now()) @map("created_at")

  @@index([userId])
  @@index([companyId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// ANALYTICS & METRICS (Phase 4 - TimescaleDB)
// ============================================================================

/// Analytics event for time-series metrics
/// Stored in TimescaleDB hypertable for efficient time-series queries
model AnalyticsEvent {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId String?  @map("company_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid

  // Event details
  eventType String   @map("event_type") @db.VarChar(100) // "invoice.created", "user.login", "payment.received"
  category  String   @db.VarChar(50) // "revenue", "user_activity", "system", "crypto"

  // Metrics
  value     Decimal? @db.Decimal(20, 8) // Numeric value (amount, count, etc.)
  currency  String?  @db.VarChar(3) // For revenue events

  // Metadata
  metadata  Json?    @default("{}") // Event-specific data

  // Timestamp (primary dimension for TimescaleDB)
  timestamp DateTime @default(now())

  // Optional relations (nullable for system events)
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId, timestamp])
  @@index([eventType, timestamp])
  @@index([category, timestamp])
  @@index([timestamp]) // Primary index for time-series queries
  @@map("analytics_events")
}

// ============================================================================
// API MARKETPLACE & OAUTH (Phase 4B)
// ============================================================================

/// Third-party OAuth applications registered to access the API
model OAuthApp {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  createdById String   @map("created_by_id") @db.Uuid

  // Application details
  name        String   @db.VarChar(255) // App name displayed to users
  description String?  @db.Text // App description
  logoUrl     String?  @map("logo_url") @db.VarChar(500) // App logo URL
  website     String?  @db.VarChar(500) // App website URL

  // OAuth credentials
  clientId     String   @unique @map("client_id") @db.VarChar(64) // Public client ID
  clientSecret String   @map("client_secret") @db.VarChar(128) // Hashed secret

  // OAuth configuration
  redirectUris String[] @map("redirect_uris") // Allowed redirect URIs (array)
  scopes       String[] // Allowed scopes for this app

  // Rate limiting & quotas
  rateLimit    Int      @default(1000) @map("rate_limit") // Requests per hour
  dailyQuota   Int      @default(10000) @map("daily_quota") // Total requests per day

  // Status
  isActive     Boolean  @default(true) @map("is_active")
  isPublic     Boolean  @default(false) @map("is_public") // Visible in marketplace

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy User         @relation(fields: [createdById], references: [id], onDelete: Cascade)
  tokens    OAuthToken[]
  apiUsage  ApiUsage[]

  @@index([companyId])
  @@index([clientId])
  @@index([isActive, isPublic])
  @@map("oauth_apps")
}

/// OAuth access and refresh tokens
model OAuthToken {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  appId        String   @map("app_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  companyId    String   @map("company_id") @db.Uuid

  // Token data
  accessToken  String   @unique @map("access_token") @db.VarChar(128) // Hashed token
  refreshToken String?  @unique @map("refresh_token") @db.VarChar(128) // Hashed token

  // Token metadata
  scopes       String[] // Granted scopes
  expiresAt    DateTime @map("expires_at") // Access token expiration
  refreshExpiresAt DateTime? @map("refresh_expires_at") // Refresh token expiration

  // OAuth flow data
  authorizationCode String? @unique @map("authorization_code") @db.VarChar(128) // Temporary auth code
  codeExpiresAt     DateTime? @map("code_expires_at")

  // Status
  isRevoked    Boolean  @default(false) @map("is_revoked")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  // Relations
  app     OAuthApp @relation(fields: [appId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([userId])
  @@index([companyId])
  @@index([accessToken])
  @@index([refreshToken])
  @@index([authorizationCode])
  @@index([expiresAt])
  @@map("oauth_tokens")
}

/// API usage tracking for rate limiting and analytics
model ApiUsage {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  appId     String?  @map("app_id") @db.Uuid
  companyId String   @map("company_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid

  // Request details
  endpoint  String   @db.VarChar(500) // API endpoint called
  method    String   @db.VarChar(10) // HTTP method (GET, POST, etc.)
  statusCode Int     @map("status_code") // HTTP status code

  // Performance metrics
  responseTime Int   @map("response_time") // Response time in milliseconds

  // Rate limiting
  requestCount Int   @default(1) @map("request_count") // Aggregated count for this time bucket

  // Metadata
  timestamp DateTime @default(now()) // Request timestamp
  ipAddress String?  @map("ip_address") @db.VarChar(45) // IPv4 or IPv6
  userAgent String?  @map("user_agent") @db.Text

  // Relations
  app     OAuthApp? @relation(fields: [appId], references: [id], onDelete: SetNull)
  company Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([appId, timestamp])
  @@index([companyId, timestamp])
  @@index([endpoint, timestamp])
  @@index([timestamp])
  @@map("api_usage")
}

// ============================================================================
// INTEGRATIONS (Phase 4B - Feature 4)
// ============================================================================

/// Third-party integrations (QuickBooks, Xero, HubSpot, Salesforce, etc.)
model Integration {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId String   @map("company_id") @db.Uuid

  // Integration details
  provider  String   @db.VarChar(50) // "quickbooks", "xero", "hubspot", "salesforce", "paypal", "square"
  name      String   @db.VarChar(255) // User-friendly name

  // OAuth credentials (encrypted)
  accessToken  String?  @map("access_token") @db.Text // Encrypted OAuth access token
  refreshToken String?  @map("refresh_token") @db.Text // Encrypted OAuth refresh token
  expiresAt    DateTime? @map("expires_at") // Token expiration

  // Provider-specific metadata
  realmId      String?  @map("realm_id") @db.VarChar(100) // QuickBooks company ID
  tenantId     String?  @map("tenant_id") @db.VarChar(100) // Xero tenant ID
  instanceUrl  String?  @map("instance_url") @db.VarChar(500) // Salesforce instance URL
  metadata     Json?    @default("{}") // Additional provider-specific data

  // Sync configuration
  syncEnabled  Boolean  @default(true) @map("sync_enabled")
  syncFrequency String  @default("hourly") @map("sync_frequency") @db.VarChar(20) // "realtime", "hourly", "daily", "manual"
  lastSyncAt   DateTime? @map("last_sync_at")
  lastSyncStatus String? @map("last_sync_status") @db.VarChar(20) // "success", "error", "partial"
  lastSyncError String?  @map("last_sync_error") @db.Text

  // Status
  isActive     Boolean  @default(true) @map("is_active")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider])
  @@index([companyId])
  @@index([provider])
  @@index([syncEnabled, isActive])
  @@map("integrations")
}

// ============================================================================
// ENUMS
// ============================================================================

enum TaxIdType {
  CIF // Company
  NIF // Individual (Spanish)
  NIE // Individual (Foreign resident)
  VAT // EU VAT number
  PASSPORT
  OTHER
}

enum UserRole {
  OWNER
  ADMIN
  ACCOUNTANT
  USER
  VIEWER
}

enum ContactType {
  CUSTOMER
  SUPPLIER
  BOTH
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum JournalStatus {
  DRAFT
  PENDING_APPROVAL
  POSTED
  REVERSED
}

enum ReferenceType {
  INVOICE
  CRYPTO_TX
  BANK_TX
  MANUAL
}

enum SourceType {
  MANUAL
  INVOICE
  CRYPTO_TX
  BANK_IMPORT
  AI
}

enum InvoiceType {
  STANDARD
  SIMPLIFIED
  CREDIT_NOTE
  DEBIT_NOTE
}

enum InvoiceStatus {
  DRAFT
  PENDING
  ISSUED
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum InvoiceDirection {
  ISSUED   // Outgoing (sales)
  RECEIVED // Incoming (purchases)
}

enum TaxType {
  IVA       // Spanish VAT
  IRPF      // Personal income tax withholding
  IGIC      // Canary Islands tax
  IPSI      // Ceuta/Melilla tax
}

enum VerifactuStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  ERROR
}

enum CryptoClassification {
  INVENTORY        // Group 3 - Active trading
  INTANGIBLE_ASSET // Group 2 - Long-term investment
}

enum WalletType {
  EXTERNAL // User's own wallet
  EXCHANGE // Exchange account wallet
  DEFI     // DeFi protocol position
  COLD     // Cold storage
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  ERROR
}

enum CryptoTxType {
  TRANSFER_IN
  TRANSFER_OUT
  SWAP
  STAKE
  UNSTAKE
  CLAIM_REWARD
  AIRDROP
  LIQUIDITY_ADD
  LIQUIDITY_REMOVE
  NFT_MINT
  NFT_TRANSFER
  NFT_SALE
  APPROVE
  CONTRACT_INTERACTION
  BRIDGE_OUT
  BRIDGE_IN
  UNKNOWN
}

enum TxStatus {
  PENDING    // Waiting for processing
  PROCESSING // Being analyzed
  COMPLETED  // Fully processed
  NEEDS_REVIEW // Requires manual review
  ERROR      // Processing failed
}

enum AiRole {
  USER
  ASSISTANT
  SYSTEM
}

enum DocumentType {
  REGULATION     // AEAT, BOICAC docs
  KNOWLEDGE_BASE // Internal knowledge
  USER_UPLOAD    // User uploaded docs
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  SEND
  APPROVE
  REJECT
}

// ============================================================================
// SUBSCRIPTIONS & PAYMENTS (Stripe Integration)
// ============================================================================

/// Subscription plan tiers
model SubscriptionPlan {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name          String   @db.VarChar(100) // "Free", "Pro", "Enterprise"
  stripePriceId String?  @map("stripe_price_id") @db.VarChar(100)

  // Pricing
  monthlyPrice  Decimal  @default(0) @map("monthly_price") @db.Decimal(10, 2)
  yearlyPrice   Decimal  @default(0) @map("yearly_price") @db.Decimal(10, 2)
  currency      String   @default("EUR") @db.VarChar(3)

  // Limits
  maxCompanies        Int     @default(1) @map("max_companies")
  maxUsers            Int     @default(1) @map("max_users")
  maxInvoicesPerMonth Int     @default(10) @map("max_invoices_per_month")
  maxWallets          Int     @default(1) @map("max_wallets")
  maxAiMessagesPerMonth Int   @default(10) @map("max_ai_messages_per_month")

  // Features
  verifactuEnabled    Boolean @default(false) @map("verifactu_enabled")
  siiEnabled          Boolean @default(false) @map("sii_enabled")
  aiChatEnabled       Boolean @default(false) @map("ai_chat_enabled")
  aiOcrEnabled        Boolean @default(false) @map("ai_ocr_enabled")
  cryptoEnabled       Boolean @default(true) @map("crypto_enabled")
  multiUserEnabled    Boolean @default(false) @map("multi_user_enabled")
  prioritySupport     Boolean @default(false) @map("priority_support")

  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@index([stripePriceId])
  @@map("subscription_plans")
}

/// Company subscription
model Subscription {
  id                String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId         String             @map("company_id") @db.Uuid
  planId            String             @map("plan_id") @db.Uuid
  stripeCustomerId  String?            @map("stripe_customer_id") @db.VarChar(100)
  stripeSubscriptionId String?         @map("stripe_subscription_id") @db.VarChar(100)

  status            SubscriptionStatus @default(TRIALING)
  currentPeriodStart DateTime?        @map("current_period_start")
  currentPeriodEnd   DateTime?        @map("current_period_end")
  cancelAtPeriodEnd  Boolean          @default(false) @map("cancel_at_period_end")
  canceledAt         DateTime?        @map("canceled_at")
  trialEndsAt        DateTime?        @map("trial_ends_at")

  // Usage tracking
  invoicesThisMonth Int              @default(0) @map("invoices_this_month")
  aiMessagesThisMonth Int            @default(0) @map("ai_messages_this_month")

  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  plan              SubscriptionPlan @relation(fields: [planId], references: [id])
  payments          Payment[]

  @@unique([companyId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

/// Payment record
model Payment {
  id                 String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId     String        @map("subscription_id") @db.Uuid
  stripePaymentIntentId String?    @map("stripe_payment_intent_id") @db.VarChar(100)
  stripeInvoiceId    String?       @map("stripe_invoice_id") @db.VarChar(100)

  amount             Decimal       @db.Decimal(10, 2)
  currency           String        @default("EUR") @db.VarChar(3)
  status             PaymentStatus @default(PENDING)

  description        String?       @db.VarChar(500)
  failureReason      String?       @map("failure_reason") @db.Text

  paidAt             DateTime?     @map("paid_at")
  createdAt          DateTime      @default(now()) @map("created_at")

  subscription       Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([paidAt])
  @@map("payments")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================================================
// ONBOARDING
// ============================================================================

/// User onboarding progress tracking
model UserOnboarding {
  userId         String                  @id @db.Uuid
  status         UserOnboardingStatus    @default(IN_PROGRESS)
  currentStep    Int                     @default(1) @map("current_step")
  completedSteps Json                    @default("[]") @map("completed_steps") // Array of step IDs
  skippedSteps   Json                    @default("[]") @map("skipped_steps")   // Array of step IDs
  startedAt      DateTime                @default(now()) @map("started_at")
  completedAt    DateTime?               @map("completed_at")
  lastActivityAt DateTime                @default(now()) @map("last_activity_at")

  user           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([lastActivityAt])
  @@map("user_onboarding")
}

enum UserOnboardingStatus {
  IN_PROGRESS
  COMPLETED
  DISMISSED
}

// ============================================================================
// WEBHOOKS SYSTEM
// ============================================================================

/// Webhook subscription configuration
model WebhookSubscription {
  id          String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String              @map("company_id") @db.Uuid
  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Endpoint configuration
  url         String              @db.VarChar(500)
  secret      String              @db.VarChar(255) // HMAC signature secret
  isActive    Boolean             @default(true) @map("is_active")

  // Events to listen to (JSON array of event types)
  events      Json                @default("[]") // ["invoice.created", "invoice.sent", etc]

  // Delivery configuration
  retryCount  Int                 @default(3) @map("retry_count")
  timeout     Int                 @default(30000) // milliseconds

  // Metadata
  description String?             @db.VarChar(500)
  metadata    Json?               @default("{}") // Custom metadata

  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  // Relations
  deliveries  WebhookDelivery[]

  @@index([companyId])
  @@index([isActive])
  @@map("webhook_subscriptions")
}

/// Webhook delivery attempt log
model WebhookDelivery {
  id               String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscriptionId   String                @map("subscription_id") @db.Uuid
  subscription     WebhookSubscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Event details
  event            String                @db.VarChar(100) // "invoice.created"
  payload          Json                  // Event payload data
  payloadHash      String                @map("payload_hash") @db.VarChar(64) // SHA-256 for deduplication

  // Delivery status
  status           WebhookDeliveryStatus @default(PENDING)
  attemptCount     Int                   @default(0) @map("attempt_count")
  maxAttempts      Int                   @default(3) @map("max_attempts")

  // Response details
  responseStatus   Int?                  @map("response_status")
  responseBody     String?               @map("response_body") @db.Text
  responseHeaders  Json?                 @map("response_headers")
  errorMessage     String?               @map("error_message") @db.Text

  // Timing
  scheduledFor     DateTime              @default(now()) @map("scheduled_for")
  lastAttemptAt    DateTime?             @map("last_attempt_at")
  nextAttemptAt    DateTime?             @map("next_attempt_at")
  deliveredAt      DateTime?             @map("delivered_at")

  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")

  @@index([subscriptionId])
  @@index([status])
  @@index([event])
  @@index([scheduledFor])
  @@index([payloadHash])
  @@map("webhook_deliveries")
}

/// Webhook event log for analytics
model WebhookEvent {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  event       String   @db.VarChar(100)
  entityType  String   @map("entity_type") @db.VarChar(100) // "Invoice", "CryptoTransaction"
  entityId    String   @map("entity_id") @db.Uuid
  payload     Json
  emittedAt   DateTime @default(now()) @map("emitted_at")

  @@index([companyId])
  @@index([event])
  @@index([entityType, entityId])
  @@index([emittedAt])
  @@map("webhook_events")
}

enum WebhookDeliveryStatus {
  PENDING
  SENDING
  DELIVERED
  FAILED
  CANCELLED
}

// ============================================================================
// WHITE-LABEL & PARTNER MANAGEMENT
// ============================================================================

/// White-Label Configuration for Company
/// Allows customization of branding per company (for B2B2C model)
model WhiteLabelConfig {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId         String    @unique @map("company_id") @db.Uuid

  // Branding
  brandName         String?   @map("brand_name") @db.VarChar(255)
  logoUrl           String?   @map("logo_url") @db.VarChar(500) // S3/CDN URL
  faviconUrl        String?   @map("favicon_url") @db.VarChar(500)

  // Theme Colors (CSS variables)
  primaryColor      String?   @map("primary_color") @db.VarChar(7) // #RRGGBB
  secondaryColor    String?   @map("secondary_color") @db.VarChar(7)
  accentColor       String?   @map("accent_color") @db.VarChar(7)
  backgroundColor   String?   @map("background_color") @db.VarChar(7)
  textColor         String?   @map("text_color") @db.VarChar(7)

  // Custom CSS (optional)
  customCss         String?   @map("custom_css") @db.Text

  // Custom Domain
  customDomain      String?   @unique @map("custom_domain") @db.VarChar(255)
  domainVerified    Boolean   @default(false) @map("domain_verified")

  // Email Branding
  emailFromName     String?   @map("email_from_name") @db.VarChar(255)
  emailReplyTo      String?   @map("email_reply_to") @db.VarChar(255)
  emailFooterText   String?   @map("email_footer_text") @db.Text

  // Feature Flags (what features to show)
  enabledFeatures   String[]  @default([]) @map("enabled_features") // ["invoicing", "crypto", "analytics"]

  // Metadata
  metadata          Json?     @default("{}")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([customDomain])
  @@map("white_label_configs")
}

/// Partner (Reseller) for White-Label Program
/// Partners can resell the platform with their own branding
model Partner {
  id                      String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Partner Info
  name                    String            @db.VarChar(255)
  legalName               String            @map("legal_name") @db.VarChar(255)
  email                   String            @unique @db.VarChar(255)
  phone                   String?           @db.VarChar(20)
  website                 String?           @db.VarChar(255)

  // Tax Info
  taxId                   String?           @map("tax_id") @db.VarChar(50)
  address                 String?           @db.VarChar(500)
  city                    String?           @db.VarChar(100)
  country                 String            @default("ES") @db.VarChar(2)

  // Partnership Terms
  commissionRate          Float             @default(20.0) @map("commission_rate") // Percentage (0-100)
  revenueShareModel       RevenueShareModel @default(PERCENTAGE) @map("revenue_share_model")
  paymentTerms            String?           @map("payment_terms") @db.VarChar(100) // "NET30", "NET60"

  // Status
  status                  PartnerStatus     @default(PENDING)
  isActive                Boolean           @default(true) @map("is_active")

  // API Access
  apiKey                  String?           @unique @map("api_key") @db.VarChar(64) // For partner API
  apiKeyHash              String?           @map("api_key_hash") @db.VarChar(128) // Hashed version
  webhookUrl              String?           @map("webhook_url") @db.VarChar(500) // Partner webhook endpoint

  // Metadata
  metadata                Json?             @default("{}")
  notes                   String?           @db.Text // Internal notes

  // Dates
  contractStartDate       DateTime?         @map("contract_start_date")
  contractEndDate         DateTime?         @map("contract_end_date")
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")

  // Relations
  customers               PartnerCustomer[]
  commissions             PartnerCommission[]
  payouts                 PartnerPayout[]

  @@index([email])
  @@index([status])
  @@index([isActive])
  @@map("partners")
}

/// Companies managed by a Partner
model PartnerCustomer {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  partnerId         String    @map("partner_id") @db.Uuid
  companyId         String    @unique @map("company_id") @db.Uuid // One company = one partner

  // Custom pricing for this customer
  customCommissionRate Float? @map("custom_commission_rate") // Override partner's default

  // Status
  status            PartnerCustomerStatus @default(ACTIVE)

  // Dates
  activatedAt       DateTime? @map("activated_at")
  deactivatedAt     DateTime? @map("deactivated_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  partner           Partner   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([companyId])
  @@index([status])
  @@map("partner_customers")
}

/// Commission tracking for partners
model PartnerCommission {
  id                String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  partnerId         String              @map("partner_id") @db.Uuid
  companyId         String              @map("company_id") @db.Uuid

  // Transaction Details
  transactionType   String              @map("transaction_type") @db.VarChar(50) // "subscription", "invoice", "addon"
  transactionId     String?             @map("transaction_id") @db.Uuid // Reference to subscription/invoice

  // Amounts
  baseAmount        Float               @map("base_amount") // Original transaction amount
  commissionRate    Float               @map("commission_rate") // Rate applied
  commissionAmount  Float               @map("commission_amount") // Calculated commission
  currency          String              @default("EUR") @db.VarChar(3)

  // Status
  status            CommissionStatus    @default(PENDING)

  // Payout tracking
  payoutId          String?             @map("payout_id") @db.Uuid
  paidAt            DateTime?           @map("paid_at")

  // Period
  periodStart       DateTime            @map("period_start")
  periodEnd         DateTime            @map("period_end")

  // Dates
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  partner           Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  payout            PartnerPayout?      @relation(fields: [payoutId], references: [id])

  @@index([partnerId])
  @@index([companyId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("partner_commissions")
}

/// Payout to partners
model PartnerPayout {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  partnerId         String            @map("partner_id") @db.Uuid

  // Payout Details
  amount            Float             // Total payout amount
  currency          String            @default("EUR") @db.VarChar(3)

  // Period covered
  periodStart       DateTime          @map("period_start")
  periodEnd         DateTime          @map("period_end")

  // Payment Details
  paymentMethod     String?           @map("payment_method") @db.VarChar(50) // "bank_transfer", "paypal"
  paymentReference  String?           @map("payment_reference") @db.VarChar(100) // Transaction ID

  // Status
  status            PayoutStatus      @default(PENDING)

  // Dates
  scheduledAt       DateTime?         @map("scheduled_at")
  paidAt            DateTime?         @map("paid_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  partner           Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  commissions       PartnerCommission[]

  @@index([partnerId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("partner_payouts")
}

// ============================================================================
// WHITE-LABEL ENUMS
// ============================================================================

enum RevenueShareModel {
  PERCENTAGE   // Fixed percentage of revenue
  TIERED       // Different rates based on volume
  FLAT_FEE     // Fixed fee per customer
  HYBRID       // Combination
}

enum PartnerStatus {
  PENDING      // Application pending review
  ACTIVE       // Active partner
  SUSPENDED    // Temporarily suspended
  TERMINATED   // Contract terminated
}

enum PartnerCustomerStatus {
  ACTIVE       // Active customer
  CHURNED      // Customer cancelled
  SUSPENDED    // Temporarily suspended
}

enum CommissionStatus {
  PENDING      // Not yet approved
  APPROVED     // Approved for payout
  PAID         // Already paid
  CANCELLED    // Cancelled (refund, chargeback)
}

enum PayoutStatus {
  PENDING      // Scheduled but not paid
  PROCESSING   // Payment in progress
  PAID         // Successfully paid
  FAILED       // Payment failed
  CANCELLED    // Cancelled
}

// ============================================================================
// CUSTOM REPORTS (Phase 4 - Advanced Analytics)
// ============================================================================

/// Custom report configuration
model CustomReport {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid

  // Report definition
  name        String   @db.VarChar(255)
  description String?  @db.Text

  // Metrics configuration
  metrics     String[] // Array of metric types: "revenue", "users", "invoices", "crypto"
  timeRange   String   @map("time_range") @db.VarChar(20) // "day", "week", "month", "quarter", "year", "custom"
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")

  // Scheduling (optional)
  schedule    String?  @db.VarChar(20) // "daily", "weekly", "monthly"
  recipients  String[] // Email addresses for scheduled reports

  // Report metadata
  lastGeneratedAt DateTime? @map("last_generated_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([companyId])
  @@index([companyId, schedule])
  @@map("custom_reports")
}

// ============================================================================
// MULTI-REGION CONFIGURATION (Phase 4)
// ============================================================================

/// Regional database configuration
model RegionalConfig {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid

  // Region identification
  region       String   @unique @db.VarChar(20) // "eu", "us", "asia"
  displayName  String   @map("display_name") @db.VarChar(100) // "Europe", "United States", "Asia Pacific"

  // Database configuration
  primaryHost      String   @map("primary_host") @db.VarChar(255)
  readReplicaHosts String[] @map("read_replica_hosts")

  // CDN configuration
  cdnEndpoint  String?  @map("cdn_endpoint") @db.VarChar(255)
  cdnCacheTtl  Int      @default(3600) @map("cdn_cache_ttl") // Cache TTL in seconds

  // Health status
  isHealthy    Boolean  @default(true) @map("is_healthy")
  lastHealthCheck DateTime? @map("last_health_check")
  avgLatencyMs Int?     @map("avg_latency_ms")

  // Configuration
  isActive     Boolean  @default(true) @map("is_active")
  isPrimary    Boolean  @default(false) @map("is_primary")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([region, isActive])
  @@map("regional_configs")
}
