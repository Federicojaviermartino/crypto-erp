{"version":3,"sources":["../../../src/common/filters/http-exception.filter.ts"],"sourcesContent":["import {\n  ExceptionFilter,\n  Catch,\n  ArgumentsHost,\n  HttpException,\n  HttpStatus,\n  Logger,\n} from '@nestjs/common';\nimport { Response } from 'express';\nimport { Prisma } from '@prisma/client';\n\ninterface ErrorResponse {\n  statusCode: number;\n  message: string | string[];\n  error: string;\n  timestamp: string;\n  path: string;\n}\n\n/**\n * Global exception filter that handles all exceptions\n * and returns consistent error responses.\n */\n@Catch()\nexport class GlobalExceptionFilter implements ExceptionFilter {\n  private readonly logger = new Logger(GlobalExceptionFilter.name);\n\n  catch(exception: unknown, host: ArgumentsHost): void {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    const errorResponse = this.buildErrorResponse(exception, request.url);\n\n    // Log error\n    if (errorResponse.statusCode >= 500) {\n      this.logger.error(\n        `${request.method} ${request.url} - ${errorResponse.statusCode}`,\n        exception instanceof Error ? exception.stack : String(exception),\n      );\n    } else {\n      this.logger.warn(\n        `${request.method} ${request.url} - ${errorResponse.statusCode}: ${JSON.stringify(errorResponse.message)}`,\n      );\n    }\n\n    response.status(errorResponse.statusCode).json(errorResponse);\n  }\n\n  private buildErrorResponse(exception: unknown, path: string): ErrorResponse {\n    const timestamp = new Date().toISOString();\n\n    // HTTP exceptions\n    if (exception instanceof HttpException) {\n      const status = exception.getStatus();\n      const exceptionResponse = exception.getResponse();\n\n      let message: string | string[];\n      if (typeof exceptionResponse === 'object' && exceptionResponse !== null) {\n        const resp = exceptionResponse as Record<string, unknown>;\n        message = (resp['message'] as string | string[]) || exception.message;\n      } else {\n        message = String(exceptionResponse);\n      }\n\n      return {\n        statusCode: status,\n        message,\n        error: HttpStatus[status] || 'Error',\n        timestamp,\n        path,\n      };\n    }\n\n    // Prisma exceptions\n    if (exception instanceof Prisma.PrismaClientKnownRequestError) {\n      return this.handlePrismaError(exception, path, timestamp);\n    }\n\n    if (exception instanceof Prisma.PrismaClientValidationError) {\n      return {\n        statusCode: HttpStatus.BAD_REQUEST,\n        message: 'Invalid data provided',\n        error: 'Bad Request',\n        timestamp,\n        path,\n      };\n    }\n\n    // Unknown errors\n    return {\n      statusCode: HttpStatus.INTERNAL_SERVER_ERROR,\n      message: 'Internal server error',\n      error: 'Internal Server Error',\n      timestamp,\n      path,\n    };\n  }\n\n  private handlePrismaError(\n    exception: Prisma.PrismaClientKnownRequestError,\n    path: string,\n    timestamp: string,\n  ): ErrorResponse {\n    switch (exception.code) {\n      case 'P2002':\n        return {\n          statusCode: HttpStatus.CONFLICT,\n          message: `Duplicate entry for ${(exception.meta?.['target'] as string[])?.join(', ') || 'field'}`,\n          error: 'Conflict',\n          timestamp,\n          path,\n        };\n\n      case 'P2025':\n        return {\n          statusCode: HttpStatus.NOT_FOUND,\n          message: 'Record not found',\n          error: 'Not Found',\n          timestamp,\n          path,\n        };\n\n      case 'P2003':\n        return {\n          statusCode: HttpStatus.BAD_REQUEST,\n          message: 'Foreign key constraint failed',\n          error: 'Bad Request',\n          timestamp,\n          path,\n        };\n\n      default:\n        return {\n          statusCode: HttpStatus.INTERNAL_SERVER_ERROR,\n          message: 'Database error',\n          error: 'Internal Server Error',\n          timestamp,\n          path,\n        };\n    }\n  }\n}\n"],"names":["GlobalExceptionFilter","catch","exception","host","ctx","switchToHttp","response","getResponse","request","getRequest","errorResponse","buildErrorResponse","url","statusCode","logger","error","method","Error","stack","String","warn","JSON","stringify","message","status","json","path","timestamp","Date","toISOString","HttpException","getStatus","exceptionResponse","resp","HttpStatus","Prisma","PrismaClientKnownRequestError","handlePrismaError","PrismaClientValidationError","BAD_REQUEST","INTERNAL_SERVER_ERROR","code","CONFLICT","meta","join","NOT_FOUND","Logger","name"],"mappings":"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"}