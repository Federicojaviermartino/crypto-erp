{"version":3,"sources":["../../../src/modules/oauth/oauth.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Get,\n  Delete,\n  Body,\n  Param,\n  Query,\n  Headers,\n  BadRequestException,\n  UseGuards,\n  Req,\n} from '@nestjs/common';\nimport { OAuthService } from './oauth.service.js';\nimport { CreateOAuthAppDto } from './dto/create-oauth-app.dto.js';\nimport { AuthorizeDto, TokenDto, RevokeTokenDto } from './dto/authorize.dto.js';\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard.js';\nimport { Request } from 'express';\n\n/**\n * OAuth 2.0 Controller\n * Implements OAuth 2.0 Authorization Code Flow endpoints\n *\n * Flow:\n * 1. POST /oauth/apps - Create OAuth app (get client_id and client_secret)\n * 2. GET /oauth/authorize - User authorizes app (returns authorization code)\n * 3. POST /oauth/token - Exchange code for access token\n * 4. Use access token in Authorization: Bearer <token> header\n * 5. POST /oauth/token (grant_type=refresh_token) - Refresh access token\n * 6. POST /oauth/revoke - Revoke token\n */\n@Controller('oauth')\nexport class OAuthController {\n  constructor(private readonly oauthService: OAuthService) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  private getUserId(req: any): string {\n    return req.user?.userId;\n  }\n\n  // ============================================================================\n  // OAuth App Management\n  // ============================================================================\n\n  /**\n   * Create a new OAuth application\n   * POST /oauth/apps\n   */\n  @Post('apps')\n  @UseGuards(JwtAuthGuard)\n  async createApp(\n    @Headers() headers: Record<string, string>,\n    @Req() req: Request,\n    @Body() dto: CreateOAuthAppDto,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const userId = this.getUserId(req);\n\n    return this.oauthService.createApp(companyId, userId, dto);\n  }\n\n  /**\n   * List OAuth applications for company\n   * GET /oauth/apps\n   */\n  @Get('apps')\n  @UseGuards(JwtAuthGuard)\n  async listApps(@Headers() headers: Record<string, string>) {\n    const companyId = this.getCompanyId(headers);\n    return this.oauthService.listApps(companyId);\n  }\n\n  /**\n   * Delete OAuth application\n   * DELETE /oauth/apps/:id\n   */\n  @Delete('apps/:id')\n  @UseGuards(JwtAuthGuard)\n  async deleteApp(\n    @Headers() headers: Record<string, string>,\n    @Param('id') appId: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    return this.oauthService.deleteApp(appId, companyId);\n  }\n\n  // ============================================================================\n  // OAuth 2.0 Authorization Flow\n  // ============================================================================\n\n  /**\n   * OAuth 2.0 Authorization Endpoint\n   * GET /oauth/authorize?client_id=...&redirect_uri=...&response_type=code&scope=...&state=...\n   *\n   * User authorizes the application and receives authorization code\n   *\n   * Example:\n   * GET /oauth/authorize?client_id=abc123&redirect_uri=https://app.com/callback&response_type=code&scope=read:invoices write:invoices&state=xyz\n   *\n   * Response: Redirect to https://app.com/callback?code=AUTH_CODE&state=xyz\n   */\n  @Get('authorize')\n  @UseGuards(JwtAuthGuard)\n  async authorize(\n    @Headers() headers: Record<string, string>,\n    @Req() req: Request,\n    @Query('client_id') clientId: string,\n    @Query('redirect_uri') redirectUri: string,\n    @Query('response_type') responseType: string,\n    @Query('scope') scopeStr: string,\n    @Query('state') state?: string,\n  ) {\n    if (responseType !== 'code') {\n      throw new BadRequestException('Only response_type=code is supported');\n    }\n\n    const companyId = this.getCompanyId(headers);\n    const userId = this.getUserId(req);\n    const scopes = scopeStr.split(' ').filter(s => s.length > 0);\n\n    const result = await this.oauthService.generateAuthorizationCode(\n      clientId,\n      userId,\n      companyId,\n      redirectUri,\n      scopes,\n    );\n\n    // Return authorization code and redirect URL\n    const redirectUrl = new URL(redirectUri);\n    redirectUrl.searchParams.set('code', result.code);\n    if (state) {\n      redirectUrl.searchParams.set('state', state);\n    }\n\n    return {\n      code: result.code,\n      redirectUri: redirectUrl.toString(),\n      expiresIn: result.expiresIn,\n    };\n  }\n\n  /**\n   * OAuth 2.0 Token Endpoint\n   * POST /oauth/token\n   *\n   * Exchange authorization code for access token or refresh access token\n   *\n   * Example (authorization code):\n   * POST /oauth/token\n   * Body: {\n   *   \"grant_type\": \"authorization_code\",\n   *   \"code\": \"AUTH_CODE\",\n   *   \"client_id\": \"abc123\",\n   *   \"client_secret\": \"secret\",\n   *   \"redirect_uri\": \"https://app.com/callback\"\n   * }\n   *\n   * Example (refresh token):\n   * POST /oauth/token\n   * Body: {\n   *   \"grant_type\": \"refresh_token\",\n   *   \"refresh_token\": \"REFRESH_TOKEN\",\n   *   \"client_id\": \"abc123\",\n   *   \"client_secret\": \"secret\"\n   * }\n   *\n   * Response: {\n   *   \"access_token\": \"ACCESS_TOKEN\",\n   *   \"refresh_token\": \"REFRESH_TOKEN\",\n   *   \"token_type\": \"Bearer\",\n   *   \"expires_in\": 3600,\n   *   \"scope\": \"read:invoices write:invoices\"\n   * }\n   */\n  @Post('token')\n  async token(@Body() dto: TokenDto) {\n    if (dto.grantType === 'authorization_code') {\n      if (!dto.code || !dto.redirectUri) {\n        throw new BadRequestException(\n          'code and redirect_uri are required for authorization_code grant',\n        );\n      }\n\n      return this.oauthService.exchangeCodeForToken(\n        dto.code,\n        dto.clientId,\n        dto.clientSecret,\n        dto.redirectUri,\n      );\n    } else if (dto.grantType === 'refresh_token') {\n      if (!dto.refreshToken) {\n        throw new BadRequestException(\n          'refresh_token is required for refresh_token grant',\n        );\n      }\n\n      return this.oauthService.refreshAccessToken(\n        dto.refreshToken,\n        dto.clientId,\n        dto.clientSecret,\n      );\n    } else {\n      throw new BadRequestException(\n        'grant_type must be authorization_code or refresh_token',\n      );\n    }\n  }\n\n  /**\n   * OAuth 2.0 Token Revocation Endpoint\n   * POST /oauth/revoke\n   *\n   * Revoke an access or refresh token\n   *\n   * Example:\n   * POST /oauth/revoke\n   * Body: {\n   *   \"token\": \"ACCESS_TOKEN\",\n   *   \"token_type_hint\": \"access_token\"\n   * }\n   */\n  @Post('revoke')\n  async revoke(@Body() dto: RevokeTokenDto) {\n    return this.oauthService.revokeToken(dto.token);\n  }\n\n  /**\n   * OAuth 2.0 Token Introspection Endpoint\n   * POST /oauth/introspect\n   *\n   * Get information about a token (for debugging)\n   *\n   * Example:\n   * POST /oauth/introspect\n   * Body: { \"token\": \"ACCESS_TOKEN\" }\n   *\n   * Response: {\n   *   \"active\": true,\n   *   \"scope\": \"read:invoices write:invoices\",\n   *   \"client_id\": \"abc123\",\n   *   \"user_id\": \"user-uuid\",\n   *   \"company_id\": \"company-uuid\"\n   * }\n   */\n  @Post('introspect')\n  async introspect(@Body('token') token: string) {\n    try {\n      const tokenData = await this.oauthService.verifyAccessToken(token);\n      return {\n        active: true,\n        scope: tokenData.scopes.join(' '),\n        clientId: tokenData.app.clientId,\n        userId: tokenData.userId,\n        companyId: tokenData.companyId,\n      };\n    } catch (error) {\n      return {\n        active: false,\n      };\n    }\n  }\n}\n"],"names":["OAuthController","getCompanyId","headers","companyId","BadRequestException","getUserId","req","user","userId","createApp","dto","oauthService","listApps","deleteApp","appId","authorize","clientId","redirectUri","responseType","scopeStr","state","scopes","split","filter","s","length","result","generateAuthorizationCode","redirectUrl","URL","searchParams","set","code","toString","expiresIn","token","grantType","exchangeCodeForToken","clientSecret","refreshToken","refreshAccessToken","revoke","revokeToken","introspect","tokenData","verifyAccessToken","active","scope","join","app","error"],"mappings":"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"}