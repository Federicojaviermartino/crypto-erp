{"version":3,"sources":["../../../../src/modules/crypto/services/crypto-transactions.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n} from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CryptoTransaction, Prisma, CryptoTxType } from '@prisma/client';\nimport { CostBasisService } from './cost-basis.service.js';\n\ntype TransactionWithWallet = CryptoTransaction & {\n  wallet: {\n    id: string;\n    label: string | null;\n    address: string;\n    chain: string;\n  };\n};\n\n@Injectable()\nexport class CryptoTransactionsService {\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly costBasisService: CostBasisService,\n  ) {}\n\n  async findAll(\n    companyId: string,\n    query: {\n      type?: string;\n      walletId?: string;\n      chain?: string;\n      startDate?: string;\n      endDate?: string;\n      skip?: number;\n      take?: number;\n    },\n  ): Promise<{ transactions: TransactionWithWallet[]; total: number }> {\n    // Get wallets for company\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    const where: Prisma.CryptoTransactionWhereInput = {\n      walletId: { in: walletIds },\n      ...(query.walletId && { walletId: query.walletId }),\n      ...(query.type && { type: query.type as CryptoTxType }),\n      ...(query.chain && { chain: query.chain }),\n      ...(query.startDate && { blockTimestamp: { gte: new Date(query.startDate) } }),\n      ...(query.endDate && { blockTimestamp: { lte: new Date(query.endDate) } }),\n    };\n\n    const [transactions, total] = await Promise.all([\n      this.prisma.cryptoTransaction.findMany({\n        where,\n        include: {\n          wallet: {\n            select: { id: true, label: true, address: true, chain: true },\n          },\n        },\n        orderBy: { blockTimestamp: 'desc' },\n        skip: query.skip || 0,\n        take: query.take || 50,\n      }),\n      this.prisma.cryptoTransaction.count({ where }),\n    ]);\n\n    return { transactions: transactions as TransactionWithWallet[], total };\n  }\n\n  async findById(companyId: string, id: string): Promise<TransactionWithWallet> {\n    // First verify the transaction belongs to a wallet owned by this company\n    const transaction = await this.prisma.cryptoTransaction.findUnique({\n      where: { id },\n      include: {\n        wallet: {\n          select: { id: true, label: true, address: true, chain: true, companyId: true },\n        },\n      },\n    });\n\n    if (!transaction) {\n      throw new NotFoundException(`Transaction with ID ${id} not found`);\n    }\n\n    // Verify company ownership\n    if ((transaction.wallet as { companyId?: string }).companyId !== companyId) {\n      throw new NotFoundException(`Transaction with ID ${id} not found`);\n    }\n\n    return transaction as TransactionWithWallet;\n  }\n\n  async getPortfolioSummary(companyId: string): Promise<{\n    positions: {\n      assetId: string;\n      symbol: string;\n      name: string;\n      totalAmount: number;\n      totalCostBasis: number;\n      averageCostBasis: number;\n    }[];\n    totalCostBasis: number;\n  }> {\n    const positions = await this.costBasisService.getPortfolioPositions(companyId);\n\n    return {\n      positions,\n      totalCostBasis: positions.reduce((sum, p) => sum + p.totalCostBasis, 0),\n    };\n  }\n\n  async getTaxReport(\n    companyId: string,\n    startDate: string,\n    endDate: string,\n  ) {\n    return this.costBasisService.generateTaxReport(\n      companyId,\n      new Date(startDate),\n      new Date(endDate),\n    );\n  }\n\n  async getTransactionStats(companyId: string): Promise<{\n    totalTransactions: number;\n    transactionsByType: Record<string, number>;\n    transactionsByChain: Record<string, number>;\n  }> {\n    // Get wallets for company\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    const [totalTransactions, byType, byChain] = await Promise.all([\n      this.prisma.cryptoTransaction.count({\n        where: { walletId: { in: walletIds } },\n      }),\n      this.prisma.cryptoTransaction.groupBy({\n        by: ['type'],\n        where: { walletId: { in: walletIds } },\n        _count: true,\n      }),\n      this.prisma.cryptoTransaction.groupBy({\n        by: ['chain'],\n        where: { walletId: { in: walletIds } },\n        _count: true,\n      }),\n    ]);\n\n    return {\n      totalTransactions,\n      transactionsByType: Object.fromEntries(\n        byType.map(t => [t.type, t._count]),\n      ),\n      transactionsByChain: Object.fromEntries(\n        byChain.map(c => [c.chain, c._count]),\n      ),\n    };\n  }\n\n  async recategorizeTransaction(\n    companyId: string,\n    id: string,\n    newType: CryptoTxType,\n    notes?: string,\n  ): Promise<TransactionWithWallet> {\n    const transaction = await this.findById(companyId, id);\n\n    await this.prisma.cryptoTransaction.update({\n      where: { id },\n      data: {\n        manualType: newType,\n        manualNotes: notes,\n      },\n    });\n\n    return this.findById(companyId, id);\n  }\n\n  /**\n   * Find all transactions for batch operations (no pagination)\n   * Used by batch categorization endpoint\n   */\n  async findAllForBatch(companyId: string, where: any): Promise<{ id: string }[]> {\n    // Get wallets for company\n    const wallets = await this.prisma.wallet.findMany({\n      where: { companyId },\n      select: { id: true },\n    });\n    const walletIds = wallets.map(w => w.id);\n\n    // Add company filter\n    const finalWhere: Prisma.CryptoTransactionWhereInput = {\n      ...where,\n      walletId: { in: walletIds },\n    };\n\n    return this.prisma.cryptoTransaction.findMany({\n      where: finalWhere,\n      select: { id: true },\n      orderBy: { blockTimestamp: 'asc' },\n    });\n  }\n}\n"],"names":["CryptoTransactionsService","findAll","companyId","query","wallets","prisma","wallet","findMany","where","select","id","walletIds","map","w","walletId","in","type","chain","startDate","blockTimestamp","gte","Date","endDate","lte","transactions","total","Promise","all","cryptoTransaction","include","label","address","orderBy","skip","take","count","findById","transaction","findUnique","NotFoundException","getPortfolioSummary","positions","costBasisService","getPortfolioPositions","totalCostBasis","reduce","sum","p","getTaxReport","generateTaxReport","getTransactionStats","totalTransactions","byType","byChain","groupBy","by","_count","transactionsByType","Object","fromEntries","t","transactionsByChain","c","recategorizeTransaction","newType","notes","update","data","manualType","manualNotes","findAllForBatch","finalWhere"],"mappings":"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"}