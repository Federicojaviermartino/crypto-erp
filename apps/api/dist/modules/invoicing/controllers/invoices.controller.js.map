{"version":3,"sources":["../../../../src/modules/invoicing/controllers/invoices.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Patch,\n  Delete,\n  Body,\n  Param,\n  Query,\n  Res,\n  UseGuards,\n  HttpCode,\n  HttpStatus,\n} from '@nestjs/common';\nimport {\n  ApiTags,\n  ApiOperation,\n  ApiResponse,\n  ApiBearerAuth,\n  ApiParam,\n  ApiQuery,\n  ApiProduces,\n} from '@nestjs/swagger';\nimport { Response } from 'express';\nimport { JwtAuthGuard, TenantGuard } from '../../../common/guards/index.js';\nimport { CurrentCompany, CurrentUser } from '../../../common/decorators/index.js';\nimport { InvoicesService } from '../services/index.js';\nimport { InvoicePdfService } from '../services/invoice-pdf.service.js';\nimport { CreateInvoiceDto, QueryInvoicesDto } from '../dto/index.js';\n\ninterface JwtPayload {\n  sub: string;\n  email: string;\n}\n\n@ApiTags('Invoices')\n@ApiBearerAuth()\n@UseGuards(JwtAuthGuard, TenantGuard)\n@Controller('invoices')\nexport class InvoicesController {\n  constructor(\n    private readonly invoicesService: InvoicesService,\n    private readonly pdfService: InvoicePdfService,\n  ) {}\n\n  @Get()\n  @ApiOperation({ summary: 'List all invoices' })\n  @ApiResponse({ status: 200, description: 'Returns paginated list of invoices' })\n  async findAll(\n    @CurrentCompany() companyId: string,\n    @Query() query: QueryInvoicesDto,\n  ) {\n    return this.invoicesService.findAll(companyId, query);\n  }\n\n  @Get(':id')\n  @ApiOperation({ summary: 'Get invoice by ID' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Returns invoice details with lines' })\n  @ApiResponse({ status: 404, description: 'Invoice not found' })\n  async findById(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n  ) {\n    return this.invoicesService.findById(companyId, id);\n  }\n\n  @Get(':id/verifactu-qr')\n  @ApiOperation({ summary: 'Get Verifactu QR code data for an invoice' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Returns QR code data for Verifactu' })\n  @ApiResponse({ status: 400, description: 'Invoice not registered with Verifactu' })\n  async getVerifactuQR(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n  ) {\n    const qrData = await this.invoicesService.getVerifactuQR(companyId, id);\n    return { qrData };\n  }\n\n  @Post('sales')\n  @ApiOperation({ summary: 'Create a new sales invoice' })\n  @ApiResponse({ status: 201, description: 'Sales invoice created successfully' })\n  @ApiResponse({ status: 400, description: 'Invalid data' })\n  async createSales(\n    @CurrentCompany() companyId: string,\n    @CurrentUser() user: JwtPayload,\n    @Body() dto: CreateInvoiceDto,\n  ) {\n    return this.invoicesService.create(companyId, user.sub, dto, 'ISSUED');\n  }\n\n  @Post('purchases')\n  @ApiOperation({ summary: 'Create a new purchase invoice' })\n  @ApiResponse({ status: 201, description: 'Purchase invoice created successfully' })\n  @ApiResponse({ status: 400, description: 'Invalid data' })\n  async createPurchase(\n    @CurrentCompany() companyId: string,\n    @CurrentUser() user: JwtPayload,\n    @Body() dto: CreateInvoiceDto,\n  ) {\n    return this.invoicesService.create(companyId, user.sub, dto, 'RECEIVED');\n  }\n\n  @Put(':id')\n  @ApiOperation({ summary: 'Update a draft invoice' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Invoice updated successfully' })\n  @ApiResponse({ status: 404, description: 'Invoice not found' })\n  @ApiResponse({ status: 409, description: 'Only draft invoices can be modified' })\n  async update(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n    @Body() dto: Partial<CreateInvoiceDto>,\n  ) {\n    return this.invoicesService.update(companyId, id, dto);\n  }\n\n  @Patch(':id/issue')\n  @ApiOperation({ summary: 'Issue an invoice (registers with Verifactu for sales)' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Invoice issued successfully' })\n  @ApiResponse({ status: 400, description: 'Verifactu registration failed' })\n  @ApiResponse({ status: 409, description: 'Only draft invoices can be issued' })\n  @HttpCode(HttpStatus.OK)\n  async issue(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n  ) {\n    return this.invoicesService.issue(companyId, id);\n  }\n\n  @Patch(':id/paid')\n  @ApiOperation({ summary: 'Mark an invoice as paid' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Invoice marked as paid' })\n  @ApiResponse({ status: 409, description: 'Only issued/sent invoices can be marked as paid' })\n  @HttpCode(HttpStatus.OK)\n  async markAsPaid(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n    @Body() body: { paidAt?: string },\n  ) {\n    return this.invoicesService.markAsPaid(\n      companyId,\n      id,\n      body.paidAt ? new Date(body.paidAt) : undefined,\n    );\n  }\n\n  @Patch(':id/cancel')\n  @ApiOperation({ summary: 'Cancel an invoice' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 200, description: 'Invoice cancelled' })\n  @ApiResponse({ status: 400, description: 'Cannot cancel Verifactu-registered invoice' })\n  @HttpCode(HttpStatus.OK)\n  async cancel(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n  ) {\n    return this.invoicesService.cancel(companyId, id);\n  }\n\n  @Delete(':id')\n  @ApiOperation({ summary: 'Delete a draft invoice' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiResponse({ status: 204, description: 'Invoice deleted successfully' })\n  @ApiResponse({ status: 409, description: 'Only draft invoices can be deleted' })\n  @HttpCode(HttpStatus.NO_CONTENT)\n  async delete(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n  ) {\n    await this.invoicesService.delete(companyId, id);\n  }\n\n  @Get(':id/pdf')\n  @ApiOperation({ summary: 'Download invoice as PDF' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiQuery({ name: 'lang', required: false, enum: ['es', 'en'], description: 'PDF language' })\n  @ApiProduces('application/pdf')\n  @ApiResponse({ status: 200, description: 'Returns PDF file' })\n  @ApiResponse({ status: 404, description: 'Invoice not found' })\n  async downloadPdf(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n    @Query('lang') lang: 'es' | 'en' = 'es',\n    @Res() res: Response,\n  ) {\n    const invoice = await this.invoicesService.findById(companyId, id);\n    const pdfBuffer = await this.pdfService.generatePdf(companyId, id, {\n      language: lang,\n      includeQR: true,\n    });\n\n    res.set({\n      'Content-Type': 'application/pdf',\n      'Content-Disposition': `attachment; filename=\"factura-${invoice.fullNumber}.pdf\"`,\n      'Content-Length': pdfBuffer.length,\n    });\n\n    res.end(pdfBuffer);\n  }\n\n  @Get(':id/pdf/preview')\n  @ApiOperation({ summary: 'Preview invoice PDF in browser' })\n  @ApiParam({ name: 'id', description: 'Invoice ID' })\n  @ApiQuery({ name: 'lang', required: false, enum: ['es', 'en'], description: 'PDF language' })\n  @ApiProduces('application/pdf')\n  @ApiResponse({ status: 200, description: 'Returns PDF for inline viewing' })\n  @ApiResponse({ status: 404, description: 'Invoice not found' })\n  async previewPdf(\n    @CurrentCompany() companyId: string,\n    @Param('id') id: string,\n    @Query('lang') lang: 'es' | 'en' = 'es',\n    @Res() res: Response,\n  ) {\n    const invoice = await this.invoicesService.findById(companyId, id);\n    const pdfBuffer = await this.pdfService.generatePdf(companyId, id, {\n      language: lang,\n      includeQR: true,\n    });\n\n    res.set({\n      'Content-Type': 'application/pdf',\n      'Content-Disposition': `inline; filename=\"factura-${invoice.fullNumber}.pdf\"`,\n      'Content-Length': pdfBuffer.length,\n    });\n\n    res.end(pdfBuffer);\n  }\n}\n"],"names":["InvoicesController","findAll","companyId","query","invoicesService","findById","id","getVerifactuQR","qrData","createSales","user","dto","create","sub","createPurchase","update","issue","markAsPaid","body","paidAt","Date","undefined","cancel","delete","downloadPdf","lang","res","invoice","pdfBuffer","pdfService","generatePdf","language","includeQR","set","fullNumber","length","end","previewPdf","summary","status","description","name","OK","NO_CONTENT","required","enum"],"mappings":"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"}