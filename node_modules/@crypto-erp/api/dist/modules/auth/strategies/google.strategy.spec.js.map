{"version":3,"sources":["../../../../src/modules/auth/strategies/google.strategy.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { GoogleStrategy } from './google.strategy';\nimport { AuthService } from '../auth.service';\nimport { ConfigService } from '@nestjs/config';\nimport { UnauthorizedException } from '@nestjs/common';\n\ndescribe('GoogleStrategy', () => {\n  let strategy: GoogleStrategy;\n  let authService: AuthService;\n\n  const mockConfigService = {\n    get: jest.fn((key: string) => {\n      const config = {\n        GOOGLE_CLIENT_ID: 'test-client-id',\n        GOOGLE_CLIENT_SECRET: 'test-client-secret',\n        GOOGLE_CALLBACK_URL: 'http://localhost:3000/auth/sso/google/callback',\n      };\n      return config[key];\n    }),\n  };\n\n  const mockAuthService = {\n    findOrCreateSSOUser: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        GoogleStrategy,\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n        {\n          provide: AuthService,\n          useValue: mockAuthService,\n        },\n      ],\n    }).compile();\n\n    strategy = module.get<GoogleStrategy>(GoogleStrategy);\n    authService = module.get<AuthService>(AuthService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(strategy).toBeDefined();\n  });\n\n  describe('validate', () => {\n    it('should validate and auto-provision user from Google profile', async () => {\n      const mockProfile = {\n        id: 'google-123',\n        emails: [{ value: 'user@example.com', verified: true }],\n        name: { givenName: 'John', familyName: 'Doe' },\n        photos: [{ value: 'https://example.com/photo.jpg' }],\n        _json: { locale: 'en' },\n      };\n\n      const mockUser = {\n        id: 'user-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n      };\n\n      mockAuthService.findOrCreateSSOUser.mockResolvedValue(mockUser);\n\n      const done = jest.fn();\n\n      await strategy.validate('access-token', 'refresh-token', mockProfile, done);\n\n      expect(authService.findOrCreateSSOUser).toHaveBeenCalledWith({\n        ssoProvider: 'google',\n        ssoId: 'google-123',\n        email: 'user@example.com',\n        firstName: 'John',\n        lastName: 'Doe',\n        avatarUrl: 'https://example.com/photo.jpg',\n        ssoMetadata: {\n          accessToken: 'access-token',\n          refreshToken: 'refresh-token',\n          locale: 'en',\n        },\n      });\n\n      expect(done).toHaveBeenCalledWith(null, mockUser);\n    });\n\n    it('should throw error if no email in profile', async () => {\n      const mockProfile = {\n        id: 'google-123',\n        emails: [],\n        name: { givenName: 'John', familyName: 'Doe' },\n      };\n\n      const done = jest.fn();\n\n      await strategy.validate('access-token', 'refresh-token', mockProfile, done);\n\n      expect(done).toHaveBeenCalledWith(\n        expect.any(UnauthorizedException),\n        false,\n      );\n    });\n\n    it('should handle service errors gracefully', async () => {\n      const mockProfile = {\n        id: 'google-123',\n        emails: [{ value: 'user@example.com' }],\n        name: { givenName: 'John', familyName: 'Doe' },\n      };\n\n      const error = new Error('Database error');\n      mockAuthService.findOrCreateSSOUser.mockRejectedValue(error);\n\n      const done = jest.fn();\n\n      await strategy.validate('access-token', 'refresh-token', mockProfile, done);\n\n      expect(done).toHaveBeenCalledWith(error, false);\n    });\n  });\n});\n"],"names":["describe","strategy","authService","mockConfigService","get","jest","fn","key","config","GOOGLE_CLIENT_ID","GOOGLE_CLIENT_SECRET","GOOGLE_CALLBACK_URL","mockAuthService","findOrCreateSSOUser","beforeEach","module","Test","createTestingModule","providers","GoogleStrategy","provide","ConfigService","useValue","AuthService","compile","clearAllMocks","it","expect","toBeDefined","mockProfile","id","emails","value","verified","name","givenName","familyName","photos","_json","locale","mockUser","email","firstName","lastName","mockResolvedValue","done","validate","toHaveBeenCalledWith","ssoProvider","ssoId","avatarUrl","ssoMetadata","accessToken","refreshToken","any","UnauthorizedException","error","Error","mockRejectedValue"],"mappings":";;;;yBAAoC;gCACL;6BACH;wBACE;wBACQ;AAEtCA,SAAS,kBAAkB;IACzB,IAAIC;IACJ,IAAIC;IAEJ,MAAMC,oBAAoB;QACxBC,KAAKC,KAAKC,EAAE,CAAC,CAACC;YACZ,MAAMC,SAAS;gBACbC,kBAAkB;gBAClBC,sBAAsB;gBACtBC,qBAAqB;YACvB;YACA,OAAOH,MAAM,CAACD,IAAI;QACpB;IACF;IAEA,MAAMK,kBAAkB;QACtBC,qBAAqBR,KAAKC,EAAE;IAC9B;IAEAQ,WAAW;QACT,MAAMC,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,WAAW;gBACTC,8BAAc;gBACd;oBACEC,SAASC,qBAAa;oBACtBC,UAAUnB;gBACZ;gBACA;oBACEiB,SAASG,wBAAW;oBACpBD,UAAUV;gBACZ;aACD;QACH,GAAGY,OAAO;QAEVvB,WAAWc,OAAOX,GAAG,CAAiBe,8BAAc;QACpDjB,cAAca,OAAOX,GAAG,CAAcmB,wBAAW;QAEjDlB,KAAKoB,aAAa;IACpB;IAEAC,GAAG,qBAAqB;QACtBC,OAAO1B,UAAU2B,WAAW;IAC9B;IAEA5B,SAAS,YAAY;QACnB0B,GAAG,+DAA+D;YAChE,MAAMG,cAAc;gBAClBC,IAAI;gBACJC,QAAQ;oBAAC;wBAAEC,OAAO;wBAAoBC,UAAU;oBAAK;iBAAE;gBACvDC,MAAM;oBAAEC,WAAW;oBAAQC,YAAY;gBAAM;gBAC7CC,QAAQ;oBAAC;wBAAEL,OAAO;oBAAgC;iBAAE;gBACpDM,OAAO;oBAAEC,QAAQ;gBAAK;YACxB;YAEA,MAAMC,WAAW;gBACfV,IAAI;gBACJW,OAAO;gBACPC,WAAW;gBACXC,UAAU;YACZ;YAEA/B,gBAAgBC,mBAAmB,CAAC+B,iBAAiB,CAACJ;YAEtD,MAAMK,OAAOxC,KAAKC,EAAE;YAEpB,MAAML,SAAS6C,QAAQ,CAAC,gBAAgB,iBAAiBjB,aAAagB;YAEtElB,OAAOzB,YAAYW,mBAAmB,EAAEkC,oBAAoB,CAAC;gBAC3DC,aAAa;gBACbC,OAAO;gBACPR,OAAO;gBACPC,WAAW;gBACXC,UAAU;gBACVO,WAAW;gBACXC,aAAa;oBACXC,aAAa;oBACbC,cAAc;oBACdd,QAAQ;gBACV;YACF;YAEAZ,OAAOkB,MAAME,oBAAoB,CAAC,MAAMP;QAC1C;QAEAd,GAAG,6CAA6C;YAC9C,MAAMG,cAAc;gBAClBC,IAAI;gBACJC,QAAQ,EAAE;gBACVG,MAAM;oBAAEC,WAAW;oBAAQC,YAAY;gBAAM;YAC/C;YAEA,MAAMS,OAAOxC,KAAKC,EAAE;YAEpB,MAAML,SAAS6C,QAAQ,CAAC,gBAAgB,iBAAiBjB,aAAagB;YAEtElB,OAAOkB,MAAME,oBAAoB,CAC/BpB,OAAO2B,GAAG,CAACC,6BAAqB,GAChC;QAEJ;QAEA7B,GAAG,2CAA2C;YAC5C,MAAMG,cAAc;gBAClBC,IAAI;gBACJC,QAAQ;oBAAC;wBAAEC,OAAO;oBAAmB;iBAAE;gBACvCE,MAAM;oBAAEC,WAAW;oBAAQC,YAAY;gBAAM;YAC/C;YAEA,MAAMoB,QAAQ,IAAIC,MAAM;YACxB7C,gBAAgBC,mBAAmB,CAAC6C,iBAAiB,CAACF;YAEtD,MAAMX,OAAOxC,KAAKC,EAAE;YAEpB,MAAML,SAAS6C,QAAQ,CAAC,gBAAgB,iBAAiBjB,aAAagB;YAEtElB,OAAOkB,MAAME,oBAAoB,CAACS,OAAO;QAC3C;IACF;AACF"}