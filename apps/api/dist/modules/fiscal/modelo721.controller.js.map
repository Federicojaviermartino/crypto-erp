{"version":3,"sources":["../../../src/modules/fiscal/modelo721.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Get,\n  Param,\n  Headers,\n  BadRequestException,\n  Res,\n} from '@nestjs/common';\nimport { Response } from 'express';\nimport { Modelo721Service } from './modelo721.service.js';\n\n@Controller('fiscal/modelo721')\nexport class Modelo721Controller {\n  constructor(private readonly modelo721Service: Modelo721Service) {}\n\n  private getCompanyId(headers: Record<string, string>): string {\n    const companyId = headers['x-company-id'];\n    if (!companyId) {\n      throw new BadRequestException('X-Company-Id header is required');\n    }\n    return companyId;\n  }\n\n  @Get(':year')\n  async getModelo721(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.modelo721Service.generateModelo721(companyId, year);\n  }\n\n  @Get(':year/validate')\n  async validateModelo721(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.modelo721Service.validateForSubmission(companyId, year);\n  }\n\n  @Get(':year/export/aeat')\n  async exportAEAT(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n    @Res() res: Response,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    const content = await this.modelo721Service.exportToAEATFormat(companyId, year);\n\n    res.setHeader('Content-Type', 'application/xml');\n    res.setHeader('Content-Disposition', `attachment; filename=modelo721_${year}.xml`);\n    res.send(content);\n  }\n\n  @Get(':year/export/csv')\n  async exportCSV(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n    @Res() res: Response,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    const content = await this.modelo721Service.exportToCSV(companyId, year);\n\n    res.setHeader('Content-Type', 'text/csv; charset=utf-8');\n    res.setHeader('Content-Disposition', `attachment; filename=modelo721_${year}.csv`);\n    res.send('\\uFEFF' + content); // BOM for Excel UTF-8\n  }\n\n  @Get(':year/modelo720')\n  async getModelo720Crypto(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.modelo721Service.generateModelo720Crypto(companyId, year);\n  }\n\n  @Get(':year/modelo720/export/aeat')\n  async exportModelo720AEAT(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n    @Res() res: Response,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    const content = await this.modelo721Service.exportModelo720ToAEATFormat(companyId, year);\n\n    res.setHeader('Content-Type', 'application/xml');\n    res.setHeader('Content-Disposition', `attachment; filename=modelo720_subgrupo8_${year}.xml`);\n    res.send(content);\n  }\n\n  @Get(':year/summary')\n  async getSummary(\n    @Headers() headers: Record<string, string>,\n    @Param('year') yearStr: string,\n  ) {\n    const companyId = this.getCompanyId(headers);\n    const year = parseInt(yearStr, 10);\n\n    if (isNaN(year) || year < 2020 || year > new Date().getFullYear()) {\n      throw new BadRequestException('Invalid year');\n    }\n\n    return this.modelo721Service.getSummary(companyId, year);\n  }\n}\n"],"names":["Modelo721Controller","getCompanyId","headers","companyId","BadRequestException","getModelo721","yearStr","year","parseInt","isNaN","Date","getFullYear","modelo721Service","generateModelo721","validateModelo721","validateForSubmission","exportAEAT","res","content","exportToAEATFormat","setHeader","send","exportCSV","exportToCSV","getModelo720Crypto","generateModelo720Crypto","exportModelo720AEAT","exportModelo720ToAEATFormat","getSummary"],"mappings":"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"}