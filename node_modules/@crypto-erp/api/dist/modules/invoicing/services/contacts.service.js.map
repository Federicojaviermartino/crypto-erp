{"version":3,"sources":["../../../../src/modules/invoicing/services/contacts.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, ConflictException } from '@nestjs/common';\nimport { PrismaService } from '@crypto-erp/database';\nimport { CreateContactDto, QueryContactsDto } from '../dto/index.js';\nimport { Contact, Prisma, ContactType } from '@prisma/client';\n\n@Injectable()\nexport class ContactsService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  async findAll(\n    companyId: string,\n    query: QueryContactsDto,\n  ): Promise<{ contacts: Contact[]; total: number }> {\n    const where: Prisma.ContactWhereInput = {\n      companyId,\n      ...(query.type && { type: query.type }),\n      ...(query.isActive !== undefined && { isActive: query.isActive }),\n      ...(query.search && {\n        OR: [\n          { name: { contains: query.search, mode: 'insensitive' as const } },\n          { taxId: { contains: query.search, mode: 'insensitive' as const } },\n          { email: { contains: query.search, mode: 'insensitive' as const } },\n        ],\n      }),\n    };\n\n    const [contacts, total] = await Promise.all([\n      this.prisma.contact.findMany({\n        where,\n        orderBy: { name: 'asc' },\n        skip: query.skip || 0,\n        take: query.take || 50,\n      }),\n      this.prisma.contact.count({ where }),\n    ]);\n\n    return { contacts, total };\n  }\n\n  async findById(companyId: string, id: string): Promise<Contact> {\n    const contact = await this.prisma.contact.findFirst({\n      where: { id, companyId },\n    });\n\n    if (!contact) {\n      throw new NotFoundException(`Contact with ID ${id} not found`);\n    }\n\n    return contact;\n  }\n\n  async findByTaxId(companyId: string, taxId: string): Promise<Contact | null> {\n    return this.prisma.contact.findFirst({\n      where: { companyId, taxId },\n    });\n  }\n\n  async create(companyId: string, dto: CreateContactDto): Promise<Contact> {\n    // Check for duplicate tax ID if provided\n    if (dto.taxId) {\n      const existing = await this.findByTaxId(companyId, dto.taxId);\n      if (existing) {\n        throw new ConflictException(`Contact with tax ID ${dto.taxId} already exists`);\n      }\n    }\n\n    return this.prisma.contact.create({\n      data: {\n        name: dto.name,\n        taxId: dto.taxId,\n        type: (dto.type as ContactType) || ContactType.CUSTOMER,\n        email: dto.email,\n        phone: dto.phone,\n        address: dto.address,\n        city: dto.city,\n        postalCode: dto.postalCode,\n        country: dto.country || 'ES',\n        notes: dto.notes,\n        isActive: dto.isActive ?? true,\n        companyId,\n      },\n    });\n  }\n\n  async update(\n    companyId: string,\n    id: string,\n    dto: Partial<CreateContactDto>,\n  ): Promise<Contact> {\n    await this.findById(companyId, id);\n\n    // Check for duplicate tax ID if being updated\n    if (dto.taxId) {\n      const existing = await this.prisma.contact.findFirst({\n        where: { companyId, taxId: dto.taxId, NOT: { id } },\n      });\n      if (existing) {\n        throw new ConflictException(`Contact with tax ID ${dto.taxId} already exists`);\n      }\n    }\n\n    return this.prisma.contact.update({\n      where: { id },\n      data: {\n        ...(dto.name && { name: dto.name }),\n        ...(dto.taxId !== undefined && { taxId: dto.taxId }),\n        ...(dto.type && { type: dto.type as ContactType }),\n        ...(dto.email !== undefined && { email: dto.email }),\n        ...(dto.phone !== undefined && { phone: dto.phone }),\n        ...(dto.address !== undefined && { address: dto.address }),\n        ...(dto.city !== undefined && { city: dto.city }),\n        ...(dto.postalCode !== undefined && { postalCode: dto.postalCode }),\n        ...(dto.country !== undefined && { country: dto.country }),\n        ...(dto.notes !== undefined && { notes: dto.notes }),\n        ...(dto.isActive !== undefined && { isActive: dto.isActive }),\n      },\n    });\n  }\n\n  async deactivate(companyId: string, id: string): Promise<Contact> {\n    await this.findById(companyId, id);\n\n    return this.prisma.contact.update({\n      where: { id },\n      data: { isActive: false },\n    });\n  }\n\n  async activate(companyId: string, id: string): Promise<Contact> {\n    await this.findById(companyId, id);\n\n    return this.prisma.contact.update({\n      where: { id },\n      data: { isActive: true },\n    });\n  }\n\n  async delete(companyId: string, id: string): Promise<void> {\n    await this.findById(companyId, id);\n\n    // Check if contact has invoices\n    const invoiceCount = await this.prisma.invoice.count({\n      where: { contactId: id },\n    });\n\n    if (invoiceCount > 0) {\n      throw new ConflictException(\n        `Cannot delete contact with ${invoiceCount} associated invoices. Deactivate instead.`,\n      );\n    }\n\n    await this.prisma.contact.delete({ where: { id } });\n  }\n}\n"],"names":["ContactsService","findAll","companyId","query","where","type","isActive","undefined","search","OR","name","contains","mode","taxId","email","contacts","total","Promise","all","prisma","contact","findMany","orderBy","skip","take","count","findById","id","findFirst","NotFoundException","findByTaxId","create","dto","existing","ConflictException","data","ContactType","CUSTOMER","phone","address","city","postalCode","country","notes","update","NOT","deactivate","activate","delete","invoiceCount","invoice","contactId"],"mappings":"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"}