{"version":3,"sources":["../../src/processors/verifactu-send.processor.ts"],"sourcesContent":["import { Processor, WorkerHost, OnWorkerEvent } from '@nestjs/bullmq';\nimport { Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Job } from 'bullmq';\nimport { PrismaService } from '@crypto-erp/database';\nimport * as https from 'https';\nimport * as fs from 'fs';\n\nconst QUEUE_NAME = 'verifactu-send';\n\ninterface VerifactuSendJobData {\n  invoiceId: string;\n  companyId: string;\n  verifactuRecordId: string;\n  xml: string;\n  nifEmisor: string;\n  invoiceNumber: string;\n  retryCount?: number;\n}\n\ninterface VerifactuSendResult {\n  success: boolean;\n  csv?: string;\n  responseCode?: string;\n  responseMessage?: string;\n  errors?: string[];\n}\n\n@Processor(QUEUE_NAME)\nexport class VerifactuSendProcessor extends WorkerHost {\n  private readonly logger = new Logger(VerifactuSendProcessor.name);\n  private readonly maxRetries = 3;\n  private readonly aeatEndpoint: string;\n  private certificate: { cert: string; key: string } | null = null;\n\n  constructor(\n    private readonly prisma: PrismaService,\n    private readonly configService: ConfigService,\n  ) {\n    super();\n\n    // Set AEAT endpoint based on environment\n    const isProduction = this.configService.get('NODE_ENV') === 'production';\n    this.aeatEndpoint = isProduction\n      ? 'https://www1.agenciatributaria.gob.es/wlpl/TGVI-JDIT/ws/VeriFactuSV'\n      : 'https://prewww1.aeat.es/wlpl/TGVI-JDIT/ws/VeriFactuSV';\n\n    this.loadCertificate();\n  }\n\n  /**\n   * Load AEAT certificate from configured path\n   */\n  private loadCertificate(): void {\n    const certPath = this.configService.get<string>('AEAT_CERTIFICATE_PATH');\n\n    if (!certPath) {\n      this.logger.warn('AEAT_CERTIFICATE_PATH not configured. Verifactu submissions will be simulated.');\n      return;\n    }\n\n    try {\n      // For P12/PFX certificates, you would need to extract cert and key\n      // This is a simplified version - in production use node-forge or similar\n      if (fs.existsSync(certPath)) {\n        this.logger.log('AEAT certificate configured');\n        // Certificate loading would go here\n      } else {\n        this.logger.warn(`Certificate file not found: ${certPath}`);\n      }\n    } catch (error) {\n      this.logger.error(`Failed to load certificate: ${error}`);\n    }\n  }\n\n  async process(job: Job<VerifactuSendJobData>): Promise<VerifactuSendResult> {\n    const { invoiceId, companyId, verifactuRecordId, xml, nifEmisor, invoiceNumber } = job.data;\n\n    this.logger.log(`Processing Verifactu submission for invoice ${invoiceNumber}`);\n\n    const result: VerifactuSendResult = {\n      success: false,\n      errors: [],\n    };\n\n    try {\n      // Update record status to ENVIANDO\n      await this.prisma.verifactuRecord.update({\n        where: { id: verifactuRecordId },\n        data: {\n          state: 'ENVIANDO',\n          sentAt: new Date(),\n        },\n      });\n\n      // If no certificate, simulate the submission\n      if (!this.certificate) {\n        this.logger.warn('No certificate configured - simulating AEAT submission');\n\n        // Simulate successful response\n        const simulatedCsv = `SIM-${Date.now()}-${invoiceNumber}`;\n\n        await this.prisma.verifactuRecord.update({\n          where: { id: verifactuRecordId },\n          data: {\n            state: 'ACEPTADO',\n            csv: simulatedCsv,\n            aeatResponse: JSON.stringify({\n              simulated: true,\n              timestamp: new Date().toISOString(),\n              message: 'Simulated acceptance - certificate not configured',\n            }),\n          },\n        });\n\n        result.success = true;\n        result.csv = simulatedCsv;\n        result.responseMessage = 'Simulated acceptance';\n\n        return result;\n      }\n\n      // Send to AEAT\n      const aeatResponse = await this.sendToAEAT(xml, nifEmisor);\n\n      if (aeatResponse.success) {\n        // Update record as accepted\n        await this.prisma.verifactuRecord.update({\n          where: { id: verifactuRecordId },\n          data: {\n            state: 'ACEPTADO',\n            csv: aeatResponse.csv,\n            aeatResponse: JSON.stringify(aeatResponse),\n          },\n        });\n\n        // Update invoice status with response data\n        await this.prisma.invoice.update({\n          where: { id: invoiceId },\n          data: {\n            verifactuStatus: 'ACCEPTED',\n            verifactuSentAt: new Date(),\n            verifactuResponse: { csv: aeatResponse.csv, code: aeatResponse.code },\n          },\n        });\n\n        result.success = true;\n        result.csv = aeatResponse.csv;\n        result.responseCode = aeatResponse.code;\n        result.responseMessage = aeatResponse.message;\n      } else {\n        // Update record as rejected\n        await this.prisma.verifactuRecord.update({\n          where: { id: verifactuRecordId },\n          data: {\n            state: 'RECHAZADO',\n            aeatResponse: JSON.stringify(aeatResponse),\n          },\n        });\n\n        result.errors?.push(aeatResponse.message || 'AEAT rejected the submission');\n        throw new Error(`AEAT rejection: ${aeatResponse.message}`);\n      }\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      result.errors?.push(errorMessage);\n\n      // Update record with error\n      await this.prisma.verifactuRecord.update({\n        where: { id: verifactuRecordId },\n        data: {\n          state: 'ERROR',\n          aeatResponse: JSON.stringify({ error: errorMessage }),\n        },\n      });\n\n      this.logger.error(`Verifactu submission failed for ${invoiceNumber}: ${errorMessage}`);\n      throw error;\n    }\n\n    return result;\n  }\n\n  /**\n   * Send XML to AEAT web service\n   */\n  private async sendToAEAT(\n    xml: string,\n    nifEmisor: string,\n  ): Promise<{\n    success: boolean;\n    csv?: string;\n    code?: string;\n    message?: string;\n  }> {\n    return new Promise((resolve) => {\n      // Build SOAP envelope\n      const soapEnvelope = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\">\n  <soapenv:Header/>\n  <soapenv:Body>\n    ${xml}\n  </soapenv:Body>\n</soapenv:Envelope>`;\n\n      const url = new URL(this.aeatEndpoint);\n      const options: https.RequestOptions = {\n        hostname: url.hostname,\n        port: 443,\n        path: url.pathname,\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/xml; charset=utf-8',\n          'Content-Length': Buffer.byteLength(soapEnvelope),\n          SOAPAction: 'RegistroFacturacion',\n        },\n        // Certificate would be added here\n        // cert: this.certificate?.cert,\n        // key: this.certificate?.key,\n      };\n\n      const req = https.request(options, (res) => {\n        let data = '';\n\n        res.on('data', (chunk) => {\n          data += chunk;\n        });\n\n        res.on('end', () => {\n          try {\n            // Parse AEAT response\n            // This is simplified - actual parsing would be more complex\n            const csvMatch = data.match(/<CSV>([^<]+)<\\/CSV>/);\n            const errorMatch = data.match(/<DescripcionErrorRegistro>([^<]+)<\\/DescripcionErrorRegistro>/);\n\n            if (csvMatch) {\n              resolve({\n                success: true,\n                csv: csvMatch[1],\n                code: '0',\n                message: 'Accepted by AEAT',\n              });\n            } else if (errorMatch) {\n              resolve({\n                success: false,\n                message: errorMatch[1],\n              });\n            } else {\n              resolve({\n                success: false,\n                message: 'Unexpected response format',\n              });\n            }\n          } catch {\n            resolve({\n              success: false,\n              message: 'Failed to parse AEAT response',\n            });\n          }\n        });\n      });\n\n      req.on('error', (error) => {\n        resolve({\n          success: false,\n          message: error.message,\n        });\n      });\n\n      req.write(soapEnvelope);\n      req.end();\n    });\n  }\n\n  @OnWorkerEvent('completed')\n  onCompleted(job: Job<VerifactuSendJobData>) {\n    this.logger.log(`Verifactu job ${job.id} completed for invoice ${job.data.invoiceNumber}`);\n  }\n\n  @OnWorkerEvent('failed')\n  onFailed(job: Job<VerifactuSendJobData> | undefined, error: Error) {\n    this.logger.error(\n      `Verifactu job failed for invoice ${job?.data.invoiceNumber}: ${error.message}`,\n    );\n  }\n}\n"],"names":["VerifactuSendProcessor","QUEUE_NAME","WorkerHost","loadCertificate","certPath","configService","get","logger","warn","fs","existsSync","log","error","process","job","invoiceId","companyId","verifactuRecordId","xml","nifEmisor","invoiceNumber","data","result","success","errors","prisma","verifactuRecord","update","where","id","state","sentAt","Date","certificate","simulatedCsv","now","csv","aeatResponse","JSON","stringify","simulated","timestamp","toISOString","message","responseMessage","sendToAEAT","invoice","verifactuStatus","verifactuSentAt","verifactuResponse","code","responseCode","push","Error","errorMessage","Promise","resolve","soapEnvelope","url","URL","aeatEndpoint","options","hostname","port","path","pathname","method","headers","Buffer","byteLength","SOAPAction","req","https","request","res","on","chunk","csvMatch","match","errorMatch","write","end","onCompleted","onFailed","Logger","name","maxRetries","isProduction"],"mappings":"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"}