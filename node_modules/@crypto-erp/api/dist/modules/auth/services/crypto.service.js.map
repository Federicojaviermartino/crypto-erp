{"version":3,"sources":["../../../../src/modules/auth/services/crypto.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport * as crypto from 'crypto';\n\n@Injectable()\nexport class CryptoService {\n  private readonly algorithm = 'aes-256-gcm';\n  private readonly keyLength = 32; // 256 bits\n  private readonly ivLength = 16; // 128 bits\n  private readonly saltLength = 64;\n  private readonly tagLength = 16;\n  private readonly encryptionKey: Buffer;\n\n  constructor(private configService: ConfigService) {\n    const key = this.configService.get<string>('ENCRYPTION_KEY');\n\n    if (!key) {\n      // Generate a random key for development (NOT for production!)\n      console.warn(\n        'ENCRYPTION_KEY not set! Generating random key. DO NOT use in production!',\n      );\n      this.encryptionKey = crypto.randomBytes(this.keyLength);\n    } else {\n      // Derive key from the config string\n      this.encryptionKey = crypto.scryptSync(key, 'salt', this.keyLength);\n    }\n  }\n\n  /**\n   * Encrypt a string value\n   */\n  async encrypt(plaintext: string): Promise<string> {\n    try {\n      const iv = crypto.randomBytes(this.ivLength);\n      const cipher = crypto.createCipheriv(this.algorithm, this.encryptionKey, iv);\n\n      const encrypted = Buffer.concat([\n        cipher.update(plaintext, 'utf8'),\n        cipher.final(),\n      ]);\n\n      const tag = cipher.getAuthTag();\n\n      // Format: iv:tag:encrypted (all base64)\n      return [\n        iv.toString('base64'),\n        tag.toString('base64'),\n        encrypted.toString('base64'),\n      ].join(':');\n    } catch (error) {\n      throw new Error(`Encryption failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Decrypt an encrypted string\n   */\n  async decrypt(ciphertext: string): Promise<string> {\n    try {\n      const [ivB64, tagB64, encryptedB64] = ciphertext.split(':');\n\n      const iv = Buffer.from(ivB64, 'base64');\n      const tag = Buffer.from(tagB64, 'base64');\n      const encrypted = Buffer.from(encryptedB64, 'base64');\n\n      const decipher = crypto.createDecipheriv(this.algorithm, this.encryptionKey, iv);\n      decipher.setAuthTag(tag);\n\n      const decrypted = Buffer.concat([decipher.update(encrypted), decipher.final()]);\n\n      return decrypted.toString('utf8');\n    } catch (error) {\n      throw new Error(`Decryption failed: ${error.message}`);\n    }\n  }\n\n  /**\n   * Generate a random token\n   */\n  generateRandomToken(length: number = 32): string {\n    return crypto.randomBytes(length).toString('hex');\n  }\n\n  /**\n   * Hash a password or sensitive data (one-way)\n   */\n  hash(data: string): string {\n    return crypto.createHash('sha256').update(data).digest('hex');\n  }\n}\n"],"names":["CryptoService","encrypt","plaintext","iv","crypto","randomBytes","ivLength","cipher","createCipheriv","algorithm","encryptionKey","encrypted","Buffer","concat","update","final","tag","getAuthTag","toString","join","error","Error","message","decrypt","ciphertext","ivB64","tagB64","encryptedB64","split","from","decipher","createDecipheriv","setAuthTag","decrypted","generateRandomToken","length","hash","data","createHash","digest","configService","keyLength","saltLength","tagLength","key","get","console","warn","scryptSync"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALc;wBACG;gEACN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,gBAAN,MAAMA;IAuBX;;GAEC,GACD,MAAMC,QAAQC,SAAiB,EAAmB;QAChD,IAAI;YACF,MAAMC,KAAKC,QAAOC,WAAW,CAAC,IAAI,CAACC,QAAQ;YAC3C,MAAMC,SAASH,QAAOI,cAAc,CAAC,IAAI,CAACC,SAAS,EAAE,IAAI,CAACC,aAAa,EAAEP;YAEzE,MAAMQ,YAAYC,OAAOC,MAAM,CAAC;gBAC9BN,OAAOO,MAAM,CAACZ,WAAW;gBACzBK,OAAOQ,KAAK;aACb;YAED,MAAMC,MAAMT,OAAOU,UAAU;YAE7B,wCAAwC;YACxC,OAAO;gBACLd,GAAGe,QAAQ,CAAC;gBACZF,IAAIE,QAAQ,CAAC;gBACbP,UAAUO,QAAQ,CAAC;aACpB,CAACC,IAAI,CAAC;QACT,EAAE,OAAOC,OAAO;YACd,MAAM,IAAIC,MAAM,CAAC,mBAAmB,EAAED,MAAME,OAAO,EAAE;QACvD;IACF;IAEA;;GAEC,GACD,MAAMC,QAAQC,UAAkB,EAAmB;QACjD,IAAI;YACF,MAAM,CAACC,OAAOC,QAAQC,aAAa,GAAGH,WAAWI,KAAK,CAAC;YAEvD,MAAMzB,KAAKS,OAAOiB,IAAI,CAACJ,OAAO;YAC9B,MAAMT,MAAMJ,OAAOiB,IAAI,CAACH,QAAQ;YAChC,MAAMf,YAAYC,OAAOiB,IAAI,CAACF,cAAc;YAE5C,MAAMG,WAAW1B,QAAO2B,gBAAgB,CAAC,IAAI,CAACtB,SAAS,EAAE,IAAI,CAACC,aAAa,EAAEP;YAC7E2B,SAASE,UAAU,CAAChB;YAEpB,MAAMiB,YAAYrB,OAAOC,MAAM,CAAC;gBAACiB,SAAShB,MAAM,CAACH;gBAAYmB,SAASf,KAAK;aAAG;YAE9E,OAAOkB,UAAUf,QAAQ,CAAC;QAC5B,EAAE,OAAOE,OAAO;YACd,MAAM,IAAIC,MAAM,CAAC,mBAAmB,EAAED,MAAME,OAAO,EAAE;QACvD;IACF;IAEA;;GAEC,GACDY,oBAAoBC,SAAiB,EAAE,EAAU;QAC/C,OAAO/B,QAAOC,WAAW,CAAC8B,QAAQjB,QAAQ,CAAC;IAC7C;IAEA;;GAEC,GACDkB,KAAKC,IAAY,EAAU;QACzB,OAAOjC,QAAOkC,UAAU,CAAC,UAAUxB,MAAM,CAACuB,MAAME,MAAM,CAAC;IACzD;IA3EA,YAAY,AAAQC,aAA4B,CAAE;aAA9BA,gBAAAA;aAPH/B,YAAY;aACZgC,YAAY,IAAI,WAAW;aAC3BnC,WAAW,IAAI,WAAW;aAC1BoC,aAAa;aACbC,YAAY;QAI3B,MAAMC,MAAM,IAAI,CAACJ,aAAa,CAACK,GAAG,CAAS;QAE3C,IAAI,CAACD,KAAK;YACR,8DAA8D;YAC9DE,QAAQC,IAAI,CACV;YAEF,IAAI,CAACrC,aAAa,GAAGN,QAAOC,WAAW,CAAC,IAAI,CAACoC,SAAS;QACxD,OAAO;YACL,oCAAoC;YACpC,IAAI,CAAC/B,aAAa,GAAGN,QAAO4C,UAAU,CAACJ,KAAK,QAAQ,IAAI,CAACH,SAAS;QACpE;IACF;AA+DF"}